<!DOCTYPE html>
<html lang="tr">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; frame-ancestors 'self' https://crm.zoho.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleekflow Inbox - Zoho CRM Widget</title>
    <!-- Zoho Embedded App SDK -->
    <script src="https://live.zwidgets.com/js-sdk/1.0/ZohoEmbededAppSDK.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar - Settings & Connection -->
        <aside class="sidebar open" id="sidebar">
            <div class="sidebar-header">
                <h2>âš™ï¸ Ayarlar</h2>
                <button class="btn-icon" id="toggleSidebar" type="button" onclick="window.toggleSidebar(); return false;">âœ•</button>
            </div>
            
            <div class="sidebar-content">
                <!-- Sleekflow Connection -->
                <div class="settings-section">
                    <h3>ğŸ“± Sleekflow Platform API</h3>
                    <div class="form-group">
                        <label>Platform API AnahtarÄ± <span style="color: #ef4444;">*</span></label>
                        <input type="password" id="sleekflowApiKey" class="input-field" placeholder="API anahtarÄ±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n" required>
                    </div>
                    <div class="form-group">
                        <label>BÃ¶lge (Base URL)</label>
                        <select id="sleekflowBaseUrl" class="input-field">
                            <option value="https://sleekflow-core-app-weu-production.azurewebsites.net">West Europe (Ã–nerilen)</option>
                            <option value="https://api.sleekflow.io">Hong Kong</option>
                            <option value="https://sleekflow-core-app-eus-production.azurewebsites.net">United States</option>
                            <option value="https://sleekflow-core-app-seas-production.azurewebsites.net">Singapore</option>
                            <option value="https://sleekflow-core-app-uaen-production.azurewebsites.net">UAE North</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" id="connectSleekflow">ğŸ”— SleekFlow'a BaÄŸlan</button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <div class="main-area">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="openSidebar" type="button" onclick="window.toggleSidebar(); return false;">â˜°</button>
                    <h1>Sleekflow Inbox!</h1> <!-- TEMP doÄŸrulama -->
                </div>
                <div class="top-bar-right" style="display: flex; align-items: center; gap: 8px;">
                    <select id="channelFilterTop" class="sender-select" title="Choose Sender" style="margin: 0; width: auto; min-width: fit-content; padding-right: 36px;">
                        <option value="">Choose Sender</option>
                        <option value="908505327532">VIP-+908505327532</option>
                        <option value="905421363421">Hamzah Coexistence-+905421363421</option>
                    </select>
                    <button class="btn-icon" id="refreshConversations" title="Yenile" style="margin: 0;">ğŸ”„</button>
                </div>
            </header>

            <!-- Chat Layout -->
            <div class="chat-layout">
                <!-- Conversations List -->
                <div class="conversations-panel" id="conversationsPanel">
                    <div class="conversations-header">
                        <h2>KonuÅŸmalar</h2>
                        <select id="channelFilter" class="sender-select" title="Kanal Filtrele">
                            <option value="">TÃ¼m Kanallar</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="instagram">Instagram</option>
                            <option value="facebook">Facebook</option>
                            <option value="sms">SMS</option>
                            <option value="line">LINE</option>
                            <option value="wechat">WeChat</option>
                            <option value="web">Web</option>
                        </select>
                        <input type="text" id="searchConversations" class="search-input" placeholder="ğŸ” Ara...">
                    </div>
                    
                    <!-- Lead filter info bar -->
                    <div id="leadFilterInfo" class="lead-filter-info" style="display:none;"></div>
                    
                    <div class="conversations-list" id="conversationsList">
                        <div class="empty-state">
                            <p>ğŸ“­ HenÃ¼z konuÅŸma yok</p>
                            <p class="empty-hint">Sleekflow'a baÄŸlanÄ±n ve konuÅŸmalarÄ± gÃ¶rÃ¼ntÃ¼leyin</p>
                        </div>
                    </div>
                </div>

                <!-- Chat View -->
                <div class="chat-view" id="chatView">
                    <div class="chat-empty">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h2>Bir konuÅŸma seÃ§in</h2>
                        <p>Sol taraftan bir konuÅŸma seÃ§erek mesajlarÄ± gÃ¶rÃ¼ntÃ¼leyin</p>
                    </div>

                    <!-- Active Chat -->
                    <div class="chat-active" id="chatActive" style="display: none;">
                        <!-- Chat Header -->
                        <div class="chat-header">
                            <div class="chat-header-info">
                                <div class="chat-avatar" id="chatAvatar">ğŸ‘¤</div>
                                <div>
                                    <h3 id="chatContactName">Ä°sim</h3>
                                    <span class="chat-meta" id="chatMeta">Durum</span>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div class="messages-area" id="messagesArea">
                            <div class="messages-list" id="messagesList">
                                <!-- Messages will be inserted here -->
                            </div>
                        </div>

                        <!-- 24 Saat KuralÄ± UyarÄ±sÄ± -->
                        <div id="twentyFourHourWarning" style="display: none; background-color: #fffbe6; border: 1px solid #ffe58f; color: #d46b08; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; line-height: 1.5;">
                            <div style="font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="background-color: #faad14; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ENDED</span>
                                <span>24-hour service window passed.</span>
                            </div>
                            <p style="margin: 8px 0;">As per Meta's messaging policy, you can only reach out using a WhatsApp template and wait for their reply to reopen the window.</p>
                            <p style="font-size: 12px; color: #d46b08; margin-top: 8px;">
                                <span id="hoursSinceLastContactDisplay"></span>
                            </p>
                        </div>

                        <!-- Message Input -->
                        <div class="message-input-area">
                            <div class="message-input-wrapper">
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    class="file-input" 
                                    multiple
                                    accept="image/*,video/*,audio/*,.pdf"
                                    style="display: none;"
                                >
                                <button class="btn btn-icon" id="attachFile" title="Dosya ekle" style="margin-right: 5px; padding: 8px 12px;">ğŸ“</button>
                                <button class="btn btn-secondary" id="openTemplates" title="Templates" style="margin-right: 5px; padding: 8px 16px; font-size: 14px;">Templates</button>
                                <div id="normalMessageInput" style="display: flex; flex: 1; gap: 5px;">
                                    <input 
                                        type="text" 
                                        id="messageInput" 
                                        class="message-input" 
                                        placeholder="Mesaj yazÄ±n..."
                                        disabled
                                    >
                                    <button class="btn btn-primary" id="sendMessage" disabled>GÃ¶nder</button>
                                </div>
                            </div>
                            <div id="selectedFilesContainer" class="selected-files-container" style="display: none;">
                                <!-- SeÃ§ilen dosyalar burada gÃ¶sterilecek -->
                            </div>
                            <!-- Show All Conversations Button (sadece filtrelenmiÅŸ modda gÃ¶rÃ¼nÃ¼r) -->
                            <div id="showAllConversationsButtonContainer" style="display: none; padding: 10px; text-align: center; border-top: 1px solid #e0e0e0; background: #f9f9f9;">
                                <button class="btn btn-secondary" id="showAllConversationsInChat" style="width: 100%; padding: 12px; font-size: 14px; cursor: pointer;">
                                    ğŸ“‹ TÃ¼m KonuÅŸmalarÄ± GÃ¶ster
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="templates-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div class="templates-modal-content" style="position: relative; background: white; margin: 50px auto; max-width: 1200px; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Templates</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" id="templateSearch" placeholder="ğŸ” Search templates..." style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; width: 250px;">
                    <button class="btn btn-primary" id="newTemplate" style="padding: 8px 16px;">+ New Template</button>
                    <button class="btn btn-icon" id="closeTemplatesModal" style="padding: 8px; font-size: 20px; background: transparent; border: none; cursor: pointer; color: #1e40af;">âœ•</button>
                </div>
            </div>
            <div id="templatesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                <!-- Templates will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Template Modal -->
    <div id="newTemplateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; overflow-y: auto;">
        <div style="background: white; max-width: 520px; margin: 80px auto; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); position: relative;">
            <h3 style="margin: 0 0 16px 0;">New Template</h3>
            <label style="display:block; font-weight:600; margin-bottom:6px;">Name</label>
            <input id="newTemplateName" type="text" placeholder="Template name" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:12px;">
            <label style="display:block; font-weight:600; margin-bottom:6px;">Content</label>
            <textarea id="newTemplateContent" rows="4" placeholder="Message content" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:12px; resize: vertical;"></textarea>
            <label style="display:block; font-weight:600; margin-bottom:6px;">Type</label>
            <select id="newTemplateType" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:16px;">
                <option value="cloudapi">Cloud API</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="quick-reply">Quick Reply</option>
            </select>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:4px;">
                <button id="cancelNewTemplate" class="btn btn-secondary" style="padding:8px 14px;">Cancel</button>
                <button id="saveNewTemplate" class="btn btn-primary" style="padding:8px 14px;">Save</button>
            </div>
        </div>
    </div>

    <!-- Template Parameters Modal -->
    <div id="templateParametersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; overflow-y: auto;">
        <div style="background: white; max-width: 600px; margin: 80px auto; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Template Parametreleri</h3>
                <button id="closeTemplateParametersModal" class="btn btn-icon" style="padding: 8px; font-size: 20px; background: transparent; border: none; cursor: pointer; color: #1e40af;">âœ•</button>
            </div>
            <div id="templateParametersContent" style="margin-bottom: 20px;">
                <!-- Parametre input'larÄ± buraya eklenecek -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelTemplateParameters" class="btn btn-secondary" style="padding: 10px 20px;">Ä°ptal</button>
                <button id="sendTemplateMessage" class="btn btn-primary" style="padding: 10px 20px;">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>YÃ¼kleniyor...</p>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- BASIC: Get Lead Name from Referrer -->
    <script>
        // Zoho EmbeddedApp SDK Ã¼zerinden recordId alma (PageLoad event)
        function initZohoEmbeddedApp() {
            if (!window.ZOHO || !ZOHO.embeddedApp) {
                console.log('âš ï¸ ZOHO.embeddedApp yok, init atlanÄ±yor');
                return;
            }

            ZOHO.embeddedApp.on("PageLoad", function (data) {
                const rid = data && (data.EntityId || data.recordId);
                if (rid) {
                    // Lead deÄŸiÅŸtiyse state'i sÄ±fÄ±rla ve yeniden yÃ¼kle
                    if (window.leadId !== rid) {
                        window.leadId = null;
                        window.leadPhone = null;
                        window.leadName = null;
                        window.leadEmail = null;
                    }
                    console.log('âœ… Lead ID via PageLoad:', rid);
                    fetchLeadData(rid);
                } else {
                    console.log('âš ï¸ PageLoad event geldi ama recordId yok:', data);
                }
            });

            ZOHO.embeddedApp.init();
            console.log('ğŸ”„ ZOHO.embeddedApp init Ã§aÄŸrÄ±ldÄ±');
        }

        // Get lead ID from referrer and fetch lead name from backend
        function getLeadFromReferrer(forceReload = false) {
            // If already loaded and not forcing reload, don't reload
            if (!forceReload && window.leadPhone && window.leadPhone !== 'null' && window.leadPhone !== '' && window.leadPhone !== 'undefined') {
                console.log('âœ… Lead phone already loaded:', window.leadPhone);
                return;
            }
            
            let leadId = null;
            
            // YÃ–NTEM 0: Zoho Widget API (en gÃ¼venilir - OAuth gerektirir ama deneyelim)
            // Bu API Ã§alÄ±ÅŸÄ±rsa diÄŸer yÃ¶ntemlere gerek kalmaz
            // Ã–NEMLÄ°: $recordId placeholder tespit edildiÄŸinde bu API'ler kullanÄ±lacak
            let useZohoAPI = false;
            const urlParamsCheck = new URLSearchParams(window.location.search);
            const recordIdParam = urlParamsCheck.get('recordId') || urlParamsCheck.get('leadId') || urlParamsCheck.get('id');
            
            // Placeholder kontrolÃ¼: $recordId, ${record.id}, #RecordId# vb.
            if (recordIdParam && (recordIdParam.includes('$') || recordIdParam.includes('{') || recordIdParam.includes('#') || recordIdParam.toLowerCase().includes('recordid'))) {
                console.log('âš ï¸âš ï¸âš ï¸ Placeholder tespit edildi:', recordIdParam);
                console.log('âš ï¸âš ï¸âš ï¸ Zoho Widget API kullanÄ±lacak (placeholder yerine)');
                useZohoAPI = true;
                leadId = null; // Placeholder'Ä± geÃ§ersiz say
            }
            
            if (window.ZOHO) {
                console.log('ğŸ” Zoho Widget API mevcut, deniyor...');
                
                // YÃ–NTEM 0.1: ZOHO.CRM.UI.getRecord() - Widget context'inden (EN Ã–NCELÄ°KLÄ°)
                if (window.ZOHO.CRM && window.ZOHO.CRM.UI && typeof window.ZOHO.CRM.UI.getRecord === 'function') {
                    try {
                        console.log('ğŸ” ZOHO.CRM.UI.getRecord() deneniyor...');
                        window.ZOHO.CRM.UI.getRecord()
                            .then(function(response) {
                                console.log('ğŸ“¥ ZOHO.CRM.UI.getRecord() response:', response);
                                if (response && response.id) {
                                    const zohoLeadId = response.id;
                                    console.log('âœ…âœ…âœ…âœ…âœ… Lead ID found via ZOHO.CRM.UI.getRecord():', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                } else if (response && response.data && response.data.id) {
                                    const zohoLeadId = response.data.id;
                                    console.log('âœ…âœ…âœ…âœ…âœ… Lead ID found via ZOHO.CRM.UI.getRecord() (data.id):', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('âš ï¸ ZOHO.CRM.UI.getRecord() hatasÄ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('âš ï¸ ZOHO.CRM.UI.getRecord() mevcut deÄŸil:', e.message);
                    }
                }
                
                // YÃ–NTEM 0.2: ZOHO.CRM.API.getRecord() - API ile
                if (window.ZOHO.CRM && window.ZOHO.CRM.API && typeof window.ZOHO.CRM.API.getRecord === 'function') {
                    try {
                        console.log('ğŸ” ZOHO.CRM.API.getRecord() deneniyor...');
                        window.ZOHO.CRM.API.getRecord({ Entity: "Leads", RecordID: "current" })
                            .then(function(response) {
                                console.log('ğŸ“¥ ZOHO.CRM.API.getRecord() response:', response);
                                if (response && response.data && response.data[0] && response.data[0].id) {
                                    const zohoLeadId = response.data[0].id;
                                    console.log('âœ…âœ…âœ…âœ…âœ… Lead ID found via ZOHO.CRM.API.getRecord():', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('âš ï¸ ZOHO.CRM.API.getRecord() hatasÄ± (normal, OAuth gerekebilir):', error.message || error);
                            });
                    } catch (e) {
                        console.log('âš ï¸ ZOHO.CRM.API.getRecord() mevcut deÄŸil:', e.message);
                    }
                }
                
                // YÃ–NTEM 0.3: ZOHO.CRM.UI.getFormInfo() - Form bilgisi
                if (window.ZOHO.CRM && window.ZOHO.CRM.UI && typeof window.ZOHO.CRM.UI.getFormInfo === 'function') {
                    try {
                        console.log('ğŸ” ZOHO.CRM.UI.getFormInfo() deneniyor...');
                        window.ZOHO.CRM.UI.getFormInfo()
                            .then(function(response) {
                                console.log('ğŸ“¥ ZOHO.CRM.UI.getFormInfo() response:', response);
                                if (response && response.Entity && response.Entity === 'Leads' && response.RecordId) {
                                    const zohoLeadId = response.RecordId;
                                    console.log('âœ…âœ…âœ…âœ…âœ… Lead ID found via ZOHO.CRM.UI.getFormInfo():', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('âš ï¸ ZOHO.CRM.UI.getFormInfo() hatasÄ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('âš ï¸ ZOHO.CRM.UI.getFormInfo() mevcut deÄŸil:', e.message);
                    }
                }
                
                // YÃ–NTEM 0.4: ZOHO.CRM.UI.getPageInfo() - Sayfa bilgisi
                if (window.ZOHO.CRM && window.ZOHO.CRM.UI && typeof window.ZOHO.CRM.UI.getPageInfo === 'function') {
                    try {
                        console.log('ğŸ” ZOHO.CRM.UI.getPageInfo() deneniyor...');
                        window.ZOHO.CRM.UI.getPageInfo()
                            .then(function(response) {
                                console.log('ğŸ“¥ ZOHO.CRM.UI.getPageInfo() response:', response);
                                if (response && response.Entity && response.Entity === 'Leads' && response.RecordId) {
                                    const zohoLeadId = response.RecordId;
                                    console.log('âœ…âœ…âœ…âœ…âœ… Lead ID found via ZOHO.CRM.UI.getPageInfo():', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('âš ï¸ ZOHO.CRM.UI.getPageInfo() hatasÄ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('âš ï¸ ZOHO.CRM.UI.getPageInfo() mevcut deÄŸil:', e.message);
                    }
                }
            } else {
                console.log('âš ï¸ window.ZOHO mevcut deÄŸil - Zoho Widget API kullanÄ±lamÄ±yor');
            }
            
            // YÃ–NTEM 1: URL parametrelerinden leadId al
            const urlParams = new URLSearchParams(window.location.search);
            leadId = urlParams.get('leadId') || urlParams.get('id') || urlParams.get('recordId') || urlParams.get('record_id');
            
            // YÃ–NTEM 1.1: EÄŸer leadId bir placeholder ise ($recordId, ${record.id}, #RecordId# vb.), geÃ§ersiz say
            if (leadId && (leadId.includes('$') || leadId.includes('{') || leadId.includes('#') || leadId.includes('RecordId') || leadId.includes('recordId') || leadId === '$recordId')) {
                console.log('âš ï¸ Placeholder tespit edildi, geÃ§ersiz sayÄ±lÄ±yor:', leadId);
                leadId = null; // Placeholder'Ä± geÃ§ersiz say, Zoho Widget API'den al
            }
            
            // YÃ–NTEM 1.5: serviceOrigin parametresinden lead ID Ã§Ä±karmayÄ± dene (Zoho widget'larÄ± bazen buraya ekler)
            if (!leadId) {
                const serviceOrigin = urlParams.get('serviceOrigin') || '';
                console.log('ğŸ” serviceOrigin parametresi:', serviceOrigin);
                // serviceOrigin genellikle base64 encoded olabilir veya URL iÃ§erebilir
                if (serviceOrigin) {
                    try {
                        // serviceOrigin URL formatÄ±nda ise parse et
                        const decodedOrigin = decodeURIComponent(serviceOrigin);
                        const originLeadMatch = decodedOrigin.match(/\/tab\/Leads\/(\d+)/) || decodedOrigin.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d+)/);
                        if (originLeadMatch && originLeadMatch[1]) {
                            leadId = originLeadMatch[1];
                            console.log('âœ…âœ…âœ… Lead ID found in serviceOrigin:', leadId);
                        }
                    } catch (e) {
                        console.log('âš ï¸ serviceOrigin parse hatasÄ±:', e.message);
                    }
                }
            }
            
            if (leadId && leadId.length >= 10 && /^\d+$/.test(leadId)) {
                console.log('âœ…âœ…âœ… Lead ID found in URL params:', leadId);
            } else {
                // Lead ID geÃ§erli deÄŸilse, Zoho Widget API'den almayÄ± dene
                console.log('âš ï¸ URL\'den geÃ§erli lead ID bulunamadÄ±, Zoho Widget API deneniyor...');
                leadId = null; // Zoho Widget API'den alÄ±nacak
                // YÃ–NTEM 2: Parent window'dan Zoho widget API ile al (iframe iÃ§inde)
                try {
                    if (window.parent && window.parent !== window) {
                        // Zoho widget API - parent window'dan record ID al
                        const parentUrl = window.parent.location?.href || '';
                        const parentLeadMatch = parentUrl.match(/\/tab\/Leads\/(\d+)/) || parentUrl.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d+)/);
                        if (parentLeadMatch && parentLeadMatch[1]) {
                            leadId = parentLeadMatch[1];
                            console.log('âœ…âœ…âœ… Lead ID found in parent window URL:', leadId);
                        }
                    }
                } catch (e) {
                    console.log('âš ï¸ Parent window eriÅŸimi yok (CORS):', e.message);
                }
                
                // YÃ–NTEM 3: Referrer'dan Ã§Ä±kar (AGRESÄ°F PARSÄ°NG)
                if (!leadId) {
                    const referrer = document.referrer || '';
                    const currentUrl = window.location.href || '';
                    const allUrls = [referrer, currentUrl].join(' ');
                    
                    console.log('ğŸ”ğŸ”ğŸ” REFERRER CHECK (AGRESÄ°F):');
                    console.log('   document.referrer:', document.referrer);
                    console.log('   window.location.href:', window.location.href);
                    console.log('   TÃ¼m URL\'ler birleÅŸtirildi:', allUrls);
                    
                    // Pattern 1: /tab/Leads/3519633000086711022 (en yaygÄ±n)
                    let leadIdMatch = allUrls.match(/\/tab\/Leads\/(\d{10,})/);
                    if (leadIdMatch && leadIdMatch[1]) {
                        leadId = leadIdMatch[1];
                        console.log('âœ…âœ…âœ… Lead ID found (pattern 1 - /tab/Leads/):', leadId);
                    } else {
                        // Pattern 2: /crm/org675407911/tab/Leads/3519633000086711022
                        leadIdMatch = allUrls.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d{10,})/);
                        if (leadIdMatch && leadIdMatch[1]) {
                            leadId = leadIdMatch[1];
                            console.log('âœ…âœ…âœ… Lead ID found (pattern 2 - /crm/.../tab/Leads/):', leadId);
                        } else {
                            // Pattern 3: /Leads/3519633000086711022 (tab olmadan)
                            leadIdMatch = allUrls.match(/\/Leads\/(\d{10,})/);
                            if (leadIdMatch && leadIdMatch[1]) {
                                leadId = leadIdMatch[1];
                                console.log('âœ…âœ…âœ… Lead ID found (pattern 3 - /Leads/):', leadId);
                            } else {
                                // Pattern 4: Herhangi bir yerde 10+ haneli sayÄ± (son Ã§are)
                                leadIdMatch = allUrls.match(/(\d{15,})/); // Zoho lead ID'leri genellikle 15+ haneli
                                if (leadIdMatch && leadIdMatch[1]) {
                                    leadId = leadIdMatch[1];
                                    console.log('âœ…âœ…âœ… Lead ID found (pattern 4 - genel sayÄ± arama):', leadId);
                                }
                            }
                        }
                    }
                }
            }
            
            // YÃ–NTEM 4: Backend'e referrer ile istek at (backend referrer header'Ä±ndan Ã§Ä±karacak)
            // AyrÄ±ca widget URL'sini de gÃ¶nder (referrer yerine)
            if (!leadId) {
                console.log('âš ï¸ Lead ID bulunamadÄ±, backend\'e referrer ile istek atÄ±lÄ±yor...');
                console.log('   Widget URL:', window.location.href);
                console.log('   Referrer:', document.referrer);
                
                // Backend'e hem referrer hem de widget URL'sini gÃ¶nder
                // Widget Render.com'da Ã§alÄ±ÅŸÄ±yorsa, relative path kullan
                const backendUrl = '/api/zoho/lead-info';
                const widgetUrl = window.location.href || '';
                
                // Backend'e widget URL'yi gÃ¶nder (referrer header otomatik gÃ¶nderilir)
                fetch(backendUrl + '?widgetUrl=' + encodeURIComponent(widgetUrl))
                    .then(res => {
                        if (!res.ok && res.status === 400) {
                            // 400 hatasÄ± = Lead ID bulunamadÄ±, bu normal (tÃ¼m konuÅŸmalarÄ± gÃ¶ster)
                            return res.json().then(data => {
                                console.log('âš ï¸ Lead ID bulunamadÄ± (normal - tÃ¼m konuÅŸmalar gÃ¶sterilecek):', data.message || 'Lead ID yok');
                                // Lead ID yoksa da devam et, tÃ¼m konuÅŸmalarÄ± gÃ¶ster
                                return null;
                            });
                        }
                        return res.json();
                    })
                    .then(lead => {
                        if (lead && lead.id && lead.id !== 'null' && lead.id !== 'undefined' && lead.id !== null) {
                            console.log('âœ…âœ…âœ… Backend\'den lead ID alÄ±ndÄ± (referrer/widgetUrl):', lead.id);
                            // Backend'den gelen lead ID ile tekrar Ã§aÄŸÄ±r
                            leadId = lead.id;
                            // Fetch lead data with the ID we got from backend
                            fetchLeadData(leadId);
                        } else {
                            // Lead ID yok - bu normal, tÃ¼m konuÅŸmalarÄ± gÃ¶ster
                            console.log('âš ï¸ Lead ID bulunamadÄ±, tÃ¼m konuÅŸmalar gÃ¶sterilecek (normal durum)');
                            // Lead ID olmadan da devam et
                        }
                    })
                    .catch(err => {
                        console.error('âŒ Backend isteÄŸi hatasÄ±:', err);
                        // Son Ã§are: TÃ¼m konuÅŸmalarÄ± gÃ¶ster (filtreleme olmadan)
                        console.log('âš ï¸ Backend hatasÄ±, tÃ¼m konuÅŸmalar gÃ¶sterilecek');
                    });
                return; // Ä°lk Ã§aÄŸrÄ±da bekle, backend'den gelecek
            }
            
            // Lead ID bulundu, veriyi Ã§ek
            fetchLeadData(leadId);
        }
        
        // Lead verilerini Ã§eken ayrÄ± fonksiyon
        function fetchLeadData(leadId) {
            if (!leadId) {
                console.error('âŒ fetchLeadData: leadId gerekli');
                return;
            }
            
            console.log('âœ…âœ…âœ… Final Lead ID:', leadId);
            
            // Get lead info from backend (Zoho access token already configured)
            // Relative path kullan - widget nerede Ã§alÄ±ÅŸÄ±yorsa oradan istek at
            const apiUrl = `/api/zoho/lead-info?id=` + encodeURIComponent(leadId);
            console.log('ğŸ“¡ğŸ“¡ğŸ“¡ FETCHING FROM BACKEND:', apiUrl);
            
            return fetch(apiUrl)
                .then(res => {
                    console.log('ğŸ“¡ğŸ“¡ğŸ“¡ BACKEND RESPONSE STATUS:', res.status, res.statusText);
                    if (!res.ok) {
                        console.error('âŒâŒâŒ Backend error:', res.status, res.statusText);
                        return res.text().then(text => {
                            console.error('   Error body:', text);
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        });
                    }
                    return res.json();
                })
                .then(lead => {
                    console.log('ğŸ“¥ğŸ“¥ğŸ“¥ BACKEND RESPONSE (FULL):', JSON.stringify(lead, null, 2));
                    console.log('ğŸ“¥ Backend response keys:', Object.keys(lead || {}));
                    console.log('ğŸ“¥ Phone fields:', {
                        'Phone': lead?.Phone,
                        'Mobile': lead?.Mobile,
                        'phone': lead?.phone,
                        'mobile': lead?.mobile
                    });
                    
                    // Get lead name (Ã¶ncelik: Full_Name > First_Name + Last_Name > Last_Name)
                    const leadName = lead?.Full_Name || 
                                   lead?.full_name ||
                                   (lead?.First_Name && lead?.Last_Name ? `${lead.First_Name} ${lead.Last_Name}`.trim() : '') ||
                                   lead?.Last_Name ||
                                   lead?.last_name ||
                                   lead?.First_Name ||
                                   lead?.first_name ||
                                   lead?.name ||
                                   '';
                    
                    // Get lead phone - PHONE IS PRIORITY FOR FILTERING
                    const leadPhone = lead?.Phone || lead?.Mobile || lead?.phone || lead?.mobile || '';
                    
                    // Get lead email
                    const leadEmail = lead?.Email || lead?.email || '';
                    
                    console.log('ğŸ“‹ğŸ“‹ğŸ“‹ EXTRACTED LEAD DATA:');
                    console.log('   Full_Name:', leadName);
                    console.log('   Phone:', leadPhone);
                    console.log('   Email:', leadEmail);
                    
                    // âœ… KRÄ°TÄ°K: Full_Name yoksa hata ver, phone kontrolÃ¼ yok (sadece Full_Name Ã¶nemli)
                    if (!leadName || leadName.trim() === '') {
                        console.warn('âš ï¸ Lead Full_Name bulunamadÄ±, tÃ¼m konuÅŸmalar gÃ¶sterilecek');
                        // Full_Name yoksa da devam et, sadece filtreleme yapÄ±lmayacak
                    }
                    
                    // Set global variables - FULL_NAME Ã–NCELÄ°KLÄ°
                    window.leadId = leadId;
                    window.leadName = leadName || ''; // âœ… FULL_NAME - FÄ°LTRELEME Ä°Ã‡Ä°N KULLANILACAK
                    window.leadPhone = leadPhone || '';
                    window.leadEmail = leadEmail || '';

                    // âœ… Lead deÄŸiÅŸtiÄŸinde tÃ¼m sender state'lerini sÄ±fÄ±rla (showAll/filteredConversations)
                    if (window.conversationsState) {
                        window.conversationsState.showAll = false;
                        window.conversationsState.filteredConversations = [];
                    }
                    if (window.conversationsStateBySender && typeof window.conversationsStateBySender === 'object') {
                        Object.keys(window.conversationsStateBySender).forEach(senderKey => {
                            const senderState = window.conversationsStateBySender[senderKey];
                            if (senderState && typeof senderState === 'object') {
                                senderState.showAll = false;
                                senderState.filteredConversations = [];
                            }
                        });
                    }
                    
                    console.log('âœ…âœ…âœ…âœ…âœ… Global variables SET:');
                    console.log('   window.leadId:', window.leadId);
                    console.log('   window.leadName:', window.leadName);
                    console.log('   window.leadPhone:', window.leadPhone);
                    console.log('   window.leadEmail:', window.leadEmail);
                    
                    // Trigger event for app.js - FULL_NAME Ã–NCELÄ°KLÄ°
                    window.dispatchEvent(new CustomEvent("zohoLeadDataLoaded", { 
                        detail: { 
                            id: window.leadId,
                            Full_Name: window.leadName, // âœ… FULL_NAME - FÄ°LTRELEME Ä°Ã‡Ä°N (Ã–NCELÄ°KLÄ°)
                            name: window.leadName, // âœ… Eski uyumluluk iÃ§in
                            phone: window.leadPhone,
                            email: window.leadEmail
                        } 
                    }));
                    
                    // Also trigger loadConversations if available
                    setTimeout(() => {
                        if (typeof loadConversations === "function") {
                            console.log("ğŸ”„ loadConversations triggered (lead phone loaded)");
                            loadConversations(false);
                        }
                    }, 300);
                })
                .catch(err => {
                    console.error('âŒ Error fetching lead:', err);
                    console.error('   Lead ID:', leadId);
                    console.error('   Referrer:', document.referrer);
                });
        }
        
        // Dinamik lead takibi - URL deÄŸiÅŸikliklerini izle
        let lastLeadId = null;
        
        function checkLeadChange() {
            let currentLeadId = null;
            
            // URL parametrelerinden kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            currentLeadId = urlParams.get('leadId') || urlParams.get('id') || urlParams.get('recordId') || urlParams.get('record_id');
            
            // Parent window'dan kontrol et (iframe iÃ§inde)
            if (!currentLeadId) {
                try {
                    if (window.parent && window.parent !== window) {
                        const parentUrl = window.parent.location?.href || '';
                        const parentLeadMatch = parentUrl.match(/\/tab\/Leads\/(\d+)/) || parentUrl.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d+)/);
                        if (parentLeadMatch && parentLeadMatch[1]) {
                            currentLeadId = parentLeadMatch[1];
                        }
                    }
                } catch (e) {
                    // CORS hatasÄ± normal
                }
            }
            
            // Referrer ve window.location.href'den kontrol et (AGRESÄ°F)
            if (!currentLeadId) {
                const referrer = document.referrer || '';
                const currentUrl = window.location.href || '';
                const allUrls = [referrer, currentUrl].join(' ');
                
                // TÃ¼m pattern'leri dene
                let leadIdMatch = allUrls.match(/\/tab\/Leads\/(\d{10,})/) || 
                                 allUrls.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d{10,})/) ||
                                 allUrls.match(/\/Leads\/(\d{10,})/) ||
                                 allUrls.match(/(\d{15,})/);
                
                if (leadIdMatch && leadIdMatch[1]) {
                    currentLeadId = leadIdMatch[1];
                }
            }
            
            // Lead ID deÄŸiÅŸtiyse veya ilk yÃ¼kleme ise
            if (currentLeadId && currentLeadId !== lastLeadId) {
                console.log('ğŸ”„ğŸ”„ğŸ”„ Lead deÄŸiÅŸti! Eski:', lastLeadId, 'Yeni:', currentLeadId);
                lastLeadId = currentLeadId;
                
                // Global deÄŸiÅŸkenleri sÄ±fÄ±rla (Ã¶nemli: Ã¶nceki lead'in cache'ini temizle)
                window.leadId = null;
                window.leadPhone = null;
                window.leadName = null;
                window.leadEmail = null;
                
                // Yeni lead bilgilerini force reload ile Ã§ek
                console.log('ğŸ”„ Yeni lead bilgileri Ã§ekiliyor...');
                fetchLeadData(currentLeadId); // Direkt fetchLeadData Ã§aÄŸÄ±r (getLeadFromReferrer yerine)
            } else if (!currentLeadId && lastLeadId) {
                // Lead ID kaybolduysa (Ã¶rneÄŸin, baÅŸka bir sayfaya geÃ§ildi)
                console.log('ğŸ”„ Lead ID kayboldu. Eski:', lastLeadId);
                lastLeadId = null;
                // UI'Ä± temizle veya boÅŸ gÃ¶ster
                window.leadId = null;
                window.leadName = null;
                window.leadPhone = null;
                window.leadEmail = null;
                // Event gÃ¶nder ki app.js konuÅŸmalarÄ± temizlesin
                window.dispatchEvent(new CustomEvent("zohoLeadDataLoaded", { 
                    detail: { id: null, name: null, phone: null, email: null } 
                }));
            }
        }
        
        // âœ… Global kullanÄ±cÄ± bilgisi (tÃ¼m API isteklerinde kullanÄ±lacak)
        window.currentZohoUser = {
            email: null,
            id: null
        };
        
        // âœ… KullanÄ±cÄ± bilgisini al ve global deÄŸiÅŸkene kaydet
        async function getCurrentZohoUser() {
            if (window.currentZohoUser.email || window.currentZohoUser.id) {
                return window.currentZohoUser; // âœ… Zaten alÄ±nmÄ±ÅŸsa cache'den dÃ¶ndÃ¼r
            }
            
            try {
                if (window.ZOHO && window.ZOHO.embeddedApp && typeof window.ZOHO.embeddedApp.getCurrentUser === 'function') {
                    const userInfo = await window.ZOHO.embeddedApp.getCurrentUser();
                    if (userInfo) {
                        window.currentZohoUser.email = userInfo.email || null;
                        window.currentZohoUser.id = userInfo.id || null;
                        console.log('âœ… Zoho kullanÄ±cÄ± bilgisi alÄ±ndÄ± ve cache\'lendi:', window.currentZohoUser);
                    }
                } else {
                    console.warn('âš ï¸ ZOHO.embeddedApp.getCurrentUser fonksiyonu mevcut deÄŸil, kullanÄ±cÄ± bilgisi alÄ±namadÄ±');
                }
            } catch (zohoError) {
                console.warn('âš ï¸ Zoho kullanÄ±cÄ± bilgisi alÄ±namadÄ±:', zohoError.message);
            }
            
            return window.currentZohoUser;
        }
        
        // âœ… API isteklerine userEmail parametresi ekle (helper function)
        function addUserParamsToUrl(url) {
            const user = window.currentZohoUser;
            if (!user.email && !user.id) {
                return url; // âœ… KullanÄ±cÄ± bilgisi yoksa deÄŸiÅŸtirme
            }
            
            const separator = url.includes('?') ? '&' : '?';
            if (user.email) {
                url += `${separator}userEmail=${encodeURIComponent(user.email)}`;
                if (user.id) {
                    url += `&userId=${encodeURIComponent(user.id)}`;
                }
            } else if (user.id) {
                url += `${separator}userId=${encodeURIComponent(user.id)}`;
            }
            
            return url;
        }
        
        // âœ… KullanÄ±cÄ± yetkilerini yÃ¼kle ve sender dropdown'Ä±nÄ± filtrele
        async function loadUserPermissionsAndFilterSenders() {
            try {
                // âœ… Ã–nce kullanÄ±cÄ± bilgisini al
                await getCurrentZohoUser();
                const userEmail = window.currentZohoUser.email;
                const userId = window.currentZohoUser.id;
                
                // Backend'den kullanÄ±cÄ±nÄ±n gÃ¶rebileceÄŸi sender'larÄ± al
                const permissionsUrl = `/api/zoho/user-permissions${userEmail ? '?userEmail=' + encodeURIComponent(userEmail) : ''}${userId ? (userEmail ? '&' : '?') + 'userId=' + encodeURIComponent(userId) : ''}`;
                const permissionsResponse = await fetch(permissionsUrl);
                const permissionsData = await permissionsResponse.json();
                
                if (permissionsData.success && permissionsData.allowedSenders) {
                    const allowedSenders = permissionsData.allowedSenders;
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    
                    if (channelFilterTop) {
                        // TÃ¼m sender'larÄ± tanÄ±mla
                        const allSenders = [
                            { value: '908505327532', label: 'VIP-+908505327532' },
                            { value: '905421363421', label: 'Hamzah Coexistence-+905421363421' }
                        ];
                        
                        // Dropdown'Ä± temizle
                        channelFilterTop.innerHTML = '<option value="">Choose Sender</option>';
                        
                        // Yetkili sender'larÄ± ekle
                        allSenders.forEach(sender => {
                            // '*' = TÃ¼m sender'larÄ± gÃ¶rebilir
                            if (allowedSenders.includes('*') || allowedSenders.includes(sender.value)) {
                                const option = document.createElement('option');
                                option.value = sender.value;
                                option.textContent = sender.label;
                                channelFilterTop.appendChild(option);
                            }
                        });
                        
                        console.log('âœ… Sender dropdown filtrelendi:', { 
                            allowedSenders, 
                            visibleSenders: Array.from(channelFilterTop.options).map(opt => opt.value) 
                        });
                    }
                }
            } catch (error) {
                console.error('âŒ KullanÄ±cÄ± yetkileri yÃ¼klenemedi:', error);
                // Hata durumunda tÃ¼m sender'larÄ± gÃ¶ster (gÃ¼venlik iÃ§in deÄŸiÅŸtirilebilir)
            }
        }
        
        // Ä°lk yÃ¼kleme
        initZohoEmbeddedApp(); // PageLoad event ile recordId yakalamayÄ± dene
        getLeadFromReferrer();
        loadUserPermissionsAndFilterSenders(); // âœ… KullanÄ±cÄ± yetkilerini yÃ¼kle
        setTimeout(getLeadFromReferrer, 300);
        setTimeout(getLeadFromReferrer, 600);
        setTimeout(getLeadFromReferrer, 1000);
        setTimeout(getLeadFromReferrer, 2000);
        
        // Her 1 saniyede bir lead deÄŸiÅŸikliÄŸini kontrol et (daha agresif)
        setInterval(checkLeadChange, 1000);
        
        // URL deÄŸiÅŸikliklerini de dinle (hashchange, popstate)
        window.addEventListener('hashchange', checkLeadChange);
        window.addEventListener('popstate', checkLeadChange);
        
        // MutationObserver ile URL deÄŸiÅŸikliklerini izle (iframe iÃ§inde)
        if (window.parent !== window) {
            try {
                const observer = new MutationObserver(() => {
                    checkLeadChange();
                });
                observer.observe(document.body, { childList: true, subtree: true });
            } catch (e) {
                console.log('âš ï¸ MutationObserver hatasÄ±:', e);
            }
        }
    </script>

    <!-- âœ… ACÄ°L Ã‡Ã–ZÃœM: Direkt baÄŸlantÄ± fonksiyonu - app.js'den baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±r -->
    <script>
        // âœ… DÄ°REKT BAÄLANTI FONKSÄ°YONU - app.js'den baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±r
        window.connectSleekflowDirect = async function(silent = false) {
            // âœ… KRÄ°TÄ°K: conversationsState'i kontrol et ve yoksa initialize et
            if (!window.conversationsState) {
                window.conversationsState = {
                    allConversations: [],
                    filteredConversations: [],
                    showAll: false,
                    currentConversationId: null,
                    lastMessageCounts: {},
                    unreadCounts: {},
                    allMessages: {}, // âœ… TÃ¼m mesajlar (WhatsApp + Instagram)
                    showAllMessages: {} // âœ… Mesajlar iÃ§in: { conversationId: true/false }
                };
            }
            
            // âœ… KRÄ°TÄ°K: unreadCounts yoksa initialize et
            if (!window.conversationsState.unreadCounts) {
                window.conversationsState.unreadCounts = {};
            }
            
            // API key ve base URL'i al
            const apiKeyInput = document.getElementById('sleekflowApiKey');
            const baseUrlSelect = document.getElementById('sleekflowBaseUrl');
            
            let apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
            let baseUrl = baseUrlSelect ? baseUrlSelect.value.trim() : 'https://sleekflow-core-app-weu-production.azurewebsites.net';
            
            // EÄŸer input boÅŸsa, localStorage'dan al
            if (!apiKey) {
                apiKey = localStorage.getItem('sleekflowApiKey') || '';
            }
            if (!baseUrl) {
                baseUrl = localStorage.getItem('sleekflowBaseUrl') || 'https://sleekflow-core-app-weu-production.azurewebsites.net';
            }
            
            if (!apiKey || apiKey.length < 10) {
                if (!silent) {
                alert('âŒ API anahtarÄ± gerekli! LÃ¼tfen API anahtarÄ±nÄ± girin.');
                }
                return;
            }
            
            // Loading gÃ¶ster
            const btn = document.getElementById('connectSleekflow');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'â³ BaÄŸlanÄ±yor...';
            }
            
            try {
                // âœ… PERFORMANS OPTÄ°MÄ°ZASYONU: BaÄŸlantÄ± testini atla, direkt konuÅŸmalarÄ± Ã§ek
                // API key geÃ§ersizse zaten hata dÃ¶ner
                const API_BASE_URL = '/api';
                
                // localStorage'a hemen kaydet (baÅŸarÄ±lÄ± olursa zaten kayÄ±tlÄ± olacak)
                localStorage.setItem('sleekflowApiKey', apiKey);
                localStorage.setItem('sleekflowBaseUrl', baseUrl);
                
                // Sidebar'Ä± hemen kapat (kullanÄ±cÄ± deneyimi iÃ§in)
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.remove('open');
                    sidebar.style.setProperty('left', '-320px', 'important');
                    sidebar.style.setProperty('opacity', '0', 'important');
                    sidebar.style.setProperty('visibility', 'hidden', 'important');
                    sidebar.style.setProperty('display', 'none', 'important');
                }
                
                // âœ… PERFORMANS: API key'i query parametresi olarak gÃ¶nder
                // âœ… KRITIK: baseUrl undefined/null kontrolÃ¼
                const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                
                // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in)
                await getCurrentZohoUser();
                
                // âœ… KRITIK: SeÃ§ili sender'Ä± fromPhone olarak gÃ¶nder (backend'de filtreleme iÃ§in)
                const channelFilterTop = document.getElementById('channelFilterTop');
                const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                
                let conversationsUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                conversationsUrl = addUserParamsToUrl(conversationsUrl);
                
                const convResponse = await fetch(conversationsUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!convResponse.ok) {
                    const errorData = await convResponse.json().catch(() => ({ error: 'KonuÅŸmalar yÃ¼klenemedi' }));
                    const error = new Error(errorData.error || 'KonuÅŸmalar yÃ¼klenemedi');
                    if (!silent) {
                        throw error;
                    }
                    return;
                }
                
                const convData = await convResponse.json();
                const conversations = convData.conversations || [];
                
                // âœ… KRITIK: API'den gelen unreadCount deÄŸerlerini state'e kaydet
                // AMA: Ã–nceden okunan conversation'lar iÃ§in unreadCount'u 0 yap (sayfa yenilendiÄŸinde badge tekrar gelmesin)
                conversations.forEach(conv => {
                    const convId = conv.conversationId || conv.id;
                    if (convId) {
                        // EÄŸer bu conversation Ã¶nceden okunmuÅŸsa, unreadCount'u 0 yap
                        if (readConversations.has(convId)) {
                            window.conversationsState.unreadCounts[convId] = 0;
                            conv.unreadCount = 0; // Conversation objesini de gÃ¼ncelle
                        } else if (conv.unreadCount && conv.unreadCount > 0) {
                            if (!window.conversationsState.unreadCounts[convId]) {
                                window.conversationsState.unreadCounts[convId] = 0;
                            }
                            // API'den gelen unreadCount'u kullan (SleekFlow'un kendi sayÄ±sÄ±)
                            window.conversationsState.unreadCounts[convId] = conv.unreadCount;
                        }
                    }
                });
                
                // âœ… BAÅARILI - localStorage'a kaydet
                localStorage.setItem('sleekflowConnected', 'true');
                
                // âœ… KRÄ°TÄ°K: showAll state'ini koru
                const showAll = window.conversationsState.showAll || false;
                renderConversationsDirectly(conversations, showAll);
                
                // âœ… Kanal filtreleme event listener'Ä±nÄ± kur
                setupChannelFilter();
                
                // âœ… Polling baÅŸlat - Yeni mesajlarÄ± otomatik kontrol et
                if (typeof startMessagePolling === 'function') {
                    startMessagePolling();
                }
                
                // âœ… Ä°LK YÃœKLEMEDE: Her konuÅŸmanÄ±n mesaj sayÄ±sÄ±nÄ± kaydet (baseline oluÅŸtur) - ARKA PLANDA
                // KullanÄ±cÄ±yÄ± bekletmeden paralel olarak Ã§ek
                setTimeout(async () => {
                    const baselinePromises = conversations.map(async (conv) => {
                        const convId = conv.conversationId || conv.id;
                        if (!convId) return;
                        
                        try {
                            const msgResponse = await fetch(`/api/sleekflow/conversations/${convId}/messages`, {
                                method: 'GET',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const msgData = await msgResponse.json();
                            const msgCount = (msgData.messages || []).length;
                            lastMessageCount[convId] = msgCount;
                            // Ä°lk yÃ¼klemede unread count sÄ±fÄ±r (henÃ¼z yeni mesaj yok)
                            if (!window.conversationsState.unreadCounts[convId]) {
                                window.conversationsState.unreadCounts[convId] = 0;
                            }
                        } catch (err) {
                            // Sessizce geÃ§
                            lastMessageCount[convId] = 0;
                        }
                    });
                    
                    await Promise.all(baselinePromises);
                    console.log('âœ… Baseline mesaj sayÄ±larÄ± kaydedildi');
                }, 1000); // 1 saniye sonra baÅŸlat (UI'Ä±n yÃ¼klenmesini bekle)
                
                // Event dispatch et (app.js dinliyorsa)
                window.dispatchEvent(new CustomEvent('sleekflowConnected', { 
                    detail: { conversations: conversations } 
                }));
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”— SleekFlow\'a BaÄŸlan';
                }
                
            } catch (error) {
                console.error('âŒ BaÄŸlantÄ± hatasÄ±:', error);
                if (!silent) {
                alert('âŒ BaÄŸlantÄ± hatasÄ±: ' + error.message);
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”— SleekFlow\'a BaÄŸlan';
                }
            }
        };
        
        // âœ… BUTON EVENT LISTENER'INI HEMEN KUR
        function setupConnectButton() {
            const btn = document.getElementById('connectSleekflow');
            if (btn) {
                btn.onclick = function() {
                    // Ã–nce direkt fonksiyonu dene
                    if (typeof window.connectSleekflowDirect === 'function') {
                        window.connectSleekflowDirect();
                    } else if (typeof window.connectSleekflow === 'function') {
                        window.connectSleekflow();
                    } else {
                        alert('âŒ BaÄŸlantÄ± fonksiyonu bulunamadÄ±! Sayfa yenileniyor...');
                        window.location.reload();
                    }
                };
            }
        }
        
        // âœ… HEMEN DENE
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupConnectButton);
        } else {
            setupConnectButton();
        }
        
        // âœ… EK GÃœVENLÄ°K: Tekrar dene
        setTimeout(setupConnectButton, 500);
        setTimeout(setupConnectButton, 1000);
        
        // âœ… OTOMATÄ°K BAÄLANTI - Sayfa yÃ¼klendiÄŸinde localStorage'dan API key'i kontrol et ve otomatik baÄŸlan
        async function autoConnectSleekflow() {
            try {
                const savedApiKey = localStorage.getItem('sleekflowApiKey');
                const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || 'https://sleekflow-core-app-weu-production.azurewebsites.net';
                const savedConnected = localStorage.getItem('sleekflowConnected');
                
                // EÄŸer API key varsa ve daha Ã¶nce baÄŸlanmÄ±ÅŸsa otomatik baÄŸlan
                if (savedApiKey && savedApiKey.trim().length >= 10 && savedConnected === 'true') {
                    // Sidebar'Ä± kapat
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('open');
                        sidebar.style.setProperty('left', '-320px', 'important');
                        sidebar.style.setProperty('opacity', '0', 'important');
                        sidebar.style.setProperty('visibility', 'hidden', 'important');
                        sidebar.style.setProperty('display', 'none', 'important');
                    }
                    
                    // Otomatik baÄŸlan (sessizce, alert gÃ¶sterme)
                    if (typeof window.connectSleekflowDirect === 'function') {
                        await window.connectSleekflowDirect(true); // true = silent mode
                        // Polling baÅŸlat
                        if (typeof startMessagePolling === 'function') {
                            startMessagePolling();
                        }
                    }
                }
            } catch (error) {
                // Hata olursa sessizce geÃ§, kullanÄ±cÄ± manuel baÄŸlanabilir
                console.log('Auto-connect hatasÄ± (normal):', error);
            }
        }
        
        // Sayfa yÃ¼klendiÄŸinde otomatik baÄŸlan
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(autoConnectSleekflow, 500);
            });
        } else {
            setTimeout(autoConnectSleekflow, 500);
        }
    </script>
    
    <!-- Frontend Utilities (matchNames, normalizeName vb.) -->
    <script src="/utils/frontendUtils.js"></script>
    
    <!-- âœ… KRÄ°TÄ°K: Direkt render fonksiyonu - app.js yÃ¼klenmeden Ã¶nce Ã§alÄ±ÅŸÄ±r -->
    <script>
        // âœ… Name normalization fonksiyonu (frontendUtils yÃ¼klenmemiÅŸse)
        function normalizeName(name) {
            if (!name) return '';
            return String(name)
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/Ä±/g, 'i')
                .replace(/ÄŸ/g, 'g')
                .replace(/Ã¼/g, 'u')
                .replace(/ÅŸ/g, 's')
                .replace(/Ã¶/g, 'o')
                .replace(/Ã§/g, 'c')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // âœ… Ä°sim eÅŸleÅŸtirme fonksiyonu
        function matchNames(leadName, conversationName) {
            if (!leadName || !conversationName) return false;
            const normalizedLead = normalizeName(leadName);
            const normalizedConv = normalizeName(conversationName);
            
            if (normalizedLead === normalizedConv) return true;
            if (normalizedConv.includes(normalizedLead) && normalizedLead.length >= 3) return true;
            
            const leadWords = normalizedLead.split(' ').filter(w => w.length >= 2);
            const convWords = normalizedConv.split(' ').filter(w => w.length >= 2);
            
            if (leadWords.length > 0 && convWords.length > 0) {
                const matchingWords = leadWords.filter(leadWord =>
                    convWords.some(convWord => convWord === leadWord)
                );
                if (matchingWords.length === leadWords.length) {
                    if (leadWords.length >= 2 || (leadWords.length === 1 && leadWords[0].length >= 3)) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // âœ… Global state - Sender'a gÃ¶re ayrÄ± state tut
        window.conversationsStateBySender = window.conversationsStateBySender || {};
        
        // âœ… Helper: Mevcut sender'Ä±n state'ini al veya oluÅŸtur
        function getCurrentSenderState() {
            const channelFilterTop = document.getElementById('channelFilterTop');
            const selectedSender = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : 'default';
            
            if (!window.conversationsStateBySender[selectedSender]) {
                window.conversationsStateBySender[selectedSender] = {
                    allConversations: [],
                    filteredConversations: [],
                    showAll: false,
                    currentConversationId: null,
                    lastMessageCounts: {},
                    showAllMessages: {}, // âœ… Mesajlar iÃ§in: { conversationId: true/false }
                    unreadCounts: {},
                    loadedMessages: {},
                    bypassCacheFor: {}
                };
            }
            
            // âœ… Global state'i de gÃ¼ncelle (geriye dÃ¶nÃ¼k uyumluluk iÃ§in)
            window.conversationsState = window.conversationsStateBySender[selectedSender];
            
            return window.conversationsStateBySender[selectedSender];
        }
        
        // âœ… Global state (geriye dÃ¶nÃ¼k uyumluluk iÃ§in)
        window.conversationsState = {
            allConversations: [],
            filteredConversations: [],
            showAll: false,
            currentConversationId: null,
            lastMessageCounts: {},
            unreadCounts: {},
            loadedMessages: {},
            bypassCacheFor: {}
        };
        
        // âœ… Polling mekanizmasÄ± - Yeni mesajlarÄ± otomatik kontrol et (SADECE YENÄ° MESAJLARI EKLE)
        let messagePollInterval = null;
        // âœ… lastMessageCount'u localStorage'dan yÃ¼kle (sayfa yenilendiÄŸinde korunur)
        let lastMessageCount = {};
        try {
            const saved = localStorage.getItem('sleekflowLastMessageCounts');
            if (saved) {
                lastMessageCount = JSON.parse(saved);
            }
        } catch (e) {
            console.warn('lastMessageCount yÃ¼klenemedi:', e);
        }
        
        // âœ… Okunan conversation'larÄ± localStorage'dan yÃ¼kle (sayfa yenilendiÄŸinde korunur)
        let readConversations = new Set();
        try {
            const savedRead = localStorage.getItem('sleekflowReadConversations');
            if (savedRead) {
                readConversations = new Set(JSON.parse(savedRead));
            }
        } catch (e) {
            console.warn('readConversations yÃ¼klenemedi:', e);
        }
        
        // âœ… lastMessageCount'u localStorage'a kaydetme fonksiyonu
        function saveLastMessageCounts() {
            try {
                localStorage.setItem('sleekflowLastMessageCounts', JSON.stringify(lastMessageCount));
            } catch (e) {
                console.warn('lastMessageCount kaydedilemedi:', e);
            }
        }
        
        // âœ… Okunan conversation'larÄ± localStorage'a kaydetme fonksiyonu
        function saveReadConversations() {
            try {
                localStorage.setItem('sleekflowReadConversations', JSON.stringify(Array.from(readConversations)));
            } catch (e) {
                console.warn('readConversations kaydedilemedi:', e);
            }
        }
        
        function startMessagePolling() {
            // EÄŸer zaten polling varsa durdur
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
            }
            
            // âœ… PERFORMANS: Polling interval'Ä±nÄ± artÄ±r ve paralel istek sayÄ±sÄ±nÄ± sÄ±nÄ±rla
            let fastPollCount = 0;
            let isPolling = false; // Ã‡akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in flag
            // âœ… Aktif conversation iÃ§in daha hÄ±zlÄ± polling (1 saniye)
            messagePollInterval = setInterval(async () => {
                // âœ… Ã‡akÄ±ÅŸma kontrolÃ¼ - EÄŸer Ã¶nceki polling hala devam ediyorsa bekle
                if (isPolling) {
                    return;
                }
                
                const currentConvId = window.conversationsState.currentConversationId;
                const allConversations = window.conversationsState.allConversations || [];
                let needsUpdate = false;
                
                isPolling = true;
                
                try {
                    // âœ… Ã–NCE AKTÄ°F CONVERSATION'Ä± kontrol et (her 3 saniyede) - SADECE SON MESAJLARI
                    if (currentConvId) {
                        try {
                            // âœ… API key'i al (polling iÃ§in)
                            const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                            const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                            const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                            
                            // âœ… ULTRA HIZLI: Sadece son 1 mesajÄ± kontrol et (yeni mesaj var mÄ± diye) - DAHA HIZLI
                            const url = `/api/sleekflow/conversations/${currentConvId}/messages?limit=1&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            const response = await fetch(url, {
                                method: 'GET',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const data = await response.json();
                            const messages = data.messages || [];
                            
                            // âœ… ULTRA HIZLI: Sadece en son mesajÄ±n ID'sini kontrol et (limit=1 olduÄŸu iÃ§in messages[0])
                            const latestMsgId = messages.length > 0 ? (messages[0].id || messages[0].timestamp || messages[0].messageUniqueID) : null;
                            const prevLatestMsgId = lastMessageCount[currentConvId + '_latest'] || null;
                            
                            if (latestMsgId && latestMsgId !== prevLatestMsgId) {
                                console.log('ğŸ†• Yeni mesaj tespit edildi!', { currentConvId, latestMsgId, prevLatestMsgId });
                                // âœ… Yeni mesaj var - Ama Ã¶nce mesajÄ±n direction'Ä±nÄ± kontrol et (limit=1 olduÄŸu iÃ§in messages[0])
                                const latestMsg = messages[0];
                                const isSent = latestMsg.direction === 'sent' || 
                                              latestMsg.isSentFromSleekflow === true ||
                                              latestMsg.isSentFromSleekflow === 'true' ||
                                              latestMsg.direction === 'outgoing';
                                
                                // âœ… Sadece karÅŸÄ±dan gelen mesajlar iÃ§in badge artÄ±r (aktif conversation'da bile)
                                const isReceived = !isSent && (
                                    latestMsg.direction === 'received' || 
                                    latestMsg.direction === 'incoming' ||
                                    (latestMsg.direction !== 'sent' && latestMsg.isSentFromSleekflow !== true && latestMsg.isSentFromSleekflow !== 'true')
                                );
                                
                                if (isReceived) {
                                    // Yeni mesaj var - TÃœM mesajlarÄ± yeniden yÃ¼kle
                                    const fullResponse = await fetch(`/api/sleekflow/conversations/${currentConvId}/messages?limit=50&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    });
                                const fullData = await fullResponse.json();
                                let allMessages = fullData.messages || [];
                                
                                // âœ… EN ESKÄ° EN ÃœSTTE, EN YENÄ° EN ALTTA sÄ±rala (normal chat gibi)
                                allMessages.sort((a, b) => {
                                    const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                    const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                    return timeA - timeB; // âœ… En eski en Ã¼stte, en yeni en altta
                                });
                                
                                let conversation = null;
                                if (window.conversationsState && window.conversationsState.allConversations) {
                                    conversation = window.conversationsState.allConversations.find(c => 
                                        (c.conversationId || c.id) === currentConvId
                                    );
                                }
                                // âœ… KRITIK: Cache'i gÃ¼ncelle (yeni mesajlar gÃ¶rÃ¼nsÃ¼n)
                                if (!window.conversationsState.loadedMessages) {
                                    window.conversationsState.loadedMessages = {};
                                }
                                window.conversationsState.loadedMessages[currentConvId] = allMessages;
                                
                                console.log('âœ… Yeni mesajlar render ediliyor:', { currentConvId, messageCount: allMessages.length });
                                renderMessagesDirectly(allMessages, currentConvId, conversation);
                                    lastMessageCount[currentConvId] = allMessages.length;
                                    lastMessageCount[currentConvId + '_latest'] = latestMsgId;
                                    saveLastMessageCounts();
                                    window.conversationsState.unreadCounts[currentConvId] = 0;
                                    
                                    // âœ… KRITIK: Mesajlar render edildikten sonra scroll yap (yeni mesaj gÃ¶rÃ¼nsÃ¼n)
                                    setTimeout(() => {
                                        const messagesArea = document.getElementById('messagesArea');
                                        const messagesList = document.getElementById('messagesList');
                                        const scrollContainer = messagesArea || messagesList;
                                        if (scrollContainer) {
                                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                        }
                                    }, 50);
                                    // âœ… Ekstra scroll (DOM gÃ¼ncellenmesi iÃ§in)
                                    setTimeout(() => {
                                        const messagesArea = document.getElementById('messagesArea');
                                        const messagesList = document.getElementById('messagesList');
                                        const scrollContainer = messagesArea || messagesList;
                                        if (scrollContainer) {
                                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                        }
                                    }, 200);
                                } else {
                                    // âœ… Bizim gÃ¶nderdiÄŸimiz mesaj - Sadece ID'yi gÃ¼ncelle, badge artÄ±rma
                                    lastMessageCount[currentConvId + '_latest'] = latestMsgId;
                                    saveLastMessageCounts();
                                }
                            } else if (!prevLatestMsgId && latestMsgId) {
                                // Ä°lk yÃ¼kleme
                                lastMessageCount[currentConvId + '_latest'] = latestMsgId;
                                saveLastMessageCounts();
                            }
                        } catch (error) {
                            // Sessizce geÃ§
                        }
                    }
                    
                    // âœ… DÄ°ÄER KONUÅMALAR Ä°Ã‡Ä°N: Her 5 polling'de bir kontrol et (performans iÃ§in)
                    fastPollCount++;
                    if (fastPollCount >= 5) {
                        fastPollCount = 0;
                        
                        // âœ… PERFORMANS: Sadece ilk 20 konuÅŸmayÄ± kontrol et (en son mesajlaÅŸanlar)
                        const otherConversations = allConversations
                            .filter(conv => {
                                const convId = conv.conversationId || conv.id;
                                return convId && convId !== currentConvId;
                            })
                            .slice(0, 20); // âœ… Sadece ilk 20 konuÅŸma
                        
                        // âœ… PERFORMANS: Paralel istek sayÄ±sÄ±nÄ± sÄ±nÄ±rla (batch processing)
                        const BATCH_SIZE = 5; // AynÄ± anda en fazla 5 istek
                        for (let i = 0; i < otherConversations.length; i += BATCH_SIZE) {
                            const batch = otherConversations.slice(i, i + BATCH_SIZE);
                            
                            const checkPromises = batch.map(async (conv) => {
                                const convId = conv.conversationId || conv.id;
                                if (!convId) return false;
                                
                                try {
                                    // âœ… API key'i al (polling iÃ§in)
                                    const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                                    const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                                    const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                                    
                                    // âœ… ULTRA HIZLI: Sadece son 1 mesajÄ± kontrol et (Ã§ok hÄ±zlÄ±)
                                    const url = `/api/sleekflow/conversations/${convId}/messages?limit=1&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                    const response = await fetch(url, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    });
                                    const data = await response.json();
                                    const messages = data.messages || [];
                                    
                                    if (messages.length === 0) return false;
                                    
                                    const latestMsgId = messages[0].id || messages[0].timestamp;
                                    const prevLatestMsgId = lastMessageCount[convId + '_latest'];
                                    
                                    if (latestMsgId && latestMsgId !== prevLatestMsgId) {
                                        // âœ… Yeni mesaj var - SADECE KARÅIDAN GELEN (received) MESAJLAR Ä°Ã‡Ä°N BADGE ARTIR
                                        const latestMsg = messages[0];
                                        
                                        // âœ… GÃœÃ‡LÃœ KONTROL: Sadece gerÃ§ekten karÅŸÄ±dan gelen mesajlar iÃ§in badge artÄ±r
                                        // EÄŸer direction === 'sent' veya isSentFromSleekflow === true ise â†’ bizim gÃ¶nderdiÄŸimiz
                                        const isSent = latestMsg.direction === 'sent' || 
                                                      latestMsg.isSentFromSleekflow === true ||
                                                      latestMsg.isSentFromSleekflow === 'true' ||
                                                      latestMsg.direction === 'outgoing';
                                        
                                        // âœ… GEVÅETÄ°LMÄ°Å KONTROL: direction !== 'sent' ve isSentFromSleekflow !== true ise received kabul et
                                        const isReceived = !isSent && (
                                            latestMsg.direction === 'received' || 
                                            latestMsg.direction === 'incoming' ||
                                            (latestMsg.direction !== 'sent' && latestMsg.isSentFromSleekflow !== true && latestMsg.isSentFromSleekflow !== 'true')
                                        );
                                        
                                        if (isReceived) {
                                            // Sadece karÅŸÄ±dan gelen mesajlar iÃ§in badge artÄ±r
                                            if (!window.conversationsState.unreadCounts[convId]) {
                                                window.conversationsState.unreadCounts[convId] = 0;
                                            }
                                            window.conversationsState.unreadCounts[convId] += 1;
                                            lastMessageCount[convId + '_latest'] = latestMsgId;
                                            saveLastMessageCounts();
                                            needsUpdate = true;
                                            console.log('âœ… Badge artÄ±rÄ±ldÄ±:', { convId, unreadCount: window.conversationsState.unreadCounts[convId], latestMsg: { direction: latestMsg.direction, isSentFromSleekflow: latestMsg.isSentFromSleekflow } });
                                            return true;
                                        } else {
                                            // Bizim gÃ¶nderdiÄŸimiz mesaj veya belirsiz - badge artÄ±rma, sadece ID'yi gÃ¼ncelle
                                            lastMessageCount[convId + '_latest'] = latestMsgId;
                                            saveLastMessageCounts();
                                            return false;
                                        }
                                    }
                                    
                                    // Ä°lk kontrol
                                    if (!prevLatestMsgId && latestMsgId) {
                                        lastMessageCount[convId + '_latest'] = latestMsgId;
                                        saveLastMessageCounts();
                                    }
                                    
                                    return false;
                                } catch (error) {
                                    return false;
                                }
                            });
                            
                            await Promise.all(checkPromises);
                            
                            // âœ… Batch'ler arasÄ±nda kÄ±sa bir bekleme (rate limiting)
                            if (i + BATCH_SIZE < otherConversations.length) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                        }
                    }
                    
                    // âœ… OkunmamÄ±ÅŸ mesaj varsa konuÅŸma listesini dinamik olarak gÃ¼ncelle
                    if (needsUpdate) {
                        const showAll = window.conversationsState.showAll || false;
                        renderConversationsDirectly(allConversations, showAll);
                    }
                } finally {
                    isPolling = false;
                }
            }, 500); // âœ… 500ms - KARÅI TARAF MESAJ ATTIÄINDA HEMEN GÃ–RÃœNSÃœN
        }
        
        function stopMessagePolling() {
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
                messagePollInterval = null;
            }
            lastMessageCount = {};
        }
        
        // âœ… Mesaj gÃ¶nderme fonksiyonu
        async function sendMessageDirectly() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            const messagesList = document.getElementById('messagesList');
            const conversationId = window.conversationsState.currentConversationId;
            
            if (!conversationId) {
                alert('LÃ¼tfen bir konuÅŸma seÃ§in');
                return;
            }
            
            // âœ… 24 SAAT KURALI KONTROLÃœ - Normal mesaj gÃ¶nderirken kontrol et
            const savedApiKey = localStorage.getItem('sleekflowApiKey') || '';
            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
            
            let hoursSinceLastContact = null;
            let isWhatsApp = false;
            try {
                const convDetailsResponse = await fetch(`/api/sleekflow/conversation/${conversationId}?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`);
                if (convDetailsResponse.ok) {
                    const convDetailsData = await convDetailsResponse.json();
                    const convDetails = convDetailsData.conversation;
                    if (convDetails) {
                        const channel = convDetails.lastMessageChannel || convDetails.channel || '';
                        isWhatsApp = channel && (
                            channel.toLowerCase().includes('whatsapp') ||
                            channel.toLowerCase().includes('messagebird') ||
                            channel.toLowerCase().includes('whatsappcloudapi') ||
                            channel.toLowerCase().includes('whatsapp360dialog') ||
                            channel.toLowerCase().includes('whatsapptwilio')
                        );
                        
                        const lastContactFromCustomers = convDetails.userProfile?.lastContactFromCustomers;
                        if (lastContactFromCustomers) {
                            const lastContactDate = new Date(lastContactFromCustomers);
                            const now = new Date();
                            hoursSinceLastContact = Math.floor((now - lastContactDate) / (1000 * 60 * 60));
                        }
                    }
                }
            } catch (err) {
                console.warn('âš ï¸ Conversation detaylarÄ± Ã§ekilemedi, 24 saat kontrolÃ¼ yapÄ±lamadÄ±:', err);
            }
            
            // âœ… 24 saat kuralÄ± kontrolÃ¼ - Normal mesaj gÃ¶nderilemez
            if (isWhatsApp && hoursSinceLastContact !== null && hoursSinceLastContact > 24) {
                alert('âŒ 24 saat kuralÄ±: Bu konuÅŸmada normal mesaj gÃ¶nderemezsiniz. LÃ¼tfen template mesaj kullanÄ±n.');
                if (sendButton) sendButton.disabled = false;
                return;
            }
            
            const text = messageInput ? messageInput.value.trim() : '';
            const hasFiles = window.selectedFiles && window.selectedFiles.length > 0;
            
            if (!text && !hasFiles) {
                alert('LÃ¼tfen mesaj yazÄ±n veya dosya seÃ§in');
                return;
            }
            
            // âœ… Sadece butonu disable et (input aÃ§Ä±k kalsÄ±n, kullanÄ±cÄ± yazmaya devam edebilsin)
            if (sendButton) sendButton.disabled = true;
            
            // âœ… OPTIMISTIC UPDATE: MesajÄ± hemen UI'a ekle (text veya dosya varsa)
            let tempMessageId = null;
            if ((text || hasFiles) && messagesList) {
                tempMessageId = 'temp_' + Date.now();
                const msgDiv = document.createElement('div');
                msgDiv.id = tempMessageId;
                msgDiv.className = 'message sent';
                msgDiv.style.cssText = 'display: flex; margin-bottom: 12px; justify-content: flex-end;';
                
                const msgContent = document.createElement('div');
                msgContent.style.cssText = 'max-width: 70%; min-width: fit-content; width: fit-content; padding: 10px 14px; border-radius: 12px; background: #6366f1; color: white; word-break: normal; overflow-wrap: break-word; box-sizing: border-box; display: inline-block; white-space: pre-wrap; unicode-bidi: plaintext; line-height: 1.4;';
                
                // âœ… Dosyalar varsa gÃ¶ster
                if (hasFiles) {
                    const filesHtml = window.selectedFiles.map((file, idx) => {
                        const fileName = file.name || 'Dosya';
                        const fileSize = file.size ? (file.size / 1024).toFixed(1) + ' KB' : '';
                        return `<div style="margin-bottom: 4px; font-size: 13px;">ğŸ“ ${fileName} (${fileSize})</div>`;
                    }).join('');
                    msgContent.innerHTML = filesHtml + (text ? `<div style="margin-top: 8px;">${text}</div>` : '');
                } else if (text) {
                    // âœ… URL'leri tÄ±klanabilir linklere Ã§evir
                    const escapeHtml = (txt) => {
                        const div = document.createElement('div');
                        div.textContent = txt;
                        return div.innerHTML;
                    };
                    const linkRegex = /(https?:\/\/[^\s<>"']+|www\.[^\s<>"']+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s<>"']*)/gi;
                    const textWithLinks = text.replace(linkRegex, (url) => {
                        let href = url.trim();
                        if (!href.match(/^https?:\/\//i)) {
                            href = href.startsWith('www.') ? 'https://' + href : 'https://' + href;
                        }
                        const safeHref = escapeHtml(href);
                        const safeUrl = escapeHtml(url);
                        return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" style="color: white; text-decoration: underline; word-break: break-all;">${safeUrl}</a>`;
                    });
                    msgContent.innerHTML = escapeHtml(textWithLinks.replace(linkRegex, (url) => {
                        let href = url.trim();
                        if (!href.match(/^https?:\/\//i)) {
                            href = href.startsWith('www.') ? 'https://' + href : 'https://' + href;
                        }
                        const safeHref = escapeHtml(href);
                        const safeUrl = escapeHtml(url);
                        return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" style="color: white; text-decoration: underline; word-break: break-all;">${safeUrl}</a>`;
                    }));
                }
                
                msgDiv.appendChild(msgContent);
                messagesList.appendChild(msgDiv);
                
                // âœ… Scroll to bottom - daha gÃ¼Ã§lÃ¼
                const messagesArea = document.getElementById('messagesArea');
                const scrollContainer = messagesArea || messagesList;
                requestAnimationFrame(() => {
                    if (scrollContainer) {
                        scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        setTimeout(() => {
                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        }, 100);
                    }
                });
            }
            
            // Input'u hemen temizle
            if (messageInput) messageInput.value = '';
            
            try {
                console.log('ğŸ“¤ Mesaj gÃ¶nderiliyor:', { conversationId, text: text.substring(0, 50), hasFiles });
                
                // âœ… API key ve baseUrl'i al - Zaten yukarÄ±da tanÄ±mlandÄ±
                if (!savedApiKey || savedApiKey.trim().length < 10) {
                    throw new Error('SleekFlow baÄŸlantÄ±sÄ± yok. LÃ¼tfen Ã¶nce baÄŸlanÄ±n.');
                }
                
                // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in)
                await getCurrentZohoUser();
                
                // âœ… SeÃ§ili sender numarasÄ±nÄ± al (hem dosya hem text iÃ§in)
                const channelFilterTop = document.getElementById('channelFilterTop');
                const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : null;
                
                let response;
                if (hasFiles) {
                    // Dosya gÃ¶nderme - FormData kullan
                    const formData = new FormData();
                    if (text) formData.append('text', text);
                    formData.append('apiKey', savedApiKey);
                    if (safeBaseUrl) formData.append('baseUrl', safeBaseUrl);
                    // âœ… SeÃ§ili sender numarasÄ±nÄ± FROM olarak ekle
                    if (selectedSenderPhone) {
                        formData.append('fromPhone', selectedSenderPhone);
                    }
                    // âœ… Backend yetki kontrolÃ¼ iÃ§in kullanÄ±cÄ± bilgisini ekle
                    if (window.currentZohoUser.email) {
                        formData.append('userEmail', window.currentZohoUser.email);
                    }
                    if (window.currentZohoUser.id) {
                        formData.append('userId', window.currentZohoUser.id);
                    }
                    window.selectedFiles.forEach((file) => {
                        formData.append('files', file);
                    });
                    
                    let messagesUrl = `/api/sleekflow/conversations/${conversationId}/messages?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    messagesUrl = addUserParamsToUrl(messagesUrl);
                    
                    response = await fetch(messagesUrl, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // Sadece metin gÃ¶nderme
                    const payload = { text, apiKey: savedApiKey, baseUrl: safeBaseUrl };
                    // âœ… SeÃ§ili sender numarasÄ±nÄ± FROM olarak ekle
                    if (selectedSenderPhone) {
                        payload.fromPhone = selectedSenderPhone;
                    }
                    // âœ… Backend yetki kontrolÃ¼ iÃ§in kullanÄ±cÄ± bilgisini ekle
                    if (window.currentZohoUser.email) {
                        payload.userEmail = window.currentZohoUser.email;
                    }
                    if (window.currentZohoUser.id) {
                        payload.userId = window.currentZohoUser.id;
                    }
                    
                    let messagesUrl = `/api/sleekflow/conversations/${conversationId}/messages?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    messagesUrl = addUserParamsToUrl(messagesUrl);
                    
                    response = await fetch(messagesUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                }
                
                // âœ… KRITIK: Response'u JSON'a Ã§evirmeden Ã¶nce status kontrolÃ¼ yap
                if (!response.ok) {
                    // Hata durumunda temp mesajÄ± kaldÄ±r ve butonu enable et
                    if (tempMessageId) {
                        const tempMsg = document.getElementById(tempMessageId);
                        if (tempMsg) tempMsg.remove();
                    }
                    if (sendButton) sendButton.disabled = false;
                    
                    // âœ… Response'u JSON'a Ã§evir ve hata mesajÄ±nÄ± al
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `HTTP ${response.status}: Mesaj gÃ¶nderilemedi` };
                    }
                    
                    const errorMsg = errorData?.error || errorData?.message || `HTTP ${response.status}: Mesaj gÃ¶nderilemedi`;
                    console.error('âŒ Mesaj gÃ¶nderilemedi (HTTP ' + response.status + '):', errorMsg, errorData);
                    
                    alert('âŒ Mesaj gÃ¶nderilemedi: ' + errorMsg);
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                
                // âœ… KRITIK: Backend response'unu kontrol et
                if (!result || !result.success) {
                    // Backend'den hata dÃ¶ndÃ¼ (200 OK ama success: false)
                    const errorMsg = result?.error || result?.message || 'Mesaj gÃ¶nderilemedi';
                    console.error('âŒ Mesaj gÃ¶nderilemedi (backend error):', errorMsg, result);
                    
                    // Temp mesajÄ± kaldÄ±r
                    if (tempMessageId) {
                        const tempMsg = document.getElementById(tempMessageId);
                        if (tempMsg) tempMsg.remove();
                    }
                    if (sendButton) sendButton.disabled = false;
                    
                    alert('âŒ Mesaj gÃ¶nderilemedi: ' + errorMsg);
                    throw new Error(errorMsg);
                }
                
                console.log('âœ… Mesaj gÃ¶nderildi:', result);
                
                // DosyalarÄ± temizle
                window.selectedFiles = [];
                updateSelectedFilesDisplay();
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
                
                // âœ… Butonu hemen enable et (mesaj gÃ¶nderildi, yÃ¼kleme arka planda)
                if (sendButton) sendButton.disabled = false;
                
                // âœ… KRITIK: Cache'i bypass et ve mesajlarÄ± YENÄ°DEN yÃ¼kle (gerÃ§ek mesajlar gelsin)
                // Cache bypass flag'i set et
                if (!window.conversationsState.bypassCacheFor) {
                    window.conversationsState.bypassCacheFor = {};
                }
                window.conversationsState.bypassCacheFor[conversationId] = true;
                
                // Cache'i de temizle
                if (window.conversationsState.loadedMessages) {
                    delete window.conversationsState.loadedMessages[conversationId];
                }
                
                // âœ… MesajlarÄ± HEMEN yÃ¼kle (cache bypass)
                loadMessagesDirectly(conversationId).then(() => {
                    // Bypass flag'ini temizle
                    if (window.conversationsState.bypassCacheFor) {
                        delete window.conversationsState.bypassCacheFor[conversationId];
                    }
                    // Mesajlar yÃ¼klendikten sonra temp mesajÄ± kaldÄ±r (gerÃ§ek mesajlar zaten gÃ¶rÃ¼nÃ¼yor)
                    setTimeout(() => {
                        if (tempMessageId) {
                            const tempMsg = document.getElementById(tempMessageId);
                            if (tempMsg) tempMsg.remove();
                        }
                        // Scroll to bottom
                        const messagesArea = document.getElementById('messagesArea');
                        const messagesList = document.getElementById('messagesList');
                        const scrollContainer = messagesArea || messagesList;
                        if (scrollContainer) {
                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        }
                    }, 1000); // 1 saniye bekle (gerÃ§ek mesajlar API'den gelsin)
                }).catch((err) => {
                    console.error('Mesajlar yÃ¼klenirken hata:', err);
                    // Hata durumunda da temp mesajÄ± kaldÄ±r
                    if (tempMessageId) {
                        const tempMsg = document.getElementById(tempMessageId);
                        if (tempMsg) tempMsg.remove();
                    }
                });
                
                // KonuÅŸmalarÄ± da arka planda yenile (showAll state'ini koru)
                if (window.conversationsState.allConversations.length > 0) {
                    const savedApiKey = localStorage.getItem('sleekflowApiKey');
                    const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                    const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                    
                    // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in)
                    await getCurrentZohoUser();
                    
                    // âœ… SeÃ§ili sender'Ä± fromPhone olarak gÃ¶nder
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                    const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                    
                    let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                    convUrl = addUserParamsToUrl(convUrl);
                    fetch(convUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(convResponse => convResponse.json())
                      .then(convData => {
                          const conversations = convData.conversations || [];
                          // âœ… KRITIK: showAll state'ini koru
                          const showAll = window.conversationsState.showAll || false;
                          window.renderConversationsDirectly(conversations, showAll);
                      }).catch(() => {});
                }
            } catch (error) {
                console.error('âŒ Mesaj gÃ¶nderme hatasÄ±:', error);
                alert('Mesaj gÃ¶nderilemedi: ' + error.message);
            } finally {
                // Butonu enable et
                if (sendButton) sendButton.disabled = false;
                if (messageInput) messageInput.disabled = false;
            }
        }
        
        // âœ… Dosya seÃ§me state
        window.selectedFiles = [];
        
        // âœ… Dosya seÃ§me fonksiyonu
        function setupFileAttachment() {
            const attachButton = document.getElementById('attachFile');
            const fileInput = document.getElementById('fileInput');
            
            if (attachButton && fileInput) {
                attachButton.onclick = function() {
                    fileInput.click();
                };
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files || []);
                    window.selectedFiles = [...window.selectedFiles, ...files];
                    updateSelectedFilesDisplay();
                };
            }
        }
        
        // âœ… SeÃ§ilen dosyalarÄ± gÃ¶ster
        function updateSelectedFilesDisplay() {
            const container = document.getElementById('selectedFilesContainer');
            if (!container) return;
            
            if (window.selectedFiles.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = window.selectedFiles.map((file, index) => {
                const fileName = file.name || 'Dosya';
                const fileSize = file.size ? (file.size / 1024).toFixed(1) + ' KB' : '';
                return `
                    <div style="display: flex; align-items: center; padding: 8px; background: #f3f4f6; border-radius: 4px; margin-bottom: 4px;">
                        <span style="flex: 1; font-size: 12px;">${fileName} (${fileSize})</span>
                        <button onclick="removeFile(${index})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">X</button>
                    </div>
                `;
            }).join('');
        }
        
        // âœ… Dosya kaldÄ±r
        window.removeFile = function(index) {
            window.selectedFiles.splice(index, 1);
            updateSelectedFilesDisplay();
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
        };
        
        // âœ… Mesaj gÃ¶nderme event listener'larÄ±nÄ± kur
        function setupMessageSending() {
            const sendButton = document.getElementById('sendMessage');
            const messageInput = document.getElementById('messageInput');
            
            if (sendButton) {
                sendButton.onclick = sendMessageDirectly;
            }
            
            if (messageInput) {
                // Enter tuÅŸu ile gÃ¶nder
                messageInput.onkeypress = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessageDirectly();
                    }
                };
            }
            
            // âœ… Dosya ekleme event listener'Ä±nÄ± kur
            setupFileAttachment();
        }
        
        // âœ… MesajlarÄ± yÃ¼kle - HIZLI VERSÄ°YON
        async function loadMessagesDirectly(conversationId) {
            try {
                // âœ… Ã–NCE chat view'Ä± gÃ¶ster (kullanÄ±cÄ± hemen gÃ¶rsÃ¼n)
                const chatActive = document.getElementById('chatActive');
                const chatEmpty = document.querySelector('.chat-empty');
                if (chatEmpty) chatEmpty.style.display = 'none';
                if (chatActive) {
                    chatActive.style.display = 'flex';
                    chatActive.style.visibility = 'visible';
                    chatActive.style.opacity = '1';
                }
                
                // âœ… Conversation bilgisini bul (paralel olarak)
                let conversation = null;
                if (window.conversationsState && window.conversationsState.allConversations) {
                    conversation = window.conversationsState.allConversations.find(c => 
                        (c.conversationId || c.id) === conversationId
                    );
                }
                
                // âœ… HEMEN chat header'Ä± gÃ¼ncelle (mesajlar gelmeden Ã¶nce)
                const chatContactName = document.getElementById('chatContactName');
                const chatMeta = document.getElementById('chatMeta');
                const chatAvatar = document.getElementById('chatAvatar');
                if (conversation && conversation.contactName) {
                    if (chatContactName) chatContactName.textContent = conversation.contactName;
                    if (chatMeta) chatMeta.textContent = conversation.channel || 'Online';
                    if (chatAvatar) chatAvatar.textContent = conversation.contactName.substring(0, 2).toUpperCase();
                }
                
                // âœ… API key'i al (24 saat kontrolÃ¼ iÃ§in)
                const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                
                // âœ… 24 SAAT KURALI KONTROLÃœ - Conversation detaylarÄ±nÄ± Ã§ek
                let hoursSinceLastContact = null;
                let isWhatsApp = false;
                try {
                    const convDetailsResponse = await fetch(`/api/sleekflow/conversation/${conversationId}?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`);
                    if (convDetailsResponse.ok) {
                        const convDetailsData = await convDetailsResponse.json();
                        const convDetails = convDetailsData.conversation;
                        if (convDetails) {
                            // Channel kontrolÃ¼
                            const channel = convDetails.lastMessageChannel || convDetails.channel || '';
                            isWhatsApp = channel && (
                                channel.toLowerCase().includes('whatsapp') ||
                                channel.toLowerCase().includes('messagebird') ||
                                channel.toLowerCase().includes('whatsappcloudapi') ||
                                channel.toLowerCase().includes('whatsapp360dialog') ||
                                channel.toLowerCase().includes('whatsapptwilio')
                            );
                            
                            // Last contact kontrolÃ¼
                            const lastContactFromCustomers = convDetails.userProfile?.lastContactFromCustomers;
                            if (lastContactFromCustomers) {
                                const lastContactDate = new Date(lastContactFromCustomers);
                                const now = new Date();
                                hoursSinceLastContact = Math.floor((now - lastContactDate) / (1000 * 60 * 60));
                            }
                        }
                    }
                } catch (err) {
                    console.warn('âš ï¸ Conversation detaylarÄ± Ã§ekilemedi, 24 saat kontrolÃ¼ yapÄ±lamadÄ±:', err);
                }
                
                // âœ… Mesaj input'u enable et (24 saat kontrolÃ¼nden sonra)
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendMessage');
                const attachFile = document.getElementById('attachFile');
                
                // âœ… 24 saat kuralÄ± kontrolÃ¼
                const normalMessageInput = document.getElementById('normalMessageInput');
                if (isWhatsApp && hoursSinceLastContact !== null && hoursSinceLastContact > 24) {
                    // 24 saat geÃ§ti - uyarÄ± gÃ¶ster ve sadece mesaj input'unu gizle (Templates butonu kalacak)
                    show24HourWarning(true, hoursSinceLastContact);
                    if (normalMessageInput) {
                        normalMessageInput.style.display = 'none';
                    }
                    if (attachFile) {
                        attachFile.style.display = 'none';
                    }
                } else {
                    // 24 saat kuralÄ± yok - normal kullanÄ±m, mesaj input'unu gÃ¶ster
                    show24HourWarning(false);
                    if (normalMessageInput) {
                        normalMessageInput.style.display = 'flex';
                    }
                    if (attachFile) {
                        attachFile.style.display = 'block';
                    }
                    if (messageInput) {
                        messageInput.disabled = false;
                        messageInput.placeholder = 'Mesaj yazÄ±n...';
                    }
                    if (sendButton) sendButton.disabled = false;
                }
                
                // âœ… Current conversation ID'yi kaydet (sender'a Ã¶zel state'e)
                const senderState = getCurrentSenderState();
                senderState.currentConversationId = conversationId;
                window.conversationsState.currentConversationId = conversationId; // Geriye dÃ¶nÃ¼k uyumluluk
                
                // âœ… API Ã§aÄŸrÄ±sÄ± (mesajlarÄ± Ã§ek) - HEMEN YÃœKLE: Son mesajlar hemen, eski mesajlar arka planda
                // âœ… LAZY LOAD STATE: Hangi mesajlar yÃ¼klendi, kaÃ§ tane daha var
                if (!window.messageLoadState) {
                    window.messageLoadState = {};
                }
                const loadState = window.messageLoadState[conversationId] = {
                    loadedCount: 0,
                    totalMessages: null,
                    isLoading: false,
                    hasMore: true
                };
                
                // âœ… API key'i al (mesaj yÃ¼kleme iÃ§in) - Zaten yukarÄ±da tanÄ±mlandÄ±, tekrar tanÄ±mlama
                
                // âœ… Ã–NCE CACHE'DEN KONTROL ET (sayfa yÃ¼klenirken yÃ¼klenmiÅŸ olabilir)
                // âœ… AMA: EÄŸer mesaj gÃ¶nderildiyse cache'i bypass et (yeni mesajlar gelsin)
                const bypassCache = window.conversationsState?.bypassCacheFor?.[conversationId] || false;
                if (!bypassCache && window.conversationsState?.loadedMessages?.[conversationId]) {
                    const cachedMessages = window.conversationsState.loadedMessages[conversationId];
                    if (cachedMessages.length > 0) {
                        // âœ… CACHE'DEN HEMEN RENDER ET (Ã§ok hÄ±zlÄ±!)
                        renderMessagesDirectly(cachedMessages, conversationId, conversation);
                        lastMessageCount[conversationId] = cachedMessages.length;
                        
                        // âœ… KRITIK: Badge'i HEMEN temizle (mesaj aÃ§Ä±ldÄ±, okundu) - Her durumda
                        window.conversationsState.unreadCounts[conversationId] = 0;
                        
                        // âœ… KRITIK: Conversation'Ä± okunan olarak iÅŸaretle (sayfa yenilendiÄŸinde badge tekrar gelmesin)
                        readConversations.add(conversationId);
                        saveReadConversations();
                        
                        // âœ… KRITIK: Conversation objesinin unreadCount deÄŸerini de gÃ¼ncelle (API'den gelen deÄŸer)
                        const conversations = window.conversationsState.allConversations || [];
                        const convIndex = conversations.findIndex(c => (c.conversationId || c.id) === conversationId);
                        if (convIndex !== -1) {
                            conversations[convIndex].unreadCount = 0;
                        }
                        
                        // âœ… Son mesaj ID'sini gÃ¼ncelle (polling tekrar aynÄ± mesajÄ± "yeni" olarak gÃ¶rmesin)
                        const lastMsg = cachedMessages[cachedMessages.length - 1];
                        const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                        if (lastMsgId) {
                            if (!lastMessageCount) {
                                lastMessageCount = {};
                            }
                            lastMessageCount[conversationId + '_latest'] = lastMsgId;
                            saveLastMessageCounts();
                        }
                        
                        // âœ… KonuÅŸma listesini HEMEN gÃ¼ncelle (badge'i kaldÄ±rmak iÃ§in)
                        const showAll = window.conversationsState.showAll || false;
                        if (window.renderConversationsDirectly) {
                            window.renderConversationsDirectly(conversations, showAll);
                        }
                        
                        setTimeout(() => {
                            const messagesArea = document.getElementById('messagesArea');
                            const scrollContainer = messagesArea || messagesList;
                            if (scrollContainer) {
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                            }
                        }, 50);
                        
                        setupInfiniteScroll(conversationId, conversation);
                        loadState.loadedCount = cachedMessages.length;
                        loadState.hasMore = cachedMessages.length >= 10;
                        
                        // Arka planda daha fazla mesaj yÃ¼kle
                        // âœ… NOT: ArtÄ±k ilk yÃ¼klemede 50 mesaj Ã§ekiyoruz, bu yÃ¼zden offset=50 olmalÄ±
                        if (cachedMessages.length >= 10) {
                            setTimeout(() => {
                                const msgUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=50${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                fetch(msgUrl)
                                    .then(r => r.json())
                                    .then(d => {
                                        const moreMsgs = d.messages || [];
                                        if (moreMsgs.length > 0) {
                                            const allMessages = [...cachedMessages, ...moreMsgs];
                                            allMessages.sort((a, b) => {
                                                const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                                const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                                return timeA - timeB;
                                            });
                                            window.conversationsState.loadedMessages[conversationId] = allMessages;
                                            loadState.loadedCount = allMessages.length;
                                            loadState.hasMore = moreMsgs.length >= 50;
                                        }
                                    })
                                    .catch(() => {});
                            }, 100);
                        }
                        // âœ… Cache bypass flag'ini temizle
                        if (window.conversationsState.bypassCacheFor) {
                            delete window.conversationsState.bypassCacheFor[conversationId];
                        }
                        return; // âœ… Cache'den yÃ¼klendi, API Ã§aÄŸrÄ±sÄ± yapma
                    }
                }
                
                // âœ… HEMEN SON MESAJLARI YÃœKLE (timeout yok, beklenir)
                try {
                    // âœ… Channel filtreleme: VIP ve Hamzah iÃ§in WhatsApp gÃ¶ster (Instagram hariÃ§)
                    // âœ… NOT: "TÃ¼m MesajlarÄ± GÃ¶r" butonuna basÄ±ldÄ±ysa channel parametresi gÃ¶nderme
                    const senderState = getCurrentSenderState();
                    const showAllMessages = senderState.showAllMessages || {};
                    const shouldShowAllMessages = showAllMessages[conversationId] || false;
                    
                    const channelFilterTopMsg = document.getElementById('channelFilterTop');
                    const selectedSenderPhoneMsg = channelFilterTopMsg && channelFilterTopMsg.value ? channelFilterTopMsg.value : '';
                    let channelParam = '';
                    // âœ… Sadece showAllMessages false ise channel ve fromPhone filtreleme yap
                    let fromPhoneParam = '';
                    if (!shouldShowAllMessages) {
                        if (selectedSenderPhoneMsg === '905421363421') {
                            // âœ… Hamzah seÃ§ildi - Sadece WhatsApp mesajlarÄ± gÃ¶ster
                            // âœ… NOT: Conversation'lar zaten backend'de doÄŸru kanala gÃ¶re filtrelenmiÅŸ geliyor
                            // âœ… O yÃ¼zden mesajlarÄ± Ã§ekerken sadece WhatsApp mesajlarÄ±nÄ± filtrelemek yeterli
                            channelParam = '&channel=whatsapp';
                        }
                        // âœ… VIP iÃ§in: TÃ¼m mesajlar filtrelenmeden gelsin (channel parametresi gÃ¶nderme)
                        
                        // âœ… KRITIK: fromPhone parametresi ekle - AynÄ± conversation'da hem VIP hem Hamzah mesajlarÄ± varsa
                        // âœ… Sadece seÃ§ili sender'dan gÃ¶nderilen mesajlarÄ± gÃ¶ster
                        if (selectedSenderPhoneMsg && (selectedSenderPhoneMsg === '908505327532' || selectedSenderPhoneMsg === '905421363421')) {
                            fromPhoneParam = `&fromPhone=${encodeURIComponent(selectedSenderPhoneMsg)}`;
                        }
                        
                        if (channelParam || fromPhoneParam) {
                            console.log('ğŸ” [MESAJ FÄ°LTRELEME] Parametreler eklendi:', {
                                selectedSenderPhone: selectedSenderPhoneMsg,
                                isVIP: selectedSenderPhoneMsg === '908505327532',
                                isHamzah: selectedSenderPhoneMsg === '905421363421',
                                shouldShowAllMessages: shouldShowAllMessages,
                                channelParam: channelParam,
                                fromPhoneParam: fromPhoneParam
                            });
                        }
                    } else {
                        console.log('âš ï¸ [MESAJ FÄ°LTRELEME] Parametreler EKLENMEDÄ°:', {
                            selectedSenderPhone: selectedSenderPhoneMsg,
                            shouldShowAllMessages: shouldShowAllMessages,
                            reason: shouldShowAllMessages ? 'showAllMessages=true' : 'sender eÅŸleÅŸmedi'
                        });
                    }
                    
                    // âœ… HIZLANDIRMA: Ä°lk yÃ¼klemede daha fazla mesaj Ã§ek (10 -> 50)
                    const msgUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${channelParam}${fromPhoneParam}`;
                    const response = await fetch(msgUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    let allMessages = data.messages || [];
                    
                    // âœ… ESKÄ° MANTIK: Ä°lk baÅŸta sadece WhatsApp mesajlarÄ±nÄ± gÃ¶ster
                    // âœ… NOT: Channel filtreleme artÄ±k backend'de yapÄ±lÄ±yor (URL'de channel=whatsapp parametresi ile)
                    // âœ… Backend'den zaten filtrelenmiÅŸ mesajlar geliyor (VIP ve Hamzah iÃ§in sadece WhatsApp)
                    // âœ… showAllMessages kontrolÃ¼: EÄŸer true ise tÃ¼m mesajlarÄ± gÃ¶ster (WhatsApp + Instagram)
                    let messages = allMessages;
                    
                    // âœ… KRITIK: MesajlarÄ± EN ESKÄ° EN ÃœSTTE, EN YENÄ° EN ALTTA sÄ±rala (normal chat gibi)
                    messages.sort((a, b) => {
                        const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                        const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                        return timeA - timeB; // âœ… En eski en Ã¼stte, en yeni en altta
                    });
                    
                    // âœ… TÃ¼m mesajlarÄ± state'te sakla (butona basÄ±nca gÃ¶sterilecek)
                    if (!window.conversationsState.allMessages) {
                        window.conversationsState.allMessages = {};
                    }
                    window.conversationsState.allMessages[conversationId] = allMessages;
                    
                    // âœ… HEMEN RENDER ET (kullanÄ±cÄ± beklemez)
                    if (messages.length > 0 || allMessages.length > 0) {
                        if (!window.conversationsState.loadedMessages) {
                            window.conversationsState.loadedMessages = {};
                        }
                        window.conversationsState.loadedMessages[conversationId] = messages;
                        
                        renderMessagesDirectly(messages, conversationId, conversation);
                        lastMessageCount[conversationId] = messages.length;
                        
                        // âœ… KRITIK: Son mesaj ID'sini gÃ¼ncelle (polling iÃ§in)
                        if (messages.length > 0) {
                            const lastMsg = messages[messages.length - 1]; // En son mesaj (en altta, en yeni)
                            const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                            if (lastMsgId) {
                                if (!lastMessageCount) {
                                    lastMessageCount = {};
                                }
                                lastMessageCount[conversationId + '_latest'] = lastMsgId;
                                saveLastMessageCounts();
                            }
                        }
                        
                        // âœ… Scroll to bottom (en yeni mesajlar altta) - daha gÃ¼Ã§lÃ¼
                        requestAnimationFrame(() => {
                            const messagesArea = document.getElementById('messagesArea');
                            const scrollContainer = messagesArea || messagesList;
                            if (scrollContainer) {
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                setTimeout(() => {
                                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                }, 100);
                                setTimeout(() => {
                                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                }, 300);
                            }
                        });
                        
                        // âœ… INFINITE SCROLL: YukarÄ± scroll yaptÄ±ÄŸÄ±nda eski mesajlarÄ± yÃ¼kle
                        setupInfiniteScroll(conversationId, conversation);
                    }
                    
                    loadState.loadedCount = messages.length;
                    loadState.hasMore = messages.length >= 10; // EÄŸer 10 mesaj geldiyse daha fazla olabilir
                    
                    // âœ… ARKA PLANDA DAHA FAZLA MESAJ YÃœKLE (kullanÄ±cÄ± fark etmez)
                    // âœ… NOT: ArtÄ±k ilk yÃ¼klemede 50 mesaj Ã§ekiyoruz, bu yÃ¼zden offset=50 olmalÄ±
                    if (messages.length >= 10) {
                        // Hemen arka planda baÅŸlat (kullanÄ±cÄ± fark etmez)
                        setTimeout(() => {
                            const moreMsgUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=50${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            fetch(moreMsgUrl)
                                .then(r => r.json())
                                .then(d => {
                                    const moreMsgs = d.messages || [];
                                    if (moreMsgs.length > 0) {
                                        // Mevcut mesajlara ekle ve sÄ±rala
                                        const allMessages = [...messages, ...moreMsgs];
                                        allMessages.sort((a, b) => {
                                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                            return timeA - timeB;
                                        });
                                        
                                        // State gÃ¼ncelle (render etme, kullanÄ±cÄ± fark etmez)
                                        window.conversationsState.loadedMessages[conversationId] = allMessages;
                                        loadState.loadedCount = allMessages.length;
                                        loadState.hasMore = moreMsgs.length >= 50;
                                    }
                                })
                                .catch(() => {});
                        }, 100); // âœ… 100ms sonra arka planda yÃ¼kle (kullanÄ±cÄ± fark etmez)
                    }
                } catch (error) {
                    console.error('Mesaj yÃ¼kleme hatasÄ±:', error);
                    renderMessagesDirectly([], conversationId, conversation);
                }
                
                
                // âœ… KRITIK: Mesaj aÃ§Ä±ldÄ± - Badge'i HEMEN temizle ve son mesaj ID'sini gÃ¼ncelle
                const loadedMsgs = window.conversationsState.loadedMessages?.[conversationId] || [];
                
                // âœ… Badge'i HEMEN temizle (mesaj aÃ§Ä±ldÄ±, okundu) - Her durumda
                window.conversationsState.unreadCounts[conversationId] = 0;
                
                // âœ… KRITIK: Conversation'Ä± okunan olarak iÅŸaretle (sayfa yenilendiÄŸinde badge tekrar gelmesin)
                readConversations.add(conversationId);
                saveReadConversations();
                
                // âœ… KRITIK: Conversation objesinin unreadCount deÄŸerini de gÃ¼ncelle (API'den gelen deÄŸer)
                const conversations = window.conversationsState.allConversations || [];
                const convIndex = conversations.findIndex(c => (c.conversationId || c.id) === conversationId);
                if (convIndex !== -1) {
                    conversations[convIndex].unreadCount = 0;
                }
                
                // âœ… KonuÅŸma listesini HEMEN gÃ¼ncelle (badge'i kaldÄ±rmak iÃ§in)
                const showAll = window.conversationsState.showAll || false;
                if (window.renderConversationsDirectly) {
                    window.renderConversationsDirectly(conversations, showAll);
                }
                
                // âœ… KRITIK: Son mesaj ID'sini her zaman gÃ¼ncelle (polling tekrar aynÄ± mesajÄ± "yeni" olarak gÃ¶rmesin)
                if (loadedMsgs.length > 0) {
                    // En son mesajÄ± al (en altta, en yeni)
                    const lastMsg = loadedMsgs[loadedMsgs.length - 1];
                    const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                    if (lastMsgId) {
                        if (!lastMessageCount) {
                            lastMessageCount = {};
                        }
                        lastMessageCount[conversationId + '_latest'] = lastMsgId;
                        saveLastMessageCounts();
                    }
                }
            } catch (err) {
                console.error('âŒ Mesajlar yÃ¼klenemedi:', err);
                alert('Mesajlar yÃ¼klenemedi: ' + err.message);
            }
        }
        
        // âœ… 24 saat kuralÄ± uyarÄ±sÄ± gÃ¶ster/gizle
        function show24HourWarning(show, hoursSinceLastContact = null) {
            const warningDiv = document.getElementById('twentyFourHourWarning');
            const hoursDisplay = document.getElementById('hoursSinceLastContactDisplay');
            const normalMessageInput = document.getElementById('normalMessageInput');
            const attachFile = document.getElementById('attachFile');
            
            if (show && hoursSinceLastContact !== null && hoursSinceLastContact > 24) {
                const daysAgo = Math.floor(hoursSinceLastContact / 24);
                if (warningDiv) {
                    warningDiv.style.display = 'block';
                }
                if (hoursDisplay) {
                    hoursDisplay.textContent = `Son mÃ¼ÅŸteri mesajÄ± ${daysAgo} gÃ¼n Ã¶nce.`;
                }
                // Sadece mesaj input'unu gizle (Templates butonu kalacak)
                if (normalMessageInput) {
                    normalMessageInput.style.display = 'none';
                }
                if (attachFile) {
                    attachFile.style.display = 'none';
                }
            } else {
                if (warningDiv) {
                    warningDiv.style.display = 'none';
                }
                // Mesaj input'unu gÃ¶ster
                if (normalMessageInput) {
                    normalMessageInput.style.display = 'flex';
                }
                if (attachFile) {
                    attachFile.style.display = 'block';
                }
            }
        }
        
        // âœ… MesajlarÄ± render et
        function renderMessagesDirectly(messages, conversationId, conversation = null) {
            const chatView = document.getElementById('chatView');
            const chatActive = document.getElementById('chatActive');
            const chatEmpty = document.querySelector('.chat-empty');
            const messagesList = document.getElementById('messagesList');
            const chatContactName = document.getElementById('chatContactName');
            const chatMeta = document.getElementById('chatMeta');
            const chatAvatar = document.getElementById('chatAvatar');
            
            if (!chatView || !chatActive || !messagesList) {
                console.error('âŒ Chat elementleri bulunamadÄ±!');
                return;
            }
            
            // âœ… Chat header'Ä± gÃ¼ncelle - kiÅŸi ismini gÃ¶ster
            if (conversation && conversation.contactName) {
                const contactName = conversation.contactName;
                if (chatContactName) {
                    chatContactName.textContent = contactName;
                }
                if (chatMeta) {
                    chatMeta.textContent = conversation.channel || 'Online';
                }
                if (chatAvatar) {
                    chatAvatar.textContent = contactName.substring(0, 2).toUpperCase();
                }
            } else if (chatContactName) {
                // Conversation bilgisi yoksa, mesajlardan isim Ã§Ä±karmaya Ã§alÄ±ÅŸ
                chatContactName.textContent = 'Bilinmeyen';
                if (chatMeta) chatMeta.textContent = '';
            }
            
            // âœ… Chat view'Ä± gÃ¶ster - KRÄ°TÄ°K: Ã–nce chat view'Ä± gÃ¶ster
            if (chatEmpty) chatEmpty.style.display = 'none';
            chatActive.style.display = 'flex';
            chatActive.style.visibility = 'visible';
            chatActive.style.opacity = '1';
            
            // âœ… Current conversation ID'yi kaydet (sender'a Ã¶zel state'e)
            const senderState = getCurrentSenderState();
            senderState.currentConversationId = conversationId;
            window.conversationsState.currentConversationId = conversationId; // Geriye dÃ¶nÃ¼k uyumluluk
            
            // âœ… Mesaj input ve gÃ¶nder butonunu enable et
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = 'Mesaj yazÄ±n...';
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
            
            // âœ… Mesaj gÃ¶nderme event listener'larÄ±nÄ± kur
            setupMessageSending();
            
            // MesajlarÄ± render et
            console.log('ğŸ“ Mesajlar render ediliyor:', { conversationId, messageCount: messages.length });
            messagesList.innerHTML = '';
            
            messages.forEach((msg, index) => {
                // âœ… DEBUG: Sadece sorunlu mesajlarÄ± logla (file type var ama fileUrl yok)
                if (index < 2 && (msg.messageType === 'file' || msg.type === 'file') && !msg.fileUrl && !msg.url) {
                    console.warn(`âš ï¸ File mesajÄ± ama fileUrl yok - MSG[${index}]:`, {
                        id: msg.id,
                        type: msg.type,
                        messageType: msg.messageType,
                        uploadedFiles: msg.uploadedFiles
                    });
                }
                
                const msgDiv = document.createElement('div');
                const isSent = msg.direction === 'sent' || msg.isSentFromSleekflow;
                msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                msgDiv.style.cssText = `display: flex; margin-bottom: 12px; ${isSent ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}`;
                
                const msgContent = document.createElement('div');
                // âœ… Ä°lk stil - sonra mediaHtml varsa deÄŸiÅŸtirilecek
                const defaultStyle = `max-width: 70%; min-width: fit-content; width: fit-content; padding: 10px 14px; border-radius: 12px; ${isSent ? 'background: #6366f1; color: white;' : 'background: #f3f4f6; color: #111827;'} word-break: normal; overflow-wrap: normal; box-sizing: border-box; display: inline-block; white-space: normal;`;
                msgContent.style.cssText = defaultStyle;
                
                // âœ… Video, fotoÄŸraf veya dosya kontrolÃ¼ - TÃœM ALANLARI KONTROL ET
                const messageType = (msg.type || msg.messageType || '').toLowerCase();
                
                // âœ… TÃœM OLASI FILE URL KAYNAKLARI (null kontrolÃ¼ ile)
                let fileUrl = '';
                if (msg.fileUrl && msg.fileUrl !== null && typeof msg.fileUrl === 'string' && msg.fileUrl.trim()) {
                    fileUrl = msg.fileUrl.trim();
                } else if (msg.url && msg.url !== null && typeof msg.url === 'string' && msg.url.trim()) {
                    fileUrl = msg.url.trim();
                } else if (msg.uploadedFiles && Array.isArray(msg.uploadedFiles) && msg.uploadedFiles.length > 0) {
                    const firstFile = msg.uploadedFiles[0];
                    const url = firstFile.url || firstFile.link || firstFile.fileUrl || '';
                    if (url && typeof url === 'string' && url.trim()) {
                        fileUrl = url.trim();
                    }
                }
                
                // âœ… TÃœM OLASI FILE TYPE KAYNAKLARI (null kontrolÃ¼ ile)
                let fileType = '';
                if (msg.fileType && msg.fileType !== null && typeof msg.fileType === 'string' && msg.fileType.trim()) {
                    fileType = msg.fileType.trim();
                } else if (msg.mimeType && msg.mimeType !== null && typeof msg.mimeType === 'string' && msg.mimeType.trim()) {
                    fileType = msg.mimeType.trim();
                } else if (msg.uploadedFiles && Array.isArray(msg.uploadedFiles) && msg.uploadedFiles.length > 0) {
                    const firstFile = msg.uploadedFiles[0];
                    const type = firstFile.type || firstFile.mimeType || firstFile.fileType || '';
                    if (type && typeof type === 'string' && type.trim()) {
                        fileType = type.trim();
                    }
                }
                
                // âœ… TÃœM OLASI FILE NAME KAYNAKLARI (null kontrolÃ¼ ile)
                let fileName = '';
                if (msg.fileName && msg.fileName !== null && typeof msg.fileName === 'string' && msg.fileName.trim()) {
                    fileName = msg.fileName.trim();
                } else if (msg.uploadedFiles && Array.isArray(msg.uploadedFiles) && msg.uploadedFiles.length > 0) {
                    const firstFile = msg.uploadedFiles[0];
                    const name = firstFile.filename || firstFile.name || firstFile.originalName || firstFile.fileName || '';
                    if (name && typeof name === 'string' && name.trim()) {
                        fileName = name.trim();
                    }
                }
                
                fileType = fileType.toLowerCase();
                
                // âœ… DEBUG: Sadece sorunlu durumlarÄ± logla (file type var ama fileUrl yok)
                if (index < 2 && fileType && !fileUrl) {
                    console.warn(`âš ï¸ File type var ama fileUrl yok - MSG[${index}]:`, {
                        type: msg.type,
                        messageType,
                        fileType,
                        uploadedFiles: msg.uploadedFiles
                    });
                }
                
                // âœ… Story kontrolÃ¼ - Daha kapsamlÄ±
                const isStory = !!(msg.isStory || msg.story || msg.isStoryReply || 
                                 (msg.channel && msg.channel.toLowerCase().includes('instagram') && 
                                  (messageType === 'story' || msg.type === 'story')));
                
                let mediaHtml = '';
                
                // âœ… STORY MESAJLARI - Ã–zel gÃ¶sterim (fileUrl varsa veya type file ise)
                if (isStory && fileUrl && fileUrl.length > 0) {
                    const isVideo = messageType === 'video' || 
                                   (messageType === 'file' && fileType && fileType.includes('video')) ||
                                   (fileType && fileType.includes('video')) || 
                                   (fileName && fileName.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i)) ||
                                   (fileUrl && fileUrl.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i));
                    
                    const isImage = messageType === 'image' || 
                                   messageType === 'photo' || 
                                   (messageType === 'file' && fileType && fileType.includes('image')) ||
                                   (fileType && fileType.includes('image')) || 
                                   (fileName && fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i)) ||
                                   (fileUrl && fileUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i));
                    
                    mediaHtml = `
                        <div style="border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'}; background: #fff;">
                            <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">ğŸ“± Story</div>
                            </div>
                            ${isVideo ? `
                                <video controls style="width: 100%; max-height: 500px; display: block;">
                                    <source src="${fileUrl}" type="video/mp4">
                                    Video yÃ¼klenemedi. <a href="${fileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">Ä°ndir</a>
                                </video>
                            ` : isImage ? `
                                <img src="${fileUrl}" alt="Story" style="width: 100%; max-height: 500px; display: block; object-fit: contain; cursor: pointer;" onclick="window.open('${fileUrl}', '_blank')">
                            ` : `
                                <div style="padding: 12px;"><a href="${fileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">ğŸ“ ${fileName || 'Dosya'}</a></div>
                            `}
                        </div>
                    `;
                }
                // âœ… Video kontrolÃ¼ - Ã‡OK KAPSAMLI (fileType Ã¶ncelikli)
                else {
                    // âœ… Ã–NCE fileType'dan kontrol et (en gÃ¼venilir)
                    const isVideo = (fileType && fileType.includes('video')) || 
                                   messageType === 'video' || 
                                   (messageType === 'file' && fileType && fileType.includes('video')) ||
                                   (msg.type === 'file' && fileType && fileType.includes('video')) ||
                                   (fileName && fileName.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i)) ||
                                   (fileUrl && fileUrl.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i));
                    
                    // âœ… DEBUG: Video tespiti iÃ§in log
                    if (index < 5 && (fileType || fileUrl)) {
                        const trimmedUrl = fileUrl ? fileUrl.trim() : '';
                        const hasValidUrl = trimmedUrl && trimmedUrl.length > 0;
                        const willShow = isVideo && hasValidUrl;
                        console.log(`ğŸ¥ VIDEO CHECK MSG[${index}]:`, {
                            isVideo,
                            fileType,
                            fileUrl: fileUrl ? fileUrl.substring(0, 80) : '(boÅŸ)',
                            fileUrlLength: fileUrl ? fileUrl.length : 0,
                            trimmedUrl: trimmedUrl ? trimmedUrl.substring(0, 50) : '(boÅŸ)',
                            trimmedUrlLength: trimmedUrl ? trimmedUrl.length : 0,
                            hasFileUrl: !!fileUrl,
                            hasValidUrl: hasValidUrl,
                            willShow: willShow,
                            direction: msg.direction,
                            isSent: isSent
                        });
                    }
                    
                    // âœ… Video gÃ¶ster (fileUrl varsa VEYA fileType video ise - her durumda gÃ¶ster)
                    // âœ… KRITIK: fileUrl.trim() kontrolÃ¼ - boÅŸluk karakterleri sorun Ã§Ä±karabilir
                    const trimmedFileUrl = fileUrl ? fileUrl.trim() : '';
                    if (isVideo && trimmedFileUrl && trimmedFileUrl.length > 0) {
                        // âœ… KRITIK: Video iÃ§in Ã¶zel HTML - tÃ¼m stiller inline ve !important ile
                        mediaHtml = `
                            <div style="max-width: 100% !important; width: 100% !important; margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'} !important; padding: 0 !important; background: transparent !important; display: block !important;">
                                <video controls style="max-width: 300px !important; max-height: 300px !important; width: auto !important; height: auto !important; border-radius: 8px !important; display: block !important; visibility: visible !important; opacity: 1 !important;">
                                    <source src="${trimmedFileUrl}" type="video/mp4">
                                    Video yÃ¼klenemedi. <a href="${trimmedFileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">Ä°ndir</a>
                                </video>
                            </div>
                        `;
                        // âœ… DEBUG: mediaHtml oluÅŸturulduÄŸunu logla
                        if (index < 5) {
                            console.log(`âœ…âœ…âœ… VIDEO HTML OLUÅTURULDU MSG[${index}]:`, {
                                mediaHtmlLength: mediaHtml.length,
                                fileUrl: trimmedFileUrl.substring(0, 80),
                                isVideo: isVideo,
                                hasValidUrl: true
                            });
                        }
                    } else if (index < 5 && isVideo) {
                        // âœ… DEBUG: isVideo true ama mediaHtml oluÅŸturulmadÄ±
                        const trimmedUrl = fileUrl ? fileUrl.trim() : '';
                        console.error(`âŒâŒâŒ VIDEO HTML OLUÅTURULAMADI MSG[${index}]:`, {
                            isVideo: isVideo,
                            fileUrl: fileUrl || '(boÅŸ)',
                            fileUrlLength: fileUrl ? fileUrl.length : 0,
                            trimmedUrl: trimmedUrl || '(boÅŸ)',
                            trimmedLength: trimmedUrl ? trimmedUrl.length : 0,
                            reason: !fileUrl ? 'fileUrl yok' : (!trimmedUrl || trimmedUrl.length === 0) ? 'fileUrl boÅŸ/trim sonrasÄ± boÅŸ' : 'bilinmeyen'
                        });
                    }
                    // âœ… FotoÄŸraf/resim kontrolÃ¼ - Ã‡OK KAPSAMLI (fileType Ã¶ncelikli)
                    else {
                        // âœ… Ã–NCE fileType'dan kontrol et (en gÃ¼venilir)
                        const isImage = (fileType && fileType.includes('image')) || 
                                       messageType === 'image' || 
                                       messageType === 'photo' || 
                                       (messageType === 'file' && fileType && fileType.includes('image')) ||
                                       (msg.type === 'file' && fileType && fileType.includes('image')) ||
                                       (fileName && fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i)) ||
                                       (fileUrl && fileUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i));
                        
                        if (isImage && fileUrl && fileUrl.trim().length > 0) {
                            mediaHtml = `
                                <div style="max-width: 100%; margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'};">
                                    <img src="${fileUrl}" alt="${fileName || 'Resim'}" style="max-width: 300px; max-height: 300px; width: auto; height: auto; border-radius: 8px; display: block; cursor: pointer; object-fit: contain;" onclick="window.open('${fileUrl}', '_blank')">
                                </div>
                            `;
                        }
                        // âœ… DiÄŸer dosyalar
                        else if (fileUrl && fileUrl.trim().length > 0) {
                            mediaHtml = `
                                <div style="margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'};"><a href="${fileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">ğŸ“ ${fileName || 'Dosya'}</a></div>
                            `;
                        }
                    }
                }
                
                // Mesaj iÃ§eriÄŸi â€“ olduÄŸu gibi (trim yok: boÅŸluk, satÄ±r, noktalama, sembol korunur)
                const textContent = (msg.text || msg.messageContent || msg.content || '');
                
                // âœ… Mesaj iÃ§eriÄŸini gÃ¶ster
                if (mediaHtml || textContent) {
                    // âœ… KRITIK: Video/resim varsa msgContent stilini Ã–NCE dÃ¼zelt (padding ve background kaldÄ±r)
                    if (mediaHtml) {
                        // Video/resim iÃ§in Ã¶zel stil - padding ve background'u kaldÄ±r, display block yap
                        msgContent.style.cssText = `max-width: 100% !important; min-width: fit-content !important; width: fit-content !important; padding: 0 !important; border-radius: 12px !important; background: transparent !important; word-break: normal !important; overflow-wrap: normal !important; box-sizing: border-box !important; display: block !important; white-space: normal !important; margin: 0 !important;`;
                    }
                    
                    // âœ… Ä°Ã§eriÄŸi set et - URL'leri tÄ±klanabilir linklere Ã§evir
                    if (textContent) {
                        // âœ… XSS korumasÄ± iÃ§in escape fonksiyonu
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        // âœ… URL'leri tÄ±klanabilir linklere Ã§evir
                        const linkColor = isSent ? 'white' : '#6366f1';
                        const linkRegex = /(https?:\/\/[^\s<>"']+|www\.[^\s<>"']+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s<>"']*)/gi;
                        
                        // âœ… Ã–nce URL'leri bul ve iÅŸaretle
                        const urlMatches = [];
                        let match;
                        while ((match = linkRegex.exec(textContent)) !== null) {
                            urlMatches.push({
                                url: match[0],
                                index: match.index,
                                length: match[0].length
                            });
                        }
                        
                        // âœ… Metni parÃ§alara ayÄ±r ve URL'leri linklere Ã§evir
                        let textWithLinks = '';
                        let lastIndex = 0;
                        
                        urlMatches.forEach((urlMatch) => {
                            // URL'den Ã¶nceki metni escape et ve ekle
                            if (urlMatch.index > lastIndex) {
                                textWithLinks += escapeHtml(textContent.substring(lastIndex, urlMatch.index));
                            }
                            
                            // URL'yi linke Ã§evir
                            let href = urlMatch.url.trim();
                            if (!href.match(/^https?:\/\//i)) {
                                href = href.startsWith('www.') ? 'https://' + href : 'https://' + href;
                            }
                            const safeHref = escapeHtml(href);
                            const safeUrl = escapeHtml(urlMatch.url);
                            textWithLinks += `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" style="color: ${linkColor}; text-decoration: underline; word-break: break-all;">${safeUrl}</a>`;
                            
                            lastIndex = urlMatch.index + urlMatch.length;
                        });
                        
                        // âœ… Kalan metni escape et ve ekle
                        if (lastIndex < textContent.length) {
                            textWithLinks += escapeHtml(textContent.substring(lastIndex));
                        }
                        
                        // âœ… EÄŸer hiÃ§ URL bulunamadÄ±ysa, tÃ¼m metni escape et
                        if (urlMatches.length === 0) {
                            textWithLinks = escapeHtml(textContent);
                        }
                        
                        msgContent.innerHTML = mediaHtml + `<div style="word-break: normal; overflow-wrap: break-word; white-space: pre-wrap; unicode-bidi: plaintext; line-height: 1.4; padding: 10px 14px; ${isSent ? 'background: #6366f1; color: white;' : 'background: #f3f4f6; color: #111827;'} border-radius: 12px; margin-top: ${mediaHtml ? '8px' : '0'}; display: inline-block;">${textWithLinks}</div>`;
                    } else {
                        msgContent.innerHTML = mediaHtml;
                    }
                    
                    // âœ… KRITIK: mediaHtml set edildikten SONRA tekrar stil kontrolÃ¼ (eÄŸer hala gÃ¶rÃ¼nmÃ¼yorsa)
                    if (mediaHtml && index < 5) {
                        // Force reflow - tarayÄ±cÄ±ya stil deÄŸiÅŸikliÄŸini zorla
                        void msgContent.offsetHeight;
                        console.log(`âœ…âœ…âœ… MEDIA HTML SET EDÄ°LDÄ° MSG[${index}]:`, {
                            mediaHtmlLength: mediaHtml.length,
                            hasTextContent: !!textContent,
                            direction: msg.direction,
                            isSent: isSent,
                            computedStyle: window.getComputedStyle(msgContent).display,
                            innerHTMLLength: msgContent.innerHTML.length
                        });
                    }
                } else {
                    // âœ… DEBUG: Sadece gerÃ§ekten sorunlu mesajlarÄ± logla (text ve media yok)
                    if (index < 2 && !textContent && !fileUrl && !fileType) {
                        console.warn(`âš ï¸ Mesaj iÃ§eriÄŸi yok - MSG[${index}]:`, {
                            type: msg.type,
                            messageType,
                            isStory: !!(msg.isStory || msg.story || msg.isStoryReply)
                        });
                    }
                    msgContent.textContent = "Story'ne Cevap Verdi";
                }
                
                msgDiv.appendChild(msgContent);
                messagesList.appendChild(msgDiv);
            });
            
            // âœ… Scroll to bottom - EN YENÄ° MESAJLAR EN ALTTA (normal chat gibi)
            // messagesArea'ya scroll yap (messagesList'in parent'Ä±)
            const messagesArea = document.getElementById('messagesArea');
            const scrollContainer = messagesArea || messagesList;
            
            // âœ… EN YENÄ° MESAJLAR EN ALTTA olduÄŸu iÃ§in en alta scroll yap - GÃœÃ‡LÃœ VERSÄ°YON
            const scrollToBottom = () => {
                if (scrollContainer) {
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                }
            };
            
            // âœ… Hemen scroll yap (DOM gÃ¼ncellenmesi iÃ§in)
            requestAnimationFrame(() => {
                scrollToBottom();
                setTimeout(() => {
                    scrollToBottom();
                    setTimeout(() => {
                        scrollToBottom();
                        setTimeout(() => {
                            scrollToBottom();
                        }, 100);
                    }, 100);
                }, 50);
            });
        }
        
        // âœ… INFINITE SCROLL: YukarÄ± scroll yaptÄ±ÄŸÄ±nda eski mesajlarÄ± yÃ¼kle
        function setupInfiniteScroll(conversationId, conversation) {
            const messagesArea = document.getElementById('messagesArea');
            const scrollContainer = messagesArea || document.getElementById('messagesList');
            if (!scrollContainer) return;
            
            // Ã–nceki listener'Ä± kaldÄ±r
            const oldHandler = scrollContainer._infiniteScrollHandler;
            if (oldHandler) {
                scrollContainer.removeEventListener('scroll', oldHandler);
            }
            
            // Yeni scroll handler
            const scrollHandler = async () => {
                const loadState = window.messageLoadState?.[conversationId];
                if (!loadState || loadState.isLoading || !loadState.hasMore) {
                    return;
                }
                
                // âœ… YukarÄ± scroll yapÄ±ldÄ±ÄŸÄ±nda (scrollTop < 200px) eski mesajlarÄ± yÃ¼kle
                if (scrollContainer.scrollTop < 200) {
                    loadState.isLoading = true;
                    
                    try {
                        // âœ… API key'i al (infinite scroll iÃ§in)
                        const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                        const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                        const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                        
                        const offset = loadState.loadedCount;
                        // âœ… Channel filtreleme: VIP ve Hamzah iÃ§in WhatsApp gÃ¶ster
                        const senderStateScroll = getCurrentSenderState();
                        const showAllMessagesScroll = senderStateScroll.showAllMessages || {};
                        const shouldShowAllMessagesScroll = showAllMessagesScroll[conversationId] || false;
                        
                        const channelFilterTopScroll = document.getElementById('channelFilterTop');
                        const selectedSenderPhoneScroll = channelFilterTopScroll && channelFilterTopScroll.value ? channelFilterTopScroll.value : '';
                        let channelParamScroll = '';
                        // âœ… Sadece showAllMessages false ise channel filtreleme yap
                        if (!shouldShowAllMessagesScroll) {
                            if (selectedSenderPhoneScroll === '905421363421') {
                                // âœ… Hamzah seÃ§ildi - Sadece WhatsApp mesajlarÄ± gÃ¶ster
                                // âœ… NOT: Conversation'lar zaten backend'de doÄŸru kanala gÃ¶re filtrelenmiÅŸ geliyor
                                channelParamScroll = '&channel=whatsapp';
                            }
                            // âœ… VIP iÃ§in: TÃ¼m mesajlar filtrelenmeden gelsin (channel parametresi gÃ¶nderme)
                        }
                        // âœ… HIZLANDIRMA: Scroll'da daha fazla mesaj Ã§ek (15 -> 50)
                        const scrollUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=${offset}${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${channelParamScroll}`;
                        const response = await fetch(scrollUrl, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        const newMessages = data.messages || [];
                        
                        if (newMessages.length === 0) {
                            loadState.hasMore = false;
                            loadState.isLoading = false;
                            return;
                        }
                        
                        // âœ… EN ESKÄ° EN ÃœSTTE sÄ±rala
                        newMessages.sort((a, b) => {
                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                            return timeA - timeB;
                        });
                        
                        // âœ… Mevcut mesajlarÄ± state'ten al ve yeni mesajlarÄ± ÃœSTE ekle
                        const existingMessages = window.conversationsState?.loadedMessages?.[conversationId] || [];
                        
                        // âœ… Yeni mesajlarÄ± mevcut mesajlarÄ±n ÃœSTÃœNE ekle (eski mesajlar)
                        const allMessages = [...newMessages, ...existingMessages];
                        
                        // âœ… EN ESKÄ° EN ÃœSTTE, EN YENÄ° EN ALTTA sÄ±rala
                        allMessages.sort((a, b) => {
                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                            return timeA - timeB;
                        });
                        
                        // âœ… Scroll pozisyonunu koru (yeni mesajlar eklendiÄŸinde scroll kaymasÄ±n)
                        const oldScrollHeight = scrollContainer.scrollHeight;
                        const oldScrollTop = scrollContainer.scrollTop;
                        
                        // MesajlarÄ± render et
                        renderMessagesDirectly(allMessages, conversationId, conversation);
                        
                        // âœ… Scroll pozisyonunu koru
                        setTimeout(() => {
                            const newScrollHeight = scrollContainer.scrollHeight;
                            const scrollDiff = newScrollHeight - oldScrollHeight;
                            scrollContainer.scrollTop = oldScrollTop + scrollDiff;
                        }, 50);
                        
                        // State gÃ¼ncelle
                        if (!window.conversationsState.loadedMessages) {
                            window.conversationsState.loadedMessages = {};
                        }
                        window.conversationsState.loadedMessages[conversationId] = allMessages;
                        loadState.loadedCount = allMessages.length;
                        loadState.hasMore = newMessages.length >= 15;
                    } catch (error) {
                        console.error('Eski mesajlar yÃ¼klenirken hata:', error);
                    } finally {
                        loadState.isLoading = false;
                    }
                }
            };
            
            scrollContainer._infiniteScrollHandler = scrollHandler;
            scrollContainer.addEventListener('scroll', scrollHandler);
        }
        
        // âœ… Kanal ikonu SVG fonksiyonu
        function getChannelIconSvg(channel) {
            const channelLower = (channel || '').toLowerCase();
            
            if (channelLower.includes('whatsapp')) {
                return `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="24" height="24" rx="12" fill="#25D366"/>
                        <path d="M17.472 14.445c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="white"/>
                    </svg>
                `;
            } else if (channelLower.includes('instagram')) {
                const uniqueId = 'ig-' + Math.random().toString(36).substr(2, 9);
                return `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="${uniqueId}" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#833AB4;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#E1306C;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FCAF45;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="24" height="24" rx="12" fill="url(#${uniqueId})"/>
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.98-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.98-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" fill="white"/>
                    </svg>
                `;
            } else {
                return `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="24" height="24" rx="12" fill="#6366f1"/>
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="white"/>
                    </svg>
                `;
            }
        }
        
        // âœ… Direkt konuÅŸmalarÄ± render et (app.js yoksa bile Ã§alÄ±ÅŸÄ±r)
        function renderConversationsDirectly(conversations, showAll = false) {
            const list = document.getElementById('conversationsList');
            if (!list) {
                console.error('âŒ conversationsList elementi bulunamadÄ±!');
                return;
            }
            
            // âœ… State'i sender'a Ã¶zel olarak gÃ¼ncelle
            const senderState = getCurrentSenderState();
            senderState.allConversations = conversations;
            senderState.showAll = showAll;
            
            // âœ… Global state'i de gÃ¼ncelle (geriye dÃ¶nÃ¼k uyumluluk iÃ§in)
            window.conversationsState.allConversations = conversations;
            window.conversationsState.showAll = showAll;
            
            // âœ… YardÄ±mcÄ± fonksiyonlar - telefon normalize et
            const cleanPhone = (phone) => {
                return String(phone || '').replace(/\+/g, '').replace(/\s/g, '').replace(/-/g, '').replace(/\(/g, '').replace(/\)/g, '').trim();
            };
            
            const normalizePhoneForMatch = (phone) => {
                const digits = cleanPhone(phone);
                if (!digits) return '';
                return digits.length > 10 ? digits.slice(-10) : digits;
            };
            
            // âœ… KANAL FÄ°LTRELEME
            const channelFilter = document.getElementById('channelFilter');
            const channelFilterTop = document.getElementById('channelFilterTop');
            
            // âœ… Sender numarasÄ±na gÃ¶re filtreleme
            const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
            
            // âœ… Sender seÃ§ilmediyse uyarÄ± gÃ¶ster ve Ã§Ä±k
            if (!selectedSenderPhone) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“ YukarÄ±dan bir sender seÃ§in</p>
                        <p class="empty-hint">Choose Sender dropdown'Ä±ndan VIP veya Hamzah numarasÄ±nÄ± seÃ§in</p>
                    </div>
                `;
                return;
            }
            
            let filteredBySender = [];
            
            // âœ… KRITIK: Sender seÃ§ildiyse, sender'a gÃ¶re farklÄ± filtreleme mantÄ±ÄŸÄ± uygula
            if (selectedSenderPhone && selectedSenderPhone !== '') {
                const cleanSelectedPhone = cleanPhone(selectedSenderPhone);
                const clen = conversations.length;
                
                // âœ… Business numaralarÄ± listesi (FROM olarak kullanÄ±lan numaralar)
                const businessNumbers = ['908505327532', '905421363421'];
                const isVIP = cleanSelectedPhone === '908505327532';
                const isHamzah = cleanSelectedPhone === '905421363421';
                
                for (let i = 0; i < clen; i++) {
                    const conv = conversations[i];
                    // âœ… Conversation'dan FROM numarasÄ±nÄ± al
                    let convFromPhone = cleanPhone(conv.fromPhone || conv.from || '');
                    
                    // âœ… VIP iÃ§in: TÃ¼m conversation'larÄ± gÃ¶ster (hiÃ§bir filtreleme yok - fromPhone boÅŸ olanlar dahil)
                    // âœ… Hamzah iÃ§in: Sadece Hamzah'a ait conversation'larÄ± gÃ¶ster (strict filtering - fromPhone boÅŸ olanlar GÃ–STERÄ°LMEYECEK)
                    if (isVIP) {
                        // âœ… VIP: TÃœM conversation'larÄ± gÃ¶ster (filtreleme yok)
                        filteredBySender.push(conv);
                    } else if (isHamzah) {
                        // âœ… Hamzah: Backend'de channel parametresi ile Ã§ekildiÄŸi iÃ§in zaten doÄŸru conversation'lar gelmiÅŸ
                        // âœ… Sadece fromPhone kontrolÃ¼ yap (channel kontrolÃ¼ backend'de yapÄ±ldÄ±)
                        if (convFromPhone === cleanSelectedPhone || convFromPhone === '') {
                            filteredBySender.push(conv);
                        } else {
                            // âœ… fromPhone eÅŸleÅŸmiyorsa ATLA
                            if (i < 10) {
                                console.log('âš ï¸ Conversation FROM numarasÄ± Hamzah ile eÅŸleÅŸmiyor, atlanÄ±yor:', {
                                    conversationId: conv.conversationId || conv.id,
                                    fromPhone: convFromPhone || '(boÅŸ)',
                                    selectedSender: cleanSelectedPhone,
                                    contactName: conv.contactName
                                });
                            }
                        }
                    } else {
                        // âœ… DiÄŸer sender'lar iÃ§in: Sadece eÅŸleÅŸen conversation'larÄ± gÃ¶ster
                        if (convFromPhone && convFromPhone === cleanSelectedPhone) {
                            filteredBySender.push(conv);
                        }
                    }
                }
                
                const filterType = isVIP ? 'VIP: TÃ¼m conversation\'lar (fromPhone boÅŸ olanlar dahil)' : (isHamzah ? 'Hamzah: TÃ¼m conversation\'lar (channel kontrolÃ¼ backend\'de)' : 'DiÄŸer: Sadece eÅŸleÅŸen conversation\'lar');
                console.log(`âœ… Sender filtreleme: ${filteredBySender.length} conversation bulundu (seÃ§ili sender: ${cleanSelectedPhone}, toplam: ${clen}, ${filterType})`);
            }
            
            // âœ… Kanal filtreleme (VIP ve Hamzah iÃ§in Ã¶zel mantÄ±k)
            let selectedChannel = '';
            if (selectedSenderPhone === '908505327532') {
                // VIP seÃ§ildi - channelFilter'Ä±n deÄŸerini kullan (whatsapp)
                selectedChannel = (channelFilter && channelFilter.value) || '';
            } else if (selectedSenderPhone === '905421363421') {
                // âœ… Hamzah seÃ§ildi - Sadece WhatsApp gÃ¶ster (Instagram hariÃ§)
                selectedChannel = 'whatsapp';
            } else if (selectedSenderPhone) {
                // DiÄŸer sender seÃ§ildi - WhatsApp kanalÄ±nÄ± kullan (varsayÄ±lan)
                selectedChannel = 'whatsapp';
            } else {
                // HiÃ§bir sender seÃ§ilmedi - channelFilter'Ä± kullan
                selectedChannel = (channelFilter && channelFilter.value) || '';
            }
            
            let filteredByChannel = filteredBySender;
            
            // âœ… Channel filtreleme: VIP ve Hamzah iÃ§in WhatsApp gÃ¶ster (Instagram hariÃ§)
            if (selectedChannel && selectedChannel !== '') {
                const fc = selectedChannel.toLowerCase();
                filteredByChannel = [];
                const clen = filteredBySender.length;
                for (let i = 0; i < clen; i++) {
                    const conv = filteredBySender[i];
                    const ch = (conv.channel || conv.rawChannel || '').toLowerCase();
                    // âœ… WhatsApp filtreleme: Instagram ve Facebook hariÃ§
                    if (fc === 'whatsapp') {
                        if (ch.includes('whatsapp') && !ch.includes('instagram') && !ch.includes('facebook')) {
                            filteredByChannel.push(conv);
                        }
                    } else if (ch.includes(fc)) {
                        filteredByChannel.push(conv);
                    }
                }
            }
            
            // âœ… FULL_NAME'E GÃ–RE FÄ°LTRELEME
            const leadName = window.leadName || '';
            const leadPhoneForMatch = normalizePhoneForMatch(window.leadPhone || window.leadPhoneNumber || '');
            let filteredConversations = filteredByChannel;
            
            if (!showAll && leadName && leadName.trim() !== '') {
                console.log('ğŸ” Lead filtre debug', {
                    leadName,
                    leadPhoneForMatch,
                    sample: filteredByChannel.slice(0, 5).map(conv => ({
                        contactName: conv.contactName,
                        phoneNumber: conv.phoneNumber,
                        customerPhone: conv.customerPhone,
                        fromPhone: conv.fromPhone,
                        rawPhoneNumber: conv.rawPhoneNumber,
                        customerName: conv.customer?.name
                    }))
                });
                filteredConversations = filteredByChannel.filter(conv => {
                    const contactName = (conv.contactName || '').trim();
                    if (contactName && !/^(bilinmeyen|unknown)$/i.test(contactName)) {
                        return matchNames(leadName, contactName);
                    }
                    
                    if (leadPhoneForMatch) {
                        const phoneCandidates = [
                            conv.phoneNumber,
                            conv.customerPhone,
                            conv.toPhone,
                            conv.fromPhone,
                            conv.rawPhoneNumber,
                            conv._rawConversation?.userProfile?.phoneNumber,
                            conv._rawConversation?.userProfile?.phone,
                            conv._rawConversation?.customer?.phoneNumber,
                            conv._rawConversation?.customer?.phone,
                            conv._rawConversation?.whatsappCloudApiReceiver?.phoneNumber,
                            conv._rawConversation?.whatsappCloudApiReceiver?.whatsappChannelPhoneNumber
                        ];
                        
                        for (const candidate of phoneCandidates) {
                            const normalized = normalizePhoneForMatch(candidate);
                            if (normalized && normalized === leadPhoneForMatch) {
                                return true;
                            }
                        }
                    }
                    
                    return false;
                });
            }
            
            // âœ… Filtered conversations'Ä± sender'a Ã¶zel state'e kaydet
            senderState.filteredConversations = filteredConversations;
            window.conversationsState.filteredConversations = filteredConversations; // Geriye dÃ¶nÃ¼k uyumluluk
            
            // âœ… ULTRA HIZLI RENDER - DocumentFragment kullan
            const fragment = document.createDocumentFragment();
            
            if (filteredConversations.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“­ "${leadName}" ile konuÅŸma bulunamadÄ±</p>
                        <p class="empty-hint">TÃ¼m konuÅŸmalarÄ± gÃ¶rmek iÃ§in butona tÄ±klayÄ±n</p>
                    </div>
                `;
                
                if (filteredBySender.length > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.style.cssText = 'width: 100%; margin-top: 15px; padding: 12px; cursor: pointer; font-weight: 600;';
                    btn.textContent = `ğŸ“‹ TÃ¼m KonuÅŸmalarÄ± GÃ¶ster (${filteredBySender.length} konuÅŸma)`;
                    btn.onclick = () => {
                        senderState.showAll = true;
                        window.conversationsState.showAll = true; // Geriye dÃ¶nÃ¼k uyumluluk
                        renderConversationsDirectly(filteredBySender, true);
                    };
                    fragment.appendChild(btn);
                }
                list.innerHTML = '';
                list.appendChild(fragment);
                return;
            }
            
            // âœ… ULTRA HIZLI RENDER - for loop + DocumentFragment
            const len = filteredConversations.length;
            for (let i = 0; i < len; i++) {
                const conv = filteredConversations[i];
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.style.cssText = 'display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;';
                
                item.onmouseenter = () => item.style.backgroundColor = '#f3f4f6';
                item.onmouseleave = () => item.style.backgroundColor = '';
                
                const channel = conv.channel || 'WhatsApp';
                
                const contactName = conv.contactName || 'Bilinmeyen';
                
                // âœ… Son mesaj preview - her zaman sadece "Mesaj" yaz
                let lastMessagePreview = 'Mesaj';
                
                const lastMessageTime = conv.lastMessageTime ? new Date(conv.lastMessageTime).toLocaleDateString('tr-TR') : '';
                const channelIconSvg = getChannelIconSvg(channel);
                
                // âœ… OkunmamÄ±ÅŸ mesaj sayÄ±sÄ± - Ã–NCE state'teki deÄŸeri kullan (mesaj aÃ§Ä±ldÄ±ÄŸÄ±nda 0 olur), yoksa API'den gelen deÄŸeri
                const convId = conv.conversationId || conv.id;
                const unreadCount = window.conversationsState.unreadCounts[convId] !== undefined 
                    ? window.conversationsState.unreadCounts[convId] 
                    : (conv.unreadCount || 0);
                const unreadBadge = unreadCount > 0 ? `
                    <div style="position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 10px; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; padding: 0 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;">
                        ${unreadCount > 99 ? '99+' : unreadCount}
                    </div>
                ` : '';
                
                item.innerHTML = `
                    <div style="position: relative; width: 40px; height: 40px; margin-right: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${contactName.substring(0, 2).toUpperCase()}
                        </div>
                        <div style="position: absolute; bottom: -2px; right: -2px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${channelIconSvg}
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <div class="conversation-name" style="font-weight: 600; color: #111827; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${contactName}</div>
                        </div>
                        <div class="conversation-preview" style="font-size: 13px; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lastMessagePreview}</div>
                    </div>
                    <div style="position: relative; font-size: 12px; color: #9ca3af; margin-left: 12px; white-space: nowrap; padding-right: ${unreadCount > 0 ? '8px' : '0'};">
                        ${lastMessageTime}
                        ${unreadBadge}
                    </div>
                `;
                
                item.onclick = async () => {
                    const convId = conv.conversationId || conv.id;
                    if (!convId) return;
                    
                    // âœ… Current conversation ID'yi kaydet (sender'a Ã¶zel state'e)
                    const senderState = getCurrentSenderState();
                    senderState.currentConversationId = convId;
                    window.conversationsState.currentConversationId = convId; // Geriye dÃ¶nÃ¼k uyumluluk
                    
                    // âœ… Ã–NCE mesajlarÄ± yÃ¼kle (chat view'Ä± gÃ¶ster)
                    await loadMessagesDirectly(convId);
                    
                    // âœ… SONRA okunmamÄ±ÅŸ mesaj sayÄ±sÄ±nÄ± sÄ±fÄ±rla ve badge'i gÃ¼ncelle
                    if (window.conversationsState.unreadCounts[convId]) {
                        window.conversationsState.unreadCounts[convId] = 0;
                        
                        // âœ… KRITIK: Son mesaj ID'sini gÃ¼ncelle (polling tekrar aynÄ± mesajÄ± "yeni" olarak gÃ¶rmesin)
                        const loadedMsgs = window.conversationsState.loadedMessages?.[convId] || [];
                        if (loadedMsgs.length > 0) {
                            const lastMsg = loadedMsgs[loadedMsgs.length - 1];
                            const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                            if (lastMsgId) {
                                if (!lastMessageCount) {
                                    lastMessageCount = {};
                                }
                                lastMessageCount[convId + '_latest'] = lastMsgId;
                                saveLastMessageCounts();
                            }
                        }
                        
                        // KonuÅŸma listesini gÃ¼ncelle (badge'i kaldÄ±rmak iÃ§in)
                        const conversations = window.conversationsState.allConversations || [];
                        const showAll = window.conversationsState.showAll || false;
                        renderConversationsDirectly(conversations, showAll);
                    } else {
                        // âœ… Badge yoksa bile son mesaj ID'sini gÃ¼ncelle (ilk aÃ§Ä±lÄ±ÅŸta)
                        const loadedMsgs = window.conversationsState.loadedMessages?.[convId] || [];
                        if (loadedMsgs.length > 0) {
                            const lastMsg = loadedMsgs[loadedMsgs.length - 1];
                            const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                            if (lastMsgId) {
                                if (!lastMessageCount) {
                                    lastMessageCount = {};
                                }
                                lastMessageCount[convId + '_latest'] = lastMsgId;
                            }
                        }
                    }
                    
                    // Polling baÅŸlat (eÄŸer baÅŸlamamÄ±ÅŸsa)
                    if (!messagePollInterval && typeof startMessagePolling === 'function') {
                        startMessagePolling();
                    }
                };
                fragment.appendChild(item);
            }
            
            // âœ… TÃ¼m konuÅŸmalarÄ± gÃ¶ster butonu (filtrelenmiÅŸ modda)
            if (!showAll && conversations.length > filteredConversations.length) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.style.cssText = 'width: 100%; margin-top: 15px; padding: 12px; cursor: pointer; font-weight: 600;';
                btn.textContent = `ğŸ“‹ TÃ¼m KonuÅŸmalarÄ± GÃ¶ster (${conversations.length} konuÅŸma)`;
                btn.onclick = () => {
                    window.conversationsState.showAll = true;
                    renderConversationsDirectly(conversations, true);
                };
                fragment.appendChild(btn);
            }
            
            // âœ… Tek seferde DOM'a ekle
            list.innerHTML = '';
            list.appendChild(fragment);
            
            // âœ… KRITIK: EÄŸer search input'unda bir deÄŸer varsa, filtrelemeyi tekrar uygula
            const searchInput = document.getElementById('searchConversations');
            if (searchInput && searchInput.value.trim() !== '') {
                // Search input'unda deÄŸer var - filtrelemeyi tetikle
                const event = new Event('input', { bubbles: true });
                searchInput.dispatchEvent(event);
            }
        }
    </script>
    
    <!-- Main App JavaScript -->
    <script src="/app.js"></script>
    <script>
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            
            sidebar.classList.toggle('open');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            return false;
        };

        window.openSidebarNow = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            sidebar.classList.add('open');
            sidebar.style.setProperty('left', '0', 'important');
            sidebar.style.setProperty('opacity', '1', 'important');
            sidebar.style.setProperty('visibility', 'visible', 'important');
            sidebar.style.setProperty('display', 'flex', 'important');
            sidebar.style.setProperty('z-index', '10000', 'important');
            document.body.style.overflow = 'hidden';
            localStorage.setItem('sidebarClosed', 'false');
            return false;
        };

        window.closeSidebarNow = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            sidebar.classList.remove('open');
            sidebar.style.left = '-320px';
            sidebar.style.opacity = '0';
            sidebar.style.visibility = 'hidden';
            document.body.style.overflow = '';
            localStorage.setItem('sidebarClosed', 'true');
            return false;
        };

        // Search function
        function setupWidgetSearch() {
            const searchInput = document.getElementById('searchConversations');
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                const normalizeText = (text) => {
                    if (!text) return '';
                    // âœ… Ã–NCE TÃœRKÃ‡E KARAKTERLERÄ° MANUEL Ã‡EVÄ°R (toLowerCase locale-aware deÄŸil)
                    let normalized = text
                        .replace(/Ä°/g, 'i')
                        .replace(/I/g, 'Ä±')
                        .replace(/Ä/g, 'ÄŸ')
                        .replace(/Ãœ/g, 'Ã¼')
                        .replace(/Å/g, 'ÅŸ')
                        .replace(/Ã–/g, 'Ã¶')
                        .replace(/Ã‡/g, 'Ã§')
                        .toLowerCase() // Åimdi kÃ¼Ã§Ã¼k harfe Ã§evir
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Diyakritik iÅŸaretleri kaldÄ±r
                        .replace(/Ä±/g, 'i') // Son olarak Ä±'yÄ± i'ye Ã§evir (tam eÅŸleÅŸme iÃ§in)
                        .replace(/ÄŸ/g, 'g')
                        .replace(/Ã¼/g, 'u')
                        .replace(/ÅŸ/g, 's')
                        .replace(/Ã¶/g, 'o')
                        .replace(/Ã§/g, 'c');
                    return normalized;
                };
                
                const search = normalizeText(e.target.value.trim());
                const items = document.querySelectorAll('.conversation-item');
                
                if (search === '') {
                    // âœ… BoÅŸsa tÃ¼m item'larÄ± gÃ¶ster
                    items.forEach(item => {
                        item.style.display = 'flex';
                    });
                    return;
                }
                
                items.forEach(item => {
                    const nameEl = item.querySelector('.conversation-name');
                    const previewEl = item.querySelector('.conversation-preview');
                    
                    if (!nameEl) {
                        item.style.display = 'none';
                        return;
                    }
                    
                    const name = normalizeText(nameEl.textContent.trim());
                    const preview = previewEl ? normalizeText(previewEl.textContent.trim()) : '';
                    
                    // âœ… Ä°sim veya mesaj Ã¶nizlemesinde ara (case-insensitive, TÃ¼rkÃ§e karakter desteÄŸi ile)
                    const matches = name.includes(search) || preview.includes(search);
                    item.style.display = matches ? 'flex' : 'none';
                });
            });
        }

        // DOM ready
        // âœ… Kanal filtreleme event listener
        function setupChannelFilter() {
            const channelFilter = document.getElementById('channelFilter');
            if (channelFilter) {
                channelFilter.onchange = function() {
                    const conversations = window.conversationsState.allConversations || [];
                    const showAll = window.conversationsState.showAll || false;
                    renderConversationsDirectly(conversations, showAll);
                };
            }
            
            // âœ… CHOOSE SENDER dropdown filtreleme
            const channelFilterTop = document.getElementById('channelFilterTop');
            if (channelFilterTop) {
                channelFilterTop.onchange = async function() {
                    const selectedValue = channelFilterTop.value;
                    
                    // âœ… KRITIK: Sender deÄŸiÅŸtiÄŸinde UI'Ä± temizle ve yeni sender iÃ§in conversation'larÄ± yÃ¼kle
                    console.log('ğŸ”„ Sender deÄŸiÅŸti, yeni sender iÃ§in conversation\'lar yÃ¼kleniyor:', selectedValue);
                    
                    // âœ… 1. Mevcut conversation'Ä± temizle
                    const messagesList = document.getElementById('messagesList');
                    if (messagesList) {
                        messagesList.innerHTML = '';
                    }
                    
                    // âœ… 2. Chat aktif alanÄ±nÄ± temizle
                    const chatActive = document.getElementById('chatActive');
                    if (chatActive) {
                        chatActive.style.display = 'none';
                    }
                    const chatEmpty = document.getElementById('chatEmpty');
                    if (chatEmpty) {
                        chatEmpty.style.display = 'flex';
                    }
                    
                    // âœ… 3. Conversation listesini temizle
                    const conversationsList = document.getElementById('conversationsList');
                    if (conversationsList) {
                        conversationsList.innerHTML = '<div class="empty-state"><p>ğŸ“­ YÃ¼kleniyor...</p></div>';
                    }
                    
                    // âœ… 4. State'i yeni sender iÃ§in ayarla
                    const senderState = getCurrentSenderState();
                    senderState.currentConversationId = null;
                    senderState.showAll = false;
                    senderState.filteredConversations = [];
                    if (window.conversationsState) {
                        window.conversationsState.showAll = false;
                        window.conversationsState.filteredConversations = [];
                    }
                    
                    // âœ… 5. Sender seÃ§ildiÄŸinde WhatsApp filtresini aktif et
                    const channelFilter = document.getElementById('channelFilter');
                    if (selectedValue && selectedValue !== '') {
                        // Sender seÃ§ildi - WhatsApp filtresini set et
                        if (channelFilter) {
                            channelFilter.value = 'whatsapp';
                        }
                        
                        // âœ… KRITIK: Sender seÃ§ildiÄŸinde conversation'larÄ± YENÄ°DEN Ã‡EK (sadece o sender'a ait olanlar)
                        try {
                            const savedApiKey = localStorage.getItem('sleekflowApiKey') || '';
                            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                            
                            // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in)
                            await getCurrentZohoUser();
                            
                            // âœ… SeÃ§ili sender'Ä± fromPhone olarak gÃ¶nder (backend'de filtreleme iÃ§in)
                            const fromPhoneParam = selectedValue ? `&fromPhone=${encodeURIComponent(selectedValue)}` : '';
                            
                            if (savedApiKey && savedApiKey.trim().length >= 10) {
                                let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                                convUrl = addUserParamsToUrl(convUrl);
                                const convResponse = await fetch(convUrl, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                if (convResponse.ok) {
                                    const convData = await convResponse.json();
                                    const conversations = convData.conversations || [];
                                    
                                    // âœ… Conversation'larÄ± sender'a Ã¶zel state'e kaydet ve render et
                                    senderState.allConversations = conversations;
                                    senderState.showAll = false;
                                    renderConversationsDirectly(conversations, false);
                                    console.log('âœ… Conversation\'lar yÃ¼klendi ve render edildi:', conversations.length);
                                } else {
                                    console.error('âŒ Conversation\'lar yÃ¼klenemedi:', convResponse.status);
                                }
                            } else {
                                console.warn('âš ï¸ SleekFlow API key bulunamadÄ±');
                            }
                        } catch (error) {
                            console.error('âŒ Conversation\'lar yÃ¼klenirken hata:', error);
                        }
                    } else if (selectedValue === '') {
                        // Choose Sender seÃ§ildi - filtreyi temizle
                        if (channelFilter) {
                            channelFilter.value = '';
                        }
                        
                        // âœ… TÃ¼m conversation'larÄ± yÃ¼kle
                        try {
                            const savedApiKey = localStorage.getItem('sleekflowApiKey') || '';
                            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                            
                            // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in)
                            await getCurrentZohoUser();
                            
                            if (savedApiKey && savedApiKey.trim().length >= 10) {
                                let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                convUrl = addUserParamsToUrl(convUrl);
                                const convResponse = await fetch(convUrl, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                if (convResponse.ok) {
                                    const convData = await convResponse.json();
                                    const conversations = convData.conversations || [];
                                    
                                    // âœ… Conversation'larÄ± default state'e kaydet ve render et
                                    senderState.allConversations = conversations;
                                      senderState.showAll = false;
                                      renderConversationsDirectly(conversations, false);
                                    console.log('âœ… TÃ¼m conversation\'lar yÃ¼klendi:', conversations.length);
                                } else {
                                    console.error('âŒ Conversation\'lar yÃ¼klenemedi:', convResponse.status);
                                }
                            } else {
                                console.warn('âš ï¸ SleekFlow API key bulunamadÄ±');
                            }
                        } catch (error) {
                            console.error('âŒ Conversation\'lar yÃ¼klenirken hata:', error);
                        }
                    }
                };
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setupChannelFilter();
            
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                // Sidebar her zaman aÃ§Ä±k baÅŸla
                if (sidebar) {
                    sidebar.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            const openBtn = document.getElementById('openSidebar');
            const closeBtn = document.getElementById('toggleSidebar');

            if (openBtn) {
                openBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.toggleSidebar();
                    return false;
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.toggleSidebar();
                    return false;
                });
            }

            setupWidgetSearch();
            
            // âœ… SAYFA YÃœKLENÄ°RKEN VERÄ°LERÄ° Ã‡EK (kullanÄ±cÄ± fark etmez)
            const savedApiKey = localStorage.getItem('sleekflowApiKey');
            const savedConnected = localStorage.getItem('sleekflowConnected');
            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
            
            if (savedApiKey && savedApiKey.trim().length >= 10 && savedConnected === 'true') {
                // âœ… ARKA PLANDA TÃœM VERÄ°LERÄ° Ã‡EK (kullanÄ±cÄ± fark etmez)
                // 1. KonuÅŸmalarÄ± Ã§ek
                // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in) - async olarak
                getCurrentZohoUser().then(() => {
                    // âœ… SeÃ§ili sender'Ä± fromPhone olarak gÃ¶nder (eÄŸer varsa)
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                    const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                    
                    let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                    convUrl = addUserParamsToUrl(convUrl);
                    fetch(convUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(r => r.json())
                .then(data => {
                    const conversations = data.conversations || [];
                    if (conversations.length > 0) {
                        // âœ… KRITIK: API'den gelen unreadCount deÄŸerlerini state'e kaydet
                        // AMA: Ã–nceden okunan conversation'lar iÃ§in unreadCount'u 0 yap (sayfa yenilendiÄŸinde badge tekrar gelmesin)
                        conversations.forEach(conv => {
                            const convId = conv.conversationId || conv.id;
                            if (convId) {
                                // EÄŸer bu conversation Ã¶nceden okunmuÅŸsa, unreadCount'u 0 yap
                                if (readConversations.has(convId)) {
                                    window.conversationsState.unreadCounts[convId] = 0;
                                    conv.unreadCount = 0; // Conversation objesini de gÃ¼ncelle
                                } else if (conv.unreadCount && conv.unreadCount > 0) {
                                    if (!window.conversationsState.unreadCounts[convId]) {
                                        window.conversationsState.unreadCounts[convId] = 0;
                                    }
                                    // API'den gelen unreadCount'u kullan (SleekFlow'un kendi sayÄ±sÄ±)
                                    window.conversationsState.unreadCounts[convId] = conv.unreadCount;
                                }
                            }
                        });
                        
                        // âœ… KonuÅŸmalarÄ± HEMEN render et (mesaj yÃ¼klemesini engelleme)
                        const showAll = window.conversationsState.showAll || false;
                        renderConversationsDirectly(conversations, showAll);
                        
                        // âœ… Polling baÅŸlat
                        if (typeof startMessagePolling === 'function') {
                            startMessagePolling();
                        }
                        
                        // âœ… ARKA PLANDA badge sayÄ±larÄ±nÄ± hesapla (mesaj yÃ¼klemesini engellemez)
                        setTimeout(() => {
                            conversations.slice(0, 20).forEach((conv, idx) => {
                                const convId = conv.conversationId || conv.id;
                                if (!convId) return;
                                
                                // Her konuÅŸma iÃ§in kÄ±sa bir gecikme ile (rate limiting)
                                setTimeout(() => {
                                    const msgUrl = `/api/sleekflow/conversations/${convId}/messages?limit=1&offset=0&apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                    fetch(msgUrl, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    })
                                    .then(r => r.json())
                                    .then(msgData => {
                                        const msgs = msgData.messages || [];
                                        if (msgs.length > 0) {
                                            const latestMsg = msgs[0];
                                            const latestMsgId = latestMsg.id || latestMsg.timestamp || latestMsg.messageId;
                                            const prevLatestMsgId = lastMessageCount[convId + '_latest'];
                                            
                                            // âœ… EÄŸer yeni mesaj varsa ve received ise badge artÄ±r
                                            if (latestMsgId && latestMsgId !== prevLatestMsgId) {
                                                const isSent = latestMsg.direction === 'sent' || 
                                                              latestMsg.isSentFromSleekflow === true ||
                                                              latestMsg.isSentFromSleekflow === 'true' ||
                                                              latestMsg.direction === 'outgoing';
                                                
                                                // âœ… GEVÅETÄ°LMÄ°Å KONTROL: direction !== 'sent' ve isSentFromSleekflow !== true ise received kabul et
                                                const isReceived = !isSent && (
                                                    latestMsg.direction === 'received' || 
                                                    latestMsg.direction === 'incoming' ||
                                                    (latestMsg.direction !== 'sent' && latestMsg.isSentFromSleekflow !== true && latestMsg.isSentFromSleekflow !== 'true')
                                                );
                                                
                                                if (isReceived) {
                                                    // Sadece karÅŸÄ±dan gelen mesajlar iÃ§in badge artÄ±r
                                                    if (!window.conversationsState.unreadCounts[convId]) {
                                                        window.conversationsState.unreadCounts[convId] = 0;
                                                    }
                                                    window.conversationsState.unreadCounts[convId] += 1;
                                                    console.log('âœ… Sayfa yÃ¼klenirken badge artÄ±rÄ±ldÄ±:', { convId, unreadCount: window.conversationsState.unreadCounts[convId] });
                                                }
                                                
                                                // Son mesaj ID'sini gÃ¼ncelle
                                                lastMessageCount[convId + '_latest'] = latestMsgId;
                                                saveLastMessageCounts();
                                                
                                                // KonuÅŸma listesini gÃ¼ncelle (badge gÃ¶sterimi iÃ§in)
                                                const allConvs = window.conversationsState.allConversations || conversations || [];
                                                const currentShowAll = window.conversationsState.showAll || showAll || false;
                                                renderConversationsDirectly(allConvs, currentShowAll);
                                            } else if (!prevLatestMsgId && latestMsgId) {
                                                // Ä°lk yÃ¼kleme - sadece ID'yi kaydet
                                                lastMessageCount[convId + '_latest'] = latestMsgId;
                                                saveLastMessageCounts();
                                            }
                                        }
                                    })
                                    .catch(() => {});
                                }, idx * 50); // Her konuÅŸma iÃ§in 50ms gecikme (rate limiting)
                            });
                        }, 300); // 300ms sonra arka planda baÅŸlat (mesaj yÃ¼klemesini engellemez)
                        
                        // âœ… ARKA PLANDA Ä°LK 5 KONUÅMANIN MESAJLARINI Ã‡EK (kullanÄ±cÄ± fark etmez)
                        const topConversations = conversations.slice(0, 5);
                        topConversations.forEach((conv, idx) => {
                            const convId = conv.conversationId || conv.id;
                            if (!convId) return;
                            
                            // Her konuÅŸma iÃ§in kÄ±sa bir gecikme ile (rate limiting)
                            setTimeout(() => {
                                const msgUrl = `/api/sleekflow/conversations/${convId}/messages?limit=10&offset=0&apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                fetch(msgUrl, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                })
                                .then(r => r.json())
                                .then(msgData => {
                                    const msgs = msgData.messages || [];
                                    if (msgs.length > 0) {
                                        // State'te sakla (kullanÄ±cÄ± tÄ±klayÄ±nca hemen gÃ¶rÃ¼nsÃ¼n)
                                        if (!window.conversationsState.loadedMessages) {
                                            window.conversationsState.loadedMessages = {};
                                        }
                                        msgs.sort((a, b) => {
                                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                            return timeA - timeB;
                                        });
                                        window.conversationsState.loadedMessages[convId] = msgs;
                                        
                                        // âœ… Son mesaj ID'sini gÃ¼ncelle
                                        const lastMsg = msgs[msgs.length - 1];
                                        const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                                        if (lastMsgId) {
                                            lastMessageCount[convId + '_latest'] = lastMsgId;
                                            saveLastMessageCounts();
                                        }
                                    }
                                })
                                .catch(() => {});
                            }, idx * 200); // Her konuÅŸma iÃ§in 200ms gecikme (rate limiting)
                        });
                    }
                })
                .catch(() => {});
                
                // âœ… 2. TEMPLATE'LERÄ° Ã‡EK (kullanÄ±cÄ± fark etmez)
                setTimeout(() => {
                    const templatesUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    fetch(templatesUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(r => r.json())
                    .then(templatesData => {
                        const templates = templatesData.templates || [];
                        if (templates.length > 0) {
                            // âœ… Templates'Ä± order'a gÃ¶re sÄ±rala
                            templates.sort((a, b) => (a.order || 0) - (b.order || 0));
                            // âœ… Global deÄŸiÅŸkende sakla (modal aÃ§Ä±ldÄ±ÄŸÄ±nda hemen gÃ¶sterilsin)
                            window.cachedTemplates = templates;
                            console.log(`âœ… ${templates.length} template arka planda yÃ¼klendi`);
                        }
                    })
                    .catch(() => {
                        // Sessizce geÃ§
                    });
                }, 300); // 300ms sonra template'leri Ã§ek
                });
            }
        });
        
        // âœ… Templates modal fonksiyonlarÄ±
        setupTemplatesModal();
        
        // âœ… Templates modal fonksiyonlarÄ±
        function setupTemplatesModal() {
            const openTemplatesBtn = document.getElementById('openTemplates');
            const closeTemplatesModal = document.getElementById('closeTemplatesModal');
            const templatesModal = document.getElementById('templatesModal');
            const templateSearch = document.getElementById('templateSearch');
            const newTemplateBtn = document.getElementById('newTemplate');
            
            // Templates butonuna tÄ±klandÄ±ÄŸÄ±nda modal'Ä± aÃ§
            if (openTemplatesBtn) {
                openTemplatesBtn.onclick = function() {
                    if (templatesModal) {
                        templatesModal.style.display = 'block';
                        loadTemplates();
                    } else {
                        console.error('âŒ templatesModal bulunamadÄ±!');
                    }
                };
            } else {
                console.error('âŒ openTemplatesBtn bulunamadÄ±!');
            }
            
            // Modal'Ä± kapat
            if (closeTemplatesModal) {
                closeTemplatesModal.onclick = function() {
                    if (templatesModal) {
                        templatesModal.style.display = 'none';
                    }
                };
            }
            
            // Modal dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda kapat
            if (templatesModal) {
                templatesModal.onclick = function(e) {
                    if (e.target === templatesModal) {
                        templatesModal.style.display = 'none';
                    }
                };
            }
            
            // Template arama
            if (templateSearch) {
                templateSearch.oninput = function(e) {
                    filterTemplates(e.target.value);
                };
            }
            
            // New Template modal aÃ§/kapat ve kaydet
            const newTemplateModal = document.getElementById('newTemplateModal');
            const saveNewTemplate = document.getElementById('saveNewTemplate');
            const cancelNewTemplate = document.getElementById('cancelNewTemplate');
            const nameInput = document.getElementById('newTemplateName');
            const contentInput = document.getElementById('newTemplateContent');
            const typeInput = document.getElementById('newTemplateType');
            
            function openNewTemplateModal() {
                if (newTemplateModal) newTemplateModal.style.display = 'block';
                if (nameInput) nameInput.value = '';
                if (contentInput) contentInput.value = '';
                if (typeInput) typeInput.value = 'cloudapi';
            }
            function closeNewTemplateModal() {
                if (newTemplateModal) newTemplateModal.style.display = 'none';
            }
            
            if (newTemplateBtn) {
                newTemplateBtn.onclick = function() {
                    openNewTemplateModal();
                };
            }
            if (cancelNewTemplate) {
                cancelNewTemplate.onclick = function() {
                    closeNewTemplateModal();
                };
            }
            if (newTemplateModal) {
                newTemplateModal.onclick = function(e) {
                    if (e.target === newTemplateModal) closeNewTemplateModal();
                };
            }
            if (saveNewTemplate) {
                saveNewTemplate.onclick = async function() {
                    const nameVal = (nameInput?.value || '').trim();
                    const contentVal = (contentInput?.value || '').trim();
                    const typeVal = (typeInput?.value || 'cloudapi').trim();
                    
                    if (!nameVal || !contentVal) {
                        alert('Name ve content gerekli');
                        return;
                    }
                    
                    // âœ… TÃ¼m template tipleri iÃ§in backend'e kaydetmeyi dene
                    try {
                        const savedApiKey = localStorage.getItem('sleekflowApiKey');
                        const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                        const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                        
                        if (!savedApiKey || savedApiKey.trim().length < 10) {
                            alert('SleekFlow baÄŸlantÄ±sÄ± yok. LÃ¼tfen Ã¶nce baÄŸlanÄ±n.');
                            return;
                        }
                        
                        let saveUrl = '';
                        let payload = {};
                        
                        if (typeVal === 'quick-reply') {
                            // âœ… Quick-reply iÃ§in direkt kaydet
                            saveUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            payload = {
                                name: nameVal,
                                text: contentVal,
                                order: 0
                            };
                        } else if (typeVal === 'cloudapi') {
                            // âœ… Cloud API template iÃ§in channelNumber gerekli
                            const channelFilterTop = document.getElementById('channelFilterTop');
                            const channelNumber = (channelFilterTop && channelFilterTop.value) ? channelFilterTop.value : '908505327532'; // Default VIP
                            
                            saveUrl = `/api/sleekflow/cloudapi-templates?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}&channelNumber=${encodeURIComponent(channelNumber)}`;
                            payload = {
                                name: nameVal,
                                content: contentVal,
                                category: 'UTILITY',
                                language: 'en_US'
                            };
                        } else if (typeVal === 'whatsapp') {
                            // âœ… WhatsApp template'leri iÃ§in de quick-reply olarak kaydet (WhatsApp template'leri Meta Ã¼zerinden yÃ¶netilir)
                            saveUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            payload = {
                                name: nameVal,
                                text: contentVal,
                                order: 0
                            };
                        } else {
                            // âœ… Bilinmeyen tip iÃ§in quick-reply olarak kaydet
                            saveUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            payload = {
                                name: nameVal,
                                text: contentVal,
                                order: 0
                            };
                        }
                        
                        // âœ… Backend'e kaydet
                        const response = await fetch(saveUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'Template kaydedilemedi');
                        }
                        
                        // âœ… BaÅŸarÄ±lÄ± - Template'leri yeniden yÃ¼kle
                        alert('Template kaydedildi');
                        loadTemplates(); // Template'leri yeniden yÃ¼kle
                        
                        // âœ… Form'u temizle ve gizle
                        closeNewTemplateModal();
                        
                    } catch (error) {
                        console.error('Template kaydetme hatasÄ±:', error);
                        alert('Template kaydedilemedi: ' + error.message);
                    }
                };
            }
        }
        
        // âœ… Templates yÃ¼kleme fonksiyonu - Ã–NCE CACHE KONTROL ET, SONRA API'DEN Ã‡EK
        async function loadTemplates() {
            console.log('ğŸ”µğŸ”µğŸ”µ loadTemplates FONKSIYONU Ã‡AÄRILDI!');
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) {
                console.error('âŒ templatesList bulunamadÄ±!');
                return;
            }
            
            // âœ… Ã–NCE CACHE KONTROL ET - EÄŸer cache varsa gÃ¶ster, sonra arka planda gÃ¼ncelle
            if (window.cachedTemplates && Array.isArray(window.cachedTemplates) && window.cachedTemplates.length > 0) {
                console.log('âœ… Cache\'den template\'ler gÃ¶steriliyor:', window.cachedTemplates.length);
                renderTemplates(window.cachedTemplates);
                // Arka planda gÃ¼ncelleme yapÄ±lacak (aÅŸaÄŸÄ±da)
            } else {
                templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">YÃ¼kleniyor...</div>';
            }
            
            try {
                // âœ… API key ve baseUrl'i localStorage'dan al
                const savedApiKey = localStorage.getItem('sleekflowApiKey');
                const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                
                if (!savedApiKey || savedApiKey.trim().length < 10) {
                    templatesList.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">SleekFlow baÄŸlantÄ±sÄ± yok. LÃ¼tfen Ã¶nce baÄŸlanÄ±n.</div>';
                    return;
                }
                
                // âœ… SleekFlow API'den hem quick-replies hem de WhatsApp / Cloud API template'lerini Ã§ek
                const quickRepliesUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                const whatsappTemplatesUrl = `/api/sleekflow/whatsapp-templates?apiKey=${encodeURIComponent(savedApiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                
                // Channel number (Cloud API) â€“ seÃ§ili sender'dan veya boÅŸ
                const channelFilterTop = document.getElementById('channelFilterTop');
                const channelNumber = (channelFilterTop && channelFilterTop.value) ? channelFilterTop.value : '';
                console.log('ğŸ“± Channel number kontrolÃ¼:', { 
                    channelFilterTop: channelFilterTop ? 'var' : 'yok',
                    channelNumber: channelNumber,
                    dropdownValue: channelFilterTop ? channelFilterTop.value : 'yok'
                });
                
                // âœ… Cloud API iÃ§in channelNumber zorunlu - eÄŸer yoksa VIP numarasÄ±nÄ± kullan
                const finalChannelNumber = channelNumber || '908505327532'; // VIP numarasÄ± default
                const cloudApiTemplatesUrl = `/api/sleekflow/cloudapi-templates?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}&channelNumber=${encodeURIComponent(finalChannelNumber)}`;
                
                console.log('â˜ï¸ Cloud API templates URL:', cloudApiTemplatesUrl);
                
                const fetchers = [
                    fetch(quickRepliesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } }),
                    fetch(whatsappTemplatesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } }),
                    fetch(cloudApiTemplatesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                ];
                
                console.log('ğŸ”„ Template\'ler yÃ¼kleniyor...', { 
                    quickRepliesUrl, 
                    whatsappTemplatesUrl, 
                    cloudApiTemplatesUrl,
                    channelNumber: finalChannelNumber
                });
                
                console.log('ğŸ“¡ 3 API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor:', fetchers.length);
                
                const responses = await Promise.allSettled(fetchers);
                
                console.log('ğŸ“¥ API yanÄ±tlarÄ± alÄ±ndÄ±:', responses.length, responses.map((r, i) => ({
                    index: i,
                    status: r.status,
                    ok: r.status === 'fulfilled' ? r.value.ok : null,
                    statusCode: r.status === 'fulfilled' ? r.value.status : null
                })));
                
                let allTemplates = [];
                
                let idx = 0;
                const quickRepliesResponse = responses[idx++];
                const whatsappTemplatesResponse = responses[idx++];
                const cloudApiTemplatesResponse = responses[idx++];
                
                // âœ… Quick-replies'larÄ± iÅŸle
                if (quickRepliesResponse && quickRepliesResponse.status === 'fulfilled' && quickRepliesResponse.value.ok) {
                    const quickRepliesData = await quickRepliesResponse.value.json();
                    const quickReplies = (quickRepliesData.templates || []).map(t => ({
                        ...t,
                        type: 'quick-reply' // Quick-reply olduÄŸunu belirt
                    }));
                    console.log('âœ… Quick-replies yÃ¼klendi:', quickReplies.length);
                    allTemplates = allTemplates.concat(quickReplies);
                } else if (quickRepliesResponse && quickRepliesResponse.status === 'fulfilled' && !quickRepliesResponse.value.ok) {
                    const errorData = await quickRepliesResponse.value.json().catch(() => ({}));
                    console.warn('âŒ Quick-replies API hatasÄ±:', errorData.error || 'Bilinmeyen hata', quickRepliesResponse.value.status);
                } else if (quickRepliesResponse && quickRepliesResponse.status === 'rejected') {
                    console.warn('âŒ Quick-replies yÃ¼klenemedi:', quickRepliesResponse.reason);
                }
                
                // âœ… WhatsApp template'lerini iÅŸle - DETAYLI LOG
                if (whatsappTemplatesResponse && whatsappTemplatesResponse.status === 'fulfilled' && whatsappTemplatesResponse.value.ok) {
                    const whatsappTemplatesData = await whatsappTemplatesResponse.value.json();
                    const whatsappTemplates = whatsappTemplatesData.templates || [];
                    console.log('âœ… WhatsApp templates yÃ¼klendi:', whatsappTemplates.length);
                    allTemplates = allTemplates.concat(whatsappTemplates);
                } else if (whatsappTemplatesResponse && whatsappTemplatesResponse.status === 'fulfilled' && !whatsappTemplatesResponse.value.ok) {
                    const errorData = await whatsappTemplatesResponse.value.json().catch(() => ({}));
                    console.error('âŒ WhatsApp templates API hatasÄ±:', errorData.error || 'Bilinmeyen hata', whatsappTemplatesResponse.value.status);
                } else if (whatsappTemplatesResponse && whatsappTemplatesResponse.status === 'rejected') {
                    console.error('âŒ WhatsApp templates yÃ¼klenemedi (rejected):', whatsappTemplatesResponse.reason);
                }
                
                // âœ… Cloud API template'lerini iÅŸle - DETAYLI LOG
                console.log('â˜ï¸â˜ï¸â˜ï¸ CLOUD API RESPONSE KONTROL:', {
                    response: cloudApiTemplatesResponse,
                    status: cloudApiTemplatesResponse?.status,
                    fulfilled: cloudApiTemplatesResponse?.status === 'fulfilled',
                    ok: cloudApiTemplatesResponse?.status === 'fulfilled' ? cloudApiTemplatesResponse.value?.ok : null,
                    statusCode: cloudApiTemplatesResponse?.status === 'fulfilled' ? cloudApiTemplatesResponse.value?.status : null
                });
                
                if (cloudApiTemplatesResponse && cloudApiTemplatesResponse.status === 'fulfilled' && cloudApiTemplatesResponse.value.ok) {
                    try {
                        const cloudApiData = await cloudApiTemplatesResponse.value.json();
                        console.log('â˜ï¸â˜ï¸â˜ï¸ CLOUD API DATA:', cloudApiData);
                        const cloudTemplates = cloudApiData.templates || cloudApiData.whatsappTemplates || [];
                        console.log('âœ…âœ…âœ… CLOUD API TEMPLATES YÃœKLENDÄ°:', cloudTemplates.length, cloudTemplates);
                        if (cloudTemplates.length > 0) {
                            allTemplates = allTemplates.concat(cloudTemplates);
                        } else {
                            console.warn('âš ï¸ Cloud API templates array boÅŸ!');
                        }
                    } catch (parseError) {
                        console.error('âŒâŒâŒ Cloud API JSON parse hatasÄ±:', parseError);
                    }
                } else if (cloudApiTemplatesResponse && cloudApiTemplatesResponse.status === 'fulfilled' && !cloudApiTemplatesResponse.value.ok) {
                    try {
                        const errorData = await cloudApiTemplatesResponse.value.json().catch(() => ({}));
                        console.error('âŒâŒâŒ CLOUD API TEMPLATES API HATASI:', {
                            status: cloudApiTemplatesResponse.value.status,
                            statusText: cloudApiTemplatesResponse.value.statusText,
                            error: errorData.error || 'Bilinmeyen hata',
                            fullError: errorData,
                            url: cloudApiTemplatesUrl
                        });
                    } catch (parseError) {
                        console.error('âŒâŒâŒ Cloud API error JSON parse hatasÄ±:', parseError);
                    }
                } else if (cloudApiTemplatesResponse && cloudApiTemplatesResponse.status === 'rejected') {
                    console.error('âŒâŒâŒ CLOUD API TEMPLATES YÃœKLENEMEDÄ° (REJECTED):', cloudApiTemplatesResponse.reason);
                } else {
                    console.error('âŒâŒâŒ CLOUD API RESPONSE YOK VEYA GEÃ‡ERSÄ°Z!', cloudApiTemplatesResponse);
                }
                
                console.log('ğŸ“Š Toplam template sayÄ±sÄ±:', allTemplates.length, { 
                    quickReplies: allTemplates.filter(t => t.type === 'quick-reply').length,
                    whatsapp: allTemplates.filter(t => t.type === 'whatsapp').length,
                    cloudapi: allTemplates.filter(t => t.type === 'cloudapi').length
                });
                
                if (allTemplates.length === 0) {
                    templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">HenÃ¼z template bulunamadÄ±</div>';
                    return;
                }
                
                // âœ… Templates'Ä± order'a gÃ¶re sÄ±rala (WhatsApp/Cloud API template'ler Ã¶nce, sonra quick-replies)
                allTemplates.sort((a, b) => {
                    const typePriority = (t) => {
                        if (t.type === 'cloudapi') return 0;
                        if (t.type === 'whatsapp') return 1;
                        return 2; // quick-reply
                    };
                    const pa = typePriority(a);
                    const pb = typePriority(b);
                    if (pa !== pb) return pa - pb;
                    return (a.order || 0) - (b.order || 0);
                });
                
                // âœ… Cache'e kaydet (her zaman gÃ¼ncel tut)
                const previousCacheLength = window.cachedTemplates ? window.cachedTemplates.length : 0;
                window.cachedTemplates = allTemplates;
                
                // âœ… Sadece cache boÅŸsa veya yeni template'ler varsa render et
                // EÄŸer zaten cache'den gÃ¶sterildiyse, sadece gÃ¼ncelle (kullanÄ±cÄ± fark etmez)
                if (previousCacheLength === 0 || allTemplates.length !== previousCacheLength) {
                    renderTemplates(allTemplates);
                } else {
                    // Arka planda sessizce gÃ¼ncelle (kullanÄ±cÄ± fark etmez)
                    console.log('âœ… Template\'ler arka planda gÃ¼ncellendi:', allTemplates.length);
                }
            } catch (error) {
                console.error('Templates yÃ¼klenirken hata:', error);
                templatesList.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Templates yÃ¼klenirken hata oluÅŸtu: ${error.message}</div>`;
            }
        }
        
        // âœ… Templates render fonksiyonu
        function renderTemplates(templates) {
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) return;
            
            if (templates.length === 0) {
                templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">Template bulunamadÄ±</div>';
                return;
            }
            
            // âœ… Templates'Ä± global deÄŸiÅŸkende sakla (selectTemplate iÃ§in)
            window.templatesData = templates;
            
            templatesList.innerHTML = templates.map(template => {
                // âœ… Content'i escape et (HTML injection Ã¶nleme)
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const templateName = escapeHtml(template.name || 'Unnamed Template');
                const templateContent = escapeHtml(template.content || '');
                const templateId = escapeHtml(template.id?.toString() || '');
                
                // âœ… Template tipine gÃ¶re badge gÃ¶ster
                const templateType = template.type || 'quick-reply';
                const typeBadge = templateType === 'cloudapi'
                    ? '<span style="display: inline-block; background: #128C7E; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Cloud API</span>'
                    : templateType === 'whatsapp'
                        ? '<span style="display: inline-block; background: #25D366; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">WhatsApp</span>'
                        : '<span style="display: inline-block; background: #6366f1; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Quick Reply</span>';
                
                // âœ… Sil butonu: Local template'ler veya quick-reply tipi backend template'leri iÃ§in gÃ¶ster
                const canDelete = template.isLocal || (template.type === 'quick-reply' && !template.isLocal);
                const deleteBtn = canDelete ? `<button style="border:none; background:transparent; color:#ef4444; font-weight:700; cursor:pointer; margin-left:8px;" onclick="window.deleteLocalTemplate('${templateId}')" title="${template.isLocal ? 'Lokal template\'i sil' : 'Backend\'den sil'}">âœ•</button>` : '';
                
                // âœ… Status badge (sadece WhatsApp template'ler iÃ§in)
                const statusBadge = template.status && template.type === 'whatsapp'
                    ? `<span style="display: inline-block; background: ${template.status === 'ACTIVE' ? '#10b981' : '#f59e0b'}; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px; font-weight: 600;">${escapeHtml(template.status)}</span>`
                    : '';
                
                return `
                    <div class="template-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; cursor: pointer; transition: box-shadow 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'"
                         onclick="selectTemplate('${templateId}')">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111; flex: 1;">${templateName}</h3>
                            ${typeBadge}
                            ${statusBadge}
                            ${deleteBtn}
                        </div>
                        <p style="margin: 0; font-size: 14px; color: #666; line-height: 1.5; max-height: 100px; overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; word-wrap: break-word;">${templateContent}</p>
                    </div>
                `;
            }).join('');
        }
        
        // âœ… Template filtreleme
        function filterTemplates(searchTerm) {
            const templateCards = document.querySelectorAll('.template-card');
            const term = searchTerm.toLowerCase();
            
            templateCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }
        
        // âœ… Template seÃ§me fonksiyonu - Medya desteÄŸi ile
        window.selectTemplate = async function(templateId) {
            const templatesModal = document.getElementById('templatesModal');
            const messageInput = document.getElementById('messageInput');
            
            // Template'i bul - cachedTemplates'ten de kontrol et
            let template = window.templatesData ? window.templatesData.find(t => t.id === templateId) : null;
            if (!template && window.cachedTemplates) {
                template = window.cachedTemplates.find(t => (t.id || '').toString() === templateId);
            }
            
            if (!template) {
                console.error('Template bulunamadÄ±:', templateId);
                return;
            }
            
            // Modal'Ä± kapat
            if (templatesModal) {
                templatesModal.style.display = 'none';
            }
            
            // âœ… Template iÃ§inde deÄŸiÅŸken alanlar var mÄ± kontrol et ({{1}}, {{2}}, vb.)
            const templateContent = template.content || '';
            const variablePattern = /\{\{(\d+)\}\}/g;
            const variables = [];
            let match;
            
            while ((match = variablePattern.exec(templateContent)) !== null) {
                const varNum = parseInt(match[1]);
                if (!variables.includes(varNum)) {
                    variables.push(varNum);
                }
            }
            
            // âœ… EÄŸer deÄŸiÅŸken alanlar varsa parametre modal'Ä±nÄ± aÃ§
            if (variables.length > 0) {
                window.selectedTemplate = template;
                window.selectedTemplateVariables = variables.sort((a, b) => a - b);
                showTemplateParametersModal(template, variables.sort((a, b) => a - b));
                return;
            }
            
            // âœ… DeÄŸiÅŸken yoksa normal ÅŸekilde mesaj input'una ekle
            if (messageInput) {
                messageInput.value = templateContent;
                messageInput.focus();
                messageInput.disabled = false;
            }
            
            // âœ… Template'te medya varsa (components array'i varsa) medya ekle
            if (template.components && Array.isArray(template.components)) {
                const headerComponent = template.components.find(c => c.type === 'HEADER');
                if (headerComponent) {
                    const format = (headerComponent.format || '').toUpperCase();
                    const example = headerComponent.example || {};
                    
                    // âœ… IMAGE formatÄ± varsa
                    if (format === 'IMAGE' && example.header_url && example.header_url.length > 0) {
                        const imageUrl = example.header_url[0];
                        try {
                            // URL'den resmi indir ve fileInput'a ekle
                            const response = await fetch(imageUrl);
                            const blob = await response.blob();
                            const fileName = `template_image_${Date.now()}.jpg`;
                            const file = new File([blob], fileName, { type: blob.type || 'image/jpeg' });
                            
                            if (!window.selectedFiles) window.selectedFiles = [];
                            window.selectedFiles.push(file);
                            updateSelectedFilesDisplay();
                            
                            console.log('Template\'ten resim eklendi:', fileName);
                        } catch (error) {
                            console.error('Template resmi indirilemedi:', error);
                        }
                    }
                    // âœ… VIDEO formatÄ± varsa
                    else if (format === 'VIDEO' && example.header_url && example.header_url.length > 0) {
                        const videoUrl = example.header_url[0];
                        try {
                            const response = await fetch(videoUrl);
                            const blob = await response.blob();
                            const fileName = `template_video_${Date.now()}.mp4`;
                            const file = new File([blob], fileName, { type: blob.type || 'video/mp4' });
                            
                            if (!window.selectedFiles) window.selectedFiles = [];
                            window.selectedFiles.push(file);
                            updateSelectedFilesDisplay();
                            
                            console.log('Template\'ten video eklendi:', fileName);
                        } catch (error) {
                            console.error('Template videosu indirilemedi:', error);
                        }
                    }
                    // âœ… DOCUMENT formatÄ± varsa
                    else if (format === 'DOCUMENT' && example.header_url && example.header_url.length > 0) {
                        const docUrl = example.header_url[0];
                        try {
                            const response = await fetch(docUrl);
                            const blob = await response.blob();
                            const fileName = `template_document_${Date.now()}.pdf`;
                            const file = new File([blob], fileName, { type: blob.type || 'application/pdf' });
                            
                            if (!window.selectedFiles) window.selectedFiles = [];
                            window.selectedFiles.push(file);
                            updateSelectedFilesDisplay();
                            
                            console.log('Template\'ten dokÃ¼man eklendi:', fileName);
                        } catch (error) {
                            console.error('Template dokÃ¼manÄ± indirilemedi:', error);
                        }
                    }
                }
            }
            
            // âœ… Template'te direkt medya URL'i varsa (eski format)
            if (template.mediaUrl || template.imageUrl || template.videoUrl) {
                const mediaUrl = template.mediaUrl || template.imageUrl || template.videoUrl;
                try {
                    const response = await fetch(mediaUrl);
                    const blob = await response.blob();
                    const fileType = template.imageUrl ? 'image/jpeg' : (template.videoUrl ? 'video/mp4' : blob.type);
                    const extension = template.imageUrl ? 'jpg' : (template.videoUrl ? 'mp4' : 'file');
                    const fileName = `template_media_${Date.now()}.${extension}`;
                    const file = new File([blob], fileName, { type: fileType });
                    
                    if (!window.selectedFiles) window.selectedFiles = [];
                    window.selectedFiles.push(file);
                    updateSelectedFilesDisplay();
                    
                    console.log('Template\'ten medya eklendi:', fileName);
                } catch (error) {
                    console.error('Template medyasÄ± indirilemedi:', error);
                }
            }
            
            // Send butonunu enable et
            const sendButton = document.getElementById('sendMessage');
            if (sendButton) {
                sendButton.disabled = false;
            }
            
            console.log('Template seÃ§ildi:', { templateId, templateName: template.name, content: template.content, hasMedia: !!(template.components || template.mediaUrl) });
        };
        
        // âœ… Template parametre modalÄ±nÄ± gÃ¶ster
        function showTemplateParametersModal(template, variables) {
            const modal = document.getElementById('templateParametersModal');
            const content = document.getElementById('templateParametersContent');
            
            if (!modal || !content) return;
            
            // âœ… Parametre input'larÄ±nÄ± oluÅŸtur - SADECE TEXT VE URL
            let html = '<p style="margin-bottom: 16px; color: #666;">LÃ¼tfen template parametrelerini doldurun:</p>';
            
            // âœ… Mesaj preview alanÄ±
            html += `
                <div id="templateMessagePreview" style="margin-bottom: 20px; padding: 16px; border: 2px solid #6366f1; border-radius: 8px; background: #f0f4ff;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #6366f1;">ğŸ“‹ Mesaj Ã–nizleme:</label>
                    <div id="templatePreviewContent" style="padding: 12px; background: white; border-radius: 6px; min-height: 50px; white-space: pre-wrap; word-wrap: break-word; color: #333; font-size: 14px; line-height: 1.5;">
                        ${template.content || ''}
                    </div>
                </div>
            `;
            
            variables.forEach((varNum, index) => {
                html += `
                    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Parametre {{${varNum}}}</label>
                        
                        <!-- Parametre tipi seÃ§imi - SADECE TEXT VE URL -->
                        <select 
                            id="templateParamType_${varNum}" 
                            class="template-param-type"
                            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; font-size: 14px;"
                            onchange="updateTemplateParamInput(${varNum}); updateTemplatePreview();"
                        >
                            <option value="text">ğŸ“ Metin</option>
                            <option value="url">ğŸ”— Link (URL)</option>
                        </select>
                        
                        <!-- Text input -->
                        <input 
                            type="text" 
                            id="templateParam_${varNum}" 
                            class="template-param-input template-param-text" 
                            placeholder="DeÄŸer girin..."
                            style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; display: block;"
                            oninput="updateTemplatePreview();"
                        >
                    </div>
                `;
            });
            
            content.innerHTML = html;
            modal.style.display = 'block';
            
            // âœ… Ä°lk input'a focus
            const firstInput = document.getElementById(`templateParam_${variables[0]}`);
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
            
            // âœ… Preview'Ä± baÅŸlat
            updateTemplatePreview();
        }
        
        // âœ… Parametre tipi deÄŸiÅŸtiÄŸinde input'u gÃ¼ncelle - SADECE TEXT VE URL
        window.updateTemplateParamInput = function(varNum) {
            const typeSelect = document.getElementById(`templateParamType_${varNum}`);
            const textInput = document.getElementById(`templateParam_${varNum}`);
            
            if (!typeSelect || !textInput) return;
            
            const paramType = typeSelect.value;
            
            if (paramType === 'text') {
                textInput.type = 'text';
                textInput.placeholder = 'DeÄŸer girin...';
            } else if (paramType === 'url') {
                textInput.type = 'url';
                textInput.placeholder = 'https://example.com';
            }
            
            // âœ… Preview'Ä± gÃ¼ncelle
            updateTemplatePreview();
        };
        
        // âœ… Template mesaj preview'Ä±nÄ± gÃ¼ncelle
        window.updateTemplatePreview = function() {
            if (!window.selectedTemplate || !window.selectedTemplateVariables) return;
            
            const template = window.selectedTemplate;
            const variables = window.selectedTemplateVariables;
            const previewContent = document.getElementById('templatePreviewContent');
            
            if (!previewContent) return;
            
            // âœ… Template iÃ§eriÄŸini al
            let previewText = template.content || '';
            
            // âœ… Parametreleri yerleÅŸtir
            variables.forEach(varNum => {
                const textInput = document.getElementById(`templateParam_${varNum}`);
                if (textInput) {
                    const value = textInput.value.trim() || `{{${varNum}}}`;
                    previewText = previewText.replace(new RegExp(`\\{\\{${varNum}\\}\\}`, 'g'), value);
                }
            });
            
            // âœ… Preview'Ä± gÃ¼ncelle
            previewContent.textContent = previewText;
        };
        
        // âœ… Template parametre modalÄ±nÄ± kapat
        function closeTemplateParametersModal() {
            const modal = document.getElementById('templateParametersModal');
            if (modal) {
                modal.style.display = 'none';
            }
            window.selectedTemplate = null;
            window.selectedTemplateVariables = null;
        }
        
        // âœ… Template mesaj gÃ¶nder (parametrelerle)
        window.sendTemplateMessageWithParams = async function() {
            if (!window.selectedTemplate || !window.selectedTemplateVariables) {
                console.error('Template veya parametreler bulunamadÄ±');
                return;
            }
            
            const template = window.selectedTemplate;
            const variables = window.selectedTemplateVariables;
            
            // âœ… Parametreleri topla - SADECE TEXT VE URL
            const params = {};
            const paramTypes = {};
            let allFilled = true;
            
            variables.forEach(varNum => {
                const typeSelect = document.getElementById(`templateParamType_${varNum}`);
                const textInput = document.getElementById(`templateParam_${varNum}`);
                
                if (!typeSelect || !textInput) {
                    allFilled = false;
                    return;
                }
                
                const paramType = typeSelect.value;
                paramTypes[varNum] = paramType;
                
                const value = textInput.value.trim();
                if (value) {
                    params[varNum] = value;
                } else {
                    allFilled = false;
                }
            });
            
            if (!allFilled) {
                alert('LÃ¼tfen tÃ¼m parametreleri doldurun!');
                return;
            }
            
            // âœ… Modal'Ä± kapat
            closeTemplateParametersModal();
            
            // âœ… Template mesajÄ±nÄ± gÃ¶nder
            // âœ… Conversation ID'yi bul
            let conversationId = null;
            
            // âœ… window.conversationsState.currentConversationId kullan
            if (window.conversationsState && window.conversationsState.currentConversationId) {
                conversationId = window.conversationsState.currentConversationId;
            } else if (window.currentConversationId) {
                conversationId = window.currentConversationId;
            } else {
                // Chat header'dan conversation ID'yi al
                const chatActive = document.getElementById('chatActive');
                if (chatActive && chatActive.dataset.conversationId) {
                    conversationId = chatActive.dataset.conversationId;
                } else {
                    // Son seÃ§ilen conversation'Ä± bul
                    const selectedConv = document.querySelector('.conversation-item.selected');
                    if (selectedConv && selectedConv.dataset.conversationId) {
                        conversationId = selectedConv.dataset.conversationId;
                    } else if (selectedConv && selectedConv.dataset.id) {
                        conversationId = selectedConv.dataset.id;
                    }
                }
            }
            
            if (!conversationId) {
                alert('LÃ¼tfen bir konuÅŸma seÃ§in!');
                return;
            }
            
            console.log('âœ… Conversation ID bulundu:', conversationId);
            
            const savedApiKey = localStorage.getItem('sleekflowApiKey');
            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
            
            if (!savedApiKey || savedApiKey.trim().length < 10) {
                alert('SleekFlow baÄŸlantÄ±sÄ± yok. LÃ¼tfen Ã¶nce baÄŸlanÄ±n.');
                return;
            }
            
            try {
                // âœ… Sadece text ve URL parametreler - JSON ile gÃ¶nder
                const payload = {
                    text: template.content || '',
                    templateId: template.id || template.name,
                    templateName: template.name,
                    templateParams: params,
                    templateParamTypes: paramTypes,
                    isTemplate: true,
                    apiKey: savedApiKey,
                    baseUrl: safeBaseUrl
                };
                
                // âœ… Ã–nce kullanÄ±cÄ± bilgisini al (backend yetki kontrolÃ¼ iÃ§in)
                await getCurrentZohoUser();
                
                // âœ… Backend yetki kontrolÃ¼ iÃ§in kullanÄ±cÄ± bilgisini ekle
                if (window.currentZohoUser.email) {
                    payload.userEmail = window.currentZohoUser.email;
                }
                if (window.currentZohoUser.id) {
                    payload.userId = window.currentZohoUser.id;
                }
                
                console.log('ğŸ“¤ Template mesaj gÃ¶nderiliyor:', { conversationId, templateName: template.name, params, paramTypes });
                
                let messagesUrl = `/api/sleekflow/conversations/${conversationId}/messages?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                messagesUrl = addUserParamsToUrl(messagesUrl);
                
                const response = await fetch(messagesUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Template mesajÄ± gÃ¶nderilemedi');
                }
                
                console.log('âœ… Template mesaj gÃ¶nderildi:', result);
                
                // âœ… KRITIK: Cache'i bypass et ve mesajlarÄ± YENÄ°DEN yÃ¼kle (gerÃ§ek mesajlar gelsin)
                // Cache bypass flag'i set et
                if (!window.conversationsState.bypassCacheFor) {
                    window.conversationsState.bypassCacheFor = {};
                }
                window.conversationsState.bypassCacheFor[conversationId] = true;
                
                // Cache'i de temizle
                if (window.conversationsState.loadedMessages) {
                    delete window.conversationsState.loadedMessages[conversationId];
                }
                
                // âœ… MesajlarÄ± HEMEN yÃ¼kle (cache bypass)
                if (window.loadMessagesDirectly) {
                    await window.loadMessagesDirectly(conversationId).then(() => {
                        // Bypass flag'ini temizle
                        if (window.conversationsState.bypassCacheFor) {
                            delete window.conversationsState.bypassCacheFor[conversationId];
                        }
                        // Scroll to bottom
                        setTimeout(() => {
                            const messagesArea = document.getElementById('messagesArea');
                            const messagesList = document.getElementById('messagesList');
                            const scrollContainer = messagesArea || messagesList;
                            if (scrollContainer) {
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                            }
                        }, 500);
                    }).catch((err) => {
                        console.error('Mesajlar yÃ¼klenirken hata:', err);
                    });
                } else if (window.loadMessages) {
                    await window.loadMessages(conversationId);
                }
                
                // âœ… BaÅŸarÄ± mesajÄ±
                if (window.showToast) {
                    window.showToast('Template mesajÄ± gÃ¶nderildi', 'success');
                }
                
            } catch (error) {
                console.error('âŒ Template mesaj gÃ¶nderme hatasÄ±:', error);
                if (window.showToast) {
                    window.showToast(`Template mesajÄ± gÃ¶nderilemedi: ${error.message}`, 'error');
                } else {
                    alert(`Template mesajÄ± gÃ¶nderilemedi: ${error.message}`);
                }
            }
        };
        
        // âœ… Template parametre modal event listener'larÄ±
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('closeTemplateParametersModal');
            const cancelBtn = document.getElementById('cancelTemplateParameters');
            const sendBtn = document.getElementById('sendTemplateMessage');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', closeTemplateParametersModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeTemplateParametersModal);
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', window.sendTemplateMessageWithParams);
            }
            
            // âœ… ESC tuÅŸu ile kapat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('templateParametersModal');
                    if (modal && modal.style.display !== 'none') {
                        closeTemplateParametersModal();
                    }
                }
            });
        });

        // âœ… Template silme (hem local hem backend)
        window.deleteLocalTemplate = async function(templateId) {
            if (!templateId) return;
            if (!window.cachedTemplates) return;
            
            const idx = window.cachedTemplates.findIndex(t => (t.id || '').toString() === templateId);
            if (idx === -1) return;
            
            const template = window.cachedTemplates[idx];
            
            // âœ… EÄŸer quick-reply ise backend'den sil
            if (template.type === 'quick-reply' && !template.isLocal) {
                if (!confirm('Bu template silinecek. Emin misiniz?')) {
                    return;
                }
                
                try {
                    const savedApiKey = localStorage.getItem('sleekflowApiKey');
                    const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                    const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                    
                    if (!savedApiKey || savedApiKey.trim().length < 10) {
                        alert('SleekFlow baÄŸlantÄ±sÄ± yok. LÃ¼tfen Ã¶nce baÄŸlanÄ±n.');
                        return;
                    }
                    
                    // âœ… Backend'den sil
                    const deleteUrl = `/api/sleekflow/quick-replies/${templateId}?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Template silinemedi');
                    }
                    
                    // âœ… BaÅŸarÄ±lÄ± - Template'leri yeniden yÃ¼kle
                    alert('Template silindi');
                    loadTemplates(); // Template'leri yeniden yÃ¼kle
                    
                } catch (error) {
                    console.error('Template silme hatasÄ±:', error);
                    alert('Template silinemedi: ' + error.message);
                }
                return;
            }
            
            // âœ… Local template veya Cloud API/WhatsApp template'i sil (sadece UI'dan)
            if (template.isLocal) {
                if (!confirm('Bu template silinecek. Emin misiniz?')) return;
                
                // âœ… Local template'i sil
                window.cachedTemplates.splice(idx, 1);
                
                // âœ… Template listesini yeniden render et
                renderTemplates(window.cachedTemplates);
                
                alert('Template silindi');
            } else {
                alert('Bu template silinemez');
            }
        };
    </script>
</body>
</html>
