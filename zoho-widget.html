<!DOCTYPE html>
<html lang="tr">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; frame-ancestors 'self' https://crm.zoho.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleekflow Inbox - Zoho CRM Widget</title>
    <!-- Zoho Embedded App SDK -->
    <script src="https://live.zwidgets.com/js-sdk/1.0/ZohoEmbededAppSDK.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar - Settings & Connection -->
        <aside class="sidebar open" id="sidebar">
            <div class="sidebar-header">
                <h2>‚öôÔ∏è Ayarlar</h2>
                <button class="btn-icon" id="toggleSidebar" type="button" onclick="window.toggleSidebar(); return false;">‚úï</button>
            </div>
            
            <div class="sidebar-content">
                <!-- Sleekflow Connection -->
                <div class="settings-section">
                    <h3>üì± Sleekflow Platform API</h3>
                    <div class="form-group">
                        <label>Platform API Anahtarƒ± <span style="color: #ef4444;">*</span></label>
                        <input type="password" id="sleekflowApiKey" class="input-field" placeholder="API anahtarƒ±nƒ±zƒ± buraya yapƒ±≈ütƒ±rƒ±n" required>
                    </div>
                    <div class="form-group">
                        <label>B√∂lge (Base URL)</label>
                        <select id="sleekflowBaseUrl" class="input-field">
                            <option value="https://sleekflow-core-app-weu-production.azurewebsites.net">West Europe (√ñnerilen)</option>
                            <option value="https://api.sleekflow.io">Hong Kong</option>
                            <option value="https://sleekflow-core-app-eus-production.azurewebsites.net">United States</option>
                            <option value="https://sleekflow-core-app-seas-production.azurewebsites.net">Singapore</option>
                            <option value="https://sleekflow-core-app-uaen-production.azurewebsites.net">UAE North</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" id="connectSleekflow">üîó SleekFlow'a Baƒülan</button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <div class="main-area">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="openSidebar" type="button" onclick="window.toggleSidebar(); return false;">‚ò∞</button>
                    <h1>Sleekflow Inbox</h1>
                </div>
                <div class="top-bar-right" style="display: flex; align-items: center; gap: 8px;">
                    <select id="channelFilterTop" class="sender-select" title="Choose Sender" style="margin: 0; width: auto; min-width: fit-content; padding-right: 36px;">
                        <option value="">Choose Sender</option>
                        <option value="908505327532">VIP-+908505327532</option>
                        <option value="905421363421">Hamzah Coexistence-+905421363421</option>
                    </select>
                    <button class="btn-icon" id="refreshConversations" title="Yenile" style="margin: 0;">üîÑ</button>
                </div>
            </header>

            <!-- Chat Layout -->
            <div class="chat-layout">
                <!-- Conversations List -->
                <div class="conversations-panel" id="conversationsPanel">
                    <div class="conversations-header">
                        <h2>Konu≈ümalar</h2>
                        <select id="channelFilter" class="sender-select" title="Kanal Filtrele">
                            <option value="">T√ºm Kanallar</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="instagram">Instagram</option>
                            <option value="facebook">Facebook</option>
                            <option value="sms">SMS</option>
                            <option value="line">LINE</option>
                            <option value="wechat">WeChat</option>
                            <option value="web">Web</option>
                        </select>
                        <input type="text" id="searchConversations" class="search-input" placeholder="üîç Ara...">
                    </div>
                    
                    <!-- Lead filter info bar (otomatik: sayfadaki lead ismine g√∂re filtre + T√ºm Konu≈ümalarƒ± G√∂r butonu) -->
                    <div id="leadFilterInfo" class="lead-filter-info" style="display:none;"></div>
                    
                    <div class="conversations-list" id="conversationsList">
                        <div class="empty-state">
                            <p>üì≠ Hen√ºz konu≈üma yok</p>
                            <p class="empty-hint">Sleekflow'a baƒülanƒ±n ve konu≈ümalarƒ± g√∂r√ºnt√ºleyin</p>
                        </div>
                    </div>
                </div>

                <!-- Chat View -->
                <div class="chat-view" id="chatView">
                    <div class="chat-empty">
                        <div class="empty-icon">üí¨</div>
                        <h2>Bir konu≈üma se√ßin</h2>
                        <p>Sol taraftan bir konu≈üma se√ßerek mesajlarƒ± g√∂r√ºnt√ºleyin</p>
                    </div>

                    <!-- Active Chat -->
                    <div class="chat-active" id="chatActive" style="display: none;">
                        <!-- Chat Header -->
                        <div class="chat-header">
                            <div class="chat-header-info">
                                <div class="chat-avatar" id="chatAvatar">üë§</div>
                                <div>
                                    <h3 id="chatContactName">ƒ∞sim</h3>
                                    <span class="chat-meta" id="chatMeta">Durum</span>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div class="messages-area" id="messagesArea">
                            <div class="messages-list" id="messagesList">
                                <!-- Messages will be inserted here -->
                            </div>
                        </div>

                        <!-- 24 Saat Kuralƒ± Uyarƒ±sƒ± -->
                        <div id="twentyFourHourWarning" style="display: none; background-color: #fffbe6; border: 1px solid #ffe58f; color: #d46b08; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; line-height: 1.5;">
                            <div style="font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="background-color: #faad14; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ENDED</span>
                                <span>24-hour service window passed.</span>
                            </div>
                            <p style="margin: 8px 0;">As per Meta's messaging policy, you can only reach out using a WhatsApp template and wait for their reply to reopen the window.</p>
                            <p style="font-size: 12px; color: #d46b08; margin-top: 8px;">
                                <span id="hoursSinceLastContactDisplay"></span>
                            </p>
                        </div>

                        <!-- Message Input -->
                        <div class="message-input-area">
                            <div class="message-input-wrapper">
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    class="file-input" 
                                    multiple
                                    accept="image/*,video/*,audio/*,.pdf"
                                    style="display: none;"
                                >
                                <button class="btn btn-icon" id="attachFile" title="Dosya ekle" style="margin-right: 5px; padding: 8px 12px;">üìé</button>
                                <button class="btn btn-secondary" id="openTemplates" title="Templates" style="margin-right: 5px; padding: 8px 16px; font-size: 14px;">Templates</button>
                                <div id="normalMessageInput" style="display: flex; flex: 1; gap: 5px;">
                                    <input 
                                        type="text" 
                                        id="messageInput" 
                                        class="message-input" 
                                        placeholder="Mesaj yazƒ±n..."
                                        disabled
                                    >
                                    <button class="btn btn-primary" id="sendMessage" disabled>G√∂nder</button>
                                </div>
                            </div>
                            <div id="selectedFilesContainer" class="selected-files-container" style="display: none;">
                                <!-- Se√ßilen dosyalar burada g√∂sterilecek -->
                            </div>
                            <!-- Show All Conversations Button (sadece filtrelenmi≈ü modda g√∂r√ºn√ºr) -->
                            <div id="showAllConversationsButtonContainer" style="display: none; padding: 10px; text-align: center; border-top: 1px solid #e0e0e0; background: #f9f9f9;">
                                <button class="btn btn-secondary" id="showAllConversationsInChat" style="width: 100%; padding: 12px; font-size: 14px; cursor: pointer;">
                                    üìã T√ºm Konu≈ümalarƒ± G√∂ster
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="templates-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div class="templates-modal-content" style="position: relative; background: white; margin: 50px auto; max-width: 1200px; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Templates</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" id="templateSearch" placeholder="üîç Search templates..." style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; width: 250px;">
                    <button class="btn btn-primary" id="newTemplate" style="padding: 8px 16px;">+ New Template</button>
                    <button class="btn btn-icon" id="closeTemplatesModal" style="padding: 8px; font-size: 20px; background: transparent; border: none; cursor: pointer; color: #1e40af;">‚úï</button>
                </div>
            </div>
            <div id="templatesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                <!-- Templates will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Template Modal -->
    <div id="newTemplateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; overflow-y: auto;">
        <div style="background: white; max-width: 520px; margin: 80px auto; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); position: relative;">
            <h3 style="margin: 0 0 16px 0;">New Template</h3>
            <label style="display:block; font-weight:600; margin-bottom:6px;">Name</label>
            <input id="newTemplateName" type="text" placeholder="Template name" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:12px;">
            <label style="display:block; font-weight:600; margin-bottom:6px;">Content</label>
            <textarea id="newTemplateContent" rows="4" placeholder="Message content" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:12px; resize: vertical;"></textarea>
            <label style="display:block; font-weight:600; margin-bottom:6px;">Type</label>
            <select id="newTemplateType" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:16px;">
                <option value="cloudapi">Cloud API</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="quick-reply">Quick Reply</option>
            </select>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:4px;">
                <button id="cancelNewTemplate" class="btn btn-secondary" style="padding:8px 14px;">Cancel</button>
                <button id="saveNewTemplate" class="btn btn-primary" style="padding:8px 14px;">Save</button>
            </div>
        </div>
    </div>

    <!-- Template Parameters Modal -->
    <div id="templateParametersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; overflow-y: auto;">
        <div style="background: white; max-width: 600px; margin: 80px auto; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Template Parametreleri</h3>
                <button id="closeTemplateParametersModal" class="btn btn-icon" style="padding: 8px; font-size: 20px; background: transparent; border: none; cursor: pointer; color: #1e40af;">‚úï</button>
            </div>
            <div id="templateParametersContent" style="margin-bottom: 20px;">
                <!-- Parametre input'larƒ± buraya eklenecek -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelTemplateParameters" class="btn btn-secondary" style="padding: 10px 20px;">ƒ∞ptal</button>
                <button id="sendTemplateMessage" class="btn btn-primary" style="padding: 10px 20px;">G√∂nder</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>Y√ºkleniyor...</p>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- BASIC: Get Lead Name from Referrer -->
    <script>
        let zohoInitPromise = null;
        let leadContextPromise = null;

        // Zoho EmbeddedApp SDK √ºzerinden recordId alma (PageLoad event)
        function initZohoEmbeddedApp() {
            if (!window.ZOHO || !ZOHO.embeddedApp) {
                console.log('‚ö†Ô∏è ZOHO.embeddedApp yok, init atlanƒ±yor');
                return;
            }

            ZOHO.embeddedApp.on("PageLoad", function (data) {
                const rid = data && (data.EntityId || data.recordId);
                if (rid) {
                    // Lead deƒüi≈ütiyse state'i sƒ±fƒ±rla ve yeniden y√ºkle
                    if (window.leadId !== rid) {
                        window.leadId = null;
                        window.leadPhone = null;
                        window.leadName = null;
                        window.leadEmail = null;
                    }
                    console.log('‚úÖ Lead ID via PageLoad:', rid);
                    loadLeadContext({ forceReload: true, preferredId: rid, source: 'PageLoad' });
                } else {
                    console.log('‚ö†Ô∏è PageLoad event geldi ama recordId yok:', data);
                }
            });

            if (!zohoInitPromise) {
                zohoInitPromise = ZOHO.embeddedApp.init()
                    .then(() => {
                        console.log('üîÑ ZOHO.embeddedApp init tamamlandƒ±');
                        return true;
                    })
                    .catch(err => {
                        console.warn('‚ö†Ô∏è ZOHO.embeddedApp init hatasƒ±:', err?.message || err);
                        return false;
                    });
            } else {
                console.log('‚ÑπÔ∏è ZOHO.embeddedApp init daha √∂nce ba≈ülatƒ±lmƒ±≈ü');
            }
        }

        async function ensureZohoInitialized() {
            if (!window.ZOHO || !window.ZOHO.embeddedApp) {
                return false;
            }
            if (!zohoInitPromise) {
                zohoInitPromise = window.ZOHO.embeddedApp.init()
                    .then(() => {
                        console.log('üîÑ ZOHO.embeddedApp init tamamlandƒ± (ensure)');
                        return true;
                    })
                    .catch(err => {
                        console.warn('‚ö†Ô∏è ZOHO.embeddedApp init hatasƒ± (ensure):', err?.message || err);
                        return false;
                    });
            }
            return zohoInitPromise;
        }

        function getWidgetContextInfo() {
            const widgetUrl = window.location.href || '';
            const referrer = document.referrer || '';
            let parentUrl = '';
            try {
                if (window.parent && window.parent !== window) {
                    parentUrl = window.parent.location?.href || '';
                }
            } catch (e) {
                // CORS engeli normal
            }
            return { widgetUrl, referrer, parentUrl };
        }

        function normalizeLeadData(raw, source) {
            if (!raw) return null;

            let candidate = raw;
            if (Array.isArray(candidate)) {
                candidate = candidate[0];
            }

            if (candidate && typeof candidate === 'object') {
                if (candidate.data) {
                    if (Array.isArray(candidate.data)) {
                        candidate = candidate.data[0] || candidate.data;
                    } else {
                        candidate = candidate.data;
                    }
                }
            }

            if (!candidate || typeof candidate !== 'object') {
                return null;
            }

            const id = candidate.id ||
                candidate.RecordId ||
                candidate.RecordID ||
                candidate.recordId ||
                candidate.recordID ||
                candidate.EntityId ||
                candidate.entityId;

            if (!id) {
                return null;
            }

            const info = {
                id,
                source: source || 'sdk',
                Full_Name: candidate.Full_Name || candidate.full_name || candidate.FullName || candidate.Fullname || '',
                First_Name: candidate.First_Name || candidate.first_name || candidate.FirstName || '',
                Last_Name: candidate.Last_Name || candidate.last_name || candidate.LastName || '',
                Phone: candidate.Phone || candidate.phone || '',
                Mobile: candidate.Mobile || candidate.mobile || '',
                Email: candidate.Email || candidate.email || ''
            };

            return info;
        }

        async function fetchLeadInfoViaZohoSdk() {
            const initOk = await ensureZohoInitialized();
            if (!initOk) {
                console.log('‚ö†Ô∏è Zoho SDK init olmadƒ±, SDK zinciri atlanƒ±yor');
                return null;
            }

            const resolvedId = window.leadId || resolveLeadIdFromUrls(null);
            const attempts = [
                {
                    name: 'ZOHO.CRM.UI.getRecord',
                    fn: () => window.ZOHO?.CRM?.UI?.getRecord?.()
                },
                {
                    name: 'ZOHO.CRM.UI.getFormInfo',
                    fn: () => window.ZOHO?.CRM?.UI?.getFormInfo?.()
                },
                {
                    name: 'ZOHO.CRM.UI.getPageInfo',
                    fn: () => window.ZOHO?.CRM?.UI?.getPageInfo?.()
                },
                ...(resolvedId ? [{
                    name: 'ZOHO.CRM.API.getRecord(' + resolvedId + ')',
                    fn: () => window.ZOHO?.CRM?.API?.getRecord ? window.ZOHO.CRM.API.getRecord({ Entity: "Leads", RecordID: String(resolvedId) }) : undefined
                }] : []),
                {
                    name: 'ZOHO.CRM.API.getRecord(current)',
                    fn: () => window.ZOHO?.CRM?.API?.getRecord ? window.ZOHO.CRM.API.getRecord({ Entity: "Leads", RecordID: "current" }) : undefined
                }
            ];

            for (const attempt of attempts) {
                if (typeof attempt.fn !== 'function') {
                    continue;
                }
                try {
                    const response = await attempt.fn();
                    const info = normalizeLeadData(response, attempt.name);
                    if (info && info.id) {
                        console.log(`‚úÖ SDK lead bilgisi bulundu (${attempt.name}):`, info.id);
                        return info;
                    }
                } catch (sdkError) {
                    console.warn(`‚ö†Ô∏è ${attempt.name} √ßaƒürƒ±sƒ± ba≈üarƒ±sƒ±z:`, sdkError?.message || sdkError);
                }
            }

            return null;
        }

        function resolveLeadIdFromUrls(preferredId) {
            if (preferredId && /^\d{10,}$/.test(preferredId)) {
                return preferredId;
            }

            const { widgetUrl, referrer, parentUrl } = getWidgetContextInfo();
            const sources = [preferredId, widgetUrl, referrer, parentUrl].filter(Boolean).join(' ');

            const patterns = [
                /\/tab\/Leads\/(\d{10,})/,
                /\/crm\/[^\/]+\/tab\/Leads\/(\d{10,})/,
                /\/Leads\/(\d{10,})/,
                /(\d{15,})/
            ];

            for (const pattern of patterns) {
                const match = sources.match(pattern);
                if (match && match[1]) {
                    console.log('‚úÖ URL kaynaklarƒ±ndan lead ID bulundu:', match[1]);
                    return match[1];
                }
            }

            return null;
        }

        async function fetchLeadDataFromBackendContext() {
            const { widgetUrl, referrer, parentUrl } = getWidgetContextInfo();
            const backendUrl = `/api/zoho/lead-info?widgetUrl=${encodeURIComponent(widgetUrl)}&referrer=${encodeURIComponent(referrer)}&parentUrl=${encodeURIComponent(parentUrl)}`;
            try {
                const response = await fetch(backendUrl);
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Backend context isteƒüi ba≈üarƒ±sƒ±z oldu:', response.status, response.statusText);
                    return null;
                }
                const lead = await response.json();
                if (lead && lead.id) {
                    console.log('‚úÖ Backend context √ºzerinden lead bulundu:', lead.id);
                    return lead;
                }
                return null;
            } catch (error) {
                console.warn('‚ö†Ô∏è Backend context isteƒüi hatasƒ±:', error?.message || error);
                return null;
            }
        }

        async function loadLeadContext({ forceReload = false, preferredId = null, source = 'manual' } = {}) {
            if (!forceReload && window.leadId && window.leadName) {
                return { status: 'cached', id: window.leadId };
            }

            if (leadContextPromise && !forceReload) {
                return leadContextPromise;
            }

            const runner = async () => {
                console.log('[LEAD] loadLeadContext ba≈ülatƒ±ldƒ±', { forceReload, preferredId, source });

                // √ñnce her zaman SDK dene ‚Äì isim buradan gelir (backend'e isim i√ßin g√ºvenme)
                const sdkLead = await fetchLeadInfoViaZohoSdk();
                if (sdkLead && sdkLead.id) {
                    const hasName = !!(sdkLead.Full_Name || sdkLead.First_Name || sdkLead.Last_Name);
                    applyLeadDataFromObject(sdkLead, { source: sdkLead.source || 'zoho-sdk', triggerLoad: true });
                    if (!hasName) await fetchLeadData(sdkLead.id, { source: 'sdk-backfill' });
                    return { status: 'sdk', id: sdkLead.id };
                }

                let candidateId = preferredId || window.leadId || resolveLeadIdFromUrls(preferredId);
                if (candidateId && (!forceReload && window.leadId === candidateId && window.leadName)) {
                    return { status: 'cached', id: candidateId };
                }
                if (candidateId) {
                    await fetchLeadData(candidateId, { source: 'url-fallback' });
                    return { status: 'url', id: candidateId };
                }

                const backendLead = await fetchLeadDataFromBackendContext();
                if (backendLead && backendLead.id) {
                    const needsBackfill = !backendLead.Full_Name && !backendLead.First_Name && !backendLead.Last_Name;
                    applyLeadDataFromObject(backendLead, { source: 'backend-context', triggerLoad: !needsBackfill });
                    if (needsBackfill) {
                        await fetchLeadData(backendLead.id, { source: 'backend-context-backfill' });
                    }
                    return { status: 'backend-context', id: backendLead.id };
                }

                console.warn('[LEAD] loadLeadContext lead bilgisi bulamadƒ±');
                return { status: 'not-found', id: null };
            };

            if (forceReload) {
                return runner();
            }

            leadContextPromise = runner().finally(() => {
                leadContextPromise = null;
            });

            return leadContextPromise;
        }

        // Get lead ID from referrer and fetch lead name from backend
        function getLeadFromReferrer(forceReload = false) {
            loadLeadContext({ forceReload, source: 'legacy-referrer' })
                .then(result => {
                    if (result && result.id) {
                        console.log('‚úÖ loadLeadContext lead bulundu:', result.id);
                    } else {
                        console.log('‚ÑπÔ∏è loadLeadContext lead d√∂nd√ºrmedi, eski fallback devam ediyor');
                    }
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è loadLeadContext hata verdi, eski fallback uygulanacak:', error?.message || error);
                });
            // If already loaded and not forcing reload, don't reload
            if (!forceReload && window.leadPhone && window.leadPhone !== 'null' && window.leadPhone !== '' && window.leadPhone !== 'undefined') {
                console.log('‚úÖ Lead phone already loaded:', window.leadPhone);
                return;
            }
            
            let leadId = null;
            
            // Y√ñNTEM 0: Zoho Widget API (en g√ºvenilir - OAuth gerektirir ama deneyelim)
            // Bu API √ßalƒ±≈üƒ±rsa diƒüer y√∂ntemlere gerek kalmaz
            // √ñNEMLƒ∞: $recordId placeholder tespit edildiƒüinde bu API'ler kullanƒ±lacak
            let useZohoAPI = false;
            const urlParamsCheck = new URLSearchParams(window.location.search);
            const recordIdParam = urlParamsCheck.get('recordId') || urlParamsCheck.get('leadId') || urlParamsCheck.get('id');
            
            // Placeholder kontrol√º: $recordId, ${record.id}, #RecordId# vb.
            if (recordIdParam && (recordIdParam.includes('$') || recordIdParam.includes('{') || recordIdParam.includes('#') || recordIdParam.toLowerCase().includes('recordid'))) {
                console.log('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Placeholder tespit edildi:', recordIdParam);
                console.log('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Zoho Widget API kullanƒ±lacak (placeholder yerine)');
                useZohoAPI = true;
                leadId = null; // Placeholder'ƒ± ge√ßersiz say
            }
            
            if (window.ZOHO) {
                console.log('üîç Zoho Widget API mevcut, deniyor...');
                
                // Y√ñNTEM 0.1: ZOHO.CRM.UI.getRecord() ‚Äì ƒ∞sim SDK cevabƒ±ndan (backend'e sorma)
                if (window.ZOHO.CRM && window.ZOHO.CRM.UI && typeof window.ZOHO.CRM.UI.getRecord === 'function') {
                    try {
                        console.log('üîç ZOHO.CRM.UI.getRecord() deneniyor...');
                        window.ZOHO.CRM.UI.getRecord()
                            .then(function(response) {
                                console.log('üì• ZOHO.CRM.UI.getRecord() response:', response);
                                var info = normalizeLeadData(response, 'ZOHO.CRM.UI.getRecord');
                                if (info && info.id) {
                                    console.log('[LEAD] SDK getRecord ‚Üí id + isim:', info.id, info.Full_Name || (info.First_Name + ' ' + info.Last_Name).trim() || '(yok)');
                                    applyLeadDataFromObject(info, { source: 'zoho-sdk-getRecord', triggerLoad: true });
                                    if (!info.Full_Name && !info.First_Name && !info.Last_Name) fetchLeadData(info.id, { source: 'sdk-backfill' });
                                    return;
                                }
                                if (response && response.id) { fetchLeadData(response.id); return; }
                                if (response && response.data && response.data && response.data.id) { fetchLeadData(response.data.id); return; }
                            })
                            .catch(function(error) {
                                console.log('‚ö†Ô∏è ZOHO.CRM.UI.getRecord() hatasƒ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('‚ö†Ô∏è ZOHO.CRM.UI.getRecord() mevcut deƒüil:', e.message);
                    }
                }
                
                // Y√ñNTEM 0.2: ZOHO.CRM.API.getRecord() ‚Äì √ñnce ger√ßek leadId ile dene (current 404 veriyor), sonra current
                var apiRecordLeadId = window.leadId || (function(){ var m = (document.referrer || '').match(/\/tab\/Leads\/(\d{10,})/) || (document.referrer || '').match(/\/Leads\/(\d{10,})/); return m && m[1] ? m[1] : null; })();
                if (window.ZOHO.CRM && window.ZOHO.CRM.API && typeof window.ZOHO.CRM.API.getRecord === 'function') {
                    try {
                        var recordIdToTry = (apiRecordLeadId && /^\d{10,}$/.test(apiRecordLeadId)) ? apiRecordLeadId : 'current';
                        console.log('üîç ZOHO.CRM.API.getRecord() deneniyor (RecordID:', recordIdToTry, ')...');
                        window.ZOHO.CRM.API.getRecord({ Entity: "Leads", RecordID: recordIdToTry })
                            .then(function(response) {
                                console.log('üì• ZOHO.CRM.API.getRecord() response:', response);
                                var info = normalizeLeadData(response, 'ZOHO.CRM.API.getRecord');
                                if (info && info.id) {
                                    console.log('[LEAD] SDK API.getRecord ‚Üí id + isim:', info.id, info.Full_Name || (info.First_Name + ' ' + info.Last_Name).trim() || '(yok)');
                                    applyLeadDataFromObject(info, { source: 'zoho-sdk-api', triggerLoad: true });
                                    if (!info.Full_Name && !info.First_Name && !info.Last_Name) fetchLeadData(info.id, { source: 'sdk-backfill' });
                                    return;
                                }
                                if (response && response.data && response.data[0] && response.data[0].id) {
                                    fetchLeadData(response.data[0].id);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('‚ö†Ô∏è ZOHO.CRM.API.getRecord() hatasƒ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('‚ö†Ô∏è ZOHO.CRM.API.getRecord() mevcut deƒüil:', e.message);
                    }
                }
                
                // Y√ñNTEM 0.3: ZOHO.CRM.UI.getFormInfo() - Form bilgisi
                if (window.ZOHO.CRM && window.ZOHO.CRM.UI && typeof window.ZOHO.CRM.UI.getFormInfo === 'function') {
                    try {
                        console.log('üîç ZOHO.CRM.UI.getFormInfo() deneniyor...');
                        window.ZOHO.CRM.UI.getFormInfo()
                            .then(function(response) {
                                console.log('üì• ZOHO.CRM.UI.getFormInfo() response:', response);
                                if (response && response.Entity && response.Entity === 'Leads' && response.RecordId) {
                                    const zohoLeadId = response.RecordId;
                                    console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Lead ID found via ZOHO.CRM.UI.getFormInfo():', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('‚ö†Ô∏è ZOHO.CRM.UI.getFormInfo() hatasƒ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('‚ö†Ô∏è ZOHO.CRM.UI.getFormInfo() mevcut deƒüil:', e.message);
                    }
                }
                
                // Y√ñNTEM 0.4: ZOHO.CRM.UI.getPageInfo() - Sayfa bilgisi
                if (window.ZOHO.CRM && window.ZOHO.CRM.UI && typeof window.ZOHO.CRM.UI.getPageInfo === 'function') {
                    try {
                        console.log('üîç ZOHO.CRM.UI.getPageInfo() deneniyor...');
                        window.ZOHO.CRM.UI.getPageInfo()
                            .then(function(response) {
                                console.log('üì• ZOHO.CRM.UI.getPageInfo() response:', response);
                                if (response && response.Entity && response.Entity === 'Leads' && response.RecordId) {
                                    const zohoLeadId = response.RecordId;
                                    console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Lead ID found via ZOHO.CRM.UI.getPageInfo():', zohoLeadId);
                                    fetchLeadData(zohoLeadId);
                                    return;
                                }
                            })
                            .catch(function(error) {
                                console.log('‚ö†Ô∏è ZOHO.CRM.UI.getPageInfo() hatasƒ±:', error.message || error);
                            });
                    } catch (e) {
                        console.log('‚ö†Ô∏è ZOHO.CRM.UI.getPageInfo() mevcut deƒüil:', e.message);
                    }
                }
            } else {
                console.log('‚ö†Ô∏è window.ZOHO mevcut deƒüil - Zoho Widget API kullanƒ±lamƒ±yor');
            }
            
            // Y√ñNTEM 1: URL parametrelerinden leadId ve lead adƒ± al
            const urlParams = new URLSearchParams(window.location.search);
            leadId = urlParams.get('leadId') || urlParams.get('id') || urlParams.get('recordId') || urlParams.get('record_id');
            // ‚úÖ Lead ismi URL'den (Zoho merge: recordName={{Lead.Full_Name}})
            const nameFromUrl = urlParams.get('recordName') || urlParams.get('leadName') || urlParams.get('record_name') || urlParams.get('full_name') || urlParams.get('Full_Name');
            if (nameFromUrl && typeof nameFromUrl === 'string') {
                const trimmed = nameFromUrl.trim();
                if (trimmed.length >= 2 && trimmed.length <= 100 && !trimmed.includes('{{') && !trimmed.includes('$') && !/^#|Record\.|Lead\./i.test(trimmed)) {
                    window.leadName = trimmed;
                    console.log('‚úÖ Lead ismi URL parametresinden alƒ±ndƒ±:', window.leadName);
                }
            }
            // Y√ñNTEM 1.1: Eƒüer leadId bir placeholder ise ($recordId, ${record.id}, #RecordId# vb.), ge√ßersiz say
            if (leadId && (leadId.includes('$') || leadId.includes('{') || leadId.includes('#') || leadId.includes('RecordId') || leadId.includes('recordId') || leadId === '$recordId')) {
                console.log('‚ö†Ô∏è Placeholder tespit edildi, ge√ßersiz sayƒ±lƒ±yor:', leadId);
                leadId = null; // Placeholder'ƒ± ge√ßersiz say, Zoho Widget API'den al
            }
            
            // Y√ñNTEM 1.5: serviceOrigin parametresinden lead ID √ßƒ±karmayƒ± dene (Zoho widget'larƒ± bazen buraya ekler)
            if (!leadId) {
                const serviceOrigin = urlParams.get('serviceOrigin') || '';
                console.log('üîç serviceOrigin parametresi:', serviceOrigin);
                // serviceOrigin genellikle base64 encoded olabilir veya URL i√ßerebilir
                if (serviceOrigin) {
                    try {
                        // serviceOrigin URL formatƒ±nda ise parse et
                        const decodedOrigin = decodeURIComponent(serviceOrigin);
                        const originLeadMatch = decodedOrigin.match(/\/tab\/Leads\/(\d+)/) || decodedOrigin.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d+)/);
                        if (originLeadMatch && originLeadMatch[1]) {
                            leadId = originLeadMatch[1];
                            console.log('‚úÖ‚úÖ‚úÖ Lead ID found in serviceOrigin:', leadId);
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è serviceOrigin parse hatasƒ±:', e.message);
                    }
                }
            }
            
            if (leadId && leadId.length >= 10 && /^\d+$/.test(leadId)) {
                console.log('‚úÖ‚úÖ‚úÖ Lead ID found in URL params:', leadId);
            } else {
                // Lead ID ge√ßerli deƒüilse, Zoho Widget API'den almayƒ± dene
                console.log('‚ö†Ô∏è URL\'den ge√ßerli lead ID bulunamadƒ±, Zoho Widget API deneniyor...');
                leadId = null; // Zoho Widget API'den alƒ±nacak
                // Y√ñNTEM 2: Parent window'dan Zoho widget API ile al (iframe i√ßinde)
                try {
                    if (window.parent && window.parent !== window) {
                        // Zoho widget API - parent window'dan record ID al
                        const parentUrl = window.parent.location?.href || '';
                        const parentLeadMatch = parentUrl.match(/\/tab\/Leads\/(\d+)/) || parentUrl.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d+)/);
                        if (parentLeadMatch && parentLeadMatch[1]) {
                            leadId = parentLeadMatch[1];
                            console.log('‚úÖ‚úÖ‚úÖ Lead ID found in parent window URL:', leadId);
                        }
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Parent window eri≈üimi yok (CORS):', e.message);
                }
                
                // Y√ñNTEM 3: Referrer'dan √ßƒ±kar (AGRESƒ∞F PARSƒ∞NG)
                if (!leadId) {
                    const referrer = document.referrer || '';
                    const currentUrl = window.location.href || '';
                    const allUrls = [referrer, currentUrl].join(' ');
                    
                    console.log('üîçüîçüîç REFERRER CHECK (AGRESƒ∞F):');
                    console.log('   document.referrer:', document.referrer);
                    console.log('   window.location.href:', window.location.href);
                    console.log('   T√ºm URL\'ler birle≈ütirildi:', allUrls);
                    
                    // Pattern 1: /tab/Leads/3519633000086711022 (en yaygƒ±n)
                    let leadIdMatch = allUrls.match(/\/tab\/Leads\/(\d{10,})/);
                    if (leadIdMatch && leadIdMatch[1]) {
                        leadId = leadIdMatch[1];
                        console.log('‚úÖ‚úÖ‚úÖ Lead ID found (pattern 1 - /tab/Leads/):', leadId);
                    } else {
                        // Pattern 2: /crm/org675407911/tab/Leads/3519633000086711022
                        leadIdMatch = allUrls.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d{10,})/);
                        if (leadIdMatch && leadIdMatch[1]) {
                            leadId = leadIdMatch[1];
                            console.log('‚úÖ‚úÖ‚úÖ Lead ID found (pattern 2 - /crm/.../tab/Leads/):', leadId);
                        } else {
                            // Pattern 3: /Leads/3519633000086711022 (tab olmadan)
                            leadIdMatch = allUrls.match(/\/Leads\/(\d{10,})/);
                            if (leadIdMatch && leadIdMatch[1]) {
                                leadId = leadIdMatch[1];
                                console.log('‚úÖ‚úÖ‚úÖ Lead ID found (pattern 3 - /Leads/):', leadId);
                            } else {
                                // Pattern 4: Herhangi bir yerde 10+ haneli sayƒ± (son √ßare)
                                leadIdMatch = allUrls.match(/(\d{15,})/); // Zoho lead ID'leri genellikle 15+ haneli
                                if (leadIdMatch && leadIdMatch[1]) {
                                    leadId = leadIdMatch[1];
                                    console.log('‚úÖ‚úÖ‚úÖ Lead ID found (pattern 4 - genel sayƒ± arama):', leadId);
                                }
                            }
                        }
                    }
                }
            }
            
            // Y√ñNTEM 4: Backend'e referrer ile istek at (backend referrer header'ƒ±ndan √ßƒ±karacak)
            // Ayrƒ±ca widget URL'sini de g√∂nder (referrer yerine)
            if (!leadId) {
                console.log('‚ö†Ô∏è Lead ID bulunamadƒ±, backend\'e referrer ile istek atƒ±lƒ±yor...');
                console.log('   Widget URL:', window.location.href);
                console.log('   Referrer:', document.referrer);
                
                // Backend'e hem referrer hem de widget URL'sini g√∂nder
                // Widget Render.com'da √ßalƒ±≈üƒ±yorsa, relative path kullan
                const backendUrl = '/api/zoho/lead-info';
                const widgetUrl = window.location.href || '';
                const referrerParam = document.referrer || '';
                let parentHref = '';
                try {
                    if (window.parent && window.parent !== window) {
                        parentHref = window.parent.location?.href || '';
                    }
                } catch (e) {
                    // CORS hatasƒ± normal
                }
                
                // Backend'e widget URL ve referrer bilgilerini g√∂nder
                const backendQuery = `?widgetUrl=${encodeURIComponent(widgetUrl)}&referrer=${encodeURIComponent(referrerParam)}&parentUrl=${encodeURIComponent(parentHref)}`;
                fetch(backendUrl + backendQuery)
                    .then(res => {
                        if (!res.ok && res.status === 400) {
                            // 400 hatasƒ± = Lead ID bulunamadƒ±, bu normal (t√ºm konu≈ümalarƒ± g√∂ster)
                            return res.json().then(data => {
                                console.log('‚ö†Ô∏è Lead ID bulunamadƒ± (normal - t√ºm konu≈ümalar g√∂sterilecek):', data.message || 'Lead ID yok');
                                // Lead ID yoksa da devam et, t√ºm konu≈ümalarƒ± g√∂ster
                                return null;
                            });
                        }
                        return res.json();
                    })
                    .then(lead => {
                        if (lead && lead.id && lead.id !== 'null' && lead.id !== 'undefined' && lead.id !== null) {
                            console.log('‚úÖ‚úÖ‚úÖ Backend\'den lead ID alƒ±ndƒ± (referrer/widgetUrl):', lead.id);
                            // Backend'den gelen lead ID ile tekrar √ßaƒüƒ±r
                            leadId = lead.id;
                            // Fetch lead data with the ID we got from backend
                            fetchLeadData(leadId);
                        } else {
                            // Lead ID yok - bu normal, t√ºm konu≈ümalarƒ± g√∂ster
                            console.log('‚ö†Ô∏è Lead ID bulunamadƒ±, t√ºm konu≈ümalar g√∂sterilecek (normal durum)');
                            // Lead ID olmadan da devam et
                        }
                    })
                    .catch(err => {
                        console.error('‚ùå Backend isteƒüi hatasƒ±:', err);
                        // Son √ßare: T√ºm konu≈ümalarƒ± g√∂ster (filtreleme olmadan)
                        console.log('‚ö†Ô∏è Backend hatasƒ±, t√ºm konu≈ümalar g√∂sterilecek');
                    });
                return; // ƒ∞lk √ßaƒürƒ±da bekle, backend'den gelecek
            }
            
            // Lead ID bulundu, veriyi √ßek
            fetchLeadData(leadId);
        }
        
        function applyLeadDataFromObject(leadInfo = {}, options = {}) {
            if (!leadInfo || !leadInfo.id) {
                console.warn('‚ö†Ô∏è applyLeadDataFromObject √ßaƒürƒ±ldƒ± ancak ge√ßerli lead ID yok');
                return;
            }

            const leadName = leadInfo.Full_Name ||
                leadInfo.full_name ||
                leadInfo.name ||
                leadInfo.displayName ||
                leadInfo.First_Name && leadInfo.Last_Name ? `${leadInfo.First_Name} ${leadInfo.Last_Name}`.trim() : leadInfo.First_Name ||
                leadInfo.customerName ||
                leadInfo.contactName ||
                '';

            const leadPhone = leadInfo.Phone ||
                leadInfo.Mobile ||
                leadInfo.phone ||
                leadInfo.mobile ||
                leadInfo.customerPhone ||
                '';

            const leadEmail = leadInfo.Email || leadInfo.email || '';

            window.leadId = leadInfo.id;
            let finalLeadName = (leadName || '').trim();
            // ‚úÖ Fallback 1: API'den isim gelmezse parent sayfa ba≈ülƒ±ƒüƒ±ndan al
            if (!finalLeadName && window.parent && window.parent !== window) {
                try {
                    const title = window.parent.document.title || '';
                    if (title && title.indexOf(' - ') !== -1) {
                        const fromTitle = title.split(' - ')[0].trim();
                        if (fromTitle.length >= 2 && fromTitle.length <= 80) {
                            finalLeadName = fromTitle;
                            console.log('‚úÖ Lead ismi parent sayfa ba≈ülƒ±ƒüƒ±ndan alƒ±ndƒ±:', finalLeadName);
                        }
                    }
                } catch (e) { /* cross-origin */ }
            }
            // ‚úÖ Fallback 2: H√¢l√¢ yoksa URL'den (recordName= veya leadName=)
            if (!finalLeadName) {
                const p = new URLSearchParams(window.location.search);
                const fromUrl = p.get('recordName') || p.get('leadName') || p.get('record_name') || p.get('full_name') || p.get('Full_Name');
                if (fromUrl && typeof fromUrl === 'string') {
                    const t = fromUrl.trim();
                    if (t.length >= 2 && t.length <= 100 && !t.includes('{{') && !t.includes('$')) {
                        finalLeadName = t;
                        console.log('‚úÖ Lead ismi URL parametresinden alƒ±ndƒ± (applyLeadData):', finalLeadName);
                    }
                }
            }
            // ‚úÖ API'den isim geldiyse onu kullan; yoksa fallback'leri kullan; hi√ßbiri yoksa mevcut window.leadName'ƒ± Sƒ∞LME (URL'den set edilmi≈ü olabilir)
            if (finalLeadName) {
                window.leadName = finalLeadName;
            } else if (typeof window.leadName === 'undefined' || window.leadName === null) {
                window.leadName = '';
            }
            window.leadPhone = leadPhone || '';
            window.leadEmail = leadEmail || '';

            if (window.conversationsState) {
                window.conversationsState.showAll = false;
                window.conversationsState.filteredConversations = [];
            }
            if (window.conversationsStateBySender && typeof window.conversationsStateBySender === 'object') {
                Object.keys(window.conversationsStateBySender).forEach(senderKey => {
                    const senderState = window.conversationsStateBySender[senderKey];
                    if (senderState && typeof senderState === 'object') {
                        senderState.showAll = false;
                        senderState.filteredConversations = [];
                    }
                });
            }

            console.log('[LEAD] Lead bilgisi uygulandƒ± ‚Üí Fƒ∞LTRE BUNU KULLANIR:', {
                id: window.leadId,
                leadName: window.leadName || '(BO≈û ‚Äì filtre uygulanmaz)',
                source: options.source || 'unknown'
            });

            window.dispatchEvent(new CustomEvent("zohoLeadDataLoaded", {
                detail: {
                    id: window.leadId,
                    Full_Name: window.leadName,
                    name: window.leadName,
                    phone: window.leadPhone,
                    email: window.leadEmail,
                    source: options.source || null
                }
            }));

            if (options.triggerLoad !== false && typeof loadConversations === "function") {
                setTimeout(() => {
                    loadConversations(false);
                }, 150);
            }
        }

        // Lead verilerini √ßeken ayrƒ± fonksiyon
        function fetchLeadData(leadId, options = {}) {
            if (!leadId) {
                console.error('‚ùå fetchLeadData: leadId gerekli');
                return;
            }
            
            console.log('‚úÖ‚úÖ‚úÖ Final Lead ID:', leadId);
            
            // Get lead info from backend (Zoho access token already configured)
            // Relative path kullan - widget nerede √ßalƒ±≈üƒ±yorsa oradan istek at
            const referrerParam = document.referrer || '';
            let parentHref = '';
            try {
                if (window.parent && window.parent !== window) {
                    parentHref = window.parent.location?.href || '';
                }
            } catch (e) {
                // CORS hatasƒ± normal
            }
            const apiUrl = `/api/zoho/lead-info?id=${encodeURIComponent(leadId)}&referrer=${encodeURIComponent(referrerParam)}&parentUrl=${encodeURIComponent(parentHref)}`;
            console.log('üì°üì°üì° FETCHING FROM BACKEND:', apiUrl);
            
            return fetch(apiUrl)
                .then(res => {
                    console.log('üì°üì°üì° BACKEND RESPONSE STATUS:', res.status, res.statusText);
                    if (!res.ok) {
                        console.error('‚ùå‚ùå‚ùå Backend error:', res.status, res.statusText);
                        return res.text().then(text => {
                            console.error('   Error body:', text);
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        });
                    }
                    return res.json();
                })
                .then(lead => {
                    applyLeadDataFromObject({ id: leadId, ...lead }, { source: options.source || 'backend-fetch', triggerLoad: false });

                    // Also trigger loadConversations if available
                    setTimeout(() => {
                        if (typeof loadConversations === "function") {
                            console.log("üîÑ loadConversations triggered (lead phone loaded)");
                            loadConversations(false);
                        }
                    }, 300);
                })
                .catch(err => {
                    console.error('‚ùå Error fetching lead:', err);
                    console.error('   Lead ID:', leadId);
                    console.error('   Referrer:', document.referrer);
                });
        }
        
        // Dinamik lead takibi - URL deƒüi≈üikliklerini izle
        let lastLeadId = null;
        
        function checkLeadChange() {
            let currentLeadId = null;
            
            // URL parametrelerinden kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            currentLeadId = urlParams.get('leadId') || urlParams.get('id') || urlParams.get('recordId') || urlParams.get('record_id');
            
            // Parent window'dan kontrol et (iframe i√ßinde)
            if (!currentLeadId) {
                try {
                    if (window.parent && window.parent !== window) {
                        const parentUrl = window.parent.location?.href || '';
                        const parentLeadMatch = parentUrl.match(/\/tab\/Leads\/(\d+)/) || parentUrl.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d+)/);
                        if (parentLeadMatch && parentLeadMatch[1]) {
                            currentLeadId = parentLeadMatch[1];
                        }
                    }
                } catch (e) {
                    // CORS hatasƒ± normal
                }
            }
            
            // Referrer ve window.location.href'den kontrol et (AGRESƒ∞F)
            if (!currentLeadId) {
                const referrer = document.referrer || '';
                const currentUrl = window.location.href || '';
                const allUrls = [referrer, currentUrl].join(' ');
                
                // T√ºm pattern'leri dene
                let leadIdMatch = allUrls.match(/\/tab\/Leads\/(\d{10,})/) || 
                                 allUrls.match(/\/crm\/[^\/]+\/tab\/Leads\/(\d{10,})/) ||
                                 allUrls.match(/\/Leads\/(\d{10,})/) ||
                                 allUrls.match(/(\d{15,})/);
                
                if (leadIdMatch && leadIdMatch[1]) {
                    currentLeadId = leadIdMatch[1];
                }
            }
            
            // Lead ID deƒüi≈ütiyse veya ilk y√ºkleme ise
            if (currentLeadId && currentLeadId !== lastLeadId) {
                console.log('üîÑüîÑüîÑ Lead deƒüi≈üti! Eski:', lastLeadId, 'Yeni:', currentLeadId);
                lastLeadId = currentLeadId;
                
                // Global deƒüi≈ükenleri sƒ±fƒ±rla (√∂nemli: √∂nceki lead'in cache'ini temizle)
                window.leadId = null;
                window.leadPhone = null;
                window.leadName = null;
                window.leadEmail = null;
                
                // Yeni lead bilgilerini force reload ile √ßek
                console.log('üîÑ Yeni lead bilgileri √ßekiliyor...');
                loadLeadContext({ forceReload: true, preferredId: currentLeadId, source: 'polling' });
            } else if (!currentLeadId && lastLeadId) {
                // Lead ID kaybolduysa (√∂rneƒüin, ba≈üka bir sayfaya ge√ßildi)
                console.log('üîÑ Lead ID kayboldu. Eski:', lastLeadId);
                lastLeadId = null;
                // UI'ƒ± temizle veya bo≈ü g√∂ster
                window.leadId = null;
                window.leadName = null;
                window.leadPhone = null;
                window.leadEmail = null;
                // Event g√∂nder ki app.js konu≈ümalarƒ± temizlesin
                window.dispatchEvent(new CustomEvent("zohoLeadDataLoaded", { 
                    detail: { id: null, name: null, phone: null, email: null } 
                }));
            }
        }
        
        // ‚úÖ Global kullanƒ±cƒ± bilgisi (t√ºm API isteklerinde kullanƒ±lacak)
        window.currentZohoUser = {
            email: null,
            id: null
        };
        
        // ‚úÖ Kullanƒ±cƒ± bilgisini al ve global deƒüi≈ükene kaydet
        async function getCurrentZohoUser() {
            if (window.currentZohoUser.email || window.currentZohoUser.id) {
                return window.currentZohoUser; // ‚úÖ Zaten alƒ±nmƒ±≈üsa cache'den d√∂nd√ºr
            }
            
            try {
                if (window.ZOHO && window.ZOHO.embeddedApp && typeof window.ZOHO.embeddedApp.getCurrentUser === 'function') {
                    const userInfo = await window.ZOHO.embeddedApp.getCurrentUser();
                    if (userInfo) {
                        window.currentZohoUser.email = userInfo.email || null;
                        window.currentZohoUser.id = userInfo.id || null;
                        console.log('‚úÖ Zoho kullanƒ±cƒ± bilgisi alƒ±ndƒ± ve cache\'lendi:', window.currentZohoUser);
                    }
                } else {
                    console.warn('‚ö†Ô∏è ZOHO.embeddedApp.getCurrentUser fonksiyonu mevcut deƒüil, kullanƒ±cƒ± bilgisi alƒ±namadƒ±');
                }
            } catch (zohoError) {
                console.warn('‚ö†Ô∏è Zoho kullanƒ±cƒ± bilgisi alƒ±namadƒ±:', zohoError.message);
            }
            
            return window.currentZohoUser;
        }
        
        // ‚úÖ API isteklerine userEmail parametresi ekle (helper function)
        function addUserParamsToUrl(url) {
            const user = window.currentZohoUser;
            if (!user.email && !user.id) {
                return url; // ‚úÖ Kullanƒ±cƒ± bilgisi yoksa deƒüi≈ütirme
            }
            
            const separator = url.includes('?') ? '&' : '?';
            if (user.email) {
                url += `${separator}userEmail=${encodeURIComponent(user.email)}`;
                if (user.id) {
                    url += `&userId=${encodeURIComponent(user.id)}`;
                }
            } else if (user.id) {
                url += `${separator}userId=${encodeURIComponent(user.id)}`;
            }
            
            return url;
        }
        
        // ‚úÖ Kullanƒ±cƒ± yetkilerini y√ºkle ve sender dropdown'ƒ±nƒ± filtrele
        async function loadUserPermissionsAndFilterSenders() {
            try {
                // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al
                await getCurrentZohoUser();
                const userEmail = window.currentZohoUser.email;
                const userId = window.currentZohoUser.id;
                
                // Backend'den kullanƒ±cƒ±nƒ±n g√∂rebileceƒüi sender'larƒ± al
                const permissionsUrl = `/api/zoho/user-permissions${userEmail ? '?userEmail=' + encodeURIComponent(userEmail) : ''}${userId ? (userEmail ? '&' : '?') + 'userId=' + encodeURIComponent(userId) : ''}`;
                const permissionsResponse = await fetch(permissionsUrl);
                const permissionsData = await permissionsResponse.json();
                
                if (permissionsData.success && permissionsData.allowedSenders) {
                    const allowedSenders = permissionsData.allowedSenders;
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    
                    if (channelFilterTop) {
                        // T√ºm sender'larƒ± tanƒ±mla
                        const allSenders = [
                            { value: '908505327532', label: 'VIP-+908505327532' },
                            { value: '905421363421', label: 'Hamzah Coexistence-+905421363421' }
                        ];
                        
                        // Dropdown'ƒ± temizle
                        channelFilterTop.innerHTML = '<option value="">Choose Sender</option>';
                        
                        // Yetkili sender'larƒ± ekle
                        allSenders.forEach(sender => {
                            // '*' = T√ºm sender'larƒ± g√∂rebilir
                            if (allowedSenders.includes('*') || allowedSenders.includes(sender.value)) {
                                const option = document.createElement('option');
                                option.value = sender.value;
                                option.textContent = sender.label;
                                channelFilterTop.appendChild(option);
                            }
                        });
                        
                        console.log('‚úÖ Sender dropdown filtrelendi:', { 
                            allowedSenders, 
                            visibleSenders: Array.from(channelFilterTop.options).map(opt => opt.value) 
                        });
                    }
                }
            } catch (error) {
                console.error('‚ùå Kullanƒ±cƒ± yetkileri y√ºklenemedi:', error);
                // Hata durumunda t√ºm sender'larƒ± g√∂ster (g√ºvenlik i√ßin deƒüi≈ütirilebilir)
            }
        }
        
        // ƒ∞lk y√ºkleme
        initZohoEmbeddedApp(); // PageLoad event ile recordId yakalamayƒ± dene
        loadLeadContext({ source: 'initial-load' });
        loadUserPermissionsAndFilterSenders(); // ‚úÖ Kullanƒ±cƒ± yetkilerini y√ºkle
        setTimeout(() => loadLeadContext({ source: 'initial-load-delay-300' }), 300);
        setTimeout(() => loadLeadContext({ source: 'initial-load-delay-600' }), 600);
        setTimeout(() => loadLeadContext({ source: 'initial-load-delay-1000' }), 1000);
        setTimeout(() => loadLeadContext({ source: 'initial-load-delay-2000' }), 2000);
        
        // Her 1 saniyede bir lead deƒüi≈üikliƒüini kontrol et (daha agresif)
        setInterval(checkLeadChange, 1000);
        
        // URL deƒüi≈üikliklerini de dinle (hashchange, popstate)
        window.addEventListener('hashchange', checkLeadChange);
        window.addEventListener('popstate', checkLeadChange);
        
        // MutationObserver ile URL deƒüi≈üikliklerini izle (iframe i√ßinde)
        if (window.parent !== window) {
            try {
                const observer = new MutationObserver(() => {
                    checkLeadChange();
                });
                observer.observe(document.body, { childList: true, subtree: true });
            } catch (e) {
                console.log('‚ö†Ô∏è MutationObserver hatasƒ±:', e);
            }
        }
    </script>

    <!-- ‚úÖ ACƒ∞L √á√ñZ√úM: Direkt baƒülantƒ± fonksiyonu - app.js'den baƒüƒ±msƒ±z √ßalƒ±≈üƒ±r -->
    <script>
        // ‚úÖ Dƒ∞REKT BAƒûLANTI FONKSƒ∞YONU - app.js'den baƒüƒ±msƒ±z √ßalƒ±≈üƒ±r
        window.connectSleekflowDirect = async function(silent = false) {
            // ‚úÖ KRƒ∞Tƒ∞K: conversationsState'i kontrol et ve yoksa initialize et
            if (!window.conversationsState) {
                window.conversationsState = {
                    allConversations: [],
                    filteredConversations: [],
                    showAll: false,
                    currentConversationId: null,
                    lastMessageCounts: {},
                    unreadCounts: {},
                    allMessages: {}, // ‚úÖ T√ºm mesajlar (WhatsApp + Instagram)
                    showAllMessages: {} // ‚úÖ Mesajlar i√ßin: { conversationId: true/false }
                };
            }
            
            // ‚úÖ KRƒ∞Tƒ∞K: unreadCounts yoksa initialize et
            if (!window.conversationsState.unreadCounts) {
                window.conversationsState.unreadCounts = {};
            }
            
            // API key ve base URL'i al
            const apiKeyInput = document.getElementById('sleekflowApiKey');
            const baseUrlSelect = document.getElementById('sleekflowBaseUrl');
            
            let apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
            let baseUrl = baseUrlSelect ? baseUrlSelect.value.trim() : 'https://sleekflow-core-app-weu-production.azurewebsites.net';
            
            // Eƒüer input bo≈üsa, localStorage'dan al
            if (!apiKey) {
                apiKey = localStorage.getItem('sleekflowApiKey') || '';
            }
            if (!baseUrl) {
                baseUrl = localStorage.getItem('sleekflowBaseUrl') || 'https://sleekflow-core-app-weu-production.azurewebsites.net';
            }
            
            if (!apiKey || apiKey.length < 10) {
                if (!silent) {
                alert('‚ùå API anahtarƒ± gerekli! L√ºtfen API anahtarƒ±nƒ± girin.');
                }
                return;
            }
            
            // Loading g√∂ster
            const btn = document.getElementById('connectSleekflow');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Baƒülanƒ±yor...';
            }
            
            try {
                // ‚úÖ PERFORMANS OPTƒ∞Mƒ∞ZASYONU: Baƒülantƒ± testini atla, direkt konu≈ümalarƒ± √ßek
                // API key ge√ßersizse zaten hata d√∂ner
                const API_BASE_URL = '/api';
                
                // localStorage'a hemen kaydet (ba≈üarƒ±lƒ± olursa zaten kayƒ±tlƒ± olacak)
                localStorage.setItem('sleekflowApiKey', apiKey);
                localStorage.setItem('sleekflowBaseUrl', baseUrl);
                
                // Sidebar'ƒ± hemen kapat (kullanƒ±cƒ± deneyimi i√ßin)
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.remove('open');
                    sidebar.style.setProperty('left', '-320px', 'important');
                    sidebar.style.setProperty('opacity', '0', 'important');
                    sidebar.style.setProperty('visibility', 'hidden', 'important');
                    sidebar.style.setProperty('display', 'none', 'important');
                }
                
                // ‚úÖ PERFORMANS: API key'i query parametresi olarak g√∂nder
                // ‚úÖ KRITIK: baseUrl undefined/null kontrol√º
                const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                
                // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al (backend yetki kontrol√º i√ßin)
                await getCurrentZohoUser();
                
                // ‚úÖ KRITIK: Se√ßili sender'ƒ± fromPhone olarak g√∂nder (backend'de filtreleme i√ßin)
                const channelFilterTop = document.getElementById('channelFilterTop');
                const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                
                let conversationsUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                if (window.leadName && String(window.leadName).trim()) {
                    conversationsUrl += '&leadName=' + encodeURIComponent(String(window.leadName).trim());
                }
                let leadIdForRequest = window.leadId || (() => { const p = new URLSearchParams(window.location.search); return p.get('recordId') || p.get('leadId') || p.get('id') || ''; })();
                if (!leadIdForRequest || /^[\$#\{\}]|recordid$/i.test(String(leadIdForRequest).trim()) || !/^\d{10,}$/.test(String(leadIdForRequest).trim())) {
                    const ref = document.referrer || '';
                    const m = ref.match(/\/tab\/Leads\/(\d{10,})/) || ref.match(/\/crm\/[^/]+\/tab\/Leads\/(\d{10,})/) || ref.match(/\/Leads\/(\d{10,})/);
                    leadIdForRequest = (m && m[1]) ? m[1] : '';
                }
                if (leadIdForRequest && String(leadIdForRequest).trim()) {
                    conversationsUrl += '&leadId=' + encodeURIComponent(String(leadIdForRequest).trim());
                }
                var pageRef = (typeof document !== 'undefined' && document.referrer) ? document.referrer : '';
                if (pageRef) conversationsUrl += '&pageReferrer=' + encodeURIComponent(pageRef);
                conversationsUrl = addUserParamsToUrl(conversationsUrl);
                
                const convResponse = await fetch(conversationsUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!convResponse.ok) {
                    const errorData = await convResponse.json().catch(() => ({ error: 'Konu≈ümalar y√ºklenemedi' }));
                    const error = new Error(errorData.error || 'Konu≈ümalar y√ºklenemedi');
                    if (!silent) {
                        throw error;
                    }
                    return;
                }
                
                const convData = await convResponse.json();
                const conversations = convData.conversations || [];
                // ‚úÖ Backend lead filtre uyguladƒ±ysa cevapta leadName/leadId d√∂ner ‚Äì frontend'de yoksa buradan al (filtre i√ßin)
                if (convData.leadName && typeof convData.leadName === 'string' && convData.leadName.trim()) {
                    if (!window.leadName || !String(window.leadName).trim()) {
                        window.leadName = convData.leadName.trim();
                        console.log('[LEAD] Backend cevabƒ±ndan leadName alƒ±ndƒ± ‚Üí filtre bunu kullanacak:', window.leadName);
                    }
                }
                if (convData.leadId && !window.leadId) window.leadId = convData.leadId;
                
                // ‚úÖ KRITIK: API'den gelen unreadCount deƒüerlerini state'e kaydet
                // AMA: √ñnceden okunan conversation'lar i√ßin unreadCount'u 0 yap (sayfa yenilendiƒüinde badge tekrar gelmesin)
                conversations.forEach(conv => {
                    const convId = conv.conversationId || conv.id;
                    if (convId) {
                        // Eƒüer bu conversation √∂nceden okunmu≈üsa, unreadCount'u 0 yap
                        if (readConversations.has(convId)) {
                            window.conversationsState.unreadCounts[convId] = 0;
                            conv.unreadCount = 0; // Conversation objesini de g√ºncelle
                        } else if (conv.unreadCount && conv.unreadCount > 0) {
                            if (!window.conversationsState.unreadCounts[convId]) {
                                window.conversationsState.unreadCounts[convId] = 0;
                            }
                            // API'den gelen unreadCount'u kullan (SleekFlow'un kendi sayƒ±sƒ±)
                            window.conversationsState.unreadCounts[convId] = conv.unreadCount;
                        }
                    }
                });
                
                // ‚úÖ BA≈ûARILI - localStorage'a kaydet
                localStorage.setItem('sleekflowConnected', 'true');
                
                // ‚úÖ KRƒ∞Tƒ∞K: showAll state'ini koru ‚Äì lead filtresi bu deƒüerlere g√∂re uygulanƒ±r
                const showAll = window.conversationsState.showAll || false;
                const leadNameForFilter = (window.leadName || '').trim();
                console.log('[LEAD] loadConversations ‚Üí render:', { leadName: leadNameForFilter || '(bo≈ü)', showAll, conversationsCount: conversations.length });
                renderConversationsDirectly(conversations, showAll);
                
                // ‚úÖ "T√ºm Konu≈ümalarƒ± G√∂ster" i√ßin: Lead filtresi OLMADAN se√ßili sendere ait t√ºm konu≈ümalarƒ± √ßekebilecek fonksiyon
                window.loadAllConversationsForSender = async function() {
                    if (typeof getCurrentZohoUser === 'function') await getCurrentZohoUser();
                    const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                    const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                    const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                    const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                    let url = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                    url = (typeof addUserParamsToUrl === 'function') ? addUserParamsToUrl(url) : url;
                    try {
                        const res = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
                        if (!res.ok) throw new Error('Konu≈ümalar y√ºklenemedi');
                        const data = await res.json();
                        const allConvs = data.conversations || [];
                        (allConvs || []).forEach(conv => {
                            const convId = conv.conversationId || conv.id;
                            if (convId && readConversations.has(convId)) {
                                if (window.conversationsState.unreadCounts) window.conversationsState.unreadCounts[convId] = 0;
                                conv.unreadCount = 0;
                            }
                        });
                        window.conversationsState.allConversations = allConvs;
                        window.conversationsState.showAll = true;
                        const senderState = getCurrentSenderState ? getCurrentSenderState() : {};
                        if (senderState) { senderState.allConversations = allConvs; senderState.showAll = true; }
                        renderConversationsDirectly(allConvs, true);
                        console.log('[LEAD] T√ºm konu≈ümalar y√ºklendi (lead filtresi yok):', allConvs.length);
                    } catch (err) {
                        console.error('[LEAD] T√ºm konu≈ümalar y√ºklenemedi:', err);
                    }
                };
                
                // ‚úÖ Kanal filtreleme event listener'ƒ±nƒ± kur
                setupChannelFilter();
                
                // ‚úÖ Polling ba≈ülat - Yeni mesajlarƒ± otomatik kontrol et
                if (typeof startMessagePolling === 'function') {
                    startMessagePolling();
                }
                
                // ‚úÖ ƒ∞LK Y√úKLEMEDE: Sadece ilk N konu≈ümanƒ±n mesaj sayƒ±sƒ±nƒ± kaydet (baseline) ‚Äì √ßok sayƒ±da istek ERR_INSUFFICIENT_RESOURCES √∂nlenir
                const BASELINE_MAX = 40;
                const BASELINE_BATCH = 8;
                setTimeout(async () => {
                    const toProcess = conversations.slice(0, BASELINE_MAX);
                    for (let i = 0; i < toProcess.length; i += BASELINE_BATCH) {
                        const batch = toProcess.slice(i, i + BASELINE_BATCH);
                        const batchPromises = batch.map(async (conv) => {
                            const convId = conv.conversationId || conv.id;
                            if (!convId) return;
                            try {
                                const msgResponse = await fetch(`/api/sleekflow/conversations/${convId}/messages`, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                const msgData = await msgResponse.json();
                                const msgCount = (msgData.messages || []).length;
                                lastMessageCount[convId] = msgCount;
                                if (!window.conversationsState.unreadCounts[convId]) {
                                    window.conversationsState.unreadCounts[convId] = 0;
                                }
                            } catch (err) {
                                lastMessageCount[convId] = 0;
                            }
                        });
                        await Promise.all(batchPromises);
                    }
                    if (toProcess.length) console.log('‚úÖ Baseline mesaj sayƒ±larƒ± kaydedildi (ilk ' + toProcess.length + ' konu≈üma)');
                }, 1000);
                
                // Event dispatch et (app.js dinliyorsa)
                window.dispatchEvent(new CustomEvent('sleekflowConnected', { 
                    detail: { conversations: conversations } 
                }));
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üîó SleekFlow\'a Baƒülan';
                }
                
            } catch (error) {
                console.error('‚ùå Baƒülantƒ± hatasƒ±:', error);
                if (!silent) {
                alert('‚ùå Baƒülantƒ± hatasƒ±: ' + error.message);
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üîó SleekFlow\'a Baƒülan';
                }
            }
        };
        
        // ‚úÖ BUTON EVENT LISTENER'INI HEMEN KUR
        function setupConnectButton() {
            const btn = document.getElementById('connectSleekflow');
            if (btn) {
                btn.onclick = function() {
                    // √ñnce direkt fonksiyonu dene
                    if (typeof window.connectSleekflowDirect === 'function') {
                        window.connectSleekflowDirect();
                    } else if (typeof window.connectSleekflow === 'function') {
                        window.connectSleekflow();
                    } else {
                        alert('‚ùå Baƒülantƒ± fonksiyonu bulunamadƒ±! Sayfa yenileniyor...');
                        window.location.reload();
                    }
                };
            }
        }
        
        // ‚úÖ HEMEN DENE
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupConnectButton);
        } else {
            setupConnectButton();
        }
        
        // ‚úÖ EK G√úVENLƒ∞K: Tekrar dene
        setTimeout(setupConnectButton, 500);
        setTimeout(setupConnectButton, 1000);
        
        // ‚úÖ OTOMATƒ∞K BAƒûLANTI - Sayfa y√ºklendiƒüinde localStorage'dan API key'i kontrol et ve otomatik baƒülan
        async function autoConnectSleekflow() {
            try {
                const savedApiKey = localStorage.getItem('sleekflowApiKey');
                const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || 'https://sleekflow-core-app-weu-production.azurewebsites.net';
                const savedConnected = localStorage.getItem('sleekflowConnected');
                
                // Eƒüer API key varsa ve daha √∂nce baƒülanmƒ±≈üsa otomatik baƒülan
                if (savedApiKey && savedApiKey.trim().length >= 10 && savedConnected === 'true') {
                    // Sidebar'ƒ± kapat
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('open');
                        sidebar.style.setProperty('left', '-320px', 'important');
                        sidebar.style.setProperty('opacity', '0', 'important');
                        sidebar.style.setProperty('visibility', 'hidden', 'important');
                        sidebar.style.setProperty('display', 'none', 'important');
                    }
                    
                    // Otomatik baƒülan (sessizce, alert g√∂sterme)
                    if (typeof window.connectSleekflowDirect === 'function') {
                        await window.connectSleekflowDirect(true); // true = silent mode
                        // Polling ba≈ülat
                        if (typeof startMessagePolling === 'function') {
                            startMessagePolling();
                        }
                    }
                }
            } catch (error) {
                // Hata olursa sessizce ge√ß, kullanƒ±cƒ± manuel baƒülanabilir
                console.log('Auto-connect hatasƒ± (normal):', error);
            }
        }
        
        // Sayfa y√ºklendiƒüinde otomatik baƒülan
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(autoConnectSleekflow, 500);
            });
        } else {
            setTimeout(autoConnectSleekflow, 500);
        }
    </script>
    
    <!-- Frontend Utilities (matchNames, normalizeName vb.) -->
    <script src="/utils/frontendUtils.js"></script>
    
    <!-- ‚úÖ KRƒ∞Tƒ∞K: Direkt render fonksiyonu - app.js y√ºklenmeden √∂nce √ßalƒ±≈üƒ±r -->
    <script>
        // ‚úÖ Name normalization fonksiyonu (frontendUtils y√ºklenmemi≈üse)
        function normalizeName(name) {
            if (!name) return '';
            return String(name)
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒ±/g, 'i')
                .replace(/ƒü/g, 'g')
                .replace(/√º/g, 'u')
                .replace(/≈ü/g, 's')
                .replace(/√∂/g, 'o')
                .replace(/√ß/g, 'c')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // ‚úÖ ƒ∞sim e≈üle≈ütirme fonksiyonu (gev≈üek: tek kelime/soyisim de yeterli)
        function matchNames(leadName, conversationName) {
            if (!leadName || !conversationName) return false;
            const normalizedLead = normalizeName(leadName);
            const normalizedConv = normalizeName(conversationName);
            if (/^(bilinmeyen|unknown)$/i.test(normalizedConv)) return false;
            if (normalizedLead === normalizedConv) return true;
            if (normalizedConv.includes(normalizedLead) && normalizedLead.length >= 3) return true;
            if (normalizedLead.includes(normalizedConv) && normalizedConv.length >= 3) return true;
            const leadWords = normalizedLead.split(' ').filter(w => w.length >= 2);
            const convWords = normalizedConv.split(' ').filter(w => w.length >= 2);
            if (leadWords.length > 0 && convWords.length > 0) {
                const matchingWords = leadWords.filter(leadWord =>
                    convWords.some(convWord => convWord === leadWord)
                );
                if (matchingWords.length === leadWords.length && (leadWords.length >= 2 || (leadWords.length === 1 && leadWords[0].length >= 3))) return true;
                if (matchingWords.length >= 2) return true;
                if (leadWords.length === 1 && leadWords[0].length >= 4 && matchingWords.length === 1) return true;
                if (matchingWords.length >= 1 && leadWords.some(w => w.length >= 4) && matchingWords.some(w => w.length >= 4)) return true;
            }
            return false;
        }
        
        // ‚úÖ Global state - Sender'a g√∂re ayrƒ± state tut
        window.conversationsStateBySender = window.conversationsStateBySender || {};
        
        // ‚úÖ Helper: Mevcut sender'ƒ±n state'ini al veya olu≈ütur
        function getCurrentSenderState() {
            const channelFilterTop = document.getElementById('channelFilterTop');
            const selectedSender = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : 'default';
            
            if (!window.conversationsStateBySender[selectedSender]) {
                window.conversationsStateBySender[selectedSender] = {
                    allConversations: [],
                    filteredConversations: [],
                    showAll: false,
                    currentConversationId: null,
                    lastMessageCounts: {},
                    showAllMessages: {}, // ‚úÖ Mesajlar i√ßin: { conversationId: true/false }
                    unreadCounts: {},
                    loadedMessages: {},
                    bypassCacheFor: {}
                };
            }
            
            // ‚úÖ Global state'i de g√ºncelle (geriye d√∂n√ºk uyumluluk i√ßin)
            window.conversationsState = window.conversationsStateBySender[selectedSender];
            
            return window.conversationsStateBySender[selectedSender];
        }
        
        // ‚úÖ Global state (geriye d√∂n√ºk uyumluluk i√ßin)
        window.conversationsState = {
            allConversations: [],
            filteredConversations: [],
            showAll: false,
            currentConversationId: null,
            lastMessageCounts: {},
            unreadCounts: {},
            loadedMessages: {},
            bypassCacheFor: {}
        };
        
        // ‚úÖ Polling mekanizmasƒ± - Yeni mesajlarƒ± otomatik kontrol et (SADECE YENƒ∞ MESAJLARI EKLE)
        let messagePollInterval = null;
        // ‚úÖ lastMessageCount'u localStorage'dan y√ºkle (sayfa yenilendiƒüinde korunur)
        let lastMessageCount = {};
        try {
            const saved = localStorage.getItem('sleekflowLastMessageCounts');
            if (saved) {
                lastMessageCount = JSON.parse(saved);
            }
        } catch (e) {
            console.warn('lastMessageCount y√ºklenemedi:', e);
        }
        
        // ‚úÖ Okunan conversation'larƒ± localStorage'dan y√ºkle (sayfa yenilendiƒüinde korunur)
        let readConversations = new Set();
        try {
            const savedRead = localStorage.getItem('sleekflowReadConversations');
            if (savedRead) {
                readConversations = new Set(JSON.parse(savedRead));
            }
        } catch (e) {
            console.warn('readConversations y√ºklenemedi:', e);
        }
        
        // ‚úÖ lastMessageCount'u localStorage'a kaydetme fonksiyonu
        function saveLastMessageCounts() {
            try {
                localStorage.setItem('sleekflowLastMessageCounts', JSON.stringify(lastMessageCount));
            } catch (e) {
                console.warn('lastMessageCount kaydedilemedi:', e);
            }
        }
        
        // ‚úÖ Okunan conversation'larƒ± localStorage'a kaydetme fonksiyonu
        function saveReadConversations() {
            try {
                localStorage.setItem('sleekflowReadConversations', JSON.stringify(Array.from(readConversations)));
            } catch (e) {
                console.warn('readConversations kaydedilemedi:', e);
            }
        }
        
        function startMessagePolling() {
            // Eƒüer zaten polling varsa durdur
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
            }
            
            // ‚úÖ PERFORMANS: Polling interval'ƒ±nƒ± artƒ±r ve paralel istek sayƒ±sƒ±nƒ± sƒ±nƒ±rla
            let fastPollCount = 0;
            let isPolling = false; // √áakƒ±≈ümayƒ± √∂nlemek i√ßin flag
            // ‚úÖ Aktif conversation i√ßin daha hƒ±zlƒ± polling (1 saniye)
            messagePollInterval = setInterval(async () => {
                // ‚úÖ √áakƒ±≈üma kontrol√º - Eƒüer √∂nceki polling hala devam ediyorsa bekle
                if (isPolling) {
                    return;
                }
                
                const currentConvId = window.conversationsState.currentConversationId;
                const allConversations = window.conversationsState.allConversations || [];
                let needsUpdate = false;
                
                isPolling = true;
                
                try {
                    // ‚úÖ √ñNCE AKTƒ∞F CONVERSATION'ƒ± kontrol et (her 3 saniyede) - SADECE SON MESAJLARI
                    if (currentConvId) {
                        try {
                            // ‚úÖ API key'i al (polling i√ßin)
                            const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                            const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                            const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                            
                            // ‚úÖ ULTRA HIZLI: Sadece son 1 mesajƒ± kontrol et (yeni mesaj var mƒ± diye) - DAHA HIZLI
                            const url = `/api/sleekflow/conversations/${currentConvId}/messages?limit=1&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            const response = await fetch(url, {
                                method: 'GET',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const data = await response.json();
                            const messages = data.messages || [];
                            
                            // ‚úÖ ULTRA HIZLI: Sadece en son mesajƒ±n ID'sini kontrol et (limit=1 olduƒüu i√ßin messages[0])
                            const latestMsgId = messages.length > 0 ? (messages[0].id || messages[0].timestamp || messages[0].messageUniqueID) : null;
                            const prevLatestMsgId = lastMessageCount[currentConvId + '_latest'] || null;
                            
                            if (latestMsgId && latestMsgId !== prevLatestMsgId) {
                                console.log('üÜï Yeni mesaj tespit edildi!', { currentConvId, latestMsgId, prevLatestMsgId });
                                // ‚úÖ Yeni mesaj var - Ama √∂nce mesajƒ±n direction'ƒ±nƒ± kontrol et (limit=1 olduƒüu i√ßin messages[0])
                                const latestMsg = messages[0];
                                const isSent = latestMsg.direction === 'sent' || 
                                              latestMsg.isSentFromSleekflow === true ||
                                              latestMsg.isSentFromSleekflow === 'true' ||
                                              latestMsg.direction === 'outgoing';
                                
                                // ‚úÖ Sadece kar≈üƒ±dan gelen mesajlar i√ßin badge artƒ±r (aktif conversation'da bile)
                                const isReceived = !isSent && (
                                    latestMsg.direction === 'received' || 
                                    latestMsg.direction === 'incoming' ||
                                    (latestMsg.direction !== 'sent' && latestMsg.isSentFromSleekflow !== true && latestMsg.isSentFromSleekflow !== 'true')
                                );
                                
                                if (isReceived) {
                                    // Yeni mesaj var - T√úM mesajlarƒ± yeniden y√ºkle
                                    const fullResponse = await fetch(`/api/sleekflow/conversations/${currentConvId}/messages?limit=50&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    });
                                const fullData = await fullResponse.json();
                                let allMessages = fullData.messages || [];
                                
                                // ‚úÖ EN ESKƒ∞ EN √úSTTE, EN YENƒ∞ EN ALTTA sƒ±rala (normal chat gibi)
                                allMessages.sort((a, b) => {
                                    const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                    const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                    return timeA - timeB; // ‚úÖ En eski en √ºstte, en yeni en altta
                                });
                                
                                let conversation = null;
                                if (window.conversationsState && window.conversationsState.allConversations) {
                                    conversation = window.conversationsState.allConversations.find(c => 
                                        (c.conversationId || c.id) === currentConvId
                                    );
                                }
                                // ‚úÖ KRITIK: Cache'i g√ºncelle (yeni mesajlar g√∂r√ºns√ºn)
                                if (!window.conversationsState.loadedMessages) {
                                    window.conversationsState.loadedMessages = {};
                                }
                                window.conversationsState.loadedMessages[currentConvId] = allMessages;
                                
                                console.log('‚úÖ Yeni mesajlar render ediliyor:', { currentConvId, messageCount: allMessages.length });
                                renderMessagesDirectly(allMessages, currentConvId, conversation);
                                    lastMessageCount[currentConvId] = allMessages.length;
                                    lastMessageCount[currentConvId + '_latest'] = latestMsgId;
                                    saveLastMessageCounts();
                                    window.conversationsState.unreadCounts[currentConvId] = 0;
                                    
                                    // ‚úÖ KRITIK: Mesajlar render edildikten sonra scroll yap (yeni mesaj g√∂r√ºns√ºn)
                                    setTimeout(() => {
                                        const messagesArea = document.getElementById('messagesArea');
                                        const messagesList = document.getElementById('messagesList');
                                        const scrollContainer = messagesArea || messagesList;
                                        if (scrollContainer) {
                                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                        }
                                    }, 50);
                                    // ‚úÖ Ekstra scroll (DOM g√ºncellenmesi i√ßin)
                                    setTimeout(() => {
                                        const messagesArea = document.getElementById('messagesArea');
                                        const messagesList = document.getElementById('messagesList');
                                        const scrollContainer = messagesArea || messagesList;
                                        if (scrollContainer) {
                                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                        }
                                    }, 200);
                                } else {
                                    // ‚úÖ Bizim g√∂nderdiƒüimiz mesaj - Sadece ID'yi g√ºncelle, badge artƒ±rma
                                    lastMessageCount[currentConvId + '_latest'] = latestMsgId;
                                    saveLastMessageCounts();
                                }
                            } else if (!prevLatestMsgId && latestMsgId) {
                                // ƒ∞lk y√ºkleme
                                lastMessageCount[currentConvId + '_latest'] = latestMsgId;
                                saveLastMessageCounts();
                            }
                        } catch (error) {
                            // Sessizce ge√ß
                        }
                    }
                    
                    // ‚úÖ Dƒ∞ƒûER KONU≈ûMALAR ƒ∞√áƒ∞N: Her 5 polling'de bir kontrol et (performans i√ßin)
                    fastPollCount++;
                    if (fastPollCount >= 5) {
                        fastPollCount = 0;
                        
                        // ‚úÖ PERFORMANS: Sadece ilk 20 konu≈ümayƒ± kontrol et (en son mesajla≈üanlar)
                        const otherConversations = allConversations
                            .filter(conv => {
                                const convId = conv.conversationId || conv.id;
                                return convId && convId !== currentConvId;
                            })
                            .slice(0, 20); // ‚úÖ Sadece ilk 20 konu≈üma
                        
                        // ‚úÖ PERFORMANS: Paralel istek sayƒ±sƒ±nƒ± sƒ±nƒ±rla (batch processing)
                        const BATCH_SIZE = 5; // Aynƒ± anda en fazla 5 istek
                        for (let i = 0; i < otherConversations.length; i += BATCH_SIZE) {
                            const batch = otherConversations.slice(i, i + BATCH_SIZE);
                            
                            const checkPromises = batch.map(async (conv) => {
                                const convId = conv.conversationId || conv.id;
                                if (!convId) return false;
                                
                                try {
                                    // ‚úÖ API key'i al (polling i√ßin)
                                    const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                                    const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                                    const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                                    
                                    // ‚úÖ ULTRA HIZLI: Sadece son 1 mesajƒ± kontrol et (√ßok hƒ±zlƒ±)
                                    const url = `/api/sleekflow/conversations/${convId}/messages?limit=1&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                    const response = await fetch(url, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    });
                                    const data = await response.json();
                                    const messages = data.messages || [];
                                    
                                    if (messages.length === 0) return false;
                                    
                                    const latestMsgId = messages[0].id || messages[0].timestamp;
                                    const prevLatestMsgId = lastMessageCount[convId + '_latest'];
                                    
                                    if (latestMsgId && latestMsgId !== prevLatestMsgId) {
                                        // ‚úÖ Yeni mesaj var - SADECE KAR≈ûIDAN GELEN (received) MESAJLAR ƒ∞√áƒ∞N BADGE ARTIR
                                        const latestMsg = messages[0];
                                        
                                        // ‚úÖ G√ú√áL√ú KONTROL: Sadece ger√ßekten kar≈üƒ±dan gelen mesajlar i√ßin badge artƒ±r
                                        // Eƒüer direction === 'sent' veya isSentFromSleekflow === true ise ‚Üí bizim g√∂nderdiƒüimiz
                                        const isSent = latestMsg.direction === 'sent' || 
                                                      latestMsg.isSentFromSleekflow === true ||
                                                      latestMsg.isSentFromSleekflow === 'true' ||
                                                      latestMsg.direction === 'outgoing';
                                        
                                        // ‚úÖ GEV≈ûETƒ∞LMƒ∞≈û KONTROL: direction !== 'sent' ve isSentFromSleekflow !== true ise received kabul et
                                        const isReceived = !isSent && (
                                            latestMsg.direction === 'received' || 
                                            latestMsg.direction === 'incoming' ||
                                            (latestMsg.direction !== 'sent' && latestMsg.isSentFromSleekflow !== true && latestMsg.isSentFromSleekflow !== 'true')
                                        );
                                        
                                        if (isReceived) {
                                            // Sadece kar≈üƒ±dan gelen mesajlar i√ßin badge artƒ±r
                                            if (!window.conversationsState.unreadCounts[convId]) {
                                                window.conversationsState.unreadCounts[convId] = 0;
                                            }
                                            window.conversationsState.unreadCounts[convId] += 1;
                                            lastMessageCount[convId + '_latest'] = latestMsgId;
                                            saveLastMessageCounts();
                                            needsUpdate = true;
                                            console.log('‚úÖ Badge artƒ±rƒ±ldƒ±:', { convId, unreadCount: window.conversationsState.unreadCounts[convId], latestMsg: { direction: latestMsg.direction, isSentFromSleekflow: latestMsg.isSentFromSleekflow } });
                                            return true;
                                        } else {
                                            // Bizim g√∂nderdiƒüimiz mesaj veya belirsiz - badge artƒ±rma, sadece ID'yi g√ºncelle
                                            lastMessageCount[convId + '_latest'] = latestMsgId;
                                            saveLastMessageCounts();
                                            return false;
                                        }
                                    }
                                    
                                    // ƒ∞lk kontrol
                                    if (!prevLatestMsgId && latestMsgId) {
                                        lastMessageCount[convId + '_latest'] = latestMsgId;
                                        saveLastMessageCounts();
                                    }
                                    
                                    return false;
                                } catch (error) {
                                    return false;
                                }
                            });
                            
                            await Promise.all(checkPromises);
                            
                            // ‚úÖ Batch'ler arasƒ±nda kƒ±sa bir bekleme (rate limiting)
                            if (i + BATCH_SIZE < otherConversations.length) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                        }
                    }
                    
                    // ‚úÖ Okunmamƒ±≈ü mesaj varsa konu≈üma listesini dinamik olarak g√ºncelle
                    if (needsUpdate) {
                        const showAll = window.conversationsState.showAll || false;
                        renderConversationsDirectly(allConversations, showAll);
                    }
                } finally {
                    isPolling = false;
                }
            }, 500); // ‚úÖ 500ms - KAR≈ûI TARAF MESAJ ATTIƒûINDA HEMEN G√ñR√úNS√úN
        }
        
        function stopMessagePolling() {
            if (messagePollInterval) {
                clearInterval(messagePollInterval);
                messagePollInterval = null;
            }
            lastMessageCount = {};
        }
        
        // ‚úÖ Mesaj g√∂nderme fonksiyonu
        async function sendMessageDirectly() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            const messagesList = document.getElementById('messagesList');
            const conversationId = window.conversationsState.currentConversationId;
            
            if (!conversationId) {
                alert('L√ºtfen bir konu≈üma se√ßin');
                return;
            }
            
            // ‚úÖ 24 SAAT KURALI KONTROL√ú - Normal mesaj g√∂nderirken kontrol et
            const savedApiKey = localStorage.getItem('sleekflowApiKey') || '';
            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
            
            let hoursSinceLastContact = null;
            let isWhatsApp = false;
            try {
                const convDetailsResponse = await fetch(`/api/sleekflow/conversation/${conversationId}?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`);
                if (convDetailsResponse.ok) {
                    const convDetailsData = await convDetailsResponse.json();
                    const convDetails = convDetailsData.conversation;
                    if (convDetails) {
                        const channel = convDetails.lastMessageChannel || convDetails.channel || '';
                        isWhatsApp = channel && (
                            channel.toLowerCase().includes('whatsapp') ||
                            channel.toLowerCase().includes('messagebird') ||
                            channel.toLowerCase().includes('whatsappcloudapi') ||
                            channel.toLowerCase().includes('whatsapp360dialog') ||
                            channel.toLowerCase().includes('whatsapptwilio')
                        );
                        
                        const lastContactFromCustomers = convDetails.userProfile?.lastContactFromCustomers;
                        if (lastContactFromCustomers) {
                            const lastContactDate = new Date(lastContactFromCustomers);
                            const now = new Date();
                            hoursSinceLastContact = Math.floor((now - lastContactDate) / (1000 * 60 * 60));
                        }
                    }
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è Conversation detaylarƒ± √ßekilemedi, 24 saat kontrol√º yapƒ±lamadƒ±:', err);
            }
            
            // ‚úÖ 24 saat kuralƒ± kontrol√º - Normal mesaj g√∂nderilemez
            if (isWhatsApp && hoursSinceLastContact !== null && hoursSinceLastContact > 24) {
                alert('‚ùå 24 saat kuralƒ±: Bu konu≈ümada normal mesaj g√∂nderemezsiniz. L√ºtfen template mesaj kullanƒ±n.');
                if (sendButton) sendButton.disabled = false;
                return;
            }
            
            const text = messageInput ? messageInput.value.trim() : '';
            const hasFiles = window.selectedFiles && window.selectedFiles.length > 0;
            
            if (!text && !hasFiles) {
                alert('L√ºtfen mesaj yazƒ±n veya dosya se√ßin');
                return;
            }
            
            // ‚úÖ Sadece butonu disable et (input a√ßƒ±k kalsƒ±n, kullanƒ±cƒ± yazmaya devam edebilsin)
            if (sendButton) sendButton.disabled = true;
            
            // ‚úÖ OPTIMISTIC UPDATE: Mesajƒ± hemen UI'a ekle (text veya dosya varsa)
            let tempMessageId = null;
            if ((text || hasFiles) && messagesList) {
                tempMessageId = 'temp_' + Date.now();
                const msgDiv = document.createElement('div');
                msgDiv.id = tempMessageId;
                msgDiv.className = 'message sent';
                msgDiv.style.cssText = 'display: flex; margin-bottom: 12px; justify-content: flex-end;';
                
                const msgContent = document.createElement('div');
                msgContent.style.cssText = 'max-width: 70%; min-width: fit-content; width: fit-content; padding: 10px 14px; border-radius: 12px; background: #6366f1; color: white; word-break: normal; overflow-wrap: break-word; box-sizing: border-box; display: inline-block; white-space: pre-wrap; unicode-bidi: plaintext; line-height: 1.4;';
                
                // ‚úÖ Dosyalar varsa g√∂ster
                if (hasFiles) {
                    const filesHtml = window.selectedFiles.map((file, idx) => {
                        const fileName = file.name || 'Dosya';
                        const fileSize = file.size ? (file.size / 1024).toFixed(1) + ' KB' : '';
                        return `<div style="margin-bottom: 4px; font-size: 13px;">üìé ${fileName} (${fileSize})</div>`;
                    }).join('');
                    msgContent.innerHTML = filesHtml + (text ? `<div style="margin-top: 8px;">${text}</div>` : '');
                } else if (text) {
                    // ‚úÖ URL'leri tƒ±klanabilir linklere √ßevir
                    const escapeHtml = (txt) => {
                        const div = document.createElement('div');
                        div.textContent = txt;
                        return div.innerHTML;
                    };
                    const linkRegex = /(https?:\/\/[^\s<>"']+|www\.[^\s<>"']+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s<>"']*)/gi;
                    const textWithLinks = text.replace(linkRegex, (url) => {
                        let href = url.trim();
                        if (!href.match(/^https?:\/\//i)) {
                            href = href.startsWith('www.') ? 'https://' + href : 'https://' + href;
                        }
                        const safeHref = escapeHtml(href);
                        const safeUrl = escapeHtml(url);
                        return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" style="color: white; text-decoration: underline; word-break: break-all;">${safeUrl}</a>`;
                    });
                    msgContent.innerHTML = escapeHtml(textWithLinks.replace(linkRegex, (url) => {
                        let href = url.trim();
                        if (!href.match(/^https?:\/\//i)) {
                            href = href.startsWith('www.') ? 'https://' + href : 'https://' + href;
                        }
                        const safeHref = escapeHtml(href);
                        const safeUrl = escapeHtml(url);
                        return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" style="color: white; text-decoration: underline; word-break: break-all;">${safeUrl}</a>`;
                    }));
                }
                
                msgDiv.appendChild(msgContent);
                messagesList.appendChild(msgDiv);
                
                // ‚úÖ Scroll to bottom - daha g√º√ßl√º
                const messagesArea = document.getElementById('messagesArea');
                const scrollContainer = messagesArea || messagesList;
                requestAnimationFrame(() => {
                    if (scrollContainer) {
                        scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        setTimeout(() => {
                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        }, 100);
                    }
                });
            }
            
            // Input'u hemen temizle
            if (messageInput) messageInput.value = '';
            
            try {
                console.log('üì§ Mesaj g√∂nderiliyor:', { conversationId, text: text.substring(0, 50), hasFiles });
                
                // ‚úÖ API key ve baseUrl'i al - Zaten yukarƒ±da tanƒ±mlandƒ±
                if (!savedApiKey || savedApiKey.trim().length < 10) {
                    throw new Error('SleekFlow baƒülantƒ±sƒ± yok. L√ºtfen √∂nce baƒülanƒ±n.');
                }
                
                // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al (backend yetki kontrol√º i√ßin)
                await getCurrentZohoUser();
                
                // ‚úÖ Se√ßili sender numarasƒ±nƒ± al (hem dosya hem text i√ßin)
                const channelFilterTop = document.getElementById('channelFilterTop');
                const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : null;
                
                let response;
                if (hasFiles) {
                    // Dosya g√∂nderme - FormData kullan
                    const formData = new FormData();
                    if (text) formData.append('text', text);
                    formData.append('apiKey', savedApiKey);
                    if (safeBaseUrl) formData.append('baseUrl', safeBaseUrl);
                    // ‚úÖ Se√ßili sender numarasƒ±nƒ± FROM olarak ekle
                    if (selectedSenderPhone) {
                        formData.append('fromPhone', selectedSenderPhone);
                    }
                    // ‚úÖ Backend yetki kontrol√º i√ßin kullanƒ±cƒ± bilgisini ekle
                    if (window.currentZohoUser.email) {
                        formData.append('userEmail', window.currentZohoUser.email);
                    }
                    if (window.currentZohoUser.id) {
                        formData.append('userId', window.currentZohoUser.id);
                    }
                    window.selectedFiles.forEach((file) => {
                        formData.append('files', file);
                    });
                    
                    let messagesUrl = `/api/sleekflow/conversations/${conversationId}/messages?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    messagesUrl = addUserParamsToUrl(messagesUrl);
                    
                    response = await fetch(messagesUrl, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // Sadece metin g√∂nderme
                    const payload = { text, apiKey: savedApiKey, baseUrl: safeBaseUrl };
                    // ‚úÖ Se√ßili sender numarasƒ±nƒ± FROM olarak ekle
                    if (selectedSenderPhone) {
                        payload.fromPhone = selectedSenderPhone;
                    }
                    // ‚úÖ Backend yetki kontrol√º i√ßin kullanƒ±cƒ± bilgisini ekle
                    if (window.currentZohoUser.email) {
                        payload.userEmail = window.currentZohoUser.email;
                    }
                    if (window.currentZohoUser.id) {
                        payload.userId = window.currentZohoUser.id;
                    }
                    
                    let messagesUrl = `/api/sleekflow/conversations/${conversationId}/messages?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    messagesUrl = addUserParamsToUrl(messagesUrl);
                    
                    response = await fetch(messagesUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                }
                
                // ‚úÖ KRITIK: Response'u JSON'a √ßevirmeden √∂nce status kontrol√º yap
                if (!response.ok) {
                    // Hata durumunda temp mesajƒ± kaldƒ±r ve butonu enable et
                    if (tempMessageId) {
                        const tempMsg = document.getElementById(tempMessageId);
                        if (tempMsg) tempMsg.remove();
                    }
                    if (sendButton) sendButton.disabled = false;
                    
                    // ‚úÖ Response'u JSON'a √ßevir ve hata mesajƒ±nƒ± al
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `HTTP ${response.status}: Mesaj g√∂nderilemedi` };
                    }
                    
                    const errorMsg = errorData?.error || errorData?.message || `HTTP ${response.status}: Mesaj g√∂nderilemedi`;
                    console.error('‚ùå Mesaj g√∂nderilemedi (HTTP ' + response.status + '):', errorMsg, errorData);
                    
                    alert('‚ùå Mesaj g√∂nderilemedi: ' + errorMsg);
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                
                // ‚úÖ KRITIK: Backend response'unu kontrol et
                if (!result || !result.success) {
                    // Backend'den hata d√∂nd√º (200 OK ama success: false)
                    const errorMsg = result?.error || result?.message || 'Mesaj g√∂nderilemedi';
                    console.error('‚ùå Mesaj g√∂nderilemedi (backend error):', errorMsg, result);
                    
                    // Temp mesajƒ± kaldƒ±r
                    if (tempMessageId) {
                        const tempMsg = document.getElementById(tempMessageId);
                        if (tempMsg) tempMsg.remove();
                    }
                    if (sendButton) sendButton.disabled = false;
                    
                    alert('‚ùå Mesaj g√∂nderilemedi: ' + errorMsg);
                    throw new Error(errorMsg);
                }
                
                console.log('‚úÖ Mesaj g√∂nderildi:', result);
                
                // Dosyalarƒ± temizle
                window.selectedFiles = [];
                updateSelectedFilesDisplay();
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
                
                // ‚úÖ Butonu hemen enable et (mesaj g√∂nderildi, y√ºkleme arka planda)
                if (sendButton) sendButton.disabled = false;
                
                // ‚úÖ KRITIK: Cache'i bypass et ve mesajlarƒ± YENƒ∞DEN y√ºkle (ger√ßek mesajlar gelsin)
                // Cache bypass flag'i set et
                if (!window.conversationsState.bypassCacheFor) {
                    window.conversationsState.bypassCacheFor = {};
                }
                window.conversationsState.bypassCacheFor[conversationId] = true;
                
                // Cache'i de temizle
                if (window.conversationsState.loadedMessages) {
                    delete window.conversationsState.loadedMessages[conversationId];
                }
                
                // ‚úÖ Mesajlarƒ± HEMEN y√ºkle (cache bypass)
                loadMessagesDirectly(conversationId).then(() => {
                    // Bypass flag'ini temizle
                    if (window.conversationsState.bypassCacheFor) {
                        delete window.conversationsState.bypassCacheFor[conversationId];
                    }
                    // Mesajlar y√ºklendikten sonra temp mesajƒ± kaldƒ±r (ger√ßek mesajlar zaten g√∂r√ºn√ºyor)
                    setTimeout(() => {
                        if (tempMessageId) {
                            const tempMsg = document.getElementById(tempMessageId);
                            if (tempMsg) tempMsg.remove();
                        }
                        // Scroll to bottom
                        const messagesArea = document.getElementById('messagesArea');
                        const messagesList = document.getElementById('messagesList');
                        const scrollContainer = messagesArea || messagesList;
                        if (scrollContainer) {
                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                        }
                    }, 1000); // 1 saniye bekle (ger√ßek mesajlar API'den gelsin)
                }).catch((err) => {
                    console.error('Mesajlar y√ºklenirken hata:', err);
                    // Hata durumunda da temp mesajƒ± kaldƒ±r
                    if (tempMessageId) {
                        const tempMsg = document.getElementById(tempMessageId);
                        if (tempMsg) tempMsg.remove();
                    }
                });
                
                // Konu≈ümalarƒ± da arka planda yenile (showAll state'ini koru)
                if (window.conversationsState.allConversations.length > 0) {
                    const savedApiKey = localStorage.getItem('sleekflowApiKey');
                    const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                    const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                    
                    // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al (backend yetki kontrol√º i√ßin)
                    await getCurrentZohoUser();
                    
                    // ‚úÖ Se√ßili sender'ƒ± fromPhone olarak g√∂nder
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                    const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                    
                    let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                    convUrl = addUserParamsToUrl(convUrl);
                    fetch(convUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(convResponse => convResponse.json())
                      .then(convData => {
                          const conversations = convData.conversations || [];
                          // ‚úÖ KRITIK: showAll state'ini koru
                          const showAll = window.conversationsState.showAll || false;
                          window.renderConversationsDirectly(conversations, showAll);
                      }).catch(() => {});
                }
            } catch (error) {
                console.error('‚ùå Mesaj g√∂nderme hatasƒ±:', error);
                alert('Mesaj g√∂nderilemedi: ' + error.message);
            } finally {
                // Butonu enable et
                if (sendButton) sendButton.disabled = false;
                if (messageInput) messageInput.disabled = false;
            }
        }
        
        // ‚úÖ Dosya se√ßme state
        window.selectedFiles = [];
        
        // ‚úÖ Dosya se√ßme fonksiyonu
        function setupFileAttachment() {
            const attachButton = document.getElementById('attachFile');
            const fileInput = document.getElementById('fileInput');
            
            if (attachButton && fileInput) {
                attachButton.onclick = function() {
                    fileInput.click();
                };
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files || []);
                    window.selectedFiles = [...window.selectedFiles, ...files];
                    updateSelectedFilesDisplay();
                };
            }
        }
        
        // ‚úÖ Se√ßilen dosyalarƒ± g√∂ster
        function updateSelectedFilesDisplay() {
            const container = document.getElementById('selectedFilesContainer');
            if (!container) return;
            
            if (window.selectedFiles.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = window.selectedFiles.map((file, index) => {
                const fileName = file.name || 'Dosya';
                const fileSize = file.size ? (file.size / 1024).toFixed(1) + ' KB' : '';
                return `
                    <div style="display: flex; align-items: center; padding: 8px; background: #f3f4f6; border-radius: 4px; margin-bottom: 4px;">
                        <span style="flex: 1; font-size: 12px;">${fileName} (${fileSize})</span>
                        <button onclick="removeFile(${index})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">X</button>
                    </div>
                `;
            }).join('');
        }
        
        // ‚úÖ Dosya kaldƒ±r
        window.removeFile = function(index) {
            window.selectedFiles.splice(index, 1);
            updateSelectedFilesDisplay();
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
        };
        
        // ‚úÖ Mesaj g√∂nderme event listener'larƒ±nƒ± kur
        function setupMessageSending() {
            const sendButton = document.getElementById('sendMessage');
            const messageInput = document.getElementById('messageInput');
            
            if (sendButton) {
                sendButton.onclick = sendMessageDirectly;
            }
            
            if (messageInput) {
                // Enter tu≈üu ile g√∂nder
                messageInput.onkeypress = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessageDirectly();
                    }
                };
            }
            
            // ‚úÖ Dosya ekleme event listener'ƒ±nƒ± kur
            setupFileAttachment();
        }
        
        // ‚úÖ Mesajlarƒ± y√ºkle - HIZLI VERSƒ∞YON
        async function loadMessagesDirectly(conversationId) {
            try {
                // ‚úÖ √ñNCE chat view'ƒ± g√∂ster (kullanƒ±cƒ± hemen g√∂rs√ºn)
                const chatActive = document.getElementById('chatActive');
                const chatEmpty = document.querySelector('.chat-empty');
                if (chatEmpty) chatEmpty.style.display = 'none';
                if (chatActive) {
                    chatActive.style.display = 'flex';
                    chatActive.style.visibility = 'visible';
                    chatActive.style.opacity = '1';
                }
                
                // ‚úÖ Conversation bilgisini bul (paralel olarak)
                let conversation = null;
                if (window.conversationsState && window.conversationsState.allConversations) {
                    conversation = window.conversationsState.allConversations.find(c => 
                        (c.conversationId || c.id) === conversationId
                    );
                }
                
                // ‚úÖ HEMEN chat header'ƒ± g√ºncelle (mesajlar gelmeden √∂nce)
                const chatContactName = document.getElementById('chatContactName');
                const chatMeta = document.getElementById('chatMeta');
                const chatAvatar = document.getElementById('chatAvatar');
                if (conversation && conversation.contactName) {
                    if (chatContactName) chatContactName.textContent = conversation.contactName;
                    if (chatMeta) chatMeta.textContent = conversation.channel || 'Online';
                    if (chatAvatar) chatAvatar.textContent = conversation.contactName.substring(0, 2).toUpperCase();
                }
                
                // ‚úÖ API key'i al (24 saat kontrol√º i√ßin)
                const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                
                // ‚úÖ 24 SAAT KURALI KONTROL√ú - Conversation detaylarƒ±nƒ± √ßek
                let hoursSinceLastContact = null;
                let isWhatsApp = false;
                try {
                    const convDetailsResponse = await fetch(`/api/sleekflow/conversation/${conversationId}?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`);
                    if (convDetailsResponse.ok) {
                        const convDetailsData = await convDetailsResponse.json();
                        const convDetails = convDetailsData.conversation;
                        if (convDetails) {
                            // Channel kontrol√º
                            const channel = convDetails.lastMessageChannel || convDetails.channel || '';
                            isWhatsApp = channel && (
                                channel.toLowerCase().includes('whatsapp') ||
                                channel.toLowerCase().includes('messagebird') ||
                                channel.toLowerCase().includes('whatsappcloudapi') ||
                                channel.toLowerCase().includes('whatsapp360dialog') ||
                                channel.toLowerCase().includes('whatsapptwilio')
                            );
                            
                            // Last contact kontrol√º
                            const lastContactFromCustomers = convDetails.userProfile?.lastContactFromCustomers;
                            if (lastContactFromCustomers) {
                                const lastContactDate = new Date(lastContactFromCustomers);
                                const now = new Date();
                                hoursSinceLastContact = Math.floor((now - lastContactDate) / (1000 * 60 * 60));
                            }
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Conversation detaylarƒ± √ßekilemedi, 24 saat kontrol√º yapƒ±lamadƒ±:', err);
                }
                
                // ‚úÖ Mesaj input'u enable et (24 saat kontrol√ºnden sonra)
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendMessage');
                const attachFile = document.getElementById('attachFile');
                
                // ‚úÖ 24 saat kuralƒ± kontrol√º
                const normalMessageInput = document.getElementById('normalMessageInput');
                if (isWhatsApp && hoursSinceLastContact !== null && hoursSinceLastContact > 24) {
                    // 24 saat ge√ßti - uyarƒ± g√∂ster ve sadece mesaj input'unu gizle (Templates butonu kalacak)
                    show24HourWarning(true, hoursSinceLastContact);
                    if (normalMessageInput) {
                        normalMessageInput.style.display = 'none';
                    }
                    if (attachFile) {
                        attachFile.style.display = 'none';
                    }
                } else {
                    // 24 saat kuralƒ± yok - normal kullanƒ±m, mesaj input'unu g√∂ster
                    show24HourWarning(false);
                    if (normalMessageInput) {
                        normalMessageInput.style.display = 'flex';
                    }
                    if (attachFile) {
                        attachFile.style.display = 'block';
                    }
                    if (messageInput) {
                        messageInput.disabled = false;
                        messageInput.placeholder = 'Mesaj yazƒ±n...';
                    }
                    if (sendButton) sendButton.disabled = false;
                }
                
                // ‚úÖ Current conversation ID'yi kaydet (sender'a √∂zel state'e)
                const senderState = getCurrentSenderState();
                senderState.currentConversationId = conversationId;
                window.conversationsState.currentConversationId = conversationId; // Geriye d√∂n√ºk uyumluluk
                
                // ‚úÖ API √ßaƒürƒ±sƒ± (mesajlarƒ± √ßek) - HEMEN Y√úKLE: Son mesajlar hemen, eski mesajlar arka planda
                // ‚úÖ LAZY LOAD STATE: Hangi mesajlar y√ºklendi, ka√ß tane daha var
                if (!window.messageLoadState) {
                    window.messageLoadState = {};
                }
                const loadState = window.messageLoadState[conversationId] = {
                    loadedCount: 0,
                    totalMessages: null,
                    isLoading: false,
                    hasMore: true
                };
                
                // ‚úÖ API key'i al (mesaj y√ºkleme i√ßin) - Zaten yukarƒ±da tanƒ±mlandƒ±, tekrar tanƒ±mlama
                
                // ‚úÖ √ñNCE CACHE'DEN KONTROL ET (sayfa y√ºklenirken y√ºklenmi≈ü olabilir)
                // ‚úÖ AMA: Eƒüer mesaj g√∂nderildiyse cache'i bypass et (yeni mesajlar gelsin)
                const bypassCache = window.conversationsState?.bypassCacheFor?.[conversationId] || false;
                if (!bypassCache && window.conversationsState?.loadedMessages?.[conversationId]) {
                    const cachedMessages = window.conversationsState.loadedMessages[conversationId];
                    if (cachedMessages.length > 0) {
                        // ‚úÖ CACHE'DEN HEMEN RENDER ET (√ßok hƒ±zlƒ±!)
                        renderMessagesDirectly(cachedMessages, conversationId, conversation);
                        lastMessageCount[conversationId] = cachedMessages.length;
                        
                        // ‚úÖ KRITIK: Badge'i HEMEN temizle (mesaj a√ßƒ±ldƒ±, okundu) - Her durumda
                        window.conversationsState.unreadCounts[conversationId] = 0;
                        
                        // ‚úÖ KRITIK: Conversation'ƒ± okunan olarak i≈üaretle (sayfa yenilendiƒüinde badge tekrar gelmesin)
                        readConversations.add(conversationId);
                        saveReadConversations();
                        
                        // ‚úÖ KRITIK: Conversation objesinin unreadCount deƒüerini de g√ºncelle (API'den gelen deƒüer)
                        const conversations = window.conversationsState.allConversations || [];
                        const convIndex = conversations.findIndex(c => (c.conversationId || c.id) === conversationId);
                        if (convIndex !== -1) {
                            conversations[convIndex].unreadCount = 0;
                        }
                        
                        // ‚úÖ Son mesaj ID'sini g√ºncelle (polling tekrar aynƒ± mesajƒ± "yeni" olarak g√∂rmesin)
                        const lastMsg = cachedMessages[cachedMessages.length - 1];
                        const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                        if (lastMsgId) {
                            if (!lastMessageCount) {
                                lastMessageCount = {};
                            }
                            lastMessageCount[conversationId + '_latest'] = lastMsgId;
                            saveLastMessageCounts();
                        }
                        
                        // ‚úÖ Konu≈üma listesini HEMEN g√ºncelle (badge'i kaldƒ±rmak i√ßin)
                        const showAll = window.conversationsState.showAll || false;
                        if (window.renderConversationsDirectly) {
                            window.renderConversationsDirectly(conversations, showAll);
                        }
                        
                        setTimeout(() => {
                            const messagesArea = document.getElementById('messagesArea');
                            const scrollContainer = messagesArea || messagesList;
                            if (scrollContainer) {
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                            }
                        }, 50);
                        
                        setupInfiniteScroll(conversationId, conversation);
                        loadState.loadedCount = cachedMessages.length;
                        loadState.hasMore = cachedMessages.length >= 10;
                        
                        // Arka planda daha fazla mesaj y√ºkle
                        // ‚úÖ NOT: Artƒ±k ilk y√ºklemede 50 mesaj √ßekiyoruz, bu y√ºzden offset=50 olmalƒ±
                        if (cachedMessages.length >= 10) {
                            setTimeout(() => {
                                const msgUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=50${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                fetch(msgUrl)
                                    .then(r => r.json())
                                    .then(d => {
                                        const moreMsgs = d.messages || [];
                                        if (moreMsgs.length > 0) {
                                            const allMessages = [...cachedMessages, ...moreMsgs];
                                            allMessages.sort((a, b) => {
                                                const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                                const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                                return timeA - timeB;
                                            });
                                            window.conversationsState.loadedMessages[conversationId] = allMessages;
                                            loadState.loadedCount = allMessages.length;
                                            loadState.hasMore = moreMsgs.length >= 50;
                                        }
                                    })
                                    .catch(() => {});
                            }, 100);
                        }
                        // ‚úÖ Cache bypass flag'ini temizle
                        if (window.conversationsState.bypassCacheFor) {
                            delete window.conversationsState.bypassCacheFor[conversationId];
                        }
                        return; // ‚úÖ Cache'den y√ºklendi, API √ßaƒürƒ±sƒ± yapma
                    }
                }
                
                // ‚úÖ HEMEN SON MESAJLARI Y√úKLE (timeout yok, beklenir)
                try {
                    // ‚úÖ Channel filtreleme: VIP ve Hamzah i√ßin WhatsApp g√∂ster (Instagram hari√ß)
                    // ‚úÖ NOT: "T√ºm Mesajlarƒ± G√∂r" butonuna basƒ±ldƒ±ysa channel parametresi g√∂nderme
                    const senderState = getCurrentSenderState();
                    const showAllMessages = senderState.showAllMessages || {};
                    const shouldShowAllMessages = showAllMessages[conversationId] || false;
                    
                    const channelFilterTopMsg = document.getElementById('channelFilterTop');
                    const selectedSenderPhoneMsg = channelFilterTopMsg && channelFilterTopMsg.value ? channelFilterTopMsg.value : '';
                    let channelParam = '';
                    // ‚úÖ Sadece showAllMessages false ise channel ve fromPhone filtreleme yap
                    let fromPhoneParam = '';
                    if (!shouldShowAllMessages) {
                        if (selectedSenderPhoneMsg === '905421363421') {
                            // ‚úÖ Hamzah se√ßildi - Sadece WhatsApp mesajlarƒ± g√∂ster
                            // ‚úÖ NOT: Conversation'lar zaten backend'de doƒüru kanala g√∂re filtrelenmi≈ü geliyor
                            // ‚úÖ O y√ºzden mesajlarƒ± √ßekerken sadece WhatsApp mesajlarƒ±nƒ± filtrelemek yeterli
                            channelParam = '&channel=whatsapp';
                        }
                        // ‚úÖ VIP i√ßin: T√ºm mesajlar filtrelenmeden gelsin (channel parametresi g√∂nderme)
                        
                        // ‚úÖ KRITIK: fromPhone parametresi ekle - Aynƒ± conversation'da hem VIP hem Hamzah mesajlarƒ± varsa
                        // ‚úÖ Sadece se√ßili sender'dan g√∂nderilen mesajlarƒ± g√∂ster
                        if (selectedSenderPhoneMsg && (selectedSenderPhoneMsg === '908505327532' || selectedSenderPhoneMsg === '905421363421')) {
                            fromPhoneParam = `&fromPhone=${encodeURIComponent(selectedSenderPhoneMsg)}`;
                        }
                        
                        if (channelParam || fromPhoneParam) {
                            console.log('üîç [MESAJ Fƒ∞LTRELEME] Parametreler eklendi:', {
                                selectedSenderPhone: selectedSenderPhoneMsg,
                                isVIP: selectedSenderPhoneMsg === '908505327532',
                                isHamzah: selectedSenderPhoneMsg === '905421363421',
                                shouldShowAllMessages: shouldShowAllMessages,
                                channelParam: channelParam,
                                fromPhoneParam: fromPhoneParam
                            });
                        }
                    } else {
                        console.log('‚ö†Ô∏è [MESAJ Fƒ∞LTRELEME] Parametreler EKLENMEDƒ∞:', {
                            selectedSenderPhone: selectedSenderPhoneMsg,
                            shouldShowAllMessages: shouldShowAllMessages,
                            reason: shouldShowAllMessages ? 'showAllMessages=true' : 'sender e≈üle≈ümedi'
                        });
                    }
                    
                    // ‚úÖ HIZLANDIRMA: ƒ∞lk y√ºklemede daha fazla mesaj √ßek (10 -> 50)
                    const msgUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=0${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${channelParam}${fromPhoneParam}`;
                    const response = await fetch(msgUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    let allMessages = data.messages || [];
                    
                    // ‚úÖ ESKƒ∞ MANTIK: ƒ∞lk ba≈üta sadece WhatsApp mesajlarƒ±nƒ± g√∂ster
                    // ‚úÖ NOT: Channel filtreleme artƒ±k backend'de yapƒ±lƒ±yor (URL'de channel=whatsapp parametresi ile)
                    // ‚úÖ Backend'den zaten filtrelenmi≈ü mesajlar geliyor (VIP ve Hamzah i√ßin sadece WhatsApp)
                    // ‚úÖ showAllMessages kontrol√º: Eƒüer true ise t√ºm mesajlarƒ± g√∂ster (WhatsApp + Instagram)
                    let messages = allMessages;
                    
                    // ‚úÖ KRITIK: Mesajlarƒ± EN ESKƒ∞ EN √úSTTE, EN YENƒ∞ EN ALTTA sƒ±rala (normal chat gibi)
                    messages.sort((a, b) => {
                        const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                        const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                        return timeA - timeB; // ‚úÖ En eski en √ºstte, en yeni en altta
                    });
                    
                    // ‚úÖ T√ºm mesajlarƒ± state'te sakla (butona basƒ±nca g√∂sterilecek)
                    if (!window.conversationsState.allMessages) {
                        window.conversationsState.allMessages = {};
                    }
                    window.conversationsState.allMessages[conversationId] = allMessages;
                    
                    // ‚úÖ HEMEN RENDER ET (kullanƒ±cƒ± beklemez)
                    if (messages.length > 0 || allMessages.length > 0) {
                        if (!window.conversationsState.loadedMessages) {
                            window.conversationsState.loadedMessages = {};
                        }
                        window.conversationsState.loadedMessages[conversationId] = messages;
                        
                        renderMessagesDirectly(messages, conversationId, conversation);
                        lastMessageCount[conversationId] = messages.length;
                        
                        // ‚úÖ KRITIK: Son mesaj ID'sini g√ºncelle (polling i√ßin)
                        if (messages.length > 0) {
                            const lastMsg = messages[messages.length - 1]; // En son mesaj (en altta, en yeni)
                            const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                            if (lastMsgId) {
                                if (!lastMessageCount) {
                                    lastMessageCount = {};
                                }
                                lastMessageCount[conversationId + '_latest'] = lastMsgId;
                                saveLastMessageCounts();
                            }
                        }
                        
                        // ‚úÖ Scroll to bottom (en yeni mesajlar altta) - daha g√º√ßl√º
                        requestAnimationFrame(() => {
                            const messagesArea = document.getElementById('messagesArea');
                            const scrollContainer = messagesArea || messagesList;
                            if (scrollContainer) {
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                setTimeout(() => {
                                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                }, 100);
                                setTimeout(() => {
                                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                }, 300);
                            }
                        });
                        
                        // ‚úÖ INFINITE SCROLL: Yukarƒ± scroll yaptƒ±ƒüƒ±nda eski mesajlarƒ± y√ºkle
                        setupInfiniteScroll(conversationId, conversation);
                    }
                    
                    loadState.loadedCount = messages.length;
                    loadState.hasMore = messages.length >= 10; // Eƒüer 10 mesaj geldiyse daha fazla olabilir
                    
                    // ‚úÖ ARKA PLANDA DAHA FAZLA MESAJ Y√úKLE (kullanƒ±cƒ± fark etmez)
                    // ‚úÖ NOT: Artƒ±k ilk y√ºklemede 50 mesaj √ßekiyoruz, bu y√ºzden offset=50 olmalƒ±
                    if (messages.length >= 10) {
                        // Hemen arka planda ba≈ülat (kullanƒ±cƒ± fark etmez)
                        setTimeout(() => {
                            const moreMsgUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=50${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            fetch(moreMsgUrl)
                                .then(r => r.json())
                                .then(d => {
                                    const moreMsgs = d.messages || [];
                                    if (moreMsgs.length > 0) {
                                        // Mevcut mesajlara ekle ve sƒ±rala
                                        const allMessages = [...messages, ...moreMsgs];
                                        allMessages.sort((a, b) => {
                                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                            return timeA - timeB;
                                        });
                                        
                                        // State g√ºncelle (render etme, kullanƒ±cƒ± fark etmez)
                                        window.conversationsState.loadedMessages[conversationId] = allMessages;
                                        loadState.loadedCount = allMessages.length;
                                        loadState.hasMore = moreMsgs.length >= 50;
                                    }
                                })
                                .catch(() => {});
                        }, 100); // ‚úÖ 100ms sonra arka planda y√ºkle (kullanƒ±cƒ± fark etmez)
                    }
                } catch (error) {
                    console.error('Mesaj y√ºkleme hatasƒ±:', error);
                    renderMessagesDirectly([], conversationId, conversation);
                }
                
                
                // ‚úÖ KRITIK: Mesaj a√ßƒ±ldƒ± - Badge'i HEMEN temizle ve son mesaj ID'sini g√ºncelle
                const loadedMsgs = window.conversationsState.loadedMessages?.[conversationId] || [];
                
                // ‚úÖ Badge'i HEMEN temizle (mesaj a√ßƒ±ldƒ±, okundu) - Her durumda
                window.conversationsState.unreadCounts[conversationId] = 0;
                
                // ‚úÖ KRITIK: Conversation'ƒ± okunan olarak i≈üaretle (sayfa yenilendiƒüinde badge tekrar gelmesin)
                readConversations.add(conversationId);
                saveReadConversations();
                
                // ‚úÖ KRITIK: Conversation objesinin unreadCount deƒüerini de g√ºncelle (API'den gelen deƒüer)
                const conversations = window.conversationsState.allConversations || [];
                const convIndex = conversations.findIndex(c => (c.conversationId || c.id) === conversationId);
                if (convIndex !== -1) {
                    conversations[convIndex].unreadCount = 0;
                }
                
                // ‚úÖ Konu≈üma listesini HEMEN g√ºncelle (badge'i kaldƒ±rmak i√ßin)
                const showAll = window.conversationsState.showAll || false;
                if (window.renderConversationsDirectly) {
                    window.renderConversationsDirectly(conversations, showAll);
                }
                
                // ‚úÖ KRITIK: Son mesaj ID'sini her zaman g√ºncelle (polling tekrar aynƒ± mesajƒ± "yeni" olarak g√∂rmesin)
                if (loadedMsgs.length > 0) {
                    // En son mesajƒ± al (en altta, en yeni)
                    const lastMsg = loadedMsgs[loadedMsgs.length - 1];
                    const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                    if (lastMsgId) {
                        if (!lastMessageCount) {
                            lastMessageCount = {};
                        }
                        lastMessageCount[conversationId + '_latest'] = lastMsgId;
                        saveLastMessageCounts();
                    }
                }
            } catch (err) {
                console.error('‚ùå Mesajlar y√ºklenemedi:', err);
                alert('Mesajlar y√ºklenemedi: ' + err.message);
            }
        }
        
        // ‚úÖ 24 saat kuralƒ± uyarƒ±sƒ± g√∂ster/gizle
        function show24HourWarning(show, hoursSinceLastContact = null) {
            const warningDiv = document.getElementById('twentyFourHourWarning');
            const hoursDisplay = document.getElementById('hoursSinceLastContactDisplay');
            const normalMessageInput = document.getElementById('normalMessageInput');
            const attachFile = document.getElementById('attachFile');
            
            if (show && hoursSinceLastContact !== null && hoursSinceLastContact > 24) {
                const daysAgo = Math.floor(hoursSinceLastContact / 24);
                if (warningDiv) {
                    warningDiv.style.display = 'block';
                }
                if (hoursDisplay) {
                    hoursDisplay.textContent = `Son m√º≈üteri mesajƒ± ${daysAgo} g√ºn √∂nce.`;
                }
                // Sadece mesaj input'unu gizle (Templates butonu kalacak)
                if (normalMessageInput) {
                    normalMessageInput.style.display = 'none';
                }
                if (attachFile) {
                    attachFile.style.display = 'none';
                }
            } else {
                if (warningDiv) {
                    warningDiv.style.display = 'none';
                }
                // Mesaj input'unu g√∂ster
                if (normalMessageInput) {
                    normalMessageInput.style.display = 'flex';
                }
                if (attachFile) {
                    attachFile.style.display = 'block';
                }
            }
        }
        
        // ‚úÖ Mesajlarƒ± render et
        function renderMessagesDirectly(messages, conversationId, conversation = null) {
            const chatView = document.getElementById('chatView');
            const chatActive = document.getElementById('chatActive');
            const chatEmpty = document.querySelector('.chat-empty');
            const messagesList = document.getElementById('messagesList');
            const chatContactName = document.getElementById('chatContactName');
            const chatMeta = document.getElementById('chatMeta');
            const chatAvatar = document.getElementById('chatAvatar');
            
            if (!chatView || !chatActive || !messagesList) {
                console.error('‚ùå Chat elementleri bulunamadƒ±!');
                return;
            }
            
            // ‚úÖ Chat header'ƒ± g√ºncelle - ki≈üi ismini g√∂ster
            if (conversation && conversation.contactName) {
                const contactName = conversation.contactName;
                if (chatContactName) {
                    chatContactName.textContent = contactName;
                }
                if (chatMeta) {
                    chatMeta.textContent = conversation.channel || 'Online';
                }
                if (chatAvatar) {
                    chatAvatar.textContent = contactName.substring(0, 2).toUpperCase();
                }
            } else if (chatContactName) {
                // Conversation bilgisi yoksa, mesajlardan isim √ßƒ±karmaya √ßalƒ±≈ü
                chatContactName.textContent = 'Bilinmeyen';
                if (chatMeta) chatMeta.textContent = '';
            }
            
            // ‚úÖ Chat view'ƒ± g√∂ster - KRƒ∞Tƒ∞K: √ñnce chat view'ƒ± g√∂ster
            if (chatEmpty) chatEmpty.style.display = 'none';
            chatActive.style.display = 'flex';
            chatActive.style.visibility = 'visible';
            chatActive.style.opacity = '1';
            
            // ‚úÖ Current conversation ID'yi kaydet (sender'a √∂zel state'e)
            const senderState = getCurrentSenderState();
            senderState.currentConversationId = conversationId;
            window.conversationsState.currentConversationId = conversationId; // Geriye d√∂n√ºk uyumluluk
            
            // ‚úÖ Mesaj input ve g√∂nder butonunu enable et
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = 'Mesaj yazƒ±n...';
            }
            if (sendButton) {
                sendButton.disabled = false;
            }
            
            // ‚úÖ Mesaj g√∂nderme event listener'larƒ±nƒ± kur
            setupMessageSending();
            
            // Mesajlarƒ± render et
            console.log('üìù Mesajlar render ediliyor:', { conversationId, messageCount: messages.length });
            messagesList.innerHTML = '';
            
            messages.forEach((msg, index) => {
                // ‚úÖ DEBUG: Sadece sorunlu mesajlarƒ± logla (file type var ama fileUrl yok)
                if (index < 2 && (msg.messageType === 'file' || msg.type === 'file') && !msg.fileUrl && !msg.url) {
                    console.warn(`‚ö†Ô∏è File mesajƒ± ama fileUrl yok - MSG[${index}]:`, {
                        id: msg.id,
                        type: msg.type,
                        messageType: msg.messageType,
                        uploadedFiles: msg.uploadedFiles
                    });
                }
                
                const msgDiv = document.createElement('div');
                const isSent = msg.direction === 'sent' || msg.isSentFromSleekflow;
                msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                msgDiv.style.cssText = `display: flex; margin-bottom: 12px; ${isSent ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}`;
                
                const msgContent = document.createElement('div');
                // ‚úÖ ƒ∞lk stil - sonra mediaHtml varsa deƒüi≈ütirilecek
                const defaultStyle = `max-width: 70%; min-width: fit-content; width: fit-content; padding: 10px 14px; border-radius: 12px; ${isSent ? 'background: #6366f1; color: white;' : 'background: #f3f4f6; color: #111827;'} word-break: normal; overflow-wrap: normal; box-sizing: border-box; display: inline-block; white-space: normal;`;
                msgContent.style.cssText = defaultStyle;
                
                // ‚úÖ Video, fotoƒüraf veya dosya kontrol√º - T√úM ALANLARI KONTROL ET
                const messageType = (msg.type || msg.messageType || '').toLowerCase();
                
                // ‚úÖ T√úM OLASI FILE URL KAYNAKLARI (null kontrol√º ile)
                let fileUrl = '';
                if (msg.fileUrl && msg.fileUrl !== null && typeof msg.fileUrl === 'string' && msg.fileUrl.trim()) {
                    fileUrl = msg.fileUrl.trim();
                } else if (msg.url && msg.url !== null && typeof msg.url === 'string' && msg.url.trim()) {
                    fileUrl = msg.url.trim();
                } else if (msg.uploadedFiles && Array.isArray(msg.uploadedFiles) && msg.uploadedFiles.length > 0) {
                    const firstFile = msg.uploadedFiles[0];
                    const url = firstFile.url || firstFile.link || firstFile.fileUrl || '';
                    if (url && typeof url === 'string' && url.trim()) {
                        fileUrl = url.trim();
                    }
                }
                
                // ‚úÖ T√úM OLASI FILE TYPE KAYNAKLARI (null kontrol√º ile)
                let fileType = '';
                if (msg.fileType && msg.fileType !== null && typeof msg.fileType === 'string' && msg.fileType.trim()) {
                    fileType = msg.fileType.trim();
                } else if (msg.mimeType && msg.mimeType !== null && typeof msg.mimeType === 'string' && msg.mimeType.trim()) {
                    fileType = msg.mimeType.trim();
                } else if (msg.uploadedFiles && Array.isArray(msg.uploadedFiles) && msg.uploadedFiles.length > 0) {
                    const firstFile = msg.uploadedFiles[0];
                    const type = firstFile.type || firstFile.mimeType || firstFile.fileType || '';
                    if (type && typeof type === 'string' && type.trim()) {
                        fileType = type.trim();
                    }
                }
                
                // ‚úÖ T√úM OLASI FILE NAME KAYNAKLARI (null kontrol√º ile)
                let fileName = '';
                if (msg.fileName && msg.fileName !== null && typeof msg.fileName === 'string' && msg.fileName.trim()) {
                    fileName = msg.fileName.trim();
                } else if (msg.uploadedFiles && Array.isArray(msg.uploadedFiles) && msg.uploadedFiles.length > 0) {
                    const firstFile = msg.uploadedFiles[0];
                    const name = firstFile.filename || firstFile.name || firstFile.originalName || firstFile.fileName || '';
                    if (name && typeof name === 'string' && name.trim()) {
                        fileName = name.trim();
                    }
                }
                
                fileType = fileType.toLowerCase();
                
                // ‚úÖ DEBUG: Sadece sorunlu durumlarƒ± logla (file type var ama fileUrl yok)
                if (index < 2 && fileType && !fileUrl) {
                    console.warn(`‚ö†Ô∏è File type var ama fileUrl yok - MSG[${index}]:`, {
                        type: msg.type,
                        messageType,
                        fileType,
                        uploadedFiles: msg.uploadedFiles
                    });
                }
                
                // ‚úÖ Story kontrol√º - Daha kapsamlƒ±
                const isStory = !!(msg.isStory || msg.story || msg.isStoryReply || 
                                 (msg.channel && msg.channel.toLowerCase().includes('instagram') && 
                                  (messageType === 'story' || msg.type === 'story')));
                
                let mediaHtml = '';
                
                // ‚úÖ STORY MESAJLARI - √ñzel g√∂sterim (fileUrl varsa veya type file ise)
                if (isStory && fileUrl && fileUrl.length > 0) {
                    const isVideo = messageType === 'video' || 
                                   (messageType === 'file' && fileType && fileType.includes('video')) ||
                                   (fileType && fileType.includes('video')) || 
                                   (fileName && fileName.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i)) ||
                                   (fileUrl && fileUrl.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i));
                    
                    const isImage = messageType === 'image' || 
                                   messageType === 'photo' || 
                                   (messageType === 'file' && fileType && fileType.includes('image')) ||
                                   (fileType && fileType.includes('image')) || 
                                   (fileName && fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i)) ||
                                   (fileUrl && fileUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i));
                    
                    mediaHtml = `
                        <div style="border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'}; background: #fff;">
                            <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">üì± Story</div>
                            </div>
                            ${isVideo ? `
                                <video controls style="width: 100%; max-height: 500px; display: block;">
                                    <source src="${fileUrl}" type="video/mp4">
                                    Video y√ºklenemedi. <a href="${fileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">ƒ∞ndir</a>
                                </video>
                            ` : isImage ? `
                                <img src="${fileUrl}" alt="Story" style="width: 100%; max-height: 500px; display: block; object-fit: contain; cursor: pointer;" onclick="window.open('${fileUrl}', '_blank')">
                            ` : `
                                <div style="padding: 12px;"><a href="${fileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">üìé ${fileName || 'Dosya'}</a></div>
                            `}
                        </div>
                    `;
                }
                // ‚úÖ Video kontrol√º - √áOK KAPSAMLI (fileType √∂ncelikli)
                else {
                    // ‚úÖ √ñNCE fileType'dan kontrol et (en g√ºvenilir)
                    const isVideo = (fileType && fileType.includes('video')) || 
                                   messageType === 'video' || 
                                   (messageType === 'file' && fileType && fileType.includes('video')) ||
                                   (msg.type === 'file' && fileType && fileType.includes('video')) ||
                                   (fileName && fileName.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i)) ||
                                   (fileUrl && fileUrl.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv|3gp|m4v)$/i));
                    
                    // ‚úÖ DEBUG: Video tespiti i√ßin log
                    if (index < 5 && (fileType || fileUrl)) {
                        const trimmedUrl = fileUrl ? fileUrl.trim() : '';
                        const hasValidUrl = trimmedUrl && trimmedUrl.length > 0;
                        const willShow = isVideo && hasValidUrl;
                        console.log(`üé• VIDEO CHECK MSG[${index}]:`, {
                            isVideo,
                            fileType,
                            fileUrl: fileUrl ? fileUrl.substring(0, 80) : '(bo≈ü)',
                            fileUrlLength: fileUrl ? fileUrl.length : 0,
                            trimmedUrl: trimmedUrl ? trimmedUrl.substring(0, 50) : '(bo≈ü)',
                            trimmedUrlLength: trimmedUrl ? trimmedUrl.length : 0,
                            hasFileUrl: !!fileUrl,
                            hasValidUrl: hasValidUrl,
                            willShow: willShow,
                            direction: msg.direction,
                            isSent: isSent
                        });
                    }
                    
                    // ‚úÖ Video g√∂ster (fileUrl varsa VEYA fileType video ise - her durumda g√∂ster)
                    // ‚úÖ KRITIK: fileUrl.trim() kontrol√º - bo≈üluk karakterleri sorun √ßƒ±karabilir
                    const trimmedFileUrl = fileUrl ? fileUrl.trim() : '';
                    if (isVideo && trimmedFileUrl && trimmedFileUrl.length > 0) {
                        // ‚úÖ KRITIK: Video i√ßin √∂zel HTML - t√ºm stiller inline ve !important ile
                        mediaHtml = `
                            <div style="max-width: 100% !important; width: 100% !important; margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'} !important; padding: 0 !important; background: transparent !important; display: block !important;">
                                <video controls style="max-width: 300px !important; max-height: 300px !important; width: auto !important; height: auto !important; border-radius: 8px !important; display: block !important; visibility: visible !important; opacity: 1 !important;">
                                    <source src="${trimmedFileUrl}" type="video/mp4">
                                    Video y√ºklenemedi. <a href="${trimmedFileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">ƒ∞ndir</a>
                                </video>
                            </div>
                        `;
                        // ‚úÖ DEBUG: mediaHtml olu≈üturulduƒüunu logla
                        if (index < 5) {
                            console.log(`‚úÖ‚úÖ‚úÖ VIDEO HTML OLU≈ûTURULDU MSG[${index}]:`, {
                                mediaHtmlLength: mediaHtml.length,
                                fileUrl: trimmedFileUrl.substring(0, 80),
                                isVideo: isVideo,
                                hasValidUrl: true
                            });
                        }
                    } else if (index < 5 && isVideo) {
                        // ‚úÖ DEBUG: isVideo true ama mediaHtml olu≈üturulmadƒ±
                        const trimmedUrl = fileUrl ? fileUrl.trim() : '';
                        console.error(`‚ùå‚ùå‚ùå VIDEO HTML OLU≈ûTURULAMADI MSG[${index}]:`, {
                            isVideo: isVideo,
                            fileUrl: fileUrl || '(bo≈ü)',
                            fileUrlLength: fileUrl ? fileUrl.length : 0,
                            trimmedUrl: trimmedUrl || '(bo≈ü)',
                            trimmedLength: trimmedUrl ? trimmedUrl.length : 0,
                            reason: !fileUrl ? 'fileUrl yok' : (!trimmedUrl || trimmedUrl.length === 0) ? 'fileUrl bo≈ü/trim sonrasƒ± bo≈ü' : 'bilinmeyen'
                        });
                    }
                    // ‚úÖ Fotoƒüraf/resim kontrol√º - √áOK KAPSAMLI (fileType √∂ncelikli)
                    else {
                        // ‚úÖ √ñNCE fileType'dan kontrol et (en g√ºvenilir)
                        const isImage = (fileType && fileType.includes('image')) || 
                                       messageType === 'image' || 
                                       messageType === 'photo' || 
                                       (messageType === 'file' && fileType && fileType.includes('image')) ||
                                       (msg.type === 'file' && fileType && fileType.includes('image')) ||
                                       (fileName && fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i)) ||
                                       (fileUrl && fileUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|jfif)$/i));
                        
                        if (isImage && fileUrl && fileUrl.trim().length > 0) {
                            mediaHtml = `
                                <div style="max-width: 100%; margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'};">
                                    <img src="${fileUrl}" alt="${fileName || 'Resim'}" style="max-width: 300px; max-height: 300px; width: auto; height: auto; border-radius: 8px; display: block; cursor: pointer; object-fit: contain;" onclick="window.open('${fileUrl}', '_blank')">
                                </div>
                            `;
                        }
                        // ‚úÖ Diƒüer dosyalar
                        else if (fileUrl && fileUrl.trim().length > 0) {
                            mediaHtml = `
                                <div style="margin-bottom: ${msg.text || msg.messageContent || msg.content ? '8px' : '0'};"><a href="${fileUrl}" target="_blank" style="color: ${isSent ? 'white' : '#6366f1'}; text-decoration: underline;">üìé ${fileName || 'Dosya'}</a></div>
                            `;
                        }
                    }
                }
                
                // Mesaj i√ßeriƒüi ‚Äì olduƒüu gibi (trim yok: bo≈üluk, satƒ±r, noktalama, sembol korunur)
                const textContent = (msg.text || msg.messageContent || msg.content || '');
                
                // ‚úÖ Mesaj i√ßeriƒüini g√∂ster
                if (mediaHtml || textContent) {
                    // ‚úÖ KRITIK: Video/resim varsa msgContent stilini √ñNCE d√ºzelt (padding ve background kaldƒ±r)
                    if (mediaHtml) {
                        // Video/resim i√ßin √∂zel stil - padding ve background'u kaldƒ±r, display block yap
                        msgContent.style.cssText = `max-width: 100% !important; min-width: fit-content !important; width: fit-content !important; padding: 0 !important; border-radius: 12px !important; background: transparent !important; word-break: normal !important; overflow-wrap: normal !important; box-sizing: border-box !important; display: block !important; white-space: normal !important; margin: 0 !important;`;
                    }
                    
                    // ‚úÖ ƒ∞√ßeriƒüi set et - URL'leri tƒ±klanabilir linklere √ßevir
                    if (textContent) {
                        // ‚úÖ XSS korumasƒ± i√ßin escape fonksiyonu
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        // ‚úÖ URL'leri tƒ±klanabilir linklere √ßevir
                        const linkColor = isSent ? 'white' : '#6366f1';
                        const linkRegex = /(https?:\/\/[^\s<>"']+|www\.[^\s<>"']+|[a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s<>"']*)/gi;
                        
                        // ‚úÖ √ñnce URL'leri bul ve i≈üaretle
                        const urlMatches = [];
                        let match;
                        while ((match = linkRegex.exec(textContent)) !== null) {
                            urlMatches.push({
                                url: match[0],
                                index: match.index,
                                length: match[0].length
                            });
                        }
                        
                        // ‚úÖ Metni par√ßalara ayƒ±r ve URL'leri linklere √ßevir
                        let textWithLinks = '';
                        let lastIndex = 0;
                        
                        urlMatches.forEach((urlMatch) => {
                            // URL'den √∂nceki metni escape et ve ekle
                            if (urlMatch.index > lastIndex) {
                                textWithLinks += escapeHtml(textContent.substring(lastIndex, urlMatch.index));
                            }
                            
                            // URL'yi linke √ßevir
                            let href = urlMatch.url.trim();
                            if (!href.match(/^https?:\/\//i)) {
                                href = href.startsWith('www.') ? 'https://' + href : 'https://' + href;
                            }
                            const safeHref = escapeHtml(href);
                            const safeUrl = escapeHtml(urlMatch.url);
                            textWithLinks += `<a href="${safeHref}" target="_blank" rel="noopener noreferrer" style="color: ${linkColor}; text-decoration: underline; word-break: break-all;">${safeUrl}</a>`;
                            
                            lastIndex = urlMatch.index + urlMatch.length;
                        });
                        
                        // ‚úÖ Kalan metni escape et ve ekle
                        if (lastIndex < textContent.length) {
                            textWithLinks += escapeHtml(textContent.substring(lastIndex));
                        }
                        
                        // ‚úÖ Eƒüer hi√ß URL bulunamadƒ±ysa, t√ºm metni escape et
                        if (urlMatches.length === 0) {
                            textWithLinks = escapeHtml(textContent);
                        }
                        
                        msgContent.innerHTML = mediaHtml + `<div style="word-break: normal; overflow-wrap: break-word; white-space: pre-wrap; unicode-bidi: plaintext; line-height: 1.4; padding: 10px 14px; ${isSent ? 'background: #6366f1; color: white;' : 'background: #f3f4f6; color: #111827;'} border-radius: 12px; margin-top: ${mediaHtml ? '8px' : '0'}; display: inline-block;">${textWithLinks}</div>`;
                    } else {
                        msgContent.innerHTML = mediaHtml;
                    }
                    
                    // ‚úÖ KRITIK: mediaHtml set edildikten SONRA tekrar stil kontrol√º (eƒüer hala g√∂r√ºnm√ºyorsa)
                    if (mediaHtml && index < 5) {
                        // Force reflow - tarayƒ±cƒ±ya stil deƒüi≈üikliƒüini zorla
                        void msgContent.offsetHeight;
                        console.log(`‚úÖ‚úÖ‚úÖ MEDIA HTML SET EDƒ∞LDƒ∞ MSG[${index}]:`, {
                            mediaHtmlLength: mediaHtml.length,
                            hasTextContent: !!textContent,
                            direction: msg.direction,
                            isSent: isSent,
                            computedStyle: window.getComputedStyle(msgContent).display,
                            innerHTMLLength: msgContent.innerHTML.length
                        });
                    }
                } else {
                    // ‚úÖ DEBUG: Sadece ger√ßekten sorunlu mesajlarƒ± logla (text ve media yok)
                    if (index < 2 && !textContent && !fileUrl && !fileType) {
                        console.warn(`‚ö†Ô∏è Mesaj i√ßeriƒüi yok - MSG[${index}]:`, {
                            type: msg.type,
                            messageType,
                            isStory: !!(msg.isStory || msg.story || msg.isStoryReply)
                        });
                    }
                    msgContent.textContent = "Story'ne Cevap Verdi";
                }
                
                msgDiv.appendChild(msgContent);
                messagesList.appendChild(msgDiv);
            });
            
            // ‚úÖ Scroll to bottom - EN YENƒ∞ MESAJLAR EN ALTTA (normal chat gibi)
            // messagesArea'ya scroll yap (messagesList'in parent'ƒ±)
            const messagesArea = document.getElementById('messagesArea');
            const scrollContainer = messagesArea || messagesList;
            
            // ‚úÖ EN YENƒ∞ MESAJLAR EN ALTTA olduƒüu i√ßin en alta scroll yap - G√ú√áL√ú VERSƒ∞YON
            const scrollToBottom = () => {
                if (scrollContainer) {
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                }
            };
            
            // ‚úÖ Hemen scroll yap (DOM g√ºncellenmesi i√ßin)
            requestAnimationFrame(() => {
                scrollToBottom();
                setTimeout(() => {
                    scrollToBottom();
                    setTimeout(() => {
                        scrollToBottom();
                        setTimeout(() => {
                            scrollToBottom();
                        }, 100);
                    }, 100);
                }, 50);
            });
        }
        
        // ‚úÖ INFINITE SCROLL: Yukarƒ± scroll yaptƒ±ƒüƒ±nda eski mesajlarƒ± y√ºkle
        function setupInfiniteScroll(conversationId, conversation) {
            const messagesArea = document.getElementById('messagesArea');
            const scrollContainer = messagesArea || document.getElementById('messagesList');
            if (!scrollContainer) return;
            
            // √ñnceki listener'ƒ± kaldƒ±r
            const oldHandler = scrollContainer._infiniteScrollHandler;
            if (oldHandler) {
                scrollContainer.removeEventListener('scroll', oldHandler);
            }
            
            // Yeni scroll handler
            const scrollHandler = async () => {
                const loadState = window.messageLoadState?.[conversationId];
                if (!loadState || loadState.isLoading || !loadState.hasMore) {
                    return;
                }
                
                // ‚úÖ Yukarƒ± scroll yapƒ±ldƒ±ƒüƒ±nda (scrollTop < 200px) eski mesajlarƒ± y√ºkle
                if (scrollContainer.scrollTop < 200) {
                    loadState.isLoading = true;
                    
                    try {
                        // ‚úÖ API key'i al (infinite scroll i√ßin)
                        const apiKey = localStorage.getItem('sleekflowApiKey') || '';
                        const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                        const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                        
                        const offset = loadState.loadedCount;
                        // ‚úÖ Channel filtreleme: VIP ve Hamzah i√ßin WhatsApp g√∂ster
                        const senderStateScroll = getCurrentSenderState();
                        const showAllMessagesScroll = senderStateScroll.showAllMessages || {};
                        const shouldShowAllMessagesScroll = showAllMessagesScroll[conversationId] || false;
                        
                        const channelFilterTopScroll = document.getElementById('channelFilterTop');
                        const selectedSenderPhoneScroll = channelFilterTopScroll && channelFilterTopScroll.value ? channelFilterTopScroll.value : '';
                        let channelParamScroll = '';
                        // ‚úÖ Sadece showAllMessages false ise channel filtreleme yap
                        if (!shouldShowAllMessagesScroll) {
                            if (selectedSenderPhoneScroll === '905421363421') {
                                // ‚úÖ Hamzah se√ßildi - Sadece WhatsApp mesajlarƒ± g√∂ster
                                // ‚úÖ NOT: Conversation'lar zaten backend'de doƒüru kanala g√∂re filtrelenmi≈ü geliyor
                                channelParamScroll = '&channel=whatsapp';
                            }
                            // ‚úÖ VIP i√ßin: T√ºm mesajlar filtrelenmeden gelsin (channel parametresi g√∂nderme)
                        }
                        // ‚úÖ HIZLANDIRMA: Scroll'da daha fazla mesaj √ßek (15 -> 50)
                        const scrollUrl = `/api/sleekflow/conversations/${conversationId}/messages?limit=50&offset=${offset}${apiKey ? '&apiKey=' + encodeURIComponent(apiKey) : ''}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${channelParamScroll}`;
                        const response = await fetch(scrollUrl, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        const newMessages = data.messages || [];
                        
                        if (newMessages.length === 0) {
                            loadState.hasMore = false;
                            loadState.isLoading = false;
                            return;
                        }
                        
                        // ‚úÖ EN ESKƒ∞ EN √úSTTE sƒ±rala
                        newMessages.sort((a, b) => {
                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                            return timeA - timeB;
                        });
                        
                        // ‚úÖ Mevcut mesajlarƒ± state'ten al ve yeni mesajlarƒ± √úSTE ekle
                        const existingMessages = window.conversationsState?.loadedMessages?.[conversationId] || [];
                        
                        // ‚úÖ Yeni mesajlarƒ± mevcut mesajlarƒ±n √úST√úNE ekle (eski mesajlar)
                        const allMessages = [...newMessages, ...existingMessages];
                        
                        // ‚úÖ EN ESKƒ∞ EN √úSTTE, EN YENƒ∞ EN ALTTA sƒ±rala
                        allMessages.sort((a, b) => {
                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                            return timeA - timeB;
                        });
                        
                        // ‚úÖ Scroll pozisyonunu koru (yeni mesajlar eklendiƒüinde scroll kaymasƒ±n)
                        const oldScrollHeight = scrollContainer.scrollHeight;
                        const oldScrollTop = scrollContainer.scrollTop;
                        
                        // Mesajlarƒ± render et
                        renderMessagesDirectly(allMessages, conversationId, conversation);
                        
                        // ‚úÖ Scroll pozisyonunu koru
                        setTimeout(() => {
                            const newScrollHeight = scrollContainer.scrollHeight;
                            const scrollDiff = newScrollHeight - oldScrollHeight;
                            scrollContainer.scrollTop = oldScrollTop + scrollDiff;
                        }, 50);
                        
                        // State g√ºncelle
                        if (!window.conversationsState.loadedMessages) {
                            window.conversationsState.loadedMessages = {};
                        }
                        window.conversationsState.loadedMessages[conversationId] = allMessages;
                        loadState.loadedCount = allMessages.length;
                        loadState.hasMore = newMessages.length >= 15;
                    } catch (error) {
                        console.error('Eski mesajlar y√ºklenirken hata:', error);
                    } finally {
                        loadState.isLoading = false;
                    }
                }
            };
            
            scrollContainer._infiniteScrollHandler = scrollHandler;
            scrollContainer.addEventListener('scroll', scrollHandler);
        }
        
        // ‚úÖ Kanal ikonu SVG fonksiyonu
        function getChannelIconSvg(channel) {
            const channelLower = (channel || '').toLowerCase();
            
            if (channelLower.includes('whatsapp')) {
                return `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="24" height="24" rx="12" fill="#25D366"/>
                        <path d="M17.472 14.445c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="white"/>
                    </svg>
                `;
            } else if (channelLower.includes('instagram')) {
                const uniqueId = 'ig-' + Math.random().toString(36).substr(2, 9);
                return `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="${uniqueId}" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#833AB4;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#E1306C;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FCAF45;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="24" height="24" rx="12" fill="url(#${uniqueId})"/>
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.98-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.98-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" fill="white"/>
                    </svg>
                `;
            } else {
                return `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="24" height="24" rx="12" fill="#6366f1"/>
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="white"/>
                    </svg>
                `;
            }
        }
        
        // ‚úÖ Direkt konu≈ümalarƒ± render et (app.js yoksa bile √ßalƒ±≈üƒ±r)
        function renderConversationsDirectly(conversations, showAll = false) {
            console.log('[LEAD] renderConversationsDirectly √ßaƒürƒ±ldƒ±', { gelenKonusma: conversations.length, showAll, windowLeadName: (window.leadName || '(bo≈ü)') });
            const list = document.getElementById('conversationsList');
            if (!list) {
                console.error('[LEAD] conversationsList bulunamadƒ±!');
                return;
            }
            
            // ‚úÖ State'i sender'a √∂zel olarak g√ºncelle
            const senderState = getCurrentSenderState();
            senderState.allConversations = conversations;
            senderState.showAll = showAll;
            
            // ‚úÖ Global state'i de g√ºncelle (geriye d√∂n√ºk uyumluluk i√ßin)
            window.conversationsState.allConversations = conversations;
            window.conversationsState.showAll = showAll;
            
            // ‚úÖ Yardƒ±mcƒ± fonksiyonlar - telefon normalize et
            const cleanPhone = (phone) => {
                return String(phone || '').replace(/\+/g, '').replace(/\s/g, '').replace(/-/g, '').replace(/\(/g, '').replace(/\)/g, '').trim();
            };
            
            // ‚úÖ KANAL Fƒ∞LTRELEME
            const channelFilter = document.getElementById('channelFilter');
            const channelFilterTop = document.getElementById('channelFilterTop');
            
            // ‚úÖ Sender numarasƒ±na g√∂re filtreleme
            const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
            
            // ‚úÖ Sender se√ßilmediyse uyarƒ± g√∂ster ve √ßƒ±k
            if (!selectedSenderPhone) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>üìû Yukarƒ±dan bir sender se√ßin</p>
                        <p class="empty-hint">Choose Sender dropdown'ƒ±ndan VIP veya Hamzah numarasƒ±nƒ± se√ßin</p>
                    </div>
                `;
                return;
            }
            
            let filteredBySender = [];
            
            // ‚úÖ KRITIK: Sender se√ßildiyse, sender'a g√∂re farklƒ± filtreleme mantƒ±ƒüƒ± uygula
            if (selectedSenderPhone && selectedSenderPhone !== '') {
                const cleanSelectedPhone = cleanPhone(selectedSenderPhone);
                const clen = conversations.length;
                
                // ‚úÖ Business numaralarƒ± listesi (FROM olarak kullanƒ±lan numaralar)
                const businessNumbers = ['908505327532', '905421363421'];
                const isVIP = cleanSelectedPhone === '908505327532';
                const isHamzah = cleanSelectedPhone === '905421363421';
                
                for (let i = 0; i < clen; i++) {
                    const conv = conversations[i];
                    // ‚úÖ Conversation'dan FROM numarasƒ±nƒ± al
                    let convFromPhone = cleanPhone(conv.fromPhone || conv.from || '');
                    
                    // ‚úÖ VIP i√ßin: T√ºm conversation'larƒ± g√∂ster (hi√ßbir filtreleme yok - fromPhone bo≈ü olanlar dahil)
                    // ‚úÖ Hamzah i√ßin: Sadece Hamzah'a ait conversation'larƒ± g√∂ster (strict filtering - fromPhone bo≈ü olanlar G√ñSTERƒ∞LMEYECEK)
                    if (isVIP) {
                        // ‚úÖ VIP: T√úM conversation'larƒ± g√∂ster (filtreleme yok)
                        filteredBySender.push(conv);
                    } else if (isHamzah) {
                        // ‚úÖ Hamzah: Backend'de channel parametresi ile √ßekildiƒüi i√ßin zaten doƒüru conversation'lar gelmi≈ü
                        // ‚úÖ Sadece fromPhone kontrol√º yap (channel kontrol√º backend'de yapƒ±ldƒ±)
                        if (convFromPhone === cleanSelectedPhone || convFromPhone === '') {
                            filteredBySender.push(conv);
                        } else {
                            // ‚úÖ fromPhone e≈üle≈ümiyorsa ATLA
                            if (i < 10) {
                                console.log('‚ö†Ô∏è Conversation FROM numarasƒ± Hamzah ile e≈üle≈ümiyor, atlanƒ±yor:', {
                                    conversationId: conv.conversationId || conv.id,
                                    fromPhone: convFromPhone || '(bo≈ü)',
                                    selectedSender: cleanSelectedPhone,
                                    contactName: conv.contactName
                                });
                            }
                        }
                    } else {
                        // ‚úÖ Diƒüer sender'lar i√ßin: Sadece e≈üle≈üen conversation'larƒ± g√∂ster
                        if (convFromPhone && convFromPhone === cleanSelectedPhone) {
                            filteredBySender.push(conv);
                        }
                    }
                }
                
                const filterType = isVIP ? 'VIP: T√ºm conversation\'lar (fromPhone bo≈ü olanlar dahil)' : (isHamzah ? 'Hamzah: T√ºm conversation\'lar (channel kontrol√º backend\'de)' : 'Diƒüer: Sadece e≈üle≈üen conversation\'lar');
                console.log(`‚úÖ Sender filtreleme: ${filteredBySender.length} conversation bulundu (se√ßili sender: ${cleanSelectedPhone}, toplam: ${clen}, ${filterType})`);
            }
            
            // ‚úÖ Kanal filtreleme (VIP ve Hamzah i√ßin √∂zel mantƒ±k)
            let selectedChannel = '';
            if (selectedSenderPhone === '908505327532') {
                // VIP se√ßildi - channelFilter'ƒ±n deƒüerini kullan (whatsapp)
                selectedChannel = (channelFilter && channelFilter.value) || '';
            } else if (selectedSenderPhone === '905421363421') {
                // ‚úÖ Hamzah se√ßildi - Sadece WhatsApp g√∂ster (Instagram hari√ß)
                selectedChannel = 'whatsapp';
            } else if (selectedSenderPhone) {
                // Diƒüer sender se√ßildi - WhatsApp kanalƒ±nƒ± kullan (varsayƒ±lan)
                selectedChannel = 'whatsapp';
            } else {
                // Hi√ßbir sender se√ßilmedi - channelFilter'ƒ± kullan
                selectedChannel = (channelFilter && channelFilter.value) || '';
            }
            
            let filteredByChannel = filteredBySender;
            
            // ‚úÖ Channel filtreleme: VIP ve Hamzah i√ßin WhatsApp g√∂ster (Instagram hari√ß)
            if (selectedChannel && selectedChannel !== '') {
                const fc = selectedChannel.toLowerCase();
                filteredByChannel = [];
                const clen = filteredBySender.length;
                for (let i = 0; i < clen; i++) {
                    const conv = filteredBySender[i];
                    const ch = (conv.channel || conv.rawChannel || '').toLowerCase();
                    // ‚úÖ WhatsApp filtreleme: Instagram ve Facebook hari√ß
                    if (fc === 'whatsapp') {
                        if (ch.includes('whatsapp') && !ch.includes('instagram') && !ch.includes('facebook')) {
                            filteredByChannel.push(conv);
                        }
                    } else if (ch.includes(fc)) {
                        filteredByChannel.push(conv);
                    }
                }
            }
            
            // ‚úÖ FULL_NAME'E G√ñRE Fƒ∞LTRELEME (sadece contactName ile matchNames)
            const leadName = (window.leadName || '').trim();
            let filteredConversations = filteredByChannel;
            if (!showAll && leadName !== '') {
                const beforeCount = filteredByChannel.length;
                filteredConversations = filteredByChannel.filter(conv => {
                    return matchNames(leadName, conv.contactName || '');
                });
                console.log('[LEAD] Filtre uygulandƒ±:', { leadName, showAll, kanalSonrasi: beforeCount, leadFiltreSonrasi: filteredConversations.length });
            } else {
                    if (!showAll && leadName === '') {
                        if (!window.__leadDebugLogged) {
                            console.warn('[LEAD] Lead ismi yok ‚Äì filtre uygulanmƒ±yor, t√ºm konu≈ümalar g√∂steriliyor.');
                            window.__leadDebugLogged = true;
                        }
                    }
            }
            senderState.filteredConversations = filteredConversations;
            window.conversationsState.filteredConversations = filteredConversations;
            const leadFilterInfoEl = document.getElementById('leadFilterInfo');
            if (leadFilterInfoEl) {
                leadFilterInfoEl.style.display = 'none';
                if (!showAll && leadName === '' && window.leadId && String(window.leadId).trim()) {
                    console.warn('[LEAD] Lead ID var ama isim yok ‚Äì filtre uygulanamƒ±yor.', { leadId: window.leadId });
                } else if (!showAll && leadName === '' && !window.leadId) {
                    console.warn('[LEAD] Lead ID yok.', { referrer: document.referrer || '(bo≈ü)' });
                }
            }
            
            // ‚úÖ ULTRA HIZLI RENDER - DocumentFragment kullan
            const fragment = document.createDocumentFragment();
            
            if (filteredConversations.length === 0) {
                const leadLabel = leadName || 'Bu lead';
                const hasSenderSelected = !!(document.getElementById('channelFilterTop') && document.getElementById('channelFilterTop').value);
                list.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ "${leadLabel}" i√ßin otomatik e≈üle≈üen konu≈üma bulunamadƒ±</p>
                        <p class="empty-hint">T√ºm konu≈ümalarƒ± g√∂rmek i√ßin butona tƒ±klayƒ±n veya g√∂nderen se√ßimini deƒüi≈ütirin.</p>
                    </div>
                `;
                
                if (filteredBySender.length > 0 || hasSenderSelected) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.style.cssText = 'width: 100%; margin-top: 15px; padding: 12px; cursor: pointer; font-weight: 600;';
                    btn.textContent = 'üìã T√ºm Konu≈ümalarƒ± G√∂ster (se√ßili numaraya ait t√ºm√º)';
                    btn.onclick = async () => {
                        btn.disabled = true;
                        btn.textContent = '‚è≥ Y√ºkleniyor...';
                        if (typeof window.loadAllConversationsForSender === 'function') {
                            await window.loadAllConversationsForSender();
                        } else {
                            window.conversationsState.showAll = true;
                            renderConversationsDirectly(filteredBySender, true);
                        }
                        btn.disabled = false;
                    };
                    fragment.appendChild(btn);
                }
                list.innerHTML = '';
                list.appendChild(fragment);
                return;
            }
            
            // ‚úÖ ULTRA HIZLI RENDER - for loop + DocumentFragment
            const len = filteredConversations.length;
            for (let i = 0; i < len; i++) {
                const conv = filteredConversations[i];
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.style.cssText = 'display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;';
                
                item.onmouseenter = () => item.style.backgroundColor = '#f3f4f6';
                item.onmouseleave = () => item.style.backgroundColor = '';
                
                const channel = conv.channel || 'WhatsApp';
                
                const contactName = conv.contactName || 'Bilinmeyen';
                
                // ‚úÖ Son mesaj preview - her zaman sadece "Mesaj" yaz
                let lastMessagePreview = 'Mesaj';
                
                const lastMessageTime = conv.lastMessageTime ? new Date(conv.lastMessageTime).toLocaleDateString('tr-TR') : '';
                const channelIconSvg = getChannelIconSvg(channel);
                
                // ‚úÖ Okunmamƒ±≈ü mesaj sayƒ±sƒ± - √ñNCE state'teki deƒüeri kullan (mesaj a√ßƒ±ldƒ±ƒüƒ±nda 0 olur), yoksa API'den gelen deƒüeri
                const convId = conv.conversationId || conv.id;
                const unreadCount = window.conversationsState.unreadCounts[convId] !== undefined 
                    ? window.conversationsState.unreadCounts[convId] 
                    : (conv.unreadCount || 0);
                const unreadBadge = unreadCount > 0 ? `
                    <div style="position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 10px; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; padding: 0 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;">
                        ${unreadCount > 99 ? '99+' : unreadCount}
                    </div>
                ` : '';
                
                item.innerHTML = `
                    <div style="position: relative; width: 40px; height: 40px; margin-right: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #6366f1; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${contactName.substring(0, 2).toUpperCase()}
                        </div>
                        <div style="position: absolute; bottom: -2px; right: -2px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${channelIconSvg}
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <div class="conversation-name" style="font-weight: 600; color: #111827; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${contactName}</div>
                        </div>
                        <div class="conversation-preview" style="font-size: 13px; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lastMessagePreview}</div>
                    </div>
                    <div style="position: relative; font-size: 12px; color: #9ca3af; margin-left: 12px; white-space: nowrap; padding-right: ${unreadCount > 0 ? '8px' : '0'};">
                        ${lastMessageTime}
                        ${unreadBadge}
                    </div>
                `;
                
                item.onclick = async () => {
                    const convId = conv.conversationId || conv.id;
                    if (!convId) return;
                    
                    // ‚úÖ Current conversation ID'yi kaydet (sender'a √∂zel state'e)
                    const senderState = getCurrentSenderState();
                    senderState.currentConversationId = convId;
                    window.conversationsState.currentConversationId = convId; // Geriye d√∂n√ºk uyumluluk
                    
                    // ‚úÖ √ñNCE mesajlarƒ± y√ºkle (chat view'ƒ± g√∂ster)
                    await loadMessagesDirectly(convId);
                    
                    // ‚úÖ SONRA okunmamƒ±≈ü mesaj sayƒ±sƒ±nƒ± sƒ±fƒ±rla ve badge'i g√ºncelle
                    if (window.conversationsState.unreadCounts[convId]) {
                        window.conversationsState.unreadCounts[convId] = 0;
                        
                        // ‚úÖ KRITIK: Son mesaj ID'sini g√ºncelle (polling tekrar aynƒ± mesajƒ± "yeni" olarak g√∂rmesin)
                        const loadedMsgs = window.conversationsState.loadedMessages?.[convId] || [];
                        if (loadedMsgs.length > 0) {
                            const lastMsg = loadedMsgs[loadedMsgs.length - 1];
                            const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                            if (lastMsgId) {
                                if (!lastMessageCount) {
                                    lastMessageCount = {};
                                }
                                lastMessageCount[convId + '_latest'] = lastMsgId;
                                saveLastMessageCounts();
                            }
                        }
                        
                        // Konu≈üma listesini g√ºncelle (badge'i kaldƒ±rmak i√ßin)
                        const conversations = window.conversationsState.allConversations || [];
                        const showAll = window.conversationsState.showAll || false;
                        renderConversationsDirectly(conversations, showAll);
                    } else {
                        // ‚úÖ Badge yoksa bile son mesaj ID'sini g√ºncelle (ilk a√ßƒ±lƒ±≈üta)
                        const loadedMsgs = window.conversationsState.loadedMessages?.[convId] || [];
                        if (loadedMsgs.length > 0) {
                            const lastMsg = loadedMsgs[loadedMsgs.length - 1];
                            const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                            if (lastMsgId) {
                                if (!lastMessageCount) {
                                    lastMessageCount = {};
                                }
                                lastMessageCount[convId + '_latest'] = lastMsgId;
                            }
                        }
                    }
                    
                    // Polling ba≈ülat (eƒüer ba≈ülamamƒ±≈üsa)
                    if (!messagePollInterval && typeof startMessagePolling === 'function') {
                        startMessagePolling();
                    }
                };
                fragment.appendChild(item);
            }
            
            // ‚úÖ T√ºm konu≈ümalarƒ± g√∂ster butonu: Lead filtresi OLMADAN se√ßili sendere ait t√ºm konu≈ümalarƒ± API'den √ßek
            if (!showAll && (conversations.length > filteredConversations.length || (window.leadId || window.leadName))) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.style.cssText = 'width: 100%; margin-top: 15px; padding: 12px; cursor: pointer; font-weight: 600;';
                btn.textContent = 'üìã T√ºm Konu≈ümalarƒ± G√∂ster (se√ßili numaraya ait t√ºm√º)';
                btn.onclick = async () => {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ Y√ºkleniyor...';
                    if (typeof window.loadAllConversationsForSender === 'function') {
                        await window.loadAllConversationsForSender();
                    } else {
                        window.conversationsState.showAll = true;
                        renderConversationsDirectly(conversations, true);
                    }
                    btn.disabled = false;
                };
                fragment.appendChild(btn);
            }
            
            // ‚úÖ Tek seferde DOM'a ekle
            list.innerHTML = '';
            list.appendChild(fragment);
            
            // ‚úÖ KRITIK: Eƒüer search input'unda bir deƒüer varsa, filtrelemeyi tekrar uygula
            const searchInput = document.getElementById('searchConversations');
            if (searchInput && searchInput.value.trim() !== '') {
                // Search input'unda deƒüer var - filtrelemeyi tetikle
                const event = new Event('input', { bubbles: true });
                searchInput.dispatchEvent(event);
            }
        }
    </script>
    
    <!-- Main App JavaScript -->
    <script src="/app.js"></script>
    <script>
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            
            sidebar.classList.toggle('open');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            return false;
        };

        window.openSidebarNow = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            sidebar.classList.add('open');
            sidebar.style.setProperty('left', '0', 'important');
            sidebar.style.setProperty('opacity', '1', 'important');
            sidebar.style.setProperty('visibility', 'visible', 'important');
            sidebar.style.setProperty('display', 'flex', 'important');
            sidebar.style.setProperty('z-index', '10000', 'important');
            document.body.style.overflow = 'hidden';
            localStorage.setItem('sidebarClosed', 'false');
            return false;
        };

        window.closeSidebarNow = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            sidebar.classList.remove('open');
            sidebar.style.left = '-320px';
            sidebar.style.opacity = '0';
            sidebar.style.visibility = 'hidden';
            document.body.style.overflow = '';
            localStorage.setItem('sidebarClosed', 'true');
            return false;
        };

        // Search function
        function setupWidgetSearch() {
            const searchInput = document.getElementById('searchConversations');
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                const normalizeText = (text) => {
                    if (!text) return '';
                    // ‚úÖ √ñNCE T√úRK√áE KARAKTERLERƒ∞ MANUEL √áEVƒ∞R (toLowerCase locale-aware deƒüil)
                    let normalized = text
                        .replace(/ƒ∞/g, 'i')
                        .replace(/I/g, 'ƒ±')
                        .replace(/ƒû/g, 'ƒü')
                        .replace(/√ú/g, '√º')
                        .replace(/≈û/g, '≈ü')
                        .replace(/√ñ/g, '√∂')
                        .replace(/√á/g, '√ß')
                        .toLowerCase() // ≈ûimdi k√º√ß√ºk harfe √ßevir
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Diyakritik i≈üaretleri kaldƒ±r
                        .replace(/ƒ±/g, 'i') // Son olarak ƒ±'yƒ± i'ye √ßevir (tam e≈üle≈üme i√ßin)
                        .replace(/ƒü/g, 'g')
                        .replace(/√º/g, 'u')
                        .replace(/≈ü/g, 's')
                        .replace(/√∂/g, 'o')
                        .replace(/√ß/g, 'c');
                    return normalized;
                };
                
                const search = normalizeText(e.target.value.trim());
                const items = document.querySelectorAll('.conversation-item');
                
                if (search === '') {
                    // ‚úÖ Bo≈üsa t√ºm item'larƒ± g√∂ster
                    items.forEach(item => {
                        item.style.display = 'flex';
                    });
                    return;
                }
                
                items.forEach(item => {
                    const nameEl = item.querySelector('.conversation-name');
                    const previewEl = item.querySelector('.conversation-preview');
                    
                    if (!nameEl) {
                        item.style.display = 'none';
                        return;
                    }
                    
                    const name = normalizeText(nameEl.textContent.trim());
                    const preview = previewEl ? normalizeText(previewEl.textContent.trim()) : '';
                    
                    // ‚úÖ ƒ∞sim veya mesaj √∂nizlemesinde ara (case-insensitive, T√ºrk√ße karakter desteƒüi ile)
                    const matches = name.includes(search) || preview.includes(search);
                    item.style.display = matches ? 'flex' : 'none';
                });
            });
        }

        // DOM ready
        // ‚úÖ Kanal filtreleme event listener
        function setupChannelFilter() {
            const channelFilter = document.getElementById('channelFilter');
            if (channelFilter) {
                channelFilter.onchange = function() {
                    const conversations = window.conversationsState.allConversations || [];
                    const showAll = window.conversationsState.showAll || false;
                    renderConversationsDirectly(conversations, showAll);
                };
            }
            
            // ‚úÖ CHOOSE SENDER dropdown filtreleme
            const channelFilterTop = document.getElementById('channelFilterTop');
            if (channelFilterTop) {
                channelFilterTop.onchange = async function() {
                    const selectedValue = channelFilterTop.value;
                    
                    // ‚úÖ KRITIK: Sender deƒüi≈ütiƒüinde UI'ƒ± temizle ve yeni sender i√ßin conversation'larƒ± y√ºkle
                    console.log('üîÑ Sender deƒüi≈üti, yeni sender i√ßin conversation\'lar y√ºkleniyor:', selectedValue);
                    
                    // ‚úÖ 1. Mevcut conversation'ƒ± temizle
                    const messagesList = document.getElementById('messagesList');
                    if (messagesList) {
                        messagesList.innerHTML = '';
                    }
                    
                    // ‚úÖ 2. Chat aktif alanƒ±nƒ± temizle
                    const chatActive = document.getElementById('chatActive');
                    if (chatActive) {
                        chatActive.style.display = 'none';
                    }
                    const chatEmpty = document.getElementById('chatEmpty');
                    if (chatEmpty) {
                        chatEmpty.style.display = 'flex';
                    }
                    
                    // ‚úÖ 3. Conversation listesini temizle
                    const conversationsList = document.getElementById('conversationsList');
                    if (conversationsList) {
                        conversationsList.innerHTML = '<div class="empty-state"><p>üì≠ Y√ºkleniyor...</p></div>';
                    }
                    
                    // ‚úÖ 4. State'i yeni sender i√ßin ayarla
                    const senderState = getCurrentSenderState();
                    senderState.currentConversationId = null;
                    senderState.showAll = false;
                    senderState.filteredConversations = [];
                    if (window.conversationsState) {
                        window.conversationsState.showAll = false;
                        window.conversationsState.filteredConversations = [];
                    }
                    
                    // ‚úÖ 5. Sender se√ßildiƒüinde: √∂nce sayfadaki lead ismini al, sonra konu≈ümalarƒ± √ßek, lead'e g√∂re filtrele, altta "T√ºm Konu≈ümalarƒ± G√∂r"
                    const channelFilter = document.getElementById('channelFilter');
                    if (selectedValue && selectedValue !== '') {
                        if (channelFilter) channelFilter.value = 'whatsapp';
                        
                        try {
                            // ‚úÖ √ñNCE: Bu sayfadaki lead ismini al (otomatik ‚Äì SDK/referrer)
                            await loadLeadContext({ forceReload: true });
                            
                            const savedApiKey = localStorage.getItem('sleekflowApiKey') || '';
                            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                            await getCurrentZohoUser();
                            
                            const fromPhoneParam = `&fromPhone=${encodeURIComponent(selectedValue)}`;
                            let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                            if (window.leadName && String(window.leadName).trim()) convUrl += '&leadName=' + encodeURIComponent(String(window.leadName).trim());
                            if (window.leadId && String(window.leadId).trim()) convUrl += '&leadId=' + encodeURIComponent(String(window.leadId).trim());
                            if (document.referrer) convUrl += '&pageReferrer=' + encodeURIComponent(document.referrer);
                            convUrl = addUserParamsToUrl(convUrl);
                            
                            if (savedApiKey && savedApiKey.trim().length >= 10) {
                                const convResponse = await fetch(convUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
                                if (convResponse.ok) {
                                    const convData = await convResponse.json();
                                    const conversations = convData.conversations || [];
                                    if (convData.leadName && typeof convData.leadName === 'string' && convData.leadName.trim() && !(window.leadName && String(window.leadName).trim())) {
                                        window.leadName = convData.leadName.trim();
                                        console.log('[LEAD] Backend cevabƒ±ndan leadName alƒ±ndƒ± (sender deƒüi≈üti):', window.leadName);
                                    }
                                    if (convData.leadId && !window.leadId) window.leadId = convData.leadId;
                                    senderState.allConversations = conversations;
                                    senderState.showAll = false;
                                    window.conversationsState.showAll = false;
                                    renderConversationsDirectly(conversations, false);
                                    console.log('[LEAD] Sender se√ßildi ‚Üí lead:', window.leadName || '(yok)', '‚Üí konu≈ümalar:', conversations.length);
                                } else {
                                    console.error('‚ùå Konu≈ümalar y√ºklenemedi:', convResponse.status);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è SleekFlow API key yok');
                            }
                        } catch (error) {
                            console.error('‚ùå Sender se√ßimi hatasƒ±:', error);
                        }
                    } else if (selectedValue === '') {
                        // Choose Sender se√ßildi - filtreyi temizle
                        if (channelFilter) {
                            channelFilter.value = '';
                        }
                        
                        // ‚úÖ T√ºm conversation'larƒ± y√ºkle
                        try {
                            const savedApiKey = localStorage.getItem('sleekflowApiKey') || '';
                            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                            
                            // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al (backend yetki kontrol√º i√ßin)
                            await getCurrentZohoUser();
                            
                            if (savedApiKey && savedApiKey.trim().length >= 10) {
                                let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                convUrl = addUserParamsToUrl(convUrl);
                                const convResponse = await fetch(convUrl, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                if (convResponse.ok) {
                                    const convData = await convResponse.json();
                                    const conversations = convData.conversations || [];
                                    
                                    // ‚úÖ Conversation'larƒ± default state'e kaydet ve render et
                                    senderState.allConversations = conversations;
                                      senderState.showAll = false;
                                      renderConversationsDirectly(conversations, false);
                                    console.log('‚úÖ T√ºm conversation\'lar y√ºklendi:', conversations.length);
                                } else {
                                    console.error('‚ùå Conversation\'lar y√ºklenemedi:', convResponse.status);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è SleekFlow API key bulunamadƒ±');
                            }
                        } catch (error) {
                            console.error('‚ùå Conversation\'lar y√ºklenirken hata:', error);
                        }
                    }
                };
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setupChannelFilter();
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                // Sidebar her zaman a√ßƒ±k ba≈üla
                if (sidebar) {
                    sidebar.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            const openBtn = document.getElementById('openSidebar');
            const closeBtn = document.getElementById('toggleSidebar');

            if (openBtn) {
                openBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.toggleSidebar();
                    return false;
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    window.toggleSidebar();
                    return false;
                });
            }

            setupWidgetSearch();
            
            // ‚úÖ SAYFA Y√úKLENƒ∞RKEN VERƒ∞LERƒ∞ √áEK (kullanƒ±cƒ± fark etmez)
            const savedApiKey = localStorage.getItem('sleekflowApiKey');
            const savedConnected = localStorage.getItem('sleekflowConnected');
            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
            
            if (savedApiKey && savedApiKey.trim().length >= 10 && savedConnected === 'true') {
                // ‚úÖ ARKA PLANDA T√úM VERƒ∞LERƒ∞ √áEK (kullanƒ±cƒ± fark etmez)
                // 1. Konu≈ümalarƒ± √ßek
                // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al (backend yetki kontrol√º i√ßin) - async olarak
                getCurrentZohoUser().then(() => {
                    // ‚úÖ Se√ßili sender'ƒ± fromPhone olarak g√∂nder (eƒüer varsa)
                    const channelFilterTop = document.getElementById('channelFilterTop');
                    const selectedSenderPhone = channelFilterTop && channelFilterTop.value ? channelFilterTop.value : '';
                    const fromPhoneParam = selectedSenderPhone ? `&fromPhone=${encodeURIComponent(selectedSenderPhone)}` : '';
                    
                    let convUrl = `/api/sleekflow/conversations?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}${fromPhoneParam}`;
                    convUrl = addUserParamsToUrl(convUrl);
                    fetch(convUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(r => r.json())
                .then(data => {
                    const conversations = data.conversations || [];
                    if (conversations.length > 0) {
                        // ‚úÖ KRITIK: API'den gelen unreadCount deƒüerlerini state'e kaydet
                        // AMA: √ñnceden okunan conversation'lar i√ßin unreadCount'u 0 yap (sayfa yenilendiƒüinde badge tekrar gelmesin)
                        conversations.forEach(conv => {
                            const convId = conv.conversationId || conv.id;
                            if (convId) {
                                // Eƒüer bu conversation √∂nceden okunmu≈üsa, unreadCount'u 0 yap
                                if (readConversations.has(convId)) {
                                    window.conversationsState.unreadCounts[convId] = 0;
                                    conv.unreadCount = 0; // Conversation objesini de g√ºncelle
                                } else if (conv.unreadCount && conv.unreadCount > 0) {
                                    if (!window.conversationsState.unreadCounts[convId]) {
                                        window.conversationsState.unreadCounts[convId] = 0;
                                    }
                                    // API'den gelen unreadCount'u kullan (SleekFlow'un kendi sayƒ±sƒ±)
                                    window.conversationsState.unreadCounts[convId] = conv.unreadCount;
                                }
                            }
                        });
                        
                        // ‚úÖ Konu≈ümalarƒ± HEMEN render et (mesaj y√ºklemesini engelleme)
                        const showAll = window.conversationsState.showAll || false;
                        renderConversationsDirectly(conversations, showAll);
                        
                        // ‚úÖ Polling ba≈ülat
                        if (typeof startMessagePolling === 'function') {
                            startMessagePolling();
                        }
                        
                        // ‚úÖ ARKA PLANDA badge sayƒ±larƒ±nƒ± hesapla (mesaj y√ºklemesini engellemez)
                        setTimeout(() => {
                            conversations.slice(0, 20).forEach((conv, idx) => {
                                const convId = conv.conversationId || conv.id;
                                if (!convId) return;
                                
                                // Her konu≈üma i√ßin kƒ±sa bir gecikme ile (rate limiting)
                                setTimeout(() => {
                                    const msgUrl = `/api/sleekflow/conversations/${convId}/messages?limit=1&offset=0&apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                    fetch(msgUrl, {
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    })
                                    .then(r => r.json())
                                    .then(msgData => {
                                        const msgs = msgData.messages || [];
                                        if (msgs.length > 0) {
                                            const latestMsg = msgs[0];
                                            const latestMsgId = latestMsg.id || latestMsg.timestamp || latestMsg.messageId;
                                            const prevLatestMsgId = lastMessageCount[convId + '_latest'];
                                            
                                            // ‚úÖ Eƒüer yeni mesaj varsa ve received ise badge artƒ±r
                                            if (latestMsgId && latestMsgId !== prevLatestMsgId) {
                                                const isSent = latestMsg.direction === 'sent' || 
                                                              latestMsg.isSentFromSleekflow === true ||
                                                              latestMsg.isSentFromSleekflow === 'true' ||
                                                              latestMsg.direction === 'outgoing';
                                                
                                                // ‚úÖ GEV≈ûETƒ∞LMƒ∞≈û KONTROL: direction !== 'sent' ve isSentFromSleekflow !== true ise received kabul et
                                                const isReceived = !isSent && (
                                                    latestMsg.direction === 'received' || 
                                                    latestMsg.direction === 'incoming' ||
                                                    (latestMsg.direction !== 'sent' && latestMsg.isSentFromSleekflow !== true && latestMsg.isSentFromSleekflow !== 'true')
                                                );
                                                
                                                if (isReceived) {
                                                    // Sadece kar≈üƒ±dan gelen mesajlar i√ßin badge artƒ±r
                                                    if (!window.conversationsState.unreadCounts[convId]) {
                                                        window.conversationsState.unreadCounts[convId] = 0;
                                                    }
                                                    window.conversationsState.unreadCounts[convId] += 1;
                                                    console.log('‚úÖ Sayfa y√ºklenirken badge artƒ±rƒ±ldƒ±:', { convId, unreadCount: window.conversationsState.unreadCounts[convId] });
                                                }
                                                
                                                // Son mesaj ID'sini g√ºncelle
                                                lastMessageCount[convId + '_latest'] = latestMsgId;
                                                saveLastMessageCounts();
                                                
                                                // Konu≈üma listesini g√ºncelle (badge g√∂sterimi i√ßin)
                                                const allConvs = window.conversationsState.allConversations || conversations || [];
                                                const currentShowAll = window.conversationsState.showAll || showAll || false;
                                                renderConversationsDirectly(allConvs, currentShowAll);
                                            } else if (!prevLatestMsgId && latestMsgId) {
                                                // ƒ∞lk y√ºkleme - sadece ID'yi kaydet
                                                lastMessageCount[convId + '_latest'] = latestMsgId;
                                                saveLastMessageCounts();
                                            }
                                        }
                                    })
                                    .catch(() => {});
                                }, idx * 50); // Her konu≈üma i√ßin 50ms gecikme (rate limiting)
                            });
                        }, 300); // 300ms sonra arka planda ba≈ülat (mesaj y√ºklemesini engellemez)
                        
                        // ‚úÖ ARKA PLANDA ƒ∞LK 5 KONU≈ûMANIN MESAJLARINI √áEK (kullanƒ±cƒ± fark etmez)
                        const topConversations = conversations.slice(0, 5);
                        topConversations.forEach((conv, idx) => {
                            const convId = conv.conversationId || conv.id;
                            if (!convId) return;
                            
                            // Her konu≈üma i√ßin kƒ±sa bir gecikme ile (rate limiting)
                            setTimeout(() => {
                                const msgUrl = `/api/sleekflow/conversations/${convId}/messages?limit=10&offset=0&apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                                fetch(msgUrl, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                })
                                .then(r => r.json())
                                .then(msgData => {
                                    const msgs = msgData.messages || [];
                                    if (msgs.length > 0) {
                                        // State'te sakla (kullanƒ±cƒ± tƒ±klayƒ±nca hemen g√∂r√ºns√ºn)
                                        if (!window.conversationsState.loadedMessages) {
                                            window.conversationsState.loadedMessages = {};
                                        }
                                        msgs.sort((a, b) => {
                                            const timeA = a.timestamp || (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                            const timeB = b.timestamp || (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                            return timeA - timeB;
                                        });
                                        window.conversationsState.loadedMessages[convId] = msgs;
                                        
                                        // ‚úÖ Son mesaj ID'sini g√ºncelle
                                        const lastMsg = msgs[msgs.length - 1];
                                        const lastMsgId = lastMsg.id || lastMsg.timestamp || lastMsg.messageId;
                                        if (lastMsgId) {
                                            lastMessageCount[convId + '_latest'] = lastMsgId;
                                            saveLastMessageCounts();
                                        }
                                    }
                                })
                                .catch(() => {});
                            }, idx * 200); // Her konu≈üma i√ßin 200ms gecikme (rate limiting)
                        });
                    }
                })
                .catch(() => {});
                
                // ‚úÖ 2. TEMPLATE'LERƒ∞ √áEK (kullanƒ±cƒ± fark etmez)
                setTimeout(() => {
                    const templatesUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    fetch(templatesUrl, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(r => r.json())
                    .then(templatesData => {
                        const templates = templatesData.templates || [];
                        if (templates.length > 0) {
                            // ‚úÖ Templates'ƒ± order'a g√∂re sƒ±rala
                            templates.sort((a, b) => (a.order || 0) - (b.order || 0));
                            // ‚úÖ Global deƒüi≈ükende sakla (modal a√ßƒ±ldƒ±ƒüƒ±nda hemen g√∂sterilsin)
                            window.cachedTemplates = templates;
                            console.log(`‚úÖ ${templates.length} template arka planda y√ºklendi`);
                        }
                    })
                    .catch(() => {
                        // Sessizce ge√ß
                    });
                }, 300); // 300ms sonra template'leri √ßek
                });
            }
        });
        
        // ‚úÖ Templates modal fonksiyonlarƒ±
        setupTemplatesModal();
        
        // ‚úÖ Templates modal fonksiyonlarƒ±
        function setupTemplatesModal() {
            const openTemplatesBtn = document.getElementById('openTemplates');
            const closeTemplatesModal = document.getElementById('closeTemplatesModal');
            const templatesModal = document.getElementById('templatesModal');
            const templateSearch = document.getElementById('templateSearch');
            const newTemplateBtn = document.getElementById('newTemplate');
            
            // Templates butonuna tƒ±klandƒ±ƒüƒ±nda modal'ƒ± a√ß
            if (openTemplatesBtn) {
                openTemplatesBtn.onclick = function() {
                    if (templatesModal) {
                        templatesModal.style.display = 'block';
                        loadTemplates();
                    } else {
                        console.error('‚ùå templatesModal bulunamadƒ±!');
                    }
                };
            } else {
                console.error('‚ùå openTemplatesBtn bulunamadƒ±!');
            }
            
            // Modal'ƒ± kapat
            if (closeTemplatesModal) {
                closeTemplatesModal.onclick = function() {
                    if (templatesModal) {
                        templatesModal.style.display = 'none';
                    }
                };
            }
            
            // Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
            if (templatesModal) {
                templatesModal.onclick = function(e) {
                    if (e.target === templatesModal) {
                        templatesModal.style.display = 'none';
                    }
                };
            }
            
            // Template arama
            if (templateSearch) {
                templateSearch.oninput = function(e) {
                    filterTemplates(e.target.value);
                };
            }
            
            // New Template modal a√ß/kapat ve kaydet
            const newTemplateModal = document.getElementById('newTemplateModal');
            const saveNewTemplate = document.getElementById('saveNewTemplate');
            const cancelNewTemplate = document.getElementById('cancelNewTemplate');
            const nameInput = document.getElementById('newTemplateName');
            const contentInput = document.getElementById('newTemplateContent');
            const typeInput = document.getElementById('newTemplateType');
            
            function openNewTemplateModal() {
                if (newTemplateModal) newTemplateModal.style.display = 'block';
                if (nameInput) nameInput.value = '';
                if (contentInput) contentInput.value = '';
                if (typeInput) typeInput.value = 'cloudapi';
            }
            function closeNewTemplateModal() {
                if (newTemplateModal) newTemplateModal.style.display = 'none';
            }
            
            if (newTemplateBtn) {
                newTemplateBtn.onclick = function() {
                    openNewTemplateModal();
                };
            }
            if (cancelNewTemplate) {
                cancelNewTemplate.onclick = function() {
                    closeNewTemplateModal();
                };
            }
            if (newTemplateModal) {
                newTemplateModal.onclick = function(e) {
                    if (e.target === newTemplateModal) closeNewTemplateModal();
                };
            }
            if (saveNewTemplate) {
                saveNewTemplate.onclick = async function() {
                    const nameVal = (nameInput?.value || '').trim();
                    const contentVal = (contentInput?.value || '').trim();
                    const typeVal = (typeInput?.value || 'cloudapi').trim();
                    
                    if (!nameVal || !contentVal) {
                        alert('Name ve content gerekli');
                        return;
                    }
                    
                    // ‚úÖ T√ºm template tipleri i√ßin backend'e kaydetmeyi dene
                    try {
                        const savedApiKey = localStorage.getItem('sleekflowApiKey');
                        const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                        const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                        
                        if (!savedApiKey || savedApiKey.trim().length < 10) {
                            alert('SleekFlow baƒülantƒ±sƒ± yok. L√ºtfen √∂nce baƒülanƒ±n.');
                            return;
                        }
                        
                        let saveUrl = '';
                        let payload = {};
                        
                        if (typeVal === 'quick-reply') {
                            // ‚úÖ Quick-reply i√ßin direkt kaydet
                            saveUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            payload = {
                                name: nameVal,
                                text: contentVal,
                                order: 0
                            };
                        } else if (typeVal === 'cloudapi') {
                            // ‚úÖ Cloud API template i√ßin channelNumber gerekli
                            const channelFilterTop = document.getElementById('channelFilterTop');
                            const channelNumber = (channelFilterTop && channelFilterTop.value) ? channelFilterTop.value : '908505327532'; // Default VIP
                            
                            saveUrl = `/api/sleekflow/cloudapi-templates?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}&channelNumber=${encodeURIComponent(channelNumber)}`;
                            payload = {
                                name: nameVal,
                                content: contentVal,
                                category: 'UTILITY',
                                language: 'en_US'
                            };
                        } else if (typeVal === 'whatsapp') {
                            // ‚úÖ WhatsApp template'leri i√ßin de quick-reply olarak kaydet (WhatsApp template'leri Meta √ºzerinden y√∂netilir)
                            saveUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            payload = {
                                name: nameVal,
                                text: contentVal,
                                order: 0
                            };
                        } else {
                            // ‚úÖ Bilinmeyen tip i√ßin quick-reply olarak kaydet
                            saveUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                            payload = {
                                name: nameVal,
                                text: contentVal,
                                order: 0
                            };
                        }
                        
                        // ‚úÖ Backend'e kaydet
                        const response = await fetch(saveUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'Template kaydedilemedi');
                        }
                        
                        // ‚úÖ Ba≈üarƒ±lƒ± - Template'leri yeniden y√ºkle
                        alert('Template kaydedildi');
                        loadTemplates(); // Template'leri yeniden y√ºkle
                        
                        // ‚úÖ Form'u temizle ve gizle
                        closeNewTemplateModal();
                        
                    } catch (error) {
                        console.error('Template kaydetme hatasƒ±:', error);
                        alert('Template kaydedilemedi: ' + error.message);
                    }
                };
            }
        }
        
        // ‚úÖ Templates y√ºkleme fonksiyonu - √ñNCE CACHE KONTROL ET, SONRA API'DEN √áEK
        async function loadTemplates() {
            console.log('üîµüîµüîµ loadTemplates FONKSIYONU √áAƒûRILDI!');
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) {
                console.error('‚ùå templatesList bulunamadƒ±!');
                return;
            }
            
            // ‚úÖ √ñNCE CACHE KONTROL ET - Eƒüer cache varsa g√∂ster, sonra arka planda g√ºncelle
            if (window.cachedTemplates && Array.isArray(window.cachedTemplates) && window.cachedTemplates.length > 0) {
                console.log('‚úÖ Cache\'den template\'ler g√∂steriliyor:', window.cachedTemplates.length);
                renderTemplates(window.cachedTemplates);
                // Arka planda g√ºncelleme yapƒ±lacak (a≈üaƒüƒ±da)
            } else {
                templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">Y√ºkleniyor...</div>';
            }
            
            try {
                // ‚úÖ API key ve baseUrl'i localStorage'dan al
                const savedApiKey = localStorage.getItem('sleekflowApiKey');
                const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                
                if (!savedApiKey || savedApiKey.trim().length < 10) {
                    templatesList.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">SleekFlow baƒülantƒ±sƒ± yok. L√ºtfen √∂nce baƒülanƒ±n.</div>';
                    return;
                }
                
                // ‚úÖ SleekFlow API'den hem quick-replies hem de WhatsApp / Cloud API template'lerini √ßek
                const quickRepliesUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(savedApiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                const whatsappTemplatesUrl = `/api/sleekflow/whatsapp-templates?apiKey=${encodeURIComponent(savedApiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                
                // Channel number (Cloud API) ‚Äì se√ßili sender'dan veya bo≈ü
                const channelFilterTop = document.getElementById('channelFilterTop');
                const channelNumber = (channelFilterTop && channelFilterTop.value) ? channelFilterTop.value : '';
                console.log('üì± Channel number kontrol√º:', { 
                    channelFilterTop: channelFilterTop ? 'var' : 'yok',
                    channelNumber: channelNumber,
                    dropdownValue: channelFilterTop ? channelFilterTop.value : 'yok'
                });
                
                // ‚úÖ Cloud API i√ßin channelNumber zorunlu - eƒüer yoksa VIP numarasƒ±nƒ± kullan
                const finalChannelNumber = channelNumber || '908505327532'; // VIP numarasƒ± default
                const cloudApiTemplatesUrl = `/api/sleekflow/cloudapi-templates?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}&channelNumber=${encodeURIComponent(finalChannelNumber)}`;
                
                console.log('‚òÅÔ∏è Cloud API templates URL:', cloudApiTemplatesUrl);
                
                const fetchers = [
                    fetch(quickRepliesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } }),
                    fetch(whatsappTemplatesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } }),
                    fetch(cloudApiTemplatesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                ];
                
                console.log('üîÑ Template\'ler y√ºkleniyor...', { 
                    quickRepliesUrl, 
                    whatsappTemplatesUrl, 
                    cloudApiTemplatesUrl,
                    channelNumber: finalChannelNumber
                });
                
                console.log('üì° 3 API √ßaƒürƒ±sƒ± yapƒ±lƒ±yor:', fetchers.length);
                
                const responses = await Promise.allSettled(fetchers);
                
                console.log('üì• API yanƒ±tlarƒ± alƒ±ndƒ±:', responses.length, responses.map((r, i) => ({
                    index: i,
                    status: r.status,
                    ok: r.status === 'fulfilled' ? r.value.ok : null,
                    statusCode: r.status === 'fulfilled' ? r.value.status : null
                })));
                
                let allTemplates = [];
                
                let idx = 0;
                const quickRepliesResponse = responses[idx++];
                const whatsappTemplatesResponse = responses[idx++];
                const cloudApiTemplatesResponse = responses[idx++];
                
                // ‚úÖ Quick-replies'larƒ± i≈üle
                if (quickRepliesResponse && quickRepliesResponse.status === 'fulfilled' && quickRepliesResponse.value.ok) {
                    const quickRepliesData = await quickRepliesResponse.value.json();
                    const quickReplies = (quickRepliesData.templates || []).map(t => ({
                        ...t,
                        type: 'quick-reply' // Quick-reply olduƒüunu belirt
                    }));
                    console.log('‚úÖ Quick-replies y√ºklendi:', quickReplies.length);
                    allTemplates = allTemplates.concat(quickReplies);
                } else if (quickRepliesResponse && quickRepliesResponse.status === 'fulfilled' && !quickRepliesResponse.value.ok) {
                    const errorData = await quickRepliesResponse.value.json().catch(() => ({}));
                    console.warn('‚ùå Quick-replies API hatasƒ±:', errorData.error || 'Bilinmeyen hata', quickRepliesResponse.value.status);
                } else if (quickRepliesResponse && quickRepliesResponse.status === 'rejected') {
                    console.warn('‚ùå Quick-replies y√ºklenemedi:', quickRepliesResponse.reason);
                }
                
                // ‚úÖ WhatsApp template'lerini i≈üle - DETAYLI LOG
                if (whatsappTemplatesResponse && whatsappTemplatesResponse.status === 'fulfilled' && whatsappTemplatesResponse.value.ok) {
                    const whatsappTemplatesData = await whatsappTemplatesResponse.value.json();
                    const whatsappTemplates = whatsappTemplatesData.templates || [];
                    console.log('‚úÖ WhatsApp templates y√ºklendi:', whatsappTemplates.length);
                    allTemplates = allTemplates.concat(whatsappTemplates);
                } else if (whatsappTemplatesResponse && whatsappTemplatesResponse.status === 'fulfilled' && !whatsappTemplatesResponse.value.ok) {
                    const errorData = await whatsappTemplatesResponse.value.json().catch(() => ({}));
                    console.error('‚ùå WhatsApp templates API hatasƒ±:', errorData.error || 'Bilinmeyen hata', whatsappTemplatesResponse.value.status);
                } else if (whatsappTemplatesResponse && whatsappTemplatesResponse.status === 'rejected') {
                    console.error('‚ùå WhatsApp templates y√ºklenemedi (rejected):', whatsappTemplatesResponse.reason);
                }
                
                // ‚úÖ Cloud API template'lerini i≈üle - DETAYLI LOG
                console.log('‚òÅÔ∏è‚òÅÔ∏è‚òÅÔ∏è CLOUD API RESPONSE KONTROL:', {
                    response: cloudApiTemplatesResponse,
                    status: cloudApiTemplatesResponse?.status,
                    fulfilled: cloudApiTemplatesResponse?.status === 'fulfilled',
                    ok: cloudApiTemplatesResponse?.status === 'fulfilled' ? cloudApiTemplatesResponse.value?.ok : null,
                    statusCode: cloudApiTemplatesResponse?.status === 'fulfilled' ? cloudApiTemplatesResponse.value?.status : null
                });
                
                if (cloudApiTemplatesResponse && cloudApiTemplatesResponse.status === 'fulfilled' && cloudApiTemplatesResponse.value.ok) {
                    try {
                        const cloudApiData = await cloudApiTemplatesResponse.value.json();
                        console.log('‚òÅÔ∏è‚òÅÔ∏è‚òÅÔ∏è CLOUD API DATA:', cloudApiData);
                        const cloudTemplates = cloudApiData.templates || cloudApiData.whatsappTemplates || [];
                        console.log('‚úÖ‚úÖ‚úÖ CLOUD API TEMPLATES Y√úKLENDƒ∞:', cloudTemplates.length, cloudTemplates);
                        if (cloudTemplates.length > 0) {
                            allTemplates = allTemplates.concat(cloudTemplates);
                        } else {
                            console.warn('‚ö†Ô∏è Cloud API templates array bo≈ü!');
                        }
                    } catch (parseError) {
                        console.error('‚ùå‚ùå‚ùå Cloud API JSON parse hatasƒ±:', parseError);
                    }
                } else if (cloudApiTemplatesResponse && cloudApiTemplatesResponse.status === 'fulfilled' && !cloudApiTemplatesResponse.value.ok) {
                    try {
                        const errorData = await cloudApiTemplatesResponse.value.json().catch(() => ({}));
                        console.error('‚ùå‚ùå‚ùå CLOUD API TEMPLATES API HATASI:', {
                            status: cloudApiTemplatesResponse.value.status,
                            statusText: cloudApiTemplatesResponse.value.statusText,
                            error: errorData.error || 'Bilinmeyen hata',
                            fullError: errorData,
                            url: cloudApiTemplatesUrl
                        });
                    } catch (parseError) {
                        console.error('‚ùå‚ùå‚ùå Cloud API error JSON parse hatasƒ±:', parseError);
                    }
                } else if (cloudApiTemplatesResponse && cloudApiTemplatesResponse.status === 'rejected') {
                    console.error('‚ùå‚ùå‚ùå CLOUD API TEMPLATES Y√úKLENEMEDƒ∞ (REJECTED):', cloudApiTemplatesResponse.reason);
                } else {
                    console.error('‚ùå‚ùå‚ùå CLOUD API RESPONSE YOK VEYA GE√áERSƒ∞Z!', cloudApiTemplatesResponse);
                }
                
                console.log('üìä Toplam template sayƒ±sƒ±:', allTemplates.length, { 
                    quickReplies: allTemplates.filter(t => t.type === 'quick-reply').length,
                    whatsapp: allTemplates.filter(t => t.type === 'whatsapp').length,
                    cloudapi: allTemplates.filter(t => t.type === 'cloudapi').length
                });
                
                if (allTemplates.length === 0) {
                    templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">Hen√ºz template bulunamadƒ±</div>';
                    return;
                }
                
                // ‚úÖ Templates'ƒ± order'a g√∂re sƒ±rala (WhatsApp/Cloud API template'ler √∂nce, sonra quick-replies)
                allTemplates.sort((a, b) => {
                    const typePriority = (t) => {
                        if (t.type === 'cloudapi') return 0;
                        if (t.type === 'whatsapp') return 1;
                        return 2; // quick-reply
                    };
                    const pa = typePriority(a);
                    const pb = typePriority(b);
                    if (pa !== pb) return pa - pb;
                    return (a.order || 0) - (b.order || 0);
                });
                
                // ‚úÖ Cache'e kaydet (her zaman g√ºncel tut)
                const previousCacheLength = window.cachedTemplates ? window.cachedTemplates.length : 0;
                window.cachedTemplates = allTemplates;
                
                // ‚úÖ Sadece cache bo≈üsa veya yeni template'ler varsa render et
                // Eƒüer zaten cache'den g√∂sterildiyse, sadece g√ºncelle (kullanƒ±cƒ± fark etmez)
                if (previousCacheLength === 0 || allTemplates.length !== previousCacheLength) {
                    renderTemplates(allTemplates);
                } else {
                    // Arka planda sessizce g√ºncelle (kullanƒ±cƒ± fark etmez)
                    console.log('‚úÖ Template\'ler arka planda g√ºncellendi:', allTemplates.length);
                }
            } catch (error) {
                console.error('Templates y√ºklenirken hata:', error);
                templatesList.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Templates y√ºklenirken hata olu≈ütu: ${error.message}</div>`;
            }
        }
        
        // ‚úÖ Templates render fonksiyonu
        function renderTemplates(templates) {
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) return;
            
            if (templates.length === 0) {
                templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">Template bulunamadƒ±</div>';
                return;
            }
            
            // ‚úÖ Templates'ƒ± global deƒüi≈ükende sakla (selectTemplate i√ßin)
            window.templatesData = templates;
            
            templatesList.innerHTML = templates.map(template => {
                // ‚úÖ Content'i escape et (HTML injection √∂nleme)
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const templateName = escapeHtml(template.name || 'Unnamed Template');
                const templateContent = escapeHtml(template.content || '');
                const templateId = escapeHtml(template.id?.toString() || '');
                
                // ‚úÖ Template tipine g√∂re badge g√∂ster
                const templateType = template.type || 'quick-reply';
                const typeBadge = templateType === 'cloudapi'
                    ? '<span style="display: inline-block; background: #128C7E; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Cloud API</span>'
                    : templateType === 'whatsapp'
                        ? '<span style="display: inline-block; background: #25D366; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">WhatsApp</span>'
                        : '<span style="display: inline-block; background: #6366f1; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Quick Reply</span>';
                
                // ‚úÖ Sil butonu: Local template'ler veya quick-reply tipi backend template'leri i√ßin g√∂ster
                const canDelete = template.isLocal || (template.type === 'quick-reply' && !template.isLocal);
                const deleteBtn = canDelete ? `<button style="border:none; background:transparent; color:#ef4444; font-weight:700; cursor:pointer; margin-left:8px;" onclick="window.deleteLocalTemplate('${templateId}')" title="${template.isLocal ? 'Lokal template\'i sil' : 'Backend\'den sil'}">‚úï</button>` : '';
                
                // ‚úÖ Status badge (sadece WhatsApp template'ler i√ßin)
                const statusBadge = template.status && template.type === 'whatsapp'
                    ? `<span style="display: inline-block; background: ${template.status === 'ACTIVE' ? '#10b981' : '#f59e0b'}; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px; font-weight: 600;">${escapeHtml(template.status)}</span>`
                    : '';
                
                return `
                    <div class="template-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; cursor: pointer; transition: box-shadow 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'"
                         onclick="selectTemplate('${templateId}')">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111; flex: 1;">${templateName}</h3>
                            ${typeBadge}
                            ${statusBadge}
                            ${deleteBtn}
                        </div>
                        <p style="margin: 0; font-size: 14px; color: #666; line-height: 1.5; max-height: 100px; overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; word-wrap: break-word;">${templateContent}</p>
                    </div>
                `;
            }).join('');
        }
        
        // ‚úÖ Template filtreleme
        function filterTemplates(searchTerm) {
            const templateCards = document.querySelectorAll('.template-card');
            const term = searchTerm.toLowerCase();
            
            templateCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }
        
        // ‚úÖ Template se√ßme fonksiyonu - Medya desteƒüi ile
        window.selectTemplate = async function(templateId) {
            const templatesModal = document.getElementById('templatesModal');
            const messageInput = document.getElementById('messageInput');
            
            // Template'i bul - cachedTemplates'ten de kontrol et
            let template = window.templatesData ? window.templatesData.find(t => t.id === templateId) : null;
            if (!template && window.cachedTemplates) {
                template = window.cachedTemplates.find(t => (t.id || '').toString() === templateId);
            }
            
            if (!template) {
                console.error('Template bulunamadƒ±:', templateId);
                return;
            }
            
            // Modal'ƒ± kapat
            if (templatesModal) {
                templatesModal.style.display = 'none';
            }
            
            // ‚úÖ Template i√ßinde deƒüi≈üken alanlar var mƒ± kontrol et ({{1}}, {{2}}, vb.)
            const templateContent = template.content || '';
            const variablePattern = /\{\{(\d+)\}\}/g;
            const variables = [];
            let match;
            
            while ((match = variablePattern.exec(templateContent)) !== null) {
                const varNum = parseInt(match[1]);
                if (!variables.includes(varNum)) {
                    variables.push(varNum);
                }
            }
            
            // ‚úÖ Eƒüer deƒüi≈üken alanlar varsa parametre modal'ƒ±nƒ± a√ß
            if (variables.length > 0) {
                window.selectedTemplate = template;
                window.selectedTemplateVariables = variables.sort((a, b) => a - b);
                showTemplateParametersModal(template, variables.sort((a, b) => a - b));
                return;
            }
            
            // ‚úÖ Deƒüi≈üken yoksa normal ≈üekilde mesaj input'una ekle
            if (messageInput) {
                messageInput.value = templateContent;
                messageInput.focus();
                messageInput.disabled = false;
            }
            
            // ‚úÖ Template'te medya varsa (components array'i varsa) medya ekle
            if (template.components && Array.isArray(template.components)) {
                const headerComponent = template.components.find(c => c.type === 'HEADER');
                if (headerComponent) {
                    const format = (headerComponent.format || '').toUpperCase();
                    const example = headerComponent.example || {};
                    
                    // ‚úÖ IMAGE formatƒ± varsa
                    if (format === 'IMAGE' && example.header_url && example.header_url.length > 0) {
                        const imageUrl = example.header_url[0];
                        try {
                            // URL'den resmi indir ve fileInput'a ekle
                            const response = await fetch(imageUrl);
                            const blob = await response.blob();
                            const fileName = `template_image_${Date.now()}.jpg`;
                            const file = new File([blob], fileName, { type: blob.type || 'image/jpeg' });
                            
                            if (!window.selectedFiles) window.selectedFiles = [];
                            window.selectedFiles.push(file);
                            updateSelectedFilesDisplay();
                            
                            console.log('Template\'ten resim eklendi:', fileName);
                        } catch (error) {
                            console.error('Template resmi indirilemedi:', error);
                        }
                    }
                    // ‚úÖ VIDEO formatƒ± varsa
                    else if (format === 'VIDEO' && example.header_url && example.header_url.length > 0) {
                        const videoUrl = example.header_url[0];
                        try {
                            const response = await fetch(videoUrl);
                            const blob = await response.blob();
                            const fileName = `template_video_${Date.now()}.mp4`;
                            const file = new File([blob], fileName, { type: blob.type || 'video/mp4' });
                            
                            if (!window.selectedFiles) window.selectedFiles = [];
                            window.selectedFiles.push(file);
                            updateSelectedFilesDisplay();
                            
                            console.log('Template\'ten video eklendi:', fileName);
                        } catch (error) {
                            console.error('Template videosu indirilemedi:', error);
                        }
                    }
                    // ‚úÖ DOCUMENT formatƒ± varsa
                    else if (format === 'DOCUMENT' && example.header_url && example.header_url.length > 0) {
                        const docUrl = example.header_url[0];
                        try {
                            const response = await fetch(docUrl);
                            const blob = await response.blob();
                            const fileName = `template_document_${Date.now()}.pdf`;
                            const file = new File([blob], fileName, { type: blob.type || 'application/pdf' });
                            
                            if (!window.selectedFiles) window.selectedFiles = [];
                            window.selectedFiles.push(file);
                            updateSelectedFilesDisplay();
                            
                            console.log('Template\'ten dok√ºman eklendi:', fileName);
                        } catch (error) {
                            console.error('Template dok√ºmanƒ± indirilemedi:', error);
                        }
                    }
                }
            }
            
            // ‚úÖ Template'te direkt medya URL'i varsa (eski format)
            if (template.mediaUrl || template.imageUrl || template.videoUrl) {
                const mediaUrl = template.mediaUrl || template.imageUrl || template.videoUrl;
                try {
                    const response = await fetch(mediaUrl);
                    const blob = await response.blob();
                    const fileType = template.imageUrl ? 'image/jpeg' : (template.videoUrl ? 'video/mp4' : blob.type);
                    const extension = template.imageUrl ? 'jpg' : (template.videoUrl ? 'mp4' : 'file');
                    const fileName = `template_media_${Date.now()}.${extension}`;
                    const file = new File([blob], fileName, { type: fileType });
                    
                    if (!window.selectedFiles) window.selectedFiles = [];
                    window.selectedFiles.push(file);
                    updateSelectedFilesDisplay();
                    
                    console.log('Template\'ten medya eklendi:', fileName);
                } catch (error) {
                    console.error('Template medyasƒ± indirilemedi:', error);
                }
            }
            
            // Send butonunu enable et
            const sendButton = document.getElementById('sendMessage');
            if (sendButton) {
                sendButton.disabled = false;
            }
            
            console.log('Template se√ßildi:', { templateId, templateName: template.name, content: template.content, hasMedia: !!(template.components || template.mediaUrl) });
        };
        
        // ‚úÖ Template parametre modalƒ±nƒ± g√∂ster
        function showTemplateParametersModal(template, variables) {
            const modal = document.getElementById('templateParametersModal');
            const content = document.getElementById('templateParametersContent');
            
            if (!modal || !content) return;
            
            // ‚úÖ Parametre input'larƒ±nƒ± olu≈ütur - SADECE TEXT VE URL
            let html = '<p style="margin-bottom: 16px; color: #666;">L√ºtfen template parametrelerini doldurun:</p>';
            
            // ‚úÖ Mesaj preview alanƒ±
            html += `
                <div id="templateMessagePreview" style="margin-bottom: 20px; padding: 16px; border: 2px solid #6366f1; border-radius: 8px; background: #f0f4ff;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #6366f1;">üìã Mesaj √ñnizleme:</label>
                    <div id="templatePreviewContent" style="padding: 12px; background: white; border-radius: 6px; min-height: 50px; white-space: pre-wrap; word-wrap: break-word; color: #333; font-size: 14px; line-height: 1.5;">
                        ${template.content || ''}
                    </div>
                </div>
            `;
            
            variables.forEach((varNum, index) => {
                html += `
                    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Parametre {{${varNum}}}</label>
                        
                        <!-- Parametre tipi se√ßimi - SADECE TEXT VE URL -->
                        <select 
                            id="templateParamType_${varNum}" 
                            class="template-param-type"
                            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; font-size: 14px;"
                            onchange="updateTemplateParamInput(${varNum}); updateTemplatePreview();"
                        >
                            <option value="text">üìù Metin</option>
                            <option value="url">üîó Link (URL)</option>
                        </select>
                        
                        <!-- Text input -->
                        <input 
                            type="text" 
                            id="templateParam_${varNum}" 
                            class="template-param-input template-param-text" 
                            placeholder="Deƒüer girin..."
                            style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; display: block;"
                            oninput="updateTemplatePreview();"
                        >
                    </div>
                `;
            });
            
            content.innerHTML = html;
            modal.style.display = 'block';
            
            // ‚úÖ ƒ∞lk input'a focus
            const firstInput = document.getElementById(`templateParam_${variables[0]}`);
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
            
            // ‚úÖ Preview'ƒ± ba≈ülat
            updateTemplatePreview();
        }
        
        // ‚úÖ Parametre tipi deƒüi≈ütiƒüinde input'u g√ºncelle - SADECE TEXT VE URL
        window.updateTemplateParamInput = function(varNum) {
            const typeSelect = document.getElementById(`templateParamType_${varNum}`);
            const textInput = document.getElementById(`templateParam_${varNum}`);
            
            if (!typeSelect || !textInput) return;
            
            const paramType = typeSelect.value;
            
            if (paramType === 'text') {
                textInput.type = 'text';
                textInput.placeholder = 'Deƒüer girin...';
            } else if (paramType === 'url') {
                textInput.type = 'url';
                textInput.placeholder = 'https://example.com';
            }
            
            // ‚úÖ Preview'ƒ± g√ºncelle
            updateTemplatePreview();
        };
        
        // ‚úÖ Template mesaj preview'ƒ±nƒ± g√ºncelle
        window.updateTemplatePreview = function() {
            if (!window.selectedTemplate || !window.selectedTemplateVariables) return;
            
            const template = window.selectedTemplate;
            const variables = window.selectedTemplateVariables;
            const previewContent = document.getElementById('templatePreviewContent');
            
            if (!previewContent) return;
            
            // ‚úÖ Template i√ßeriƒüini al
            let previewText = template.content || '';
            
            // ‚úÖ Parametreleri yerle≈ütir
            variables.forEach(varNum => {
                const textInput = document.getElementById(`templateParam_${varNum}`);
                if (textInput) {
                    const value = textInput.value.trim() || `{{${varNum}}}`;
                    previewText = previewText.replace(new RegExp(`\\{\\{${varNum}\\}\\}`, 'g'), value);
                }
            });
            
            // ‚úÖ Preview'ƒ± g√ºncelle
            previewContent.textContent = previewText;
        };
        
        // ‚úÖ Template parametre modalƒ±nƒ± kapat
        function closeTemplateParametersModal() {
            const modal = document.getElementById('templateParametersModal');
            if (modal) {
                modal.style.display = 'none';
            }
            window.selectedTemplate = null;
            window.selectedTemplateVariables = null;
        }
        
        // ‚úÖ Template mesaj g√∂nder (parametrelerle)
        window.sendTemplateMessageWithParams = async function() {
            if (!window.selectedTemplate || !window.selectedTemplateVariables) {
                console.error('Template veya parametreler bulunamadƒ±');
                return;
            }
            
            const template = window.selectedTemplate;
            const variables = window.selectedTemplateVariables;
            
            // ‚úÖ Parametreleri topla - SADECE TEXT VE URL
            const params = {};
            const paramTypes = {};
            let allFilled = true;
            
            variables.forEach(varNum => {
                const typeSelect = document.getElementById(`templateParamType_${varNum}`);
                const textInput = document.getElementById(`templateParam_${varNum}`);
                
                if (!typeSelect || !textInput) {
                    allFilled = false;
                    return;
                }
                
                const paramType = typeSelect.value;
                paramTypes[varNum] = paramType;
                
                const value = textInput.value.trim();
                if (value) {
                    params[varNum] = value;
                } else {
                    allFilled = false;
                }
            });
            
            if (!allFilled) {
                alert('L√ºtfen t√ºm parametreleri doldurun!');
                return;
            }
            
            // ‚úÖ Modal'ƒ± kapat
            closeTemplateParametersModal();
            
            // ‚úÖ Template mesajƒ±nƒ± g√∂nder
            // ‚úÖ Conversation ID'yi bul
            let conversationId = null;
            
            // ‚úÖ window.conversationsState.currentConversationId kullan
            if (window.conversationsState && window.conversationsState.currentConversationId) {
                conversationId = window.conversationsState.currentConversationId;
            } else if (window.currentConversationId) {
                conversationId = window.currentConversationId;
            } else {
                // Chat header'dan conversation ID'yi al
                const chatActive = document.getElementById('chatActive');
                if (chatActive && chatActive.dataset.conversationId) {
                    conversationId = chatActive.dataset.conversationId;
                } else {
                    // Son se√ßilen conversation'ƒ± bul
                    const selectedConv = document.querySelector('.conversation-item.selected');
                    if (selectedConv && selectedConv.dataset.conversationId) {
                        conversationId = selectedConv.dataset.conversationId;
                    } else if (selectedConv && selectedConv.dataset.id) {
                        conversationId = selectedConv.dataset.id;
                    }
                }
            }
            
            if (!conversationId) {
                alert('L√ºtfen bir konu≈üma se√ßin!');
                return;
            }
            
            console.log('‚úÖ Conversation ID bulundu:', conversationId);
            
            const savedApiKey = localStorage.getItem('sleekflowApiKey');
            const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
            
            if (!savedApiKey || savedApiKey.trim().length < 10) {
                alert('SleekFlow baƒülantƒ±sƒ± yok. L√ºtfen √∂nce baƒülanƒ±n.');
                return;
            }
            
            try {
                // ‚úÖ Sadece text ve URL parametreler - JSON ile g√∂nder
                const payload = {
                    text: template.content || '',
                    templateId: template.id || template.name,
                    templateName: template.name,
                    templateParams: params,
                    templateParamTypes: paramTypes,
                    isTemplate: true,
                    apiKey: savedApiKey,
                    baseUrl: safeBaseUrl
                };
                
                // ‚úÖ √ñnce kullanƒ±cƒ± bilgisini al (backend yetki kontrol√º i√ßin)
                await getCurrentZohoUser();
                
                // ‚úÖ Backend yetki kontrol√º i√ßin kullanƒ±cƒ± bilgisini ekle
                if (window.currentZohoUser.email) {
                    payload.userEmail = window.currentZohoUser.email;
                }
                if (window.currentZohoUser.id) {
                    payload.userId = window.currentZohoUser.id;
                }
                
                console.log('üì§ Template mesaj g√∂nderiliyor:', { conversationId, templateName: template.name, params, paramTypes });
                
                let messagesUrl = `/api/sleekflow/conversations/${conversationId}/messages?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                messagesUrl = addUserParamsToUrl(messagesUrl);
                
                const response = await fetch(messagesUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Template mesajƒ± g√∂nderilemedi');
                }
                
                console.log('‚úÖ Template mesaj g√∂nderildi:', result);
                
                // ‚úÖ KRITIK: Cache'i bypass et ve mesajlarƒ± YENƒ∞DEN y√ºkle (ger√ßek mesajlar gelsin)
                // Cache bypass flag'i set et
                if (!window.conversationsState.bypassCacheFor) {
                    window.conversationsState.bypassCacheFor = {};
                }
                window.conversationsState.bypassCacheFor[conversationId] = true;
                
                // Cache'i de temizle
                if (window.conversationsState.loadedMessages) {
                    delete window.conversationsState.loadedMessages[conversationId];
                }
                
                // ‚úÖ Mesajlarƒ± HEMEN y√ºkle (cache bypass)
                if (window.loadMessagesDirectly) {
                    await window.loadMessagesDirectly(conversationId).then(() => {
                        // Bypass flag'ini temizle
                        if (window.conversationsState.bypassCacheFor) {
                            delete window.conversationsState.bypassCacheFor[conversationId];
                        }
                        // Scroll to bottom
                        setTimeout(() => {
                            const messagesArea = document.getElementById('messagesArea');
                            const messagesList = document.getElementById('messagesList');
                            const scrollContainer = messagesArea || messagesList;
                            if (scrollContainer) {
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                            }
                        }, 500);
                    }).catch((err) => {
                        console.error('Mesajlar y√ºklenirken hata:', err);
                    });
                } else if (window.loadMessages) {
                    await window.loadMessages(conversationId);
                }
                
                // ‚úÖ Ba≈üarƒ± mesajƒ±
                if (window.showToast) {
                    window.showToast('Template mesajƒ± g√∂nderildi', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Template mesaj g√∂nderme hatasƒ±:', error);
                if (window.showToast) {
                    window.showToast(`Template mesajƒ± g√∂nderilemedi: ${error.message}`, 'error');
                } else {
                    alert(`Template mesajƒ± g√∂nderilemedi: ${error.message}`);
                }
            }
        };
        
        // ‚úÖ Template parametre modal event listener'larƒ±
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('closeTemplateParametersModal');
            const cancelBtn = document.getElementById('cancelTemplateParameters');
            const sendBtn = document.getElementById('sendTemplateMessage');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', closeTemplateParametersModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeTemplateParametersModal);
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', window.sendTemplateMessageWithParams);
            }
            
            // ‚úÖ ESC tu≈üu ile kapat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('templateParametersModal');
                    if (modal && modal.style.display !== 'none') {
                        closeTemplateParametersModal();
                    }
                }
            });
        });

        // ‚úÖ Template silme (hem local hem backend)
        window.deleteLocalTemplate = async function(templateId) {
            if (!templateId) return;
            if (!window.cachedTemplates) return;
            
            const idx = window.cachedTemplates.findIndex(t => (t.id || '').toString() === templateId);
            if (idx === -1) return;
            
            const template = window.cachedTemplates[idx];
            
            // ‚úÖ Eƒüer quick-reply ise backend'den sil
            if (template.type === 'quick-reply' && !template.isLocal) {
                if (!confirm('Bu template silinecek. Emin misiniz?')) {
                    return;
                }
                
                try {
                    const savedApiKey = localStorage.getItem('sleekflowApiKey');
                    const savedBaseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
                    const safeBaseUrl = (savedBaseUrl && savedBaseUrl !== 'undefined' && savedBaseUrl !== 'null') ? savedBaseUrl : '';
                    
                    if (!savedApiKey || savedApiKey.trim().length < 10) {
                        alert('SleekFlow baƒülantƒ±sƒ± yok. L√ºtfen √∂nce baƒülanƒ±n.');
                        return;
                    }
                    
                    // ‚úÖ Backend'den sil
                    const deleteUrl = `/api/sleekflow/quick-replies/${templateId}?apiKey=${encodeURIComponent(savedApiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Template silinemedi');
                    }
                    
                    // ‚úÖ Ba≈üarƒ±lƒ± - Template'leri yeniden y√ºkle
                    alert('Template silindi');
                    loadTemplates(); // Template'leri yeniden y√ºkle
                    
                } catch (error) {
                    console.error('Template silme hatasƒ±:', error);
                    alert('Template silinemedi: ' + error.message);
                }
                return;
            }
            
            // ‚úÖ Local template veya Cloud API/WhatsApp template'i sil (sadece UI'dan)
            if (template.isLocal) {
                if (!confirm('Bu template silinecek. Emin misiniz?')) return;
                
                // ‚úÖ Local template'i sil
                window.cachedTemplates.splice(idx, 1);
                
                // ‚úÖ Template listesini yeniden render et
                renderTemplates(window.cachedTemplates);
                
                alert('Template silindi');
            } else {
                alert('Bu template silinemez');
            }
        };
    </script>
</body>
</html>
