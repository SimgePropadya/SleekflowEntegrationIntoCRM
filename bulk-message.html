<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SleekFlow Toplu Mesaj G√∂nder</title>
    <!-- Zoho CRM Embedded App SDK (Widget i√ßin) -->
    <script src="https://live.zwidgets.com/js-sdk/1.0/ZohoEmbededAppSDK.min.js"></script>
    <!-- Zoho CRM JavaScript API (List View i√ßin) -->
    <script src="https://js.zohostatic.com/crm/javascript/crmapi.min.js"></script>
    <!-- Zoho CRM JS SDK (CORS i√ßin - Client-based OAuth Application) -->
    <script src="https://static.zohocdn.com/zohocrm/v2.0/sdk/3.0.0/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 24px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }

        .recipients-summary {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #666;
        }

        .phone-type-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .recipients-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .recipient-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f0f7ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
        }

        .recipient-info {
            flex: 1;
        }

        .recipient-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .recipient-phone {
            font-size: 13px;
            color: #666;
        }

        .recipient-warning {
            font-size: 12px;
            color: #ff6b6b;
            margin-top: 4px;
        }

        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #ff5252;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #ffb300;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .message-section {
            margin-top: 24px;
        }

        .template-selectors {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .template-select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .message-input {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }

        .send-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
        }

        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ SleekFlow Toplu Mesaj G√∂nder</h1>
            <button class="close-btn" onclick="window.close()">√ó</button>
        </div>

        <div class="content">
            <!-- Error/Success Messages -->
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <!-- Recipients Section (Sadece se√ßili lead'lerin numaralarƒ±) -->
            <div class="section">
                <div class="section-title">üì± Alƒ±cƒ±lar</div>
                
                <div class="recipients-summary" id="recipientsSummary">
                    <strong>Se√ßili <span id="selectedLeadCount">0</span> lead</strong> | 
                    <strong>Toplam <span id="recipientCount">0</span> numara</strong>
                </div>

                <div class="recipients-list" id="recipientsList" style="margin-top: 16px;">
                    <!-- Se√ßili lead'lerin telefon numaralarƒ± buraya eklenecek -->
                </div>

                <div class="action-buttons" style="margin-top: 16px; display: flex; gap: 8px;">
                    <button class="btn btn-warning" onclick="removeDuplicates()">üîÑ Duplicate Numaralarƒ± Kaldƒ±r</button>
                    <button class="btn btn-success" onclick="addRecipients()">+ Alƒ±cƒ± Ekle</button>
                </div>
            </div>

            <!-- Sender Selection Section -->
            <div class="section">
                <div class="section-title">üìû G√∂nderen Numarasƒ±</div>
                <select id="senderSelect" class="template-select" style="margin-bottom: 0;">
                    <option value="908505327532">VIP Proje Pazarlama-+908505327532</option>
                    <option value="905421363421">Hamzah Coexistence-+905421363421</option>
                </select>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    Mesajlarƒ±n hangi numaradan g√∂nderileceƒüini se√ßin
                </p>
            </div>

            <!-- Message Section -->
            <div class="section message-section">
                <div class="section-title">üí¨ Mesaj</div>

                <div style="margin-bottom: 12px;">
                    <button class="btn btn-primary" id="openTemplates" style="padding: 10px 20px; font-size: 14px;">
                        üìã Templates
                    </button>
                </div>

                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n... (Template se√ßerseniz otomatik doldurulur)"
                ></textarea>
            </div>

            <!-- Send Section -->
            <div class="send-section">
                <button class="send-btn" id="sendBtn" onclick="sendBulkMessage()">
                    ‚ñ∫ Toplu Mesaj G√∂nder
                </button>
                <div class="loading" id="loading">
                    Mesajlar g√∂nderiliyor... L√ºtfen bekleyin.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ Base URL'i dinamik olarak bul (Render.com veya localhost)
        function getBaseUrl() {
            // Eƒüer window.location.origin varsa onu kullan
            if (typeof window !== 'undefined' && window.location && window.location.origin) {
                return window.location.origin;
            }
            // Fallback: Environment variable veya default
            return process.env.RENDER_EXTERNAL_URL || process.env.API_BASE_URL || 'http://localhost:3000';
        }
        
        // ‚úÖ Base URL'i sayfa y√ºklendiƒüinde g√∂ster (kullanƒ±cƒ± i√ßin)
        const BASE_URL = getBaseUrl();
        console.log('üìç Base URL:', BASE_URL);
        
        // Global state
        let recipients = [];
        let allRecipients = [];
        let currentFilter = 'all';
        let pageLoadSelectedIds = [];
        let pageLoadListenerRegistered = false;

        function extractIdsFromPageLoad(data) {
            const candidates = [];
            if (!data) return [];
            if (data.EntityId) candidates.push(data.EntityId);
            if (data.entityId) candidates.push(data.entityId);
            if (data.recordId) candidates.push(data.recordId);
            if (data.RecordId) candidates.push(data.RecordId);
            if (data.EntityIds) candidates.push(...(Array.isArray(data.EntityIds) ? data.EntityIds : [data.EntityIds]));
            if (data.entityIds) candidates.push(...(Array.isArray(data.entityIds) ? data.entityIds : [data.entityIds]));
            if (data.RecordIds) candidates.push(...(Array.isArray(data.RecordIds) ? data.RecordIds : [data.RecordIds]));
            if (data.recordIds) candidates.push(...(Array.isArray(data.recordIds) ? data.recordIds : [data.recordIds]));
            if (data.SelectedRecords) candidates.push(...(Array.isArray(data.SelectedRecords) ? data.SelectedRecords : [data.SelectedRecords]));
            if (data.selectedRecords) candidates.push(...(Array.isArray(data.selectedRecords) ? data.selectedRecords : [data.selectedRecords]));

            return candidates
                .map(rec => rec?.id || rec?.Id || rec?.ID || rec?.recordId || rec?.record_id || rec)
                .map(id => (id ? id.toString() : null))
                .filter(id => id && id.length >= 10);
        }

        // ‚úÖ PageLoad'tan direkt telefon numaralarƒ±nƒ± √ßƒ±kar
        function extractLeadsWithPhonesFromPageLoad(data) {
            if (!data) return [];
            
            const leads = [];
            
            // ‚úÖ SelectedRecords'dan direkt telefon numaralarƒ±nƒ± al
            const selectedRecords = data.SelectedRecords || data.selectedRecords || data.Records || data.records;
            if (selectedRecords && Array.isArray(selectedRecords)) {
                selectedRecords.forEach(record => {
                    const phone = record.Phone || record.phone || '';
                    const mobile = record.Mobile || record.mobile || '';
                    const secondaryPhone = record.Secondary_Phone || record.SecondaryPhone || record.secondary_phone || '';
                    
                    if (phone || mobile || secondaryPhone) {
                        const firstName = record.First_Name || record.FirstName || record.first_name || '';
                        const lastName = record.Last_Name || record.LastName || record.last_name || '';
                        const fullName = record.Full_Name || record.FullName || record.full_name || 
                                        (firstName && lastName ? `${firstName} ${lastName}` : firstName || lastName || 'ƒ∞simsiz');
                        
                        const leadId = record.id || record.Id || record.ID || record.recordId || record.record_id || '';
                        
                        leads.push({
                            id: leadId,
                            name: fullName,
                            Phone: phone,
                            Mobile: mobile,
                            Secondary_Phone: secondaryPhone,
                            First_Name: firstName,
                            Last_Name: lastName
                        });
                    }
                });
            }
            
            return leads;
        }

        function setupZohoPageLoadListener() {
            if (pageLoadListenerRegistered) return;
            if (typeof ZOHO === 'undefined' || !ZOHO.embeddedApp || typeof ZOHO.embeddedApp.on !== 'function') return;
            pageLoadListenerRegistered = true;
            ZOHO.embeddedApp.on("PageLoad", async function(data) {
                console.log('‚úÖ ZOHO PageLoad data:', data);
                
                // ‚úÖ √ñnce direkt telefon numaralarƒ±nƒ± dene
                const leadsWithPhones = extractLeadsWithPhonesFromPageLoad(data);
                if (leadsWithPhones.length > 0) {
                    console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ ZOHO PageLoad se√ßili lead telefon numaralarƒ±:', leadsWithPhones);
                    
                    leadsWithPhones.forEach(lead => {
                        if (lead.id) {
                            selectedLeadIds.add(lead.id);
                        }
                    });
                    
                    buildRecipients(leadsWithPhones);
                    renderLeadsList();
                    renderRecipients();
                    return;
                }
                
                // ‚úÖ Fallback: ID'leri al ve backend API'den telefon numaralarƒ±nƒ± √ßek
                const ids = extractIdsFromPageLoad(data);
                if (ids && ids.length > 0) {
                    console.log('‚úÖ ZOHO PageLoad se√ßili lead ID\'leri:', ids);
                    pageLoadSelectedIds = ids;
                    
                    // ‚úÖ Backend API'den telefon numaralarƒ±nƒ± √ßek
                    try {
                        const leadsWithPhones = await fetchSelectedLeadsDetails(ids);
                        if (leadsWithPhones && leadsWithPhones.length > 0) {
                            console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ PageLoad ID\'lerinden telefon numaralarƒ± √ßekildi:', leadsWithPhones.length);
                            
                            leadsWithPhones.forEach(lead => {
                                const leadId = getLeadId(lead);
                                if (leadId) {
                                    selectedLeadIds.add(leadId);
                                }
                            });
                            
                            buildRecipients(leadsWithPhones);
                            renderLeadsList();
                            renderRecipients();
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è PageLoad ID\'lerinden telefon numaralarƒ± √ßekilemedi:', error);
                    }
                }
            });
        }

        // URL'den lead ID'lerini al
        function getLeadIdsFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            // Zoho CRM bazen farklƒ± parametre isimleri kullanƒ±r
            const leadIds = urlParams.get('leadIds') || urlParams.get('recordIds') || urlParams.get('ids') || urlParams.get('recordId') || '';
            
            console.log('üîç URL parametreleri:', {
                fullUrl: window.location.href,
                search: window.location.search,
                leadIds: urlParams.get('leadIds'),
                recordIds: urlParams.get('recordIds'),
                ids: urlParams.get('ids'),
                recordId: urlParams.get('recordId'),
                allParams: Object.fromEntries(urlParams.entries())
            });
            
            if (leadIds) {
                // Virg√ºlle ayrƒ±lmƒ±≈ü ID'leri parse et
                const ids = leadIds.split(',').map(id => id.trim()).filter(id => id && id.length >= 10);
                console.log('‚úÖ Lead ID\'leri bulundu:', {
                    raw: leadIds,
                    parsed: ids,
                    count: ids.length
                });
                
                if (ids.length > 0) {
                    return ids;
                } else {
                    console.warn('‚ö†Ô∏è Lead ID\'leri parse edildi ama ge√ßerli ID bulunamadƒ± (uzunluk < 10)');
                }
            }
            
            console.warn('‚ö†Ô∏è Lead ID\'leri URL\'de bulunamadƒ±');
            return [];
        }

        // Lead bilgilerini Zoho API'den √ßek
        async function fetchLeadDetails(leadIds) {
            try {
                console.log('üìû Lead bilgileri √ßekiliyor...', { 
                    leadIds, 
                    count: leadIds.length,
                    leadIdsString: leadIds.join(',')
                });
                
                const url = `/api/zoho/leads?leadIds=${encodeURIComponent(leadIds.join(','))}`;
                console.log('üì° API URL:', url);
                
                const response = await fetch(url);
                console.log('üì• API Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Lead bilgileri √ßekilemedi (HTTP error):', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData
                    });
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Lead bilgileri √ßekildi:', { 
                    success: data.success, 
                    count: data.leads?.length || 0,
                    total: data.total,
                    leads: data.leads,
                    fullResponse: data
                });
                
                if (!data.success) {
                    console.warn('‚ö†Ô∏è API success=false d√∂nd√º:', data);
                }
                
                return data.leads || [];
            } catch (error) {
                console.error('‚ùå Lead bilgileri √ßekilemedi (catch):', {
                    error: error,
                    message: error.message,
                    stack: error.stack
                });
                showError('Lead bilgileri √ßekilemedi: ' + error.message);
                return [];
            }
        }

        // Recipients listesini olu≈ütur
        function buildRecipients(leads) {
            allRecipients = [];
            
            console.log('üìã Recipients olu≈üturuluyor, lead sayƒ±sƒ±:', leads.length);
            console.log('üìã ƒ∞lk lead √∂rneƒüi:', leads[0]);
            
            leads.forEach((lead, index) => {
                // ‚úÖ ƒ∞sim alanlarƒ±nƒ± kontrol et (b√ºy√ºk/k√º√ß√ºk harf duyarlƒ± olabilir)
                const name = (lead.First_Name && lead.Last_Name) 
                    ? `${lead.First_Name} ${lead.Last_Name}` 
                    : (lead.First_Name || lead.Last_Name || lead.Full_Name || 
                       lead.first_name || lead.last_name || lead.full_name || 'ƒ∞simsiz');
                
                // ‚úÖ Telefon numaralarƒ±nƒ± kontrol et (b√ºy√ºk/k√º√ß√ºk harf duyarlƒ± olabilir)
                const phone = lead.Phone || lead.phone;
                const mobile = lead.Mobile || lead.mobile;
                const secondaryPhone = lead.Secondary_Phone || lead.secondary_phone || lead.SecondaryPhone || lead.secondary_phone;
                
                console.log(`üìû Lead ${index + 1} (${name}):`, {
                    id: lead.id,
                    phone: phone || 'YOK',
                    mobile: mobile || 'YOK',
                    secondaryPhone: secondaryPhone || 'YOK',
                    allFields: Object.keys(lead)
                });
                
                // Phone
                if (phone) {
                    allRecipients.push({
                        name,
                        phone: phone,
                        type: 'phone',
                        leadId: lead.id
                    });
                }
                
                // Mobile
                if (mobile) {
                    allRecipients.push({
                        name,
                        phone: mobile,
                        type: 'mobile',
                        leadId: lead.id
                    });
                }
                
                // Secondary Phone
                if (secondaryPhone) {
                    allRecipients.push({
                        name,
                        phone: secondaryPhone,
                        type: 'secondary',
                        leadId: lead.id
                    });
                }
                
                // ‚úÖ Eƒüer hi√ß telefon numarasƒ± yoksa uyar
                if (!phone && !mobile && !secondaryPhone) {
                    console.warn(`‚ö†Ô∏è Lead ${index + 1} (${name}) i√ßin telefon numarasƒ± bulunamadƒ±!`, {
                        leadId: lead.id,
                        availableFields: Object.keys(lead)
                    });
                }
            });
            
            console.log('‚úÖ Toplam recipients olu≈üturuldu:', allRecipients.length);
            
            // Duplicate kontrol√º
            const phoneMap = {};
            recipients = allRecipients.filter(recipient => {
                const cleanPhone = recipient.phone.replace(/\D/g, '');
                if (phoneMap[cleanPhone]) {
                    phoneMap[cleanPhone].duplicate = true;
                    recipient.duplicate = true;
                    return true;
                }
                phoneMap[cleanPhone] = recipient;
                return true;
            });
            
            console.log('‚úÖ Recipients render ediliyor:', recipients.length);
            renderRecipients();
        }

        // Recipients'ƒ± render et
        function renderRecipients() {
            const filtered = currentFilter === 'all' 
                ? recipients 
                : recipients.filter(r => r.type === currentFilter);
            
            document.getElementById('recipientCount').textContent = filtered.length;
            
            const list = document.getElementById('recipientsList');
            list.innerHTML = '';
            
            filtered.forEach((recipient, index) => {
                const item = document.createElement('div');
                item.className = 'recipient-item';
                
                const cleanPhone = recipient.phone.replace(/\D/g, '');
                
                item.innerHTML = `
                    <div class="recipient-info">
                        <div class="recipient-name">${recipient.name}</div>
                        <div class="recipient-phone">${recipient.phone} (${recipient.type})</div>
                        ${recipient.duplicate ? '<div class="recipient-warning">‚ö†Ô∏è Duplicate</div>' : ''}
                    </div>
                    <button class="remove-btn" onclick="removeRecipient(${index})">√ó</button>
                `;
                
                list.appendChild(item);
            });
        }

        // Recipient kaldƒ±r
        function removeRecipient(index) {
            const filtered = currentFilter === 'all' 
                ? recipients 
                : recipients.filter(r => r.type === currentFilter);
            
            const recipient = filtered[index];
            recipients = recipients.filter(r => r !== recipient);
            renderRecipients();
        }

        // Duplicate'leri kaldƒ±r
        function removeDuplicates() {
            const phoneMap = {};
            recipients = recipients.filter(recipient => {
                const cleanPhone = recipient.phone.replace(/\D/g, '');
                if (phoneMap[cleanPhone]) {
                    return false; // Duplicate, kaldƒ±r
                }
                phoneMap[cleanPhone] = recipient;
                recipient.duplicate = false;
                return true;
            });
            renderRecipients();
        }

        // ‚úÖ Alƒ±cƒ± ekle - Lead se√ßim modal'ƒ±nƒ± a√ß
        function addRecipients() {
            // ‚úÖ Lead se√ßim modal'ƒ±nƒ± g√∂ster
            showLeadSelectionModal();
        }
        
        // ‚úÖ Lead se√ßim modal'ƒ±nƒ± g√∂ster
        function showLeadSelectionModal() {
            // ‚úÖ Modal zaten varsa g√∂ster, yoksa olu≈ütur
            let modal = document.getElementById('leadSelectionModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'leadSelectionModal';
                modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;';
                modal.innerHTML = `
                    <div style="max-width: 800px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #333;">üìã Lead Se√ß</h2>
                            <button onclick="closeLeadSelectionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <input 
                                type="text" 
                                id="modalLeadSearch" 
                                placeholder="üîç Lead ara (isim, telefon, email...)" 
                                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
                            >
                        </div>
                        
                        <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                            <button onclick="selectAllLeadsInModal()" class="btn btn-primary" style="flex: 1; padding: 10px; font-size: 14px;">‚úÖ T√ºm√ºn√º Se√ß</button>
                            <button onclick="deselectAllLeadsInModal()" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 14px;">‚ùå Se√ßimi Temizle</button>
                        </div>
                        
                        <div id="modalLeadsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                            <div style="text-align: center; padding: 40px; color: #666;">Lead'ler y√ºkleniyor...</div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button onclick="closeLeadSelectionModal()" class="btn btn-secondary" style="padding: 10px 20px; font-size: 14px;">ƒ∞ptal</button>
                            <button onclick="confirmLeadSelection()" class="btn btn-success" style="padding: 10px 20px; font-size: 14px;">‚úÖ Se√ßilenleri Ekle</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ‚úÖ Arama input'una event listener ekle
                const searchInput = document.getElementById('modalLeadSearch');
                if (searchInput) {
                    let searchTimeout;
                    searchInput.addEventListener('input', function(e) {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            renderModalLeadsList();
                        }, 300);
                    });
                }
            }
            
            // ‚úÖ Modal'ƒ± g√∂ster ve lead'leri y√ºkle
            modal.style.display = 'block';
            
            // ‚úÖ Lead'leri y√ºkle (eƒüer y√ºklenmemi≈üse)
            if (allLeads.length === 0) {
                loadAllLeads().then(() => {
                    renderModalLeadsList();
                });
            } else {
                renderModalLeadsList();
            }
        }
        
        // ‚úÖ Modal lead listesini render et
        function renderModalLeadsList() {
            const modalLeadsList = document.getElementById('modalLeadsList');
            if (!modalLeadsList) return;
            
            const searchTerm = (document.getElementById('modalLeadSearch')?.value || '').toLowerCase().trim();
            
            // ‚úÖ Arama terimine g√∂re filtrele
            let filteredLeads = allLeads;
            if (searchTerm) {
                filteredLeads = allLeads.filter(lead => {
                    const name = ((lead.First_Name || '') + ' ' + (lead.Last_Name || '')).trim() || lead.Full_Name || 'ƒ∞simsiz';
                    const phone = (lead.Phone || lead.phone || '').toString();
                    const mobile = (lead.Mobile || lead.mobile || '').toString();
                    const email = (lead.Email || lead.email || '').toString();
                    
                    return name.toLowerCase().includes(searchTerm) || 
                           phone.includes(searchTerm) || 
                           mobile.includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm);
                });
            }
            
            if (filteredLeads.length === 0) {
                modalLeadsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Lead bulunamadƒ±</div>';
                return;
            }
            
            modalLeadsList.innerHTML = filteredLeads.map(lead => {
                const name = (lead.First_Name && lead.Last_Name) 
                    ? `${lead.First_Name} ${lead.Last_Name}` 
                    : (lead.First_Name || lead.Last_Name || lead.Full_Name || 'ƒ∞simsiz');
                
                const phone = lead.Phone || lead.phone || '';
                const mobile = lead.Mobile || lead.mobile || '';
                const secondaryPhone = lead.Secondary_Phone || lead.secondary_phone || lead.SecondaryPhone || '';
                const hasPhone = phone || mobile || secondaryPhone;

                const leadId = getLeadId(lead);
                const isSelected = selectedLeadIds.has(leadId);
                
                return `
                    <div class="lead-item" style="display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid ${isSelected ? '#667eea' : '#e0e0e0'}; ${isSelected ? 'background: #f0f4ff;' : ''}">
                        <input 
                            type="checkbox" 
                            class="lead-checkbox" 
                            data-lead-id="${leadId}"
                            ${isSelected ? 'checked' : ''}
                            onchange="toggleLeadSelectionInModal('${leadId}', this.checked)"
                            style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"
                        >
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${name}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${phone ? `üìû ${phone}` : ''} ${mobile ? `üì± ${mobile}` : ''} ${secondaryPhone ? `üìû ${secondaryPhone}` : ''}
                                ${!hasPhone ? '<span style="color: #ef4444;">‚ö†Ô∏è Telefon yok</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ‚úÖ Modal'da lead se√ßimi toggle
        window.toggleLeadSelectionInModal = function(leadId, isSelected) {
            if (isSelected) {
                selectedLeadIds.add(leadId);
            } else {
                selectedLeadIds.delete(leadId);
            }
            renderModalLeadsList(); // ‚úÖ Checkbox durumunu g√ºncelle
        };
        
        // ‚úÖ Modal'da t√ºm√ºn√º se√ß
        window.selectAllLeadsInModal = function() {
            const searchTerm = (document.getElementById('modalLeadSearch')?.value || '').toLowerCase().trim();
            let leadsToSelect = allLeads;
            
            if (searchTerm) {
                leadsToSelect = allLeads.filter(lead => {
                    const name = ((lead.First_Name || '') + ' ' + (lead.Last_Name || '')).trim() || lead.Full_Name || 'ƒ∞simsiz';
                    const phone = (lead.Phone || lead.phone || '').toString();
                    const mobile = (lead.Mobile || lead.mobile || '').toString();
                    const email = (lead.Email || lead.email || '').toString();
                    
                    return name.toLowerCase().includes(searchTerm) || 
                           phone.includes(searchTerm) || 
                           mobile.includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm);
                });
            }
            
            leadsToSelect.forEach(lead => {
                const leadId = getLeadId(lead);
                if (leadId) {
                    selectedLeadIds.add(leadId);
                }
            });
            renderModalLeadsList();
        };
        
        // ‚úÖ Modal'da se√ßimi temizle
        window.deselectAllLeadsInModal = function() {
            const searchTerm = (document.getElementById('modalLeadSearch')?.value || '').toLowerCase().trim();
            let leadsToDeselect = allLeads;
            
            if (searchTerm) {
                leadsToDeselect = allLeads.filter(lead => {
                    const name = ((lead.First_Name || '') + ' ' + (lead.Last_Name || '')).trim() || lead.Full_Name || 'ƒ∞simsiz';
                    const phone = (lead.Phone || lead.phone || '').toString();
                    const mobile = (lead.Mobile || lead.mobile || '').toString();
                    const email = (lead.Email || lead.email || '').toString();
                    
                    return name.toLowerCase().includes(searchTerm) || 
                           phone.includes(searchTerm) || 
                           mobile.includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm);
                });
            }
            
            leadsToDeselect.forEach(lead => {
                const leadId = getLeadId(lead);
                if (leadId) {
                    selectedLeadIds.delete(leadId);
                }
            });
            renderModalLeadsList();
        };
        
        // ‚úÖ Modal'ƒ± kapat
        window.closeLeadSelectionModal = function() {
            const modal = document.getElementById('leadSelectionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        // ‚úÖ Se√ßilen lead'leri onayla ve recipients'a ekle
        window.confirmLeadSelection = function() {
            // ‚úÖ Se√ßili lead'lerden recipients olu≈ütur
            updateRecipientsFromSelectedLeads();
            
            // ‚úÖ Modal'ƒ± kapat
            closeLeadSelectionModal();
            
            // ‚úÖ Ba≈üarƒ± mesajƒ±
            console.log('‚úÖ Se√ßilen lead\'ler recipients listesine eklendi:', selectedLeadIds.size);
        };

        // Filter deƒüi≈ütir
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.type;
                renderRecipients();
            });
        });

        // Template'leri y√ºkle (normal UI'daki gibi - quick-replies, whatsapp-templates, cloudapi-templates)
        async function loadTemplates() {
            const apiKey = localStorage.getItem('sleekflowApiKey');
            const baseUrl = localStorage.getItem('sleekflowBaseUrl') || '';
            const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
            const channelNumber = localStorage.getItem('selectedChannelNumber') || '908505327532';
            
            console.log('üìã Template\'ler y√ºkleniyor...', { 
                hasApiKey: !!apiKey, 
                baseUrl: safeBaseUrl, 
                channelNumber 
            });
            
            if (!apiKey) {
                console.warn('‚ö†Ô∏è API key bulunamadƒ±, template\'ler y√ºklenemiyor');
                const templateSelect = document.getElementById('whatsappTemplates');
                if (templateSelect) {
                    templateSelect.innerHTML = '<option value="">SleekFlow baƒülantƒ±sƒ± yok</option>';
                }
                return;
            }
            
            try {
                // ‚úÖ Normal UI'daki gibi 3 farklƒ± template kaynaƒüƒ±ndan √ßek
                const quickRepliesUrl = `/api/sleekflow/quick-replies?apiKey=${encodeURIComponent(apiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                const whatsappTemplatesUrl = `/api/sleekflow/whatsapp-templates?apiKey=${encodeURIComponent(apiKey)}&limit=100&offset=0${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`;
                const cloudApiTemplatesUrl = `/api/sleekflow/cloudapi-templates?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}&channelNumber=${encodeURIComponent(channelNumber)}`;
                
                console.log('üì° 3 template API √ßaƒürƒ±sƒ± yapƒ±lƒ±yor:', {
                    quickRepliesUrl,
                    whatsappTemplatesUrl,
                    cloudApiTemplatesUrl
                });
                
                // ‚úÖ Paralel olarak hepsini √ßek (Promise.allSettled - biri ba≈üarƒ±sƒ±z olsa bile diƒüerleri √ßalƒ±≈üƒ±r)
                const responses = await Promise.allSettled([
                    fetch(quickRepliesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } }),
                    fetch(whatsappTemplatesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } }),
                    fetch(cloudApiTemplatesUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                ]);
                
                let allTemplates = [];
                
                // ‚úÖ Quick-replies'larƒ± i≈üle
                const quickRepliesResponse = responses[0];
                if (quickRepliesResponse.status === 'fulfilled' && quickRepliesResponse.value.ok) {
                    try {
                        const quickRepliesData = await quickRepliesResponse.value.json();
                        const quickReplies = quickRepliesData.templates || [];
                        if (quickReplies.length > 0) {
                            allTemplates = allTemplates.concat(quickReplies);
                            console.log('‚úÖ Quick-replies y√ºklendi:', quickReplies.length);
                        }
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è Quick-replies parse hatasƒ±:', parseError);
                    }
                } else if (quickRepliesResponse.status === 'fulfilled') {
                    try {
                        const errorData = await quickRepliesResponse.value.json().catch(() => ({}));
                        console.warn('‚ö†Ô∏è Quick-replies API hatasƒ±:', errorData.error || 'Bilinmeyen hata', quickRepliesResponse.value.status);
                    } catch (e) {}
                } else {
                    console.warn('‚ö†Ô∏è Quick-replies y√ºklenemedi:', quickRepliesResponse.reason);
                }
                
                // ‚úÖ WhatsApp templates'larƒ± i≈üle
                const whatsappTemplatesResponse = responses[1];
                if (whatsappTemplatesResponse.status === 'fulfilled' && whatsappTemplatesResponse.value.ok) {
                    try {
                        const whatsappData = await whatsappTemplatesResponse.value.json();
                        const whatsappTemplates = whatsappData.templates || whatsappData.whatsappTemplates || [];
                        if (whatsappTemplates.length > 0) {
                            allTemplates = allTemplates.concat(whatsappTemplates);
                            console.log('‚úÖ WhatsApp templates y√ºklendi:', whatsappTemplates.length);
                        }
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è WhatsApp templates parse hatasƒ±:', parseError);
                    }
                } else if (whatsappTemplatesResponse.status === 'fulfilled') {
                    try {
                        const errorData = await whatsappTemplatesResponse.value.json().catch(() => ({}));
                        console.warn('‚ö†Ô∏è WhatsApp templates API hatasƒ±:', errorData.error || 'Bilinmeyen hata', whatsappTemplatesResponse.value.status);
                    } catch (e) {}
                } else {
                    console.warn('‚ö†Ô∏è WhatsApp templates y√ºklenemedi:', whatsappTemplatesResponse.reason);
                }
                
                // ‚úÖ Cloud API templates'larƒ± i≈üle
                const cloudApiTemplatesResponse = responses[2];
                if (cloudApiTemplatesResponse.status === 'fulfilled' && cloudApiTemplatesResponse.value.ok) {
                    try {
                        const cloudApiData = await cloudApiTemplatesResponse.value.json();
                        const cloudTemplates = cloudApiData.templates || cloudApiData.whatsappTemplates || [];
                        if (cloudTemplates.length > 0) {
                            allTemplates = allTemplates.concat(cloudTemplates);
                            console.log('‚úÖ Cloud API templates y√ºklendi:', cloudTemplates.length);
                        }
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è Cloud API templates parse hatasƒ±:', parseError);
                    }
                } else if (cloudApiTemplatesResponse.status === 'fulfilled') {
                    try {
                        const errorData = await cloudApiTemplatesResponse.value.json().catch(() => ({}));
                        console.warn('‚ö†Ô∏è Cloud API templates API hatasƒ±:', errorData.error || 'Bilinmeyen hata', cloudApiTemplatesResponse.value.status);
                    } catch (e) {}
                } else {
                    console.warn('‚ö†Ô∏è Cloud API templates y√ºklenemedi:', cloudApiTemplatesResponse.reason);
                }
                
                // ‚úÖ Template'leri order'a g√∂re sƒ±rala (Cloud API √∂nce, sonra WhatsApp, sonra quick-reply)
                allTemplates.sort((a, b) => {
                    const typePriority = (t) => {
                        if (t.type === 'cloudapi') return 0;
                        if (t.type === 'whatsapp') return 1;
                        return 2; // quick-reply
                    };
                    const pa = typePriority(a);
                    const pb = typePriority(b);
                    if (pa !== pb) return pa - pb;
                    return (a.order || 0) - (b.order || 0);
                });
                
                // ‚úÖ Cache'e kaydet (template se√ßildiƒüinde i√ßeriƒüi hƒ±zlƒ±ca almak i√ßin)
                window.cachedTemplates = allTemplates;
                
                console.log('‚úÖ Toplam template y√ºklendi:', allTemplates.length, {
                    quickReplies: allTemplates.filter(t => t.type === 'quick-reply').length,
                    whatsapp: allTemplates.filter(t => t.type === 'whatsapp').length,
                    cloudapi: allTemplates.filter(t => t.type === 'cloudapi').length
                });
                
                // ‚úÖ Template'leri render et (modal i√ßinde)
                renderTemplates(allTemplates);
            } catch (error) {
                console.error('‚ùå Template\'ler y√ºklenemedi (genel hata):', error);
                const templateSelect = document.getElementById('whatsappTemplates');
                if (templateSelect) {
                    templateSelect.innerHTML = '<option value="">Template y√ºklenemedi</option>';
                }
            }
        }

        // ‚úÖ Templates modal fonksiyonlarƒ±
        function setupTemplatesModal() {
            const openTemplatesBtn = document.getElementById('openTemplates');
            const closeTemplatesModal = document.getElementById('closeTemplatesModal');
            const templatesModal = document.getElementById('templatesModal');
            const templateSearch = document.getElementById('templateSearch');
            
            // Templates butonuna tƒ±klandƒ±ƒüƒ±nda modal'ƒ± a√ß
            if (openTemplatesBtn) {
                openTemplatesBtn.onclick = function() {
                    if (templatesModal) {
                        templatesModal.style.display = 'block';
                        loadTemplates();
                    } else {
                        console.error('‚ùå templatesModal bulunamadƒ±!');
                    }
                };
            }
            
            // Modal'ƒ± kapat
            if (closeTemplatesModal) {
                closeTemplatesModal.onclick = function() {
                    if (templatesModal) {
                        templatesModal.style.display = 'none';
                    }
                };
            }
            
            // Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
            if (templatesModal) {
                templatesModal.onclick = function(e) {
                    if (e.target === templatesModal) {
                        templatesModal.style.display = 'none';
                    }
                };
            }
            
            // Template arama
            if (templateSearch) {
                templateSearch.oninput = function(e) {
                    filterTemplates(e.target.value);
                };
            }
        }

        // ‚úÖ Template render fonksiyonu
        function renderTemplates(templates) {
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) {
                console.error('‚ùå templatesList bulunamadƒ±!');
                return;
            }
            
            if (templates.length === 0) {
                templatesList.innerHTML = '<div style="padding: 20px; text-align: center;">Template bulunamadƒ±</div>';
                return;
            }
            
            // ‚úÖ Templates'ƒ± global deƒüi≈ükende sakla
            window.templatesData = templates;
            
            templatesList.innerHTML = templates.map(template => {
                // ‚úÖ Content'i escape et (HTML injection √∂nleme)
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const templateName = escapeHtml(template.name || 'Unnamed Template');
                const templateContent = escapeHtml(template.content || '');
                const templateId = escapeHtml((template.id || template.name || '').toString());
                
                // ‚úÖ Template tipine g√∂re badge g√∂ster
                const templateType = template.type || 'quick-reply';
                const typeBadge = templateType === 'cloudapi'
                    ? '<span style="display: inline-block; background: #128C7E; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Cloud API</span>'
                    : templateType === 'whatsapp'
                        ? '<span style="display: inline-block; background: #25D366; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">WhatsApp</span>'
                        : '<span style="display: inline-block; background: #6366f1; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Quick Reply</span>';
                
                return `
                    <div class="template-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; cursor: pointer; transition: box-shadow 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'"
                         onclick="selectTemplate('${templateId}')">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111; flex: 1;">${templateName}</h3>
                            ${typeBadge}
                        </div>
                        <p style="margin: 0; font-size: 14px; color: #666; line-height: 1.5; max-height: 100px; overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; word-wrap: break-word;">${templateContent}</p>
                    </div>
                `;
            }).join('');
        }
        
        // ‚úÖ Template filtreleme
        function filterTemplates(searchTerm) {
            const templateCards = document.querySelectorAll('.template-card');
            const term = searchTerm.toLowerCase();
            
            templateCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }
        
        // ‚úÖ Se√ßili template'i sakla
        let selectedTemplate = null;
        let selectedTemplateVariables = null;
        
        // ‚úÖ Template se√ßme fonksiyonu - Parametre desteƒüi ile
        window.selectTemplate = function(templateId) {
            const templatesModal = document.getElementById('templatesModal');
            const messageInput = document.getElementById('messageInput');
            
            // Template'i bul
            let template = window.templatesData ? window.templatesData.find(t => (t.id || t.name || '').toString() === templateId) : null;
            if (!template && window.cachedTemplates) {
                template = window.cachedTemplates.find(t => (t.id || t.name || '').toString() === templateId);
            }
            
            if (!template) {
                console.error('Template bulunamadƒ±:', templateId);
                return;
            }
            
            // ‚úÖ Template i√ßinde deƒüi≈üken alanlar var mƒ± kontrol et ({{1}}, {{2}}, vb.)
            const templateContent = template.content || '';
            const variablePattern = /\{\{(\d+)\}\}/g;
            const variables = [];
            let match;
            
            while ((match = variablePattern.exec(templateContent)) !== null) {
                const varNum = parseInt(match[1]);
                if (!variables.includes(varNum)) {
                    variables.push(varNum);
                }
            }
            
            // ‚úÖ Eƒüer deƒüi≈üken alanlar varsa parametre modal'ƒ±nƒ± a√ß
            if (variables.length > 0) {
                selectedTemplate = template;
                selectedTemplateVariables = variables.sort((a, b) => a - b);
                showTemplateParametersModal(template, variables.sort((a, b) => a - b));
                return;
            }
            
            // ‚úÖ Deƒüi≈üken yoksa normal ≈üekilde mesaj input'una ekle
            selectedTemplate = template;
            
            // Modal'ƒ± kapat
            if (templatesModal) {
                templatesModal.style.display = 'none';
            }
            
            // Mesaj alanƒ±na template i√ßeriƒüini yaz
            if (messageInput && template.content) {
                messageInput.value = template.content;
                console.log('‚úÖ Template se√ßildi:', template.name, template);
            }
        };
        
        // ‚úÖ Template parametre modalƒ±nƒ± g√∂ster
        function showTemplateParametersModal(template, variables) {
            const modal = document.getElementById('templateParametersModal');
            const content = document.getElementById('templateParametersContent');
            
            if (!modal || !content) {
                console.error('Template parametre modal elementi bulunamadƒ±');
                return;
            }
            
            // ‚úÖ Parametre input'larƒ±nƒ± olu≈ütur - SADECE TEXT VE URL
            let html = '<p style="margin-bottom: 16px; color: #666;">L√ºtfen template parametrelerini doldurun:</p>';
            
            // ‚úÖ Mesaj preview alanƒ±
            html += `
                <div id="templateMessagePreview" style="margin-bottom: 20px; padding: 16px; border: 2px solid #6366f1; border-radius: 8px; background: #f0f4ff;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #6366f1;">üìã Mesaj √ñnizleme:</label>
                    <div id="templatePreviewContent" style="padding: 12px; background: white; border-radius: 6px; min-height: 50px; white-space: pre-wrap; word-wrap: break-word; color: #333; font-size: 14px; line-height: 1.5;">
                        ${template.content || ''}
                    </div>
                </div>
            `;
            
            variables.forEach((varNum, index) => {
                html += `
                    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Parametre {{${varNum}}}</label>
                        
                        <!-- Parametre tipi se√ßimi - SADECE TEXT VE URL -->
                        <select 
                            id="templateParamType_${varNum}" 
                            class="template-param-type"
                            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; font-size: 14px;"
                            onchange="updateTemplateParamInput(${varNum}); updateTemplatePreview();"
                        >
                            <option value="text">üìù Metin</option>
                            <option value="url">üîó Link (URL)</option>
                        </select>
                        
                        <!-- Text input -->
                        <input 
                            type="text" 
                            id="templateParam_${varNum}" 
                            class="template-param-input template-param-text" 
                            placeholder="Deƒüer girin..."
                            style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; display: block;"
                            oninput="updateTemplatePreview();"
                        >
                    </div>
                `;
            });
            
            content.innerHTML = html;
            modal.style.display = 'block';
            
            // ‚úÖ ƒ∞lk input'a focus
            const firstInput = document.getElementById(`templateParam_${variables[0]}`);
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
            
            // ‚úÖ Preview'ƒ± ba≈ülat
            updateTemplatePreview();
        }
        
        // ‚úÖ Parametre tipi deƒüi≈ütiƒüinde input'u g√ºncelle - SADECE TEXT VE URL
        window.updateTemplateParamInput = function(varNum) {
            const typeSelect = document.getElementById(`templateParamType_${varNum}`);
            const textInput = document.getElementById(`templateParam_${varNum}`);
            
            if (!typeSelect || !textInput) return;
            
            const paramType = typeSelect.value;
            
            if (paramType === 'text') {
                textInput.type = 'text';
                textInput.placeholder = 'Deƒüer girin...';
            } else if (paramType === 'url') {
                textInput.type = 'url';
                textInput.placeholder = 'https://example.com';
            }
            
            // ‚úÖ Preview'ƒ± g√ºncelle
            updateTemplatePreview();
        };
        
        // ‚úÖ Template mesaj preview'ƒ±nƒ± g√ºncelle
        window.updateTemplatePreview = function() {
            if (!selectedTemplate || !selectedTemplateVariables) return;
            
            const template = selectedTemplate;
            const variables = selectedTemplateVariables;
            const previewContent = document.getElementById('templatePreviewContent');
            
            if (!previewContent) return;
            
            // ‚úÖ Template i√ßeriƒüini al
            let previewText = template.content || '';
            
            // ‚úÖ Parametreleri yerle≈ütir
            variables.forEach(varNum => {
                const textInput = document.getElementById(`templateParam_${varNum}`);
                if (textInput) {
                    const value = textInput.value.trim() || `{{${varNum}}}`;
                    previewText = previewText.replace(new RegExp(`\\{\\{${varNum}\\}\\}`, 'g'), value);
                }
            });
            
            // ‚úÖ Preview'ƒ± g√ºncelle
            previewContent.textContent = previewText;
        };
        
        // ‚úÖ Template parametre modalƒ±nƒ± kapat
        function closeTemplateParametersModal() {
            const modal = document.getElementById('templateParametersModal');
            if (modal) {
                modal.style.display = 'none';
            }
            selectedTemplate = null;
            selectedTemplateVariables = null;
        }
        
        // ‚úÖ Template parametreleriyle bulk mesaj g√∂nder
        window.sendBulkMessageWithTemplateParams = async function() {
            if (!selectedTemplate || !selectedTemplateVariables) {
                alert('Template veya parametreler bulunamadƒ±');
                return;
            }
            
            const template = selectedTemplate;
            const variables = selectedTemplateVariables;
            
            // ‚úÖ Parametreleri topla - SADECE TEXT VE URL
            const params = {};
            const paramTypes = {};
            let allFilled = true;
            
            variables.forEach(varNum => {
                const typeSelect = document.getElementById(`templateParamType_${varNum}`);
                const textInput = document.getElementById(`templateParam_${varNum}`);
                
                if (!typeSelect || !textInput) {
                    allFilled = false;
                    return;
                }
                
                const paramType = typeSelect.value;
                paramTypes[varNum] = paramType;
                
                const value = textInput.value.trim();
                if (value) {
                    params[varNum] = value;
                } else {
                    allFilled = false;
                }
            });
            
            if (!allFilled) {
                alert('L√ºtfen t√ºm parametreleri doldurun!');
                return;
            }
            
            // ‚úÖ Template i√ßeriƒüini parametrelerle doldur
            let messageContent = template.content || '';
            variables.forEach(varNum => {
                const value = params[varNum] || '';
                messageContent = messageContent.replace(new RegExp(`\\{\\{${varNum}\\}\\}`, 'g'), value);
            });
            
            // ‚úÖ Modal'ƒ± kapat
            closeTemplateParametersModal();
            
            // ‚úÖ Mesaj input'una yaz
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = messageContent;
            }
            
            // ‚úÖ Bulk mesaj g√∂nder
            await sendBulkMessage();
        };

        // Toplu mesaj g√∂nder
        // ‚úÖ Conversation ID bulma fonksiyonu (telefon numarasƒ±ndan)
        async function findConversationByPhone(phone, apiKey, baseUrl) {
            try {
                const cleanPhone = phone.replace(/\D/g, '');
                const response = await fetch(`/api/sleekflow/conversations?apiKey=${encodeURIComponent(apiKey)}${baseUrl ? '&baseUrl=' + encodeURIComponent(baseUrl) : ''}`);
                if (!response.ok) return null;
                
                const data = await response.json();
                const conversations = data.conversations || [];
                
                // Telefon numarasƒ±na g√∂re conversation bul
                for (const conv of conversations) {
                    const convPhone = (conv.userProfile?.phone || conv.phone || '').replace(/\D/g, '');
                    if (convPhone === cleanPhone) {
                        return conv.id || conv.conversationId;
                    }
                }
                return null;
            } catch (error) {
                console.error('‚ùå Conversation bulunamadƒ±:', error);
                return null;
            }
        }

        async function sendBulkMessage() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) {
                showError('Mesaj input alanƒ± bulunamadƒ±');
                return;
            }
            
            const message = messageInput.value.trim();
            
            // Template bilgilerini al
            let templateId = null;
            let templateName = null;
            let templateLanguage = 'tr';
            
            if (selectedTemplate) {
                templateId = selectedTemplate.id || selectedTemplate.name;
                templateName = selectedTemplate.name || selectedTemplate.id;
                templateLanguage = selectedTemplate.language || selectedTemplate.lang || 'tr';
                console.log('‚úÖ‚úÖ‚úÖ Template se√ßilmi≈ü:', { templateId, templateName, templateLanguage, selectedTemplate });
            } else {
                console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Template se√ßilmemi≈ü! selectedTemplate:', selectedTemplate);
            }
            
            if (!message && !templateName) {
                showError('L√ºtfen mesaj yazƒ±n veya template se√ßin');
                return;
            }
            
            if (recipients.length === 0) {
                showError('En az bir alƒ±cƒ± se√ßmelisiniz');
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            const loading = document.getElementById('loading');
            
            if (!sendBtn || !loading) {
                showError('G√∂nder butonu veya loading elementi bulunamadƒ±');
                return;
            }
            
            sendBtn.disabled = true;
            loading.classList.add('active');
            hideError();
            hideSuccess();
            
            try {
                const apiKey = localStorage.getItem('sleekflowApiKey');
                const baseUrl = localStorage.getItem('sleekflowBaseUrl') || 'https://api.sleekflow.io';
                const safeBaseUrl = (baseUrl && baseUrl !== 'undefined' && baseUrl !== 'null') ? baseUrl : '';
                
                if (!apiKey || apiKey.trim().length < 10) {
                    throw new Error('SleekFlow baƒülantƒ±sƒ± yok. L√ºtfen √∂nce baƒülanƒ±n.');
                }
                
                console.log('üì§ Toplu mesaj g√∂nderiliyor...', {
                    recipientCount: recipients.length,
                    hasMessage: !!message,
                    hasTemplate: !!templateName
                });
                
                // ‚úÖ Her bir recipient i√ßin SIRAYLA mesaj g√∂nder (normal UI'daki gibi)
                // ‚úÖ √ñNEMLƒ∞: Sƒ±rayla g√∂nder, aynƒ± anda g√∂nderme (rate limiting i√ßin)
                const results = [];
                const errors = [];
                
                // ‚úÖ Sƒ±rayla g√∂nder - her mesaj arasƒ±nda bekle (NORMAL UI MANTIƒûI)
                for (let i = 0; i < recipients.length; i++) {
                    const recipient = recipients[i];
                    const phone = recipient.phone.replace(/\D/g, '');
                    if (!phone) continue;
                    
                    try {
                        // ‚úÖ NORMAL UI MANTIƒûI: Conversation ID bul (yoksa telefon numarasƒ± kullanƒ±lacak)
                        let conversationId = await findConversationByPhone(phone, apiKey, safeBaseUrl);
                        
                        // ‚úÖ Conversation ID yoksa telefon numarasƒ±nƒ± kullan (backend telefon numarasƒ±ndan conversation bulacak)
                        const conversationIdOrPhone = conversationId || phone;
                        
                        // ‚úÖ NORMAL UI MANTIƒûI: Template varsa i√ßeriƒüi text olarak kullan (normal UI'daki gibi)
                        // ‚úÖ Normal UI'da template se√ßildiƒüinde i√ßerik mesaj input'una yazƒ±lƒ±yor ve normal mesaj gibi g√∂nderiliyor
                        // ‚úÖ Template i√ßeriƒüi text olarak g√∂nderiliyor, template bilgileri payload'a eklenmiyor (normal UI'daki gibi)
                        let textToSend = message || '';
                        if (templateName && selectedTemplate && selectedTemplate.content) {
                            // Template i√ßeriƒüini text olarak kullan (normal UI'daki gibi)
                            textToSend = selectedTemplate.content || textToSend;
                        }
                        
                        // ‚úÖ HAMZAH DESTEƒûƒ∞: Se√ßili sender numarasƒ±nƒ± fromPhone olarak ekle
                        const senderSelect = document.getElementById('senderSelect');
                        const selectedSenderPhone = senderSelect && senderSelect.value ? senderSelect.value : '';
                        
                        // ‚úÖ NORMAL UI PAYLOAD: Sadece text, apiKey, baseUrl g√∂nder (TAM OLARAK NORMAL UI Gƒ∞Bƒ∞)
                        // ‚úÖ HAMZAH DESTEƒûƒ∞: fromPhone ekle (VIP veya Hamzah i√ßin)
                        // ‚úÖ NOT: Normal UI'da template bilgileri payload'a eklenmiyor, sadece text g√∂nderiliyor
                        // ‚úÖ BULK MESAJ FLAG: Backend'e bulk mesaj olduƒüunu bildir (FROM sabit numara i√ßin)
                        const messagePayload = {
                            text: textToSend || undefined,
                            apiKey,
                            baseUrl: safeBaseUrl,
                            isBulkMessage: true, // ‚úÖ Bulk mesaj flag'i
                            fromPhone: selectedSenderPhone || undefined // ‚úÖ HAMZAH DESTEƒûƒ∞: Se√ßili sender numarasƒ±
                        };
                        
                        console.log(`üì§ [${i + 1}/${recipients.length}] ${phone} i√ßin mesaj g√∂nderiliyor (NORMAL UI MANTIƒûI - TAM OLARAK AYNI)...`, {
                            conversationIdOrPhone,
                            text: textToSend ? textToSend.substring(0, 50) : '',
                            hasTemplate: !!templateName
                        });
                        
                        // ‚úÖ NORMAL UI ENDPOINT: TAM OLARAK AYNI ENDPOINT (normal UI'daki gibi)
                        const response = await fetch(`/api/sleekflow/conversations/${conversationIdOrPhone}/messages?apiKey=${encodeURIComponent(apiKey)}${safeBaseUrl ? '&baseUrl=' + encodeURIComponent(safeBaseUrl) : ''}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(messagePayload)
                        });
                        
                        // ‚úÖ NORMAL UI RESPONSE KONTROL√ú: TAM OLARAK AYNI KONTROL (normal UI'daki gibi)
                        if (!response.ok) {
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = { error: `HTTP ${response.status}: Mesaj g√∂nderilemedi` };
                            }
                            
                            const errorMsg = errorData?.error || errorData?.message || `HTTP ${response.status}: Mesaj g√∂nderilemedi`;
                            console.error(`‚ùå [${i + 1}/${recipients.length}] ${phone} i√ßin mesaj g√∂nderilemedi (HTTP ${response.status}):`, errorMsg, errorData);
                            errors.push({ phone, error: errorMsg });
                            await new Promise(resolve => setTimeout(resolve, 500));
                            continue;
                        }
                        
                        const result = await response.json();
                        
                        // ‚úÖ DETAYLI RESPONSE KONTROL√ú: Backend'den gelen response'u detaylƒ± kontrol et
                        console.log(`üîç [${i + 1}/${recipients.length}] ${phone} i√ßin backend response:`, result);
                        
                        // ‚úÖ NORMAL UI RESPONSE KONTROL√ú: TAM OLARAK AYNI KONTROL (normal UI'daki gibi)
                        if (!result || !result.success) {
                            const errorMsg = result?.error || result?.message || 'Mesaj g√∂nderilemedi';
                            console.error(`‚ùå [${i + 1}/${recipients.length}] ${phone} i√ßin mesaj g√∂nderilemedi (backend error):`, errorMsg, result);
                            errors.push({ phone, error: errorMsg });
                            await new Promise(resolve => setTimeout(resolve, 500));
                            continue;
                        }
                        
                        // ‚úÖ EK KONTROL: Backend'den success: true geldi ama SleekFlow API'den hata gelmi≈ü olabilir
                        // ‚úÖ Backend'de zaten kontrol yapƒ±lƒ±yor ama ekstra g√ºvenlik i√ßin
                        if (result.data && typeof result.data === 'object') {
                            const data = result.data;
                            // ‚úÖ Array kontrol√º
                            if (Array.isArray(data) && data.length > 0) {
                                const firstItem = data[0];
                                if (firstItem.error || firstItem.status === 'Failed' || firstItem.status === 'failed') {
                                    const errorMsg = firstItem.error || firstItem.channelStatusMessage || firstItem.message || 'SleekFlow API mesajƒ± reddetti';
                                    console.error(`‚ùå [${i + 1}/${recipients.length}] ${phone} i√ßin SleekFlow API hatasƒ±:`, errorMsg, firstItem);
                                    errors.push({ phone, error: errorMsg });
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                    continue;
                                }
                            } else if (!Array.isArray(data)) {
                                // ‚úÖ Object kontrol√º
                                if (data.status === 'Failed' || data.status === 'failed' || data.error) {
                                    const errorMsg = data.channelStatusMessage || data.error || data.message || 'SleekFlow API mesajƒ± reddetti';
                                    console.error(`‚ùå [${i + 1}/${recipients.length}] ${phone} i√ßin SleekFlow API hatasƒ±:`, errorMsg, data);
                                    errors.push({ phone, error: errorMsg });
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                    continue;
                                }
                            }
                        }
                        
                        console.log(`‚úÖ [${i + 1}/${recipients.length}] ${phone} i√ßin mesaj ba≈üarƒ±yla g√∂nderildi!`, result);
                        results.push({ phone, success: true, result: result });
                        
                        // ‚úÖ Rate limiting (500ms bekle - normal UI'daki gibi)
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`‚ùå [${i + 1}/${recipients.length}] ${phone} i√ßin mesaj g√∂nderme hatasƒ±:`, error);
                        errors.push({ phone, error: error.message || 'Bilinmeyen hata' });
                        // ‚úÖ Hata olsa bile bir sonraki mesajdan √∂nce bekle
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // ‚úÖ Sonu√ßlarƒ± g√∂ster
                const successCount = results.length;
                const errorCount = errors.length;
                
                let errorDetails = '';
                if (errors.length > 0) {
                    errorDetails = '\n\n‚ùå Hatalar:\n';
                    errors.forEach((err, index) => {
                        errorDetails += `${index + 1}. ${err.phone}: ${err.error}\n`;
                    });
                }
                
                if (successCount > 0) {
                    showSuccess(`‚úÖ ${successCount} mesaj ba≈üarƒ±yla g√∂nderildi! ${errorCount > 0 ? `(${errorCount} hata)` : ''}${errorDetails}`);
                } else {
                    showError(`‚ùå Hi√ß mesaj g√∂nderilemedi! (${errorCount} hata)${errorDetails}`);
                }
                
                messageInput.value = '';
                selectedTemplate = null; // Template se√ßimini temizle
                
            } catch (error) {
                console.error('‚ùå Toplu mesaj g√∂nderme hatasƒ±:', error);
                showError('Hata: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        // Helper functions
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.add('show');
        }

        function hideSuccess() {
            document.getElementById('successMessage').classList.remove('show');
        }

        // ‚úÖ √ñNCE: Se√ßili lead'lerin telefon numaralarƒ±nƒ± √ßek (Zoho CRM'den se√ßili lead'ler varsa)
        async function loadSelectedLeadsPhones() {
            console.log('üîçüîçüîç Se√ßili lead\'lerin telefon numaralarƒ± √ßekiliyor...');
            
            // ‚úÖ 1. ADIM: Zoho CRM'den se√ßili lead ID'lerini al (retry ile)
            let selectedLeadIdsFromZoho = [];
            let retryCount = 0;
            const maxRetries = 10;
            
            while (retryCount < maxRetries && (!selectedLeadIdsFromZoho || selectedLeadIdsFromZoho.length === 0)) {
                selectedLeadIdsFromZoho = await getSelectedLeadsFromZoho();
                
                if (selectedLeadIdsFromZoho && selectedLeadIdsFromZoho.length > 0) {
                    console.log('‚úÖ‚úÖ‚úÖ Se√ßili lead ID\'leri bulundu:', selectedLeadIdsFromZoho);
                    break;
                } else {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.log(`‚ÑπÔ∏è Se√ßili lead bulunamadƒ±, ${retryCount + 1}. deneme yapƒ±lƒ±yor... (${retryCount}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }
            
            // ‚úÖ 2. ADIM: Eƒüer se√ßili lead'ler varsa, SADECE ONLARIN TELEFON NUMARALARINI √ßek
            if (selectedLeadIdsFromZoho && selectedLeadIdsFromZoho.length > 0) {
                console.log('‚úÖ‚úÖ‚úÖ Se√ßili lead\'lerin telefon numaralarƒ± √ßekiliyor...', selectedLeadIdsFromZoho);
                
                try {
                    const baseUrl = getBaseUrl();
                    const leadIdsParam = selectedLeadIdsFromZoho.join(',');
                    const response = await fetch(`${baseUrl}/api/zoho/selected-leads?leadIds=${leadIdsParam}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ‚úÖ‚úÖ Se√ßili lead\'lerin telefon numaralarƒ± √ßekildi:', data);
                    
                    if (data.success && data.leads && data.leads.length > 0) {
                        // ‚úÖ Sadece telefon numarasƒ± olan lead'leri filtrele
                        const leadsWithPhones = data.leads.filter(lead => {
                            const phone = lead.Phone || lead.Mobile || lead.Secondary_Phone || 
                                        lead.phone || lead.mobile || lead.secondary_phone;
                            return phone && phone.trim().length > 0;
                        });
                        
                        console.log('‚úÖ‚úÖ‚úÖ Telefon numarasƒ± olan lead\'ler:', leadsWithPhones.length);
                        
                        // ‚úÖ Se√ßili lead ID'lerini Set'e ekle
                        selectedLeadIdsFromZoho.forEach(id => {
                            selectedLeadIds.add(id);
                            console.log('‚úÖ Lead ID Set\'e eklendi:', id);
                        });
                        
                        // ‚úÖ Recipients olu≈ütur (SADECE TELEFON NUMARALARI)
                        buildRecipients(leadsWithPhones);
                        
                        // ‚úÖ "Lead Se√ßimi" b√∂l√ºm√ºn√º gizle (se√ßili lead'ler otomatik geldi)
                        const leadSelectionSection = document.querySelector('.section');
                        if (leadSelectionSection && leadSelectionSection.querySelector('#leadSearch')) {
                            leadSelectionSection.style.display = 'none';
                            console.log('‚úÖ Lead se√ßimi b√∂l√ºm√º gizlendi (Zoho CRM\'den se√ßili lead\'ler kullanƒ±lƒ±yor)');
                        }
                        
                        // ‚úÖ Recipients render et
                        renderRecipients();
                        
                        return true; // ‚úÖ Se√ßili lead'ler bulundu ve telefon numaralarƒ± √ßekildi
                    } else {
                        console.warn('‚ö†Ô∏è Se√ßili lead\'ler √ßekilemedi, t√ºm lead\'ler y√ºklenecek');
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Se√ßili lead\'lerin telefon numaralarƒ± √ßekilemedi:', error);
                    return false; // Hata olsa bile devam et, t√ºm lead'leri y√ºkle
                }
            } else {
                console.log('‚ÑπÔ∏è Zoho CRM\'de se√ßili lead bulunamadƒ±, t√ºm lead\'ler y√ºklenecek');
                return false;
            }
        }

        // ‚úÖ T√ºm lead'leri √ßek ve g√∂ster
        let allLeads = [];
        let selectedLeadIds = new Set();

        // ‚úÖ Lead ID'yi normalize et (Zoho farklƒ± alan adlarƒ± kullanabilir)
        function getLeadId(lead) {
            return (lead?.id || lead?.Id || lead?.ID || lead?.recordId || lead?.record_id || '').toString();
        }
        
        async function loadAllLeads() {
            const leadsList = document.getElementById('leadsList');
            const searchTerm = document.getElementById('leadSearch')?.value || '';
            
            if (leadsList) {
                leadsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Lead\'ler y√ºkleniyor...</div>';
            }
            
            try {
                const url = `/api/zoho/all-leads?perPage=200${searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''}`;
                console.log('üìû T√ºm lead\'ler √ßekiliyor...', { url, searchTerm });
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Lead\'ler √ßekilemedi (HTTP error):', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData
                    });
                    
                    // ‚úÖ 401 hatasƒ± i√ßin √∂zel mesaj
                    if (response.status === 401) {
                        const errorMsg = 'Zoho CRM baƒülantƒ±sƒ± yok veya ge√ßersiz. L√ºtfen Render.com\'da Zoho API credentials (ZOHO_CLIENT_ID, ZOHO_CLIENT_SECRET, ZOHO_ORG_ID) kontrol edin.';
                        if (leadsList) {
                            leadsList.innerHTML = `<div style="text-align: center; padding: 20px; color: red;">
                                <strong>‚ùå Zoho CRM Baƒülantƒ± Hatasƒ±</strong><br>
                                <p>HTTP 401 - Authentication Failed</p>
                                <p style="font-size: 12px; margin-top: 8px;">Render.com'da environment variables kontrol edin:<br>
                                ZOHO_CLIENT_ID<br>
                                ZOHO_CLIENT_SECRET<br>
                                ZOHO_ORG_ID</p>
                            </div>`;
                        }
                        showError(errorMsg);
                        throw new Error(errorMsg);
                    }
                    
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Lead\'ler √ßekildi:', { count: data.leads?.length || 0, data });
                
                allLeads = data.leads || [];
                renderLeadsList();
            } catch (error) {
                console.error('‚ùå Lead\'ler √ßekilemedi:', error);
                if (leadsList && !leadsList.innerHTML.includes('Zoho CRM Baƒülantƒ± Hatasƒ±')) {
                    leadsList.innerHTML = `<div style="text-align: center; padding: 20px; color: red;">Lead'ler y√ºklenemedi: ${error.message}</div>`;
                }
                if (!error.message.includes('Zoho CRM baƒülantƒ±sƒ±')) {
                    showError('Lead\'ler y√ºklenemedi: ' + error.message);
                }
            }
        }
        
        // ‚úÖ Lead listesini render et (checkbox'larla)
        function renderLeadsList() {
            const leadsList = document.getElementById('leadsList');
            if (!leadsList) {
                console.error('‚ùå leadsList bulunamadƒ±!');
                return;
            }
            
            if (allLeads.length === 0) {
                leadsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Lead bulunamadƒ±</div>';
                return;
            }
            
            leadsList.innerHTML = allLeads.map(lead => {
                const name = (lead.First_Name && lead.Last_Name) 
                    ? `${lead.First_Name} ${lead.Last_Name}` 
                    : (lead.First_Name || lead.Last_Name || lead.Full_Name || 'ƒ∞simsiz');
                
                const phone = lead.Phone || lead.phone || '';
                const mobile = lead.Mobile || lead.mobile || '';
                const secondaryPhone = lead.Secondary_Phone || lead.secondary_phone || lead.SecondaryPhone || '';
                const hasPhone = phone || mobile || secondaryPhone;

                const leadId = getLeadId(lead);
                const isSelected = selectedLeadIds.has(leadId);
                
                return `
                    <div class="lead-item" style="display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid ${isSelected ? '#667eea' : '#e0e0e0'}; ${isSelected ? 'background: #f0f4ff;' : ''}">
                        <input 
                            type="checkbox" 
                            class="lead-checkbox" 
                            data-lead-id="${leadId}"
                            ${isSelected ? 'checked' : ''}
                            onchange="toggleLeadSelection('${leadId}', this.checked)"
                            style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;"
                        >
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${name}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${phone ? `üìû ${phone}` : ''} ${mobile ? `üì± ${mobile}` : ''} ${secondaryPhone ? `üìû ${secondaryPhone}` : ''}
                                ${!hasPhone ? '<span style="color: #ef4444;">‚ö†Ô∏è Telefon yok</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateRecipientsFromSelectedLeads();
        }
        
        // ‚úÖ Lead se√ßimi toggle
        window.toggleLeadSelection = function(leadId, isSelected) {
            if (isSelected) {
                selectedLeadIds.add(leadId);
            } else {
                selectedLeadIds.delete(leadId);
            }
            console.log('‚úÖ Lead se√ßimi deƒüi≈üti:', { leadId, isSelected, totalSelected: selectedLeadIds.size });
            updateRecipientsFromSelectedLeads();
        };
        
        // ‚úÖ Se√ßili lead'lerden recipients olu≈ütur
        function updateRecipientsFromSelectedLeads() {
            const selectedLeads = allLeads.filter(lead => selectedLeadIds.has(getLeadId(lead)));
            const selectedCountEl = document.getElementById('selectedLeadCount');
            if (selectedCountEl) {
                selectedCountEl.textContent = selectedLeads.length;
            }
            
            console.log('üìã Se√ßili lead\'ler:', { count: selectedLeads.length, leads: selectedLeads });
            
            if (selectedLeads.length > 0) {
                buildRecipients(selectedLeads);
            } else {
                recipients = [];
                allRecipients = [];
                renderRecipients();
            }
        }
        
        // ‚úÖ T√ºm√ºn√º se√ß / Se√ßimi temizle
        window.selectAllLeads = function() {
            allLeads.forEach(lead => {
                const leadId = getLeadId(lead);
                if (leadId) {
                    selectedLeadIds.add(leadId);
                }
            });
            console.log('‚úÖ T√ºm lead\'ler se√ßildi:', selectedLeadIds.size);
            renderLeadsList();
        };
        
        window.deselectAllLeads = function() {
            selectedLeadIds.clear();
            console.log('‚úÖ T√ºm se√ßimler temizlendi');
            renderLeadsList();
        };
        
        // ‚úÖ Lead arama
        const leadSearchInput = document.getElementById('leadSearch');
        if (leadSearchInput) {
            leadSearchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim();
                clearTimeout(window.searchTimeout);
                window.searchTimeout = setTimeout(() => {
                    loadAllLeads();
                }, 500); // 500ms debounce
            });
        }

        // ‚úÖ Zoho CRM'den se√ßili lead'lerin TELEFON NUMARALARINI direkt al (ID'ye gerek yok!)
        async function getSelectedLeadsPhonesFromZoho() {
            try {
                // ‚úÖ SDK'nƒ±n y√ºklenmesini bekle
                let retryCount = 0;
                const maxRetries = 10;
                
                while (typeof ZOHO === 'undefined' && retryCount < maxRetries) {
                    console.log(`‚è≥ Zoho SDK y√ºkleniyor... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    retryCount++;
                }
                
                if (typeof ZOHO === 'undefined') {
                    console.warn('‚ö†Ô∏è Zoho CRM API y√ºkl√º deƒüil');
                    return [];
                }
                
                // ‚úÖ embeddedApp'i ba≈ülat
                if (typeof ZOHO.embeddedApp !== 'undefined') {
                    try {
                        await ZOHO.embeddedApp.init();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (initError) {
                        console.warn('‚ö†Ô∏è Zoho embeddedApp ba≈ülatƒ±lamadƒ±:', initError);
                    }
                }
                
                // ‚úÖ getSelectedRecords() ile se√ßili lead'leri al (telefon numaralarƒ± dahil!)
                if (ZOHO.CRM && ZOHO.CRM.UI && typeof ZOHO.CRM.UI.getSelectedRecords === 'function') {
                    try {
                        console.log('üìû Se√ßili lead\'lerin telefon numaralarƒ± direkt alƒ±nƒ±yor...');
                        
                        let selectedRecords = await ZOHO.CRM.UI.getSelectedRecords();
                        if (!selectedRecords || (Array.isArray(selectedRecords) && selectedRecords.length === 0)) {
                            try {
                                selectedRecords = await ZOHO.CRM.UI.getSelectedRecords({ Entity: 'Leads' });
                            } catch (e) {}
                        }
                        if (!selectedRecords || (Array.isArray(selectedRecords) && selectedRecords.length === 0)) {
                            try {
                                selectedRecords = await ZOHO.CRM.UI.getSelectedRecords({ entity: 'Leads' });
                            } catch (e) {}
                        }
                        if (!selectedRecords || (Array.isArray(selectedRecords) && selectedRecords.length === 0)) {
                            try {
                                selectedRecords = await ZOHO.CRM.UI.getSelectedRecords({ module: 'Leads' });
                            } catch (e) {}
                        }
                        
                        console.log('‚úÖ‚úÖ‚úÖ getSelectedRecords() sonucu:', selectedRecords);
                        
                        if (selectedRecords) {
                            const recordsArray = Array.isArray(selectedRecords) ? selectedRecords : [selectedRecords];
                            
                            if (recordsArray.length > 0) {
                                // ‚úÖ Direkt telefon numaralarƒ±nƒ± √ßƒ±kar!
                                const leadsWithPhones = recordsArray
                                    .map(record => {
                                        const phone = record.Phone || record.phone || '';
                                        const mobile = record.Mobile || record.mobile || '';
                                        const secondaryPhone = record.Secondary_Phone || record.SecondaryPhone || record.secondary_phone || '';
                                        
                                        const firstName = record.First_Name || record.FirstName || record.first_name || '';
                                        const lastName = record.Last_Name || record.LastName || record.last_name || '';
                                        const fullName = record.Full_Name || record.FullName || record.full_name || 
                                                        (firstName && lastName ? `${firstName} ${lastName}` : firstName || lastName || 'ƒ∞simsiz');
                                        
                                        const leadId = record.id || record.Id || record.ID || record.recordId || record.record_id || '';
                                        
                                        return {
                                            id: leadId,
                                            name: fullName,
                                            Phone: phone,
                                            Mobile: mobile,
                                            Secondary_Phone: secondaryPhone,
                                            First_Name: firstName,
                                            Last_Name: lastName
                                        };
                                    })
                                    .filter(lead => {
                                        // ‚úÖ Sadece telefon numarasƒ± olan lead'leri al
                                        const hasPhone = (lead.Phone && lead.Phone.trim()) || 
                                                       (lead.Mobile && lead.Mobile.trim()) || 
                                                       (lead.Secondary_Phone && lead.Secondary_Phone.trim());
                                        return hasPhone;
                                    });
                                
                                console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Direkt telefon numaralarƒ± alƒ±ndƒ±:', leadsWithPhones.length, 'lead');
                                return leadsWithPhones;
                            }
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è getSelectedRecords() √ßalƒ±≈ümadƒ±:', error);
                    }
                }
                
                // ‚úÖ getPageInfo() ile de dene
                if (ZOHO.CRM && ZOHO.CRM.UI && typeof ZOHO.CRM.UI.getPageInfo === 'function') {
                    try {
                        const pageInfo = await ZOHO.CRM.UI.getPageInfo();
                        console.log('‚úÖ‚úÖ‚úÖ getPageInfo() sonucu:', pageInfo);
                        
                        if (pageInfo && pageInfo.selectedRecords && pageInfo.selectedRecords.length > 0) {
                            const leadsWithPhones = pageInfo.selectedRecords
                                .map(record => {
                                    const phone = record.Phone || record.phone || '';
                                    const mobile = record.Mobile || record.mobile || '';
                                    const secondaryPhone = record.Secondary_Phone || record.SecondaryPhone || record.secondary_phone || '';
                                    
                                    const firstName = record.First_Name || record.FirstName || record.first_name || '';
                                    const lastName = record.Last_Name || record.LastName || record.last_name || '';
                                    const fullName = record.Full_Name || record.FullName || record.full_name || 
                                                    (firstName && lastName ? `${firstName} ${lastName}` : firstName || lastName || 'ƒ∞simsiz');
                                    
                                    const leadId = record.id || record.Id || record.ID || record.recordId || record.record_id || '';
                                    
                                    return {
                                        id: leadId,
                                        name: fullName,
                                        Phone: phone,
                                        Mobile: mobile,
                                        Secondary_Phone: secondaryPhone,
                                        First_Name: firstName,
                                        Last_Name: lastName
                                    };
                                })
                                .filter(lead => {
                                    const hasPhone = (lead.Phone && lead.Phone.trim()) || 
                                                   (lead.Mobile && lead.Mobile.trim()) || 
                                                   (lead.Secondary_Phone && lead.Secondary_Phone.trim());
                                    return hasPhone;
                                });
                            
                            if (leadsWithPhones.length > 0) {
                                console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ getPageInfo() ile telefon numaralarƒ± alƒ±ndƒ±:', leadsWithPhones.length);
                                return leadsWithPhones;
                            }
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è getPageInfo() √ßalƒ±≈ümadƒ±:', error);
                    }
                }
                
                return [];
            } catch (error) {
                console.error('‚ùå Se√ßili lead telefon numaralarƒ± alƒ±namadƒ±:', error);
                return [];
            }
        }

        // ‚úÖ Zoho CRM'den se√ßili lead'leri al (JavaScript API ile) - ESKƒ∞ FONKSƒ∞YON (geriye uyumluluk i√ßin)
        async function getSelectedLeadsFromZoho() {
            try {
                if (pageLoadSelectedIds && pageLoadSelectedIds.length > 0) {
                    console.log('‚úÖ PageLoad ile alƒ±nan se√ßili lead ID\'leri kullanƒ±lƒ±yor:', pageLoadSelectedIds);
                    return pageLoadSelectedIds;
                }

                // ‚úÖ Y√∂ntem 0: URL parametrelerinden al (en g√ºvenilir - custom button'dan geliyorsa)
                const urlParams = new URLSearchParams(window.location.search);
                let leadIdsParam = urlParams.get('leadIds') || urlParams.get('recordIds') || urlParams.get('ids');
                
                console.log('üîçüîçüîç URL parametreleri kontrol ediliyor:', {
                    fullUrl: window.location.href,
                    search: window.location.search,
                    leadIds: leadIdsParam,
                    allParams: Object.fromEntries(urlParams.entries()),
                    hash: window.location.hash,
                    referrer: document.referrer
                });
                
                // ‚úÖ EKSTRA: Hash'ten de kontrol et (bazen Zoho CRM hash kullanƒ±r)
                if (window.location.hash) {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const hashLeadIds = hashParams.get('leadIds') || hashParams.get('recordIds') || hashParams.get('ids');
                    console.log('üîçüîçüîç Hash parametreleri:', {
                        hash: window.location.hash,
                        hashLeadIds: hashLeadIds
                    });
                    if (hashLeadIds && hashLeadIds !== '$recordIds' && !hashLeadIds.includes('$recordIds')) {
                        const ids = hashLeadIds.split(',').map(id => id.trim()).filter(id => id && id.length >= 10);
                        if (ids.length > 0) {
                            console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Hash\'ten alƒ±nan lead ID\'leri:', ids);
                            return ids;
                        }
                    }
                }
                
                // ‚úÖ Eƒüer $recordIds literal string'i varsa, Zoho CRM JavaScript API'den almayƒ± dene
                if (leadIdsParam === '$recordIds' || leadIdsParam?.includes('$recordIds')) {
                    console.log('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è URL\'de $recordIds literal string\'i var, Zoho CRM JavaScript API\'den alƒ±nacak');
                    leadIdsParam = null; // A≈üaƒüƒ±daki API √ßaƒürƒ±larƒ±na ge√ß
                } else if (leadIdsParam && leadIdsParam.trim() && leadIdsParam.trim() !== '$recordIds') {
                    const ids = leadIdsParam.split(',').map(id => id.trim()).filter(id => id && id.length >= 10);
                    if (ids.length > 0) {
                        console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ URL parametrelerinden alƒ±nan lead ID\'leri:', ids);
                        return ids;
                    } else {
                        console.warn('‚ö†Ô∏è URL\'den leadIdsParam var ama ge√ßerli ID yok:', leadIdsParam);
                        leadIdsParam = null; // JavaScript API'ye ge√ß
                    }
                } else {
                    console.warn('‚ö†Ô∏è URL\'de leadIdsParam yok veya bo≈ü:', leadIdsParam);
                    leadIdsParam = null; // JavaScript API'ye ge√ß
                }
                
                // ‚úÖ SDK'nƒ±n y√ºklenmesini bekle (sayfa y√ºklenirken SDK hen√ºz y√ºklenmemi≈ü olabilir)
                let retryCount = 0;
                const maxRetries = 10; // Daha fazla bekle
                
                while (typeof ZOHO === 'undefined' && retryCount < maxRetries) {
                    console.log(`‚è≥ Zoho SDK y√ºkleniyor... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 saniye bekle
                    retryCount++;
                }
                
                // Zoho CRM JavaScript API'si y√ºkl√º m√º kontrol et
                if (typeof ZOHO === 'undefined') {
                    console.warn('‚ö†Ô∏è Zoho CRM API y√ºkl√º deƒüil (sayfa ayrƒ± tab\'da a√ßƒ±lmƒ±≈ü olabilir)');
                    return null;
                }
                
                console.log('üìû Zoho CRM API\'den se√ßili lead\'ler alƒ±nƒ±yor...');
                console.log('üîç Zoho API durumu:', {
                    hasZOHO: typeof ZOHO !== 'undefined',
                    hasCRM: typeof ZOHO.CRM !== 'undefined',
                    hasUI: typeof ZOHO.CRM?.UI !== 'undefined',
                    hasEmbeddedApp: typeof ZOHO.embeddedApp !== 'undefined',
                    hasAPI: typeof ZOHO.CRM?.API !== 'undefined'
                });
                
                // ‚úÖ √ñnce embeddedApp'i ba≈ülat (eƒüer varsa)
                if (typeof ZOHO.embeddedApp !== 'undefined') {
                    try {
                        await ZOHO.embeddedApp.init();
                        console.log('‚úÖ Zoho embeddedApp ba≈ülatƒ±ldƒ±');
                        // Init'ten sonra biraz bekle
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (initError) {
                        console.warn('‚ö†Ô∏è Zoho embeddedApp ba≈ülatƒ±lamadƒ± (normal olabilir - sayfa widget i√ßinde deƒüil):', initError);
                    }
                }

                // ‚úÖ Y√∂ntem 0.5: getPageInfo() doƒürudan dene (getSelectedRecords olmasa bile √ßalƒ±≈üabilir)
                if (ZOHO.CRM && ZOHO.CRM.UI && typeof ZOHO.CRM.UI.getPageInfo === 'function') {
                    try {
                        const pageInfo = await ZOHO.CRM.UI.getPageInfo();
                        console.log('‚úÖ‚úÖ‚úÖ getPageInfo() sonucu:', pageInfo);
                        const candidates = [];
                        if (pageInfo?.selectedRecords) candidates.push(...pageInfo.selectedRecords);
                        if (pageInfo?.selectedRecordIds) candidates.push(...pageInfo.selectedRecordIds);
                        if (pageInfo?.recordIds) candidates.push(...pageInfo.recordIds);
                        if (pageInfo?.records) candidates.push(...pageInfo.records);
                        const pageInfoIds = candidates
                            .map(rec => rec?.id || rec?.Id || rec?.ID || rec?.recordId || rec?.record_id || rec)
                            .map(id => (id ? id.toString() : null))
                            .filter(id => id && id.length >= 10);
                        if (pageInfoIds.length > 0) {
                            console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ getPageInfo() ile alƒ±nan lead ID\'leri:', pageInfoIds);
                            return pageInfoIds;
                        }
                    } catch (pageInfoError) {
                        console.warn('‚ö†Ô∏è getPageInfo() √ßalƒ±≈ümadƒ±:', pageInfoError);
                    }
                }
                
                // ‚úÖ Y√ñNTEM 0: DOM'dan se√ßili checkbox'larƒ± kontrol et (EN HIZLI VE G√úVENƒ∞Lƒ∞R)
                // Zoho CRM'de se√ßili lead'ler checkbox'larla i≈üaretlenir, bunlarƒ± DOM'dan okuyabiliriz
                try {
                    console.log('üîçüîçüîç DOM\'dan se√ßili checkbox\'lar kontrol ediliyor...');
                    
                    // ‚úÖ √ñNCE: Parent window'dan (Zoho CRM sayfasƒ±ndan) se√ßili checkbox'larƒ± al
                    if (window.parent && window.parent !== window) {
                        try {
                            const parentDoc = window.parent.document;
                            if (parentDoc) {
                                // ‚úÖ T√ºm se√ßili checkbox'larƒ± bul
                                const selectedCheckboxes = parentDoc.querySelectorAll('input[type="checkbox"]:checked');
                                console.log('‚úÖ‚úÖ‚úÖ Parent window\'dan se√ßili checkbox\'lar:', selectedCheckboxes.length);
                                
                                if (selectedCheckboxes.length > 0) {
                                    const leadIds = [];
                                    selectedCheckboxes.forEach((checkbox, index) => {
                                        // ‚úÖ Y√∂ntem 1: Checkbox'un value attribute'u
                                        let leadId = checkbox.value;
                                        
                                        // ‚úÖ Y√∂ntem 2: Checkbox'un data attribute'larƒ±
                                        if (!leadId || leadId.length < 10) {
                                            leadId = checkbox.getAttribute('data-id') || 
                                                    checkbox.getAttribute('data-record-id') || 
                                                    checkbox.getAttribute('data-entity-id') ||
                                                    checkbox.getAttribute('id');
                                        }
                                        
                                        // ‚úÖ Y√∂ntem 3: Checkbox'un parent elementinden al
                                        if (!leadId || leadId.length < 10) {
                                            const parent = checkbox.closest('tr, div[data-id], div[data-record-id], li[data-id]');
                                            if (parent) {
                                                leadId = parent.getAttribute('data-id') || 
                                                        parent.getAttribute('data-record-id') ||
                                                        parent.getAttribute('id') ||
                                                        parent.getAttribute('data-entity-id');
                                            }
                                        }
                                        
                                        // ‚úÖ Y√∂ntem 4: Checkbox'un yakƒ±nƒ±ndaki link'ten al (Zoho CRM'de lead link'leri genelde ID i√ßerir)
                                        if (!leadId || leadId.length < 10) {
                                            const nearbyLink = checkbox.closest('tr, div, li')?.querySelector('a[href*="/Leads/"]');
                                            if (nearbyLink) {
                                                const hrefMatch = nearbyLink.href.match(/\/Leads\/(\d+)/);
                                                if (hrefMatch && hrefMatch[1]) {
                                                    leadId = hrefMatch[1];
                                                }
                                            }
                                        }
                                        
                                        // ‚úÖ Y√∂ntem 5: Checkbox'un yakƒ±nƒ±ndaki span veya div'den al (Zoho CRM bazen ID'yi buraya koyar)
                                        if (!leadId || leadId.length < 10) {
                                            const nearbyElements = checkbox.closest('tr, div, li')?.querySelectorAll('[data-id], [data-record-id], [id*="lead"], [id*="record"]');
                                            if (nearbyElements && nearbyElements.length > 0) {
                                                for (const el of nearbyElements) {
                                                    const id = el.getAttribute('data-id') || el.getAttribute('data-record-id') || el.id;
                                                    if (id && id.length >= 10 && !id.includes('select-all') && !id.includes('selectAll')) {
                                                        leadId = id;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        
                                        // ‚úÖ Filtrele: Ge√ßerli bir lead ID olmalƒ±
                                        if (leadId && leadId.toString().length >= 10 && 
                                            !leadId.toString().includes('select-all') && 
                                            !leadId.toString().includes('selectAll') &&
                                            !leadId.toString().includes('header') &&
                                            !leadId.toString().includes('footer')) {
                                            leadIds.push(leadId.toString());
                                            console.log(`‚úÖ Checkbox ${index + 1} lead ID bulundu:`, leadId, {
                                                checkboxValue: checkbox.value,
                                                checkboxId: checkbox.id,
                                                parentDataId: checkbox.closest('tr, div, li')?.getAttribute('data-id')
                                            });
                                        } else {
                                            console.log(`‚ö†Ô∏è Checkbox ${index + 1} i√ßin ge√ßerli lead ID bulunamadƒ±:`, {
                                                leadId,
                                                checkboxValue: checkbox.value,
                                                checkboxId: checkbox.id
                                            });
                                        }
                                    });
                                    
                                    if (leadIds.length > 0) {
                                        console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ DOM\'dan alƒ±nan lead ID\'leri:', leadIds);
                                        return leadIds;
                                    } else {
                                        console.warn('‚ö†Ô∏è Se√ßili checkbox\'lar var ama lead ID √ßƒ±karƒ±lamadƒ±');
                                    }
                                } else {
                                    console.log('‚ÑπÔ∏è Parent window\'da se√ßili checkbox bulunamadƒ±');
                                }
                            }
                        } catch (parentError) {
                            console.warn('‚ö†Ô∏è Parent window\'a eri≈üilemedi (CORS veya iframe sorunu olabilir):', parentError.message);
                        }
                    }
                    
                    // ‚úÖ SONRA: Kendi window'umuzda da kontrol et (eƒüer widget i√ßindeysek)
                    try {
                        const currentCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                        console.log('üîç Kendi window\'umuzda se√ßili checkbox\'lar:', currentCheckboxes.length);
                        
                        if (currentCheckboxes.length > 0) {
                            const leadIds = [];
                            currentCheckboxes.forEach((checkbox, index) => {
                                let leadId = checkbox.value || 
                                            checkbox.getAttribute('data-id') || 
                                            checkbox.getAttribute('data-record-id') ||
                                            checkbox.closest('tr, div, li')?.getAttribute('data-id');
                                
                                if (leadId && leadId.toString().length >= 10 && 
                                    !leadId.toString().includes('select-all') && 
                                    !leadId.toString().includes('selectAll')) {
                                    leadIds.push(leadId.toString());
                                    console.log(`‚úÖ Kendi window checkbox ${index + 1} lead ID:`, leadId);
                                }
                            });
                            
                            if (leadIds.length > 0) {
                                console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Kendi window\'dan alƒ±nan lead ID\'leri:', leadIds);
                                return leadIds;
                            }
                        }
                    } catch (currentError) {
                        console.warn('‚ö†Ô∏è Kendi window\'da checkbox\'lar kontrol edilemedi:', currentError.message);
                    }
                } catch (domError) {
                    console.warn('‚ö†Ô∏è DOM\'dan checkbox\'lar alƒ±namadƒ±:', domError);
                }
                
                // ‚úÖ Y√∂ntem 1: getSelectedRecords() (widget i√ßinde √ßalƒ±≈üƒ±r - EN √ñNCELƒ∞KLƒ∞)
                console.log('üîç getSelectedRecords() kontrol ediliyor...', {
                    hasZOHO: typeof ZOHO !== 'undefined',
                    hasCRM: typeof ZOHO?.CRM !== 'undefined',
                    hasUI: typeof ZOHO?.CRM?.UI !== 'undefined',
                    hasGetSelectedRecords: typeof ZOHO?.CRM?.UI?.getSelectedRecords === 'function'
                });
                
                if (ZOHO.CRM && ZOHO.CRM.UI && typeof ZOHO.CRM.UI.getSelectedRecords === 'function') {
                    try {
                        console.log('‚úÖ‚úÖ‚úÖ getSelectedRecords() fonksiyonu bulundu, √ßaƒürƒ±lƒ±yor...');
                        
                        // ‚úÖ √ñNCE: getPageInfo() ile se√ßili kayƒ±tlarƒ± kontrol et
                        let pageInfo = null;
                        if (typeof ZOHO.CRM.UI.getPageInfo === 'function') {
                            try {
                                pageInfo = await ZOHO.CRM.UI.getPageInfo();
                                console.log('‚úÖ‚úÖ‚úÖ getPageInfo() sonucu:', pageInfo);
                                console.log('‚úÖ‚úÖ‚úÖ getPageInfo() t√ºm key\'leri:', Object.keys(pageInfo || {}));
                                
                                // PageInfo'dan se√ßili kayƒ±tlarƒ± √ßƒ±kar
                                if (pageInfo && pageInfo.selectedRecords && pageInfo.selectedRecords.length > 0) {
                                    const leadIds = pageInfo.selectedRecords.map(record => {
                                        const id = record.id || record.Id || record.ID || record.recordId || record.record_id;
                                        return id ? id.toString() : null;
                                    }).filter(id => id && id.length >= 10);
                                    
                                    if (leadIds.length > 0) {
                                        console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ getPageInfo() ile alƒ±nan lead ID\'leri:', leadIds);
                                        return leadIds;
                                    }
                                }
                            } catch (pageInfoError) {
                                console.warn('‚ö†Ô∏è getPageInfo() √ßalƒ±≈ümadƒ±:', pageInfoError);
                            }
                        }
                        
                        // ‚úÖ SONRA: Direkt getSelectedRecords() √ßaƒüƒ±r
                        let selectedRecords = await ZOHO.CRM.UI.getSelectedRecords();
                        // ‚úÖ Parametreli dene (bazƒ± CRM s√ºr√ºmleri module/entity ister)
                        if (!selectedRecords || (Array.isArray(selectedRecords) && selectedRecords.length === 0)) {
                            try {
                                selectedRecords = await ZOHO.CRM.UI.getSelectedRecords({ Entity: 'Leads' });
                            } catch (e) {}
                        }
                        if (!selectedRecords || (Array.isArray(selectedRecords) && selectedRecords.length === 0)) {
                            try {
                                selectedRecords = await ZOHO.CRM.UI.getSelectedRecords({ entity: 'Leads' });
                            } catch (e) {}
                        }
                        if (!selectedRecords || (Array.isArray(selectedRecords) && selectedRecords.length === 0)) {
                            try {
                                selectedRecords = await ZOHO.CRM.UI.getSelectedRecords({ module: 'Leads' });
                            } catch (e) {}
                        }
                        console.log('‚úÖ‚úÖ‚úÖ getSelectedRecords() √ßaƒürƒ±sƒ± tamamlandƒ±!');
                        console.log('‚úÖ‚úÖ‚úÖ Zoho CRM\'den se√ßili kayƒ±tlar (getSelectedRecords):', selectedRecords);
                        console.log('‚úÖ‚úÖ‚úÖ Se√ßili kayƒ±t sayƒ±sƒ±:', selectedRecords?.length || 0);
                        console.log('‚úÖ‚úÖ‚úÖ Se√ßili kayƒ±t tipi:', typeof selectedRecords);
                        console.log('‚úÖ‚úÖ‚úÖ Se√ßili kayƒ±t Array mi?', Array.isArray(selectedRecords));
                        console.log('‚úÖ‚úÖ‚úÖ Se√ßili kayƒ±t tam i√ßeriƒüi:', JSON.stringify(selectedRecords, null, 2));
                        
                        if (selectedRecords) {
                            // ‚úÖ Eƒüer array deƒüilse, array'e √ßevir / data alanƒ±nƒ± kullan
                            const recordsArray = Array.isArray(selectedRecords)
                                ? selectedRecords
                                : (Array.isArray(selectedRecords.data) ? selectedRecords.data
                                : (Array.isArray(selectedRecords.records) ? selectedRecords.records
                                : (Array.isArray(selectedRecords.selectedRecords) ? selectedRecords.selectedRecords
                                : [selectedRecords])));
                            console.log('‚úÖ Records array:', recordsArray);
                            
                            if (recordsArray.length > 0) {
                                // ‚úÖ ƒ∞lk record'un t√ºm key'lerini logla
                                console.log('‚úÖ ƒ∞lk record\'un t√ºm key\'leri:', Object.keys(recordsArray[0]));
                                console.log('‚úÖ ƒ∞lk record tam i√ßeriƒüi:', JSON.stringify(recordsArray[0], null, 2));
                                
                                const leadIds = recordsArray.map((record, index) => {
                                    // ‚úÖ T√ºm olasƒ± ID alanlarƒ±nƒ± kontrol et
                                    const id = record.id || record.Id || record.ID || record.recordId || record.record_id || 
                                              record.entity_id || record.entityId || record.EntityId || 
                                              record.lead_id || record.leadId || record.LeadId ||
                                              record.entityId || record.EntityId ||
                                              (record.entity_details && record.entity_details.id) ||
                                              (record.Entity && record.Entity.id);
                                    const idStr = id ? id.toString() : null;
                                    console.log(`üîç Record ${index + 1} ID √ßƒ±karƒ±lƒ±yor:`, { 
                                        recordKeys: Object.keys(record),
                                        idStr,
                                        fullRecord: record
                                    });
                                    return idStr;
                                }).filter(id => id && id.length >= 10);
                                
                                console.log('‚úÖ Filtrelenmi≈ü lead ID\'leri:', leadIds);
                                
                                if (leadIds.length > 0) {
                                    console.log('‚úÖ‚úÖ‚úÖ Zoho CRM\'den alƒ±nan lead ID\'leri:', leadIds);
                                    return leadIds;
                                } else {
                                    console.warn('‚ö†Ô∏è Se√ßili kayƒ±tlar var ama ID √ßƒ±karƒ±lamadƒ±. T√ºm record\'lar:', recordsArray);
                                }
                            } else {
                                console.log('‚ÑπÔ∏è getSelectedRecords() bo≈ü array d√∂nd√º (se√ßili kayƒ±t yok)');
                            }
                        } else {
                            console.log('‚ÑπÔ∏è getSelectedRecords() null/undefined d√∂nd√º (se√ßili kayƒ±t yok)');
                        }
                    } catch (getSelectedError) {
                        console.warn('‚ö†Ô∏è getSelectedRecords() √ßalƒ±≈ümadƒ±:', getSelectedError);
                        console.warn('‚ö†Ô∏è Hata detaylarƒ±:', getSelectedError.message, getSelectedError.stack);
                    }
                }
                
                // ‚úÖ Y√∂ntem 2: ZOHO.CRM.API.getRecords() ile se√ßili kayƒ±tlarƒ± al (COQL Query kullanarak)
                if (ZOHO.CRM && ZOHO.CRM.API && typeof ZOHO.CRM.API.getRecords === 'function') {
                    try {
                        console.log('üîç ZOHO.CRM.API.getRecords() deneniyor...');
                        
                        // ‚úÖ √ñnce getSelectedRecords() ile ID'leri al (eƒüer varsa)
                        let selectedIds = [];
                        if (ZOHO.CRM.UI && typeof ZOHO.CRM.UI.getSelectedRecords === 'function') {
                            try {
                                const selectedRecords = await ZOHO.CRM.UI.getSelectedRecords();
                                if (selectedRecords && selectedRecords.length > 0) {
                                    selectedIds = selectedRecords.map(r => r.id || r.Id || r.ID || r.recordId).filter(Boolean);
                                    console.log('‚úÖ getSelectedRecords() ile ID\'ler alƒ±ndƒ±:', selectedIds);
                                }
                            } catch (e) {
                                console.warn('‚ö†Ô∏è getSelectedRecords() √ßalƒ±≈ümadƒ±:', e);
                            }
                        }
                        
                        // ‚úÖ Eƒüer ID'ler varsa, COQL Query ile telefon numaralarƒ±nƒ± √ßek
                        if (selectedIds.length > 0) {
                            const idsString = selectedIds.map(id => `'${id}'`).join(',');
                            const coqlQuery = `SELECT id, First_Name, Last_Name, Full_Name, Phone, Mobile, Secondary_Phone, Email FROM Leads WHERE id IN (${idsString})`;
                            
                            console.log('üîç COQL Query ile se√ßili lead\'ler √ßekiliyor:', coqlQuery);
                            
                            const apiResponse = await ZOHO.CRM.API.getRecords({
                                Entity: 'Leads',
                                select_query: coqlQuery
                            });
                            
                            console.log('‚úÖ COQL Query sonucu:', apiResponse);
                            
                            if (apiResponse && apiResponse.data && apiResponse.data.length > 0) {
                                const leadIds = apiResponse.data.map(lead => lead.id).filter(id => id && id.length >= 10);
                                if (leadIds.length > 0) {
                                    console.log('‚úÖ‚úÖ‚úÖ COQL Query ile alƒ±nan lead ID\'leri:', leadIds);
                                    return leadIds;
                                }
                            }
                        }
                    } catch (apiError) {
                        console.warn('‚ö†Ô∏è ZOHO.CRM.API.getRecords() √ßalƒ±≈ümadƒ±:', apiError);
                    }
                }
                
                // ‚úÖ Y√∂ntem 3: getPageInfo() ile se√ßili kayƒ±tlarƒ± al
                if (ZOHO.CRM && ZOHO.CRM.UI && typeof ZOHO.CRM.UI.getPageInfo === 'function') {
                    try {
                        console.log('üîç getPageInfo() deneniyor...');
                        const pageInfo = await ZOHO.CRM.UI.getPageInfo();
                        console.log('‚úÖ Zoho CRM PageInfo:', pageInfo);
                        console.log('‚úÖ PageInfo t√ºm key\'leri:', Object.keys(pageInfo || {}));
                        
                        // PageInfo'dan se√ßili kayƒ±tlarƒ± √ßƒ±kar
                        if (pageInfo && pageInfo.selectedRecords && pageInfo.selectedRecords.length > 0) {
                            const leadIds = pageInfo.selectedRecords.map(record => {
                                const id = record.id || record.Id || record.ID || record.recordId || record.record_id;
                                return id ? id.toString() : null;
                            }).filter(id => id && id.length >= 10);
                            
                            if (leadIds.length > 0) {
                                console.log('‚úÖ‚úÖ‚úÖ PageInfo\'dan alƒ±nan lead ID\'leri:', leadIds);
                                return leadIds;
                            }
                        } else {
                            console.log('‚ÑπÔ∏è PageInfo\'da selectedRecords yok. PageInfo i√ßeriƒüi:', JSON.stringify(pageInfo, null, 2));
                        }
                    } catch (pageInfoError) {
                        console.warn('‚ö†Ô∏è getPageInfo() √ßalƒ±≈ümadƒ±:', pageInfoError);
                    }
                }
                
                // ‚úÖ Y√∂ntem 3: Parent window'dan postMessage ile al (iframe i√ßindeyse)
                try {
                    if (window.parent && window.parent !== window) {
                        console.log('üîç Parent window\'a postMessage g√∂nderiliyor...');
                        window.parent.postMessage({ type: 'GET_SELECTED_LEADS' }, '*');
                        
                        // PostMessage response'u bekle
                        return new Promise((resolve) => {
                            const timeout = setTimeout(() => {
                                console.warn('‚ö†Ô∏è PostMessage timeout (5 saniye)');
                                resolve(null);
                            }, 5000);
                            
                            const messageHandler = (event) => {
                                if (event.data && event.data.type === 'SELECTED_LEADS' && event.data.leadIds) {
                                    clearTimeout(timeout);
                                    window.removeEventListener('message', messageHandler);
                                    const leadIds = event.data.leadIds.filter(id => id && id.toString().length >= 10);
                                    if (leadIds.length > 0) {
                                        console.log('‚úÖ‚úÖ‚úÖ PostMessage\'dan alƒ±nan lead ID\'leri:', leadIds);
                                        resolve(leadIds);
                                    } else {
                                        resolve(null);
                                    }
                                }
                            };
                            
                            window.addEventListener('message', messageHandler);
                        });
                    }
                } catch (postMessageError) {
                    console.warn('‚ö†Ô∏è PostMessage √ßalƒ±≈ümadƒ±:', postMessageError);
                }
                
                // ‚úÖ Y√∂ntem 5: URL'den referrer'dan al (son √ßare)
                try {
                    const referrer = document.referrer;
                    console.log('üîç Referrer URL:', referrer);
                    
                    if (referrer && referrer.includes('zoho.com/crm')) {
                        const referrerUrl = new URL(referrer);
                        const recordIds = referrerUrl.searchParams.get('ids') || referrerUrl.searchParams.get('recordIds') || referrerUrl.searchParams.get('selectedIds');
                        if (recordIds && recordIds !== '$recordIds') {
                            const ids = recordIds.split(',').map(id => id.trim()).filter(id => id && id.length >= 10);
                            if (ids.length > 0) {
                                console.log('‚úÖ Referrer\'dan alƒ±nan lead ID\'leri:', ids);
                                return ids;
                            }
                        }
                    }
                } catch (referrerError) {
                    console.warn('‚ö†Ô∏è Referrer\'dan alƒ±namadƒ±:', referrerError);
                }
                
                console.warn('‚ö†Ô∏è Zoho CRM\'de se√ßili kayƒ±t bulunamadƒ± (t√ºm y√∂ntemler denendi)');
                return null;
            } catch (error) {
                console.error('‚ùå Zoho CRM API hatasƒ±:', error);
                return null;
            }
        }

        // Initialize
        // ‚úÖ Sadece se√ßili lead'lerin detaylarƒ±nƒ± √ßek
        async function fetchSelectedLeadsDetails(leadIds) {
            if (!leadIds || leadIds.length === 0) {
                return [];
            }
            
            try {
                const leadIdsParam = leadIds.join(',');
                // ‚úÖ YENƒ∞ ENDPOINT: COQL Query ile kesin √ß√∂z√ºm
                const url = `/api/zoho/selected-leads?leadIds=${encodeURIComponent(leadIdsParam)}`;
                console.log('‚úÖ‚úÖ‚úÖ COQL Query ile se√ßili lead\'lerin telefon numaralarƒ± √ßekiliyor...', { url, leadIds });
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ‚úÖ‚úÖ COQL Query ile se√ßili lead\'lerin telefon numaralarƒ± √ßekildi:', { 
                    count: data.leads?.length || 0,
                    withPhones: data.withPhones || 0,
                    method: data.method || 'unknown'
                });
                
                if (data.leads && data.leads.length > 0) {
                    // ‚úÖ Telefon numaralarƒ±nƒ± kontrol et
                    const leadsWithPhones = data.leads.filter(lead => {
                        const hasPhone = lead.Phone || lead.Mobile || lead.Secondary_Phone || 
                                       lead.phone || lead.mobile || lead.secondary_phone;
                        return hasPhone;
                    });
                    
                    console.log('‚úÖ‚úÖ‚úÖ Telefon numarasƒ± olan lead\'ler:', leadsWithPhones.length, 'toplam:', data.leads.length);
                    
                    if (leadsWithPhones.length === 0) {
                        console.warn('‚ö†Ô∏è Se√ßili lead\'lerde telefon numarasƒ± yok!');
                    }
                }
                
                return data.leads || [];
            } catch (error) {
                console.error('‚ùå Se√ßili lead\'lerin detaylarƒ± √ßekilemedi:', error);
                throw error;
            }
        }

        async function init() {
            console.log('üöÄ Bulk message sayfasƒ± ba≈ülatƒ±lƒ±yor...');
            
            // Templates modal'ƒ± kur
            setupTemplatesModal();
            
            // Template'leri y√ºkle (paralel olarak - modal a√ßƒ±ldƒ±ƒüƒ±nda tekrar y√ºklenecek)
            loadTemplates().catch(err => {
                console.error('Template y√ºkleme hatasƒ±:', err);
            });

            // ‚úÖ Zoho PageLoad dinleyicisini kur (se√ßili kayƒ±tlar i√ßin)
            setupZohoPageLoadListener();
            
            // ‚úÖ 1. ADIM: √ñNCE SE√áƒ∞Lƒ∞ LEAD'LERƒ∞ KONTROL ET
            let hasSelectedLeads = false;
            
            // ‚úÖ 0. ADIM: URL'den gelen se√ßili lead ID'lerini √∂nce kullan
            const urlLeadIds = getLeadIdsFromUrl();
            if (urlLeadIds && urlLeadIds.length > 0) {
                // UI bozulmasƒ±n diye sadece se√ßimi √∂nceden i≈üaretle
                urlLeadIds.forEach(id => selectedLeadIds.add(id));
                console.log('‚úÖ URL\'den lead ID bulundu, √∂nceden se√ßildi:', urlLeadIds);

                // Hƒ±zlƒ± dolmasƒ± i√ßin detaylarƒ± √ßekip recipients olu≈üturmayƒ± dene
                console.log('‚úÖ URL lead ID detaylarƒ± √ßekiliyor...', urlLeadIds);
                try {
                    const leadsFromUrl = await fetchSelectedLeadsDetails(urlLeadIds);
                    if (leadsFromUrl && leadsFromUrl.length > 0) {
                        const leadsWithPhones = leadsFromUrl.filter(lead => {
                            const phone = lead.Phone || lead.Mobile || lead.Secondary_Phone || 
                                         lead.phone || lead.mobile || lead.secondary_phone;
                            return phone && phone.trim().length > 0;
                        });
                        
                        console.log('‚úÖ‚úÖ‚úÖ URL ile gelen se√ßili lead\'lerde telefon numarasƒ± olanlar:', leadsWithPhones.length);
                        if (leadsWithPhones.length > 0) {
                            // ‚úÖ Recipients olu≈ütur (SADECE URL ile gelen se√ßili lead'ler)
                            buildRecipients(leadsWithPhones);
                            hasSelectedLeads = true; // ‚úÖ URL'den lead'ler geldi
                        } else {
                            console.warn('‚ö†Ô∏è URL ile gelen se√ßili lead\'lerde telefon numarasƒ± yok, fallback devreye giriyor');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è URL ile gelen lead detaylarƒ± bo≈ü d√∂nd√º, fallback devreye giriyor');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è URL ile lead detaylarƒ± √ßekilemedi, fallback devreye giriyor:', error);
                }
            }
            
            // ‚úÖ 2. ADIM: PageLoad'tan ID'ler gelmi≈üse onlarƒ± kullan (sonsuz d√∂ng√ºy√º √∂nle)
            if (pageLoadSelectedIds && pageLoadSelectedIds.length > 0) {
                console.log('‚úÖ‚úÖ‚úÖ PageLoad\'tan ID\'ler var, backend API\'den telefon numaralarƒ± √ßekiliyor...', pageLoadSelectedIds);
                try {
                    const leadsWithPhones = await fetchSelectedLeadsDetails(pageLoadSelectedIds);
                    if (leadsWithPhones && leadsWithPhones.length > 0) {
                        console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ PageLoad ID\'lerinden telefon numaralarƒ± √ßekildi:', leadsWithPhones.length);
                        
                        leadsWithPhones.forEach(lead => {
                            const leadId = getLeadId(lead);
                            if (leadId) {
                                selectedLeadIds.add(leadId);
                            }
                        });
                        
                        buildRecipients(leadsWithPhones);
                        hasSelectedLeads = true;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è PageLoad ID\'lerinden telefon numaralarƒ± √ßekilemedi:', error);
                }
            }
            
            // ‚úÖ 3. ADIM: ZOHO CRM'DEN SE√áƒ∞Lƒ∞ LEAD'LERƒ∞N TELEFON NUMARALARINI Dƒ∞REKT AL (sadece 1 deneme - sonsuz d√∂ng√ºy√º √∂nle)
            let selectedLeadsWithPhones = await getSelectedLeadsPhonesFromZoho();
            
            // ‚úÖ 4. ADIM: EƒûER SE√áƒ∞Lƒ∞ LEAD'LER VARSA, Dƒ∞REKT RECIPIENTS'A EKLE!
            if (selectedLeadsWithPhones && selectedLeadsWithPhones.length > 0) {
                console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Se√ßili lead\'ler bulundu, direkt recipients\'a ekleniyor...', selectedLeadsWithPhones);
                
                selectedLeadsWithPhones.forEach(lead => {
                    if (lead.id) {
                        selectedLeadIds.add(lead.id);
                    }
                });
                
                buildRecipients(selectedLeadsWithPhones);
                renderRecipients();
                console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Se√ßili lead\'ler direkt recipients\'a eklendi!');
                hasSelectedLeads = true;
            }
            
            // ‚úÖ 5. ADIM: SE√áƒ∞Lƒ∞ LEAD'LER VARSA RECIPIENTS'I RENDER ET
            if (hasSelectedLeads && recipients.length > 0) {
                renderRecipients();
            }
        }

        // Sayfa y√ºklendiƒüinde
        window.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Templates Modal -->
    <div id="templatesModal" class="templates-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div class="templates-modal-content" style="position: relative; background: white; margin: 50px auto; max-width: 1200px; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Templates</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" id="templateSearch" placeholder="üîç Search templates..." style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; width: 250px;">
                    <button class="btn btn-icon" id="closeTemplatesModal" style="padding: 8px; font-size: 20px; background: transparent; border: none; cursor: pointer; color: #1e40af;">‚úï</button>
                </div>
            </div>
            <div id="templatesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                <!-- Templates will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Template Parameters Modal -->
    <div id="templateParametersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; overflow-y: auto;">
        <div style="position: relative; background: white; margin: 50px auto; max-width: 800px; border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Template Parametreleri</h2>
                <button class="btn btn-icon" onclick="closeTemplateParametersModal()" style="padding: 8px; font-size: 20px; background: transparent; border: none; cursor: pointer; color: #1e40af;">‚úï</button>
            </div>
            <div id="templateParametersContent">
                <!-- Template parametreleri buraya eklenecek -->
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button onclick="closeTemplateParametersModal()" style="padding: 10px 20px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ƒ∞ptal</button>
                <button onclick="sendBulkMessageWithTemplateParams()" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">G√∂nder</button>
            </div>
        </div>
    </div>
</body>
</html>

