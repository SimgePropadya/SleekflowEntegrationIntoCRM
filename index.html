<!DOCTYPE html>
<html lang="tr">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; frame-ancestors 'self' https://crm.zoho.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleekflow Inbox - Zoho CRM Widget</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar - Settings & Connection -->
        <aside class="sidebar open" id="sidebar">
            <div class="sidebar-header">
                <h2>âš™ï¸ Ayarlar</h2>
                <button class="btn-icon" id="toggleSidebar" type="button" onclick="window.toggleSidebar(); return false;">âœ•</button>
            </div>
            
            <div class="sidebar-content">
                <!-- Sleekflow Connection -->
                <div class="settings-section">
                    <h3>ğŸ“± Sleekflow Platform API</h3>
                    <div class="form-group">
                        <label>Platform API AnahtarÄ± <span style="color: #ef4444;">*</span></label>
                        <input type="password" id="sleekflowApiKey" class="input-field" placeholder="API anahtarÄ±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n" required>
                    </div>
                    <div class="form-group">
                        <label>BÃ¶lge (Base URL)</label>
                        <select id="sleekflowBaseUrl" class="input-field">
                            <option value="https://sleekflow-core-app-weu-production.azurewebsites.net">West Europe (Ã–nerilen)</option>
                            <option value="https://api.sleekflow.io">Hong Kong</option>
                            <option value="https://sleekflow-core-app-eus-production.azurewebsites.net">United States</option>
                            <option value="https://sleekflow-core-app-seas-production.azurewebsites.net">Singapore</option>
                            <option value="https://sleekflow-core-app-uaen-production.azurewebsites.net">UAE North</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" id="connectSleekflow">ğŸ”— SleekFlow'a BaÄŸlan</button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <div class="main-area">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="openSidebar" type="button" onclick="window.toggleSidebar(); return false;" style="background: #3b82f6 !important; color: white !important; padding: 10px 15px !important; border-radius: 6px !important; font-size: 18px !important; font-weight: bold !important; cursor: pointer !important; z-index: 10001 !important; position: relative !important;">â˜° AYARLAR</button>
                    <h1>Sleekflow Inbox</h1>
                </div>
                <div class="top-bar-right">
                    <button class="btn-icon" id="refreshConversations" title="Yenile">ğŸ”„</button>
                </div>
            </header>

            <!-- Chat Layout -->
            <div class="chat-layout">
                <!-- Conversations List -->
                <div class="conversations-panel" id="conversationsPanel">
                    <div class="conversations-header">
                        <h2>KonuÅŸmalar</h2>
                        <select id="channelFilter" class="sender-select" title="Kanal Filtrele">
                            <option value="">TÃ¼m Kanallar</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="instagram">Instagram</option>
                            <option value="facebook">Facebook</option>
                            <option value="sms">SMS</option>
                            <option value="line">LINE</option>
                            <option value="wechat">WeChat</option>
                            <option value="web">Web</option>
                        </select>
                        <input type="text" id="searchConversations" class="search-input" placeholder="ğŸ” Ara...">
                    </div>
                    
                    <!-- Lead filter info bar -->
                    <div id="leadFilterInfo" class="lead-filter-info" style="display:none;"></div>
                    
                    <div class="conversations-list" id="conversationsList" style="flex: 1; overflow-y: auto;">
                        <div class="empty-state">
                            <p>ğŸ“­ HenÃ¼z konuÅŸma yok</p>
                            <p class="empty-hint">Sleekflow'a baÄŸlanÄ±n ve konuÅŸmalarÄ± gÃ¶rÃ¼ntÃ¼leyin</p>
                        </div>
                    </div>
                    
                    <!-- Leads Follow-Up Grubu BÃ¶lÃ¼mÃ¼ KALDIRILDI -->
                </div>

                <!-- Chat View -->
                <div class="chat-view" id="chatView">
                    <div class="chat-empty">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h2>Bir konuÅŸma seÃ§in</h2>
                        <p>Sol taraftan bir konuÅŸma seÃ§erek mesajlarÄ± gÃ¶rÃ¼ntÃ¼leyin</p>
                    </div>

                    <!-- Active Chat -->
                    <div class="chat-active" id="chatActive" style="display: none;">
                        <!-- Chat Header -->
                        <div class="chat-header">
                            <div class="chat-header-info">
                                <div class="chat-avatar" id="chatAvatar">ğŸ‘¤</div>
                                <div>
                                    <h3 id="chatContactName">Ä°sim</h3>
                                    <span class="chat-meta" id="chatMeta">Durum</span>
                                </div>
                            </div>
                            <div class="chat-header-actions">
                                <!-- Leads Follow-Up yÃ¶nlendirme butonu KALDIRILDI -->
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div class="messages-area" id="messagesArea">
                            <div class="messages-list" id="messagesList">
                                <!-- Messages will be inserted here -->
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="message-input-area">
                            <div class="message-input-wrapper">
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    class="file-input" 
                                    multiple
                                    accept="image/*,video/*,audio/*,.pdf"
                                    style="display: none;"
                                >
                                <button class="btn btn-icon" id="attachFile" title="Dosya ekle" style="margin-right: 5px; padding: 8px 12px;">ğŸ“</button>
                                <input 
                                    type="text" 
                                    id="messageInput" 
                                    class="message-input" 
                                    placeholder="Mesaj yazÄ±n..."
                                    disabled
                                >
                                <button class="btn btn-primary" id="sendMessage" disabled>GÃ¶nder</button>
                            </div>
                            <div id="selectedFilesContainer" class="selected-files-container" style="display: none;">
                                <!-- SeÃ§ilen dosyalar burada gÃ¶sterilecek -->
                            </div>
                            <!-- Show All Conversations Button (sadece filtrelenmiÅŸ modda gÃ¶rÃ¼nÃ¼r) -->
                            <div id="showAllConversationsButtonContainer" style="display: none; padding: 10px; text-align: center; border-top: 1px solid #e0e0e0; background: #f9f9f9;">
                                <button class="btn btn-secondary" id="showAllConversationsInChat" style="width: 100%; padding: 12px; font-size: 14px; cursor: pointer;">
                                    ğŸ“‹ TÃ¼m KonuÅŸmalarÄ± GÃ¶ster
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>YÃ¼kleniyor...</p>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ============================================ -->
    <!-- ğŸš€ ZOHO SDK Ä°LE LEAD NAME Ã‡EKME (EN DOÄRU YÃ–NTEM) -->
    <!-- ============================================ -->
    <!-- Zoho CRM Widget SDK -->
    <script src="https://static.zohocdn.com/crm/v2.0/sdk/js/ZohoEmbededAppSDK.min.js"></script>
    
    <script>
        // âœ… BASÄ°T DEÄÄ°ÅKENLER: Lead bilgilerini tutmak iÃ§in (global window'a da ekle)
        window.leadId = null;
        window.leadName = null;  // âœ… BASÄ°T: Lead name deÄŸiÅŸkeni (app.js'den eriÅŸilebilir)
        window.leadPhone = null;
        window.leadEmail = null;
        
        // âœ… KÄ±sa isimler iÃ§in deÄŸiÅŸkenler
        let leadId = window.leadId;
        let leadName = window.leadName;
        let leadPhone = window.leadPhone;
        let leadEmail = window.leadEmail;
        
        // âœ… KESÄ°N Ã‡Ã–ZÃœM: Widget URL'inden lead ID Ã§Ä±kar (query parameter veya hash)
        function getLeadIdFromWidgetURL() {
            try {
                // YÃ–NTEM 1: Query parameter (leadId=...)
                const params = new URLSearchParams(window.location.search);
                let foundLeadId = params.get('leadId');
                
                // Placeholder kontrolÃ¼
                if (foundLeadId && (foundLeadId.includes('$') || foundLeadId.includes('{') || foundLeadId.includes('CRM_RECORD_ID'))) {
                    foundLeadId = null;
                }
                
                // YÃ–NTEM 2: Hash (#leadId=...)
                if (!foundLeadId && window.location.hash) {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    foundLeadId = hashParams.get('leadId');
                    if (foundLeadId && (foundLeadId.includes('$') || foundLeadId.includes('{') || foundLeadId.includes('CRM_RECORD_ID'))) {
                        foundLeadId = null;
                    }
                }
                
                // YÃ–NTEM 3: URL'den direkt Ã§Ä±kar (son / dan sonraki sayÄ±)
                if (!foundLeadId) {
                    const urlPath = window.location.pathname;
                    const lastSlashIndex = urlPath.lastIndexOf('/');
                    if (lastSlashIndex !== -1) {
                        const afterLastSlash = urlPath.substring(lastSlashIndex + 1);
                        if (/^\d{10,}$/.test(afterLastSlash)) {
                            foundLeadId = afterLastSlash;
                            console.log('âœ…âœ…âœ… URL path\'den leadId Ã§Ä±karÄ±ldÄ±:', foundLeadId);
                        }
                    }
                }
                
                return foundLeadId;
            } catch (e) {
                console.error('âŒ getLeadIdFromWidgetURL hatasÄ±:', e);
                return null;
            }
        }
        
        // âœ… KESÄ°N Ã‡Ã–ZÃœM: Widget URL'inden lead ID Ã§Ä±kar, backend'den ismini al!
        function getLeadNameFromWidgetURL() {
            try {
                const foundLeadId = getLeadIdFromWidgetURL();
                
                if (foundLeadId) {
                    console.log('âœ…âœ…âœ… Widget URL\'den lead ID bulundu, backend\'den ismi Ã§ekiliyor:', foundLeadId);
                    
                    // Backend'den lead ismini Ã§ek
                    const API_BASE_URL = `${window.location.origin}/api`;
                    fetch(API_BASE_URL + '/zoho/lead-info?id=' + encodeURIComponent(foundLeadId))
                        .then(res => res.json())
                        .then(lead => {
                            const name = lead.Full_Name || lead.Last_Name || lead.name || null;
                            if (name) {
                                console.log('âœ…âœ…âœ…âœ…âœ… Backend\'den lead ismi alÄ±ndÄ± (Widget URL):', name);
                                window.leadName = name;
                                window.leadId = foundLeadId;
                                window.leadPhone = lead.phone || lead.Phone || '';
                                window.leadEmail = lead.email || lead.Email || '';
                                
                                leadName = window.leadName;
                                leadId = window.leadId;
                                leadPhone = window.leadPhone;
                                leadEmail = window.leadEmail;
                                
                                // Event gÃ¶nder
                                window.dispatchEvent(
                                    new CustomEvent('zohoLeadDataLoaded', { detail: { id: foundLeadId, name: name } })
                                );
                                
                                if (typeof loadConversations === 'function') {
                                    loadConversations(false);
                                }
                            }
                        })
                        .catch(err => console.error('âŒ Backend lead ismi Ã§ekme hatasÄ±:', err));
                } else {
                    console.log('âš ï¸ Widget URL\'den lead ID bulunamadÄ±. Widget URL:', window.location.href);
                }
            } catch (e) {
                console.error('âŒ getLeadNameFromWidgetURL hatasÄ±:', e);
            }
        }
        
        // âœ… HEMEN widget URL'den lead ismini oku!
        setTimeout(() => {
            if (!window.leadName) {
                getLeadNameFromWidgetURL();
            }
        }, 100); // 100ms bekle, sayfa yÃ¼klensin
        
        // âœ… ZOHO SDK Ä°LE LEAD NAME Ã‡EKME - KRÄ°TÄ°K: DOM ready'de Ã§alÄ±ÅŸmalÄ±
        function initZohoLead() {
            console.log('ğŸ” initZohoLead Ã§aÄŸrÄ±ldÄ±');
            console.log('   ZOHO var mÄ±?', typeof ZOHO !== 'undefined' ? 'EVET' : 'HAYIR');
            console.log('   ZOHO.embeddedApp var mÄ±?', typeof ZOHO !== 'undefined' && ZOHO.embeddedApp ? 'EVET' : 'HAYIR');
            
            // âœ… KRÄ°TÄ°K: ZOHO SDK'nÄ±n yÃ¼klendiÄŸini kontrol et
            if (typeof ZOHO === 'undefined' || !ZOHO.embeddedApp) {
                console.error('âŒâŒâŒ ZOHO SDK YÃœKLENMEMÄ°Å! Tekrar deneniyor...');
                // 500ms sonra tekrar dene
                setTimeout(() => {
                    if (typeof ZOHO !== 'undefined' && ZOHO.embeddedApp) {
                        console.log('âœ… ZOHO SDK yÃ¼klendi, ÅŸimdi baÅŸlatÄ±lÄ±yor...');
                        initZohoLead();
                    } else {
                        console.error('âŒ ZOHO SDK hala yÃ¼klenmemiÅŸ, fallback kullanÄ±lacak');
                        console.error('   Bu, widget\'in external URL olarak eklenmiÅŸ olabileceÄŸini gÃ¶sterir!');
                        console.error('   Widget ZIP widget olarak eklenmeli!');
                        tryFallbackLeadId();
                    }
                }, 500);
                return;
            }
            
            console.log('ğŸš€ Zoho SDK baÅŸlatÄ±lÄ±yor...');
            
            // âœ… KRÄ°TÄ°K: PageLoad event'ini dinle
            ZOHO.embeddedApp.on("PageLoad", async function (data) {
                console.log('ğŸ”µğŸ”µğŸ”µ Zoho PageLoad event TETÄ°KLENDÄ°:', data);
                
                const entity = data.Entity;      // "Leads"
                const recordId = data.EntityId;  // o lead'in ID'si
                
                console.log('   Entity:', entity);
                console.log('   RecordId:', recordId);
                
                if (entity !== "Leads" || !recordId) {
                    console.log('âš ï¸ Lead sayfasÄ±nda deÄŸiliz. Entity:', entity, 'RecordId:', recordId);
                    return;
                }
                
                try {
                    console.log('ğŸ“¡ Zoho API\'den lead kaydÄ± Ã§ekiliyor...', { Entity: entity, RecordID: recordId });
                    
                    const resp = await ZOHO.CRM.API.getRecord({
                        Entity: entity,
                        RecordID: recordId
                    });
                    
                    console.log('ğŸ”µ Zoho getRecord response:', resp);
                    
                    if (!resp.data || !resp.data.length) {
                        console.log('âš ï¸ Zoho API\'den lead data gelmedi');
                        return;
                    }
                    
                    const lead = resp.data[0];
                    console.log('âœ… Zoho Lead Data:', lead);
                    
                    // Full_Name = Lead Name (Zoho'da bu alan)
                    const fullName = lead.Full_Name || 
                                   ((lead.First_Name || "") + " " + (lead.Last_Name || "")).trim() ||
                                   lead.Last_Name ||
                                   'Bilinmeyen';
                    
                    const phone = lead.Phone || lead.Mobile || '';
                    const email = lead.Email || '';
                    
                    // âœ… KRÄ°TÄ°K: Global window deÄŸiÅŸkenlerine ata (app.js'den eriÅŸilebilir)
                    window.leadId = recordId;
                    window.leadName = fullName;  // âœ… BASÄ°T: Lead name deÄŸiÅŸkene atandÄ±!
                    window.leadPhone = phone;
                    window.leadEmail = email;
                    
                    // âœ… KÄ±sa isimler iÃ§in de gÃ¼ncelle
                    leadId = window.leadId;
                    leadName = window.leadName;
                    leadPhone = window.leadPhone;
                    leadEmail = window.leadEmail;
                    
                    console.log('âœ…âœ…âœ…âœ…âœ… Lead Name SET EDÄ°LDÄ° (Zoho SDK):');
                    console.log('   window.leadId:', window.leadId);
                    console.log('   window.leadName:', window.leadName);  // âœ… Lead name deÄŸiÅŸkende!
                    console.log('   window.leadPhone:', window.leadPhone);
                    console.log('   window.leadEmail:', window.leadEmail);
                    
                    // âœ… Eski kod uyumluluÄŸu iÃ§in window.zohoCustomerData'ya da set et
                    window.zohoCustomerData = {
                        id: leadId,
                        name: leadName,
                        Full_Name: lead.Full_Name || fullName,
                        Last_Name: lead.Last_Name,
                        First_Name: lead.First_Name,
                        phone: leadPhone,
                        email: leadEmail,
                        Company: lead.Company,
                        Lead_Source: lead.Lead_Source,
                        Lead_Status: lead.Lead_Status,
                        ...lead
                    };
                    
                    console.log('âœ…âœ…âœ… window.zohoCustomerData SET EDÄ°LDÄ°:', window.zohoCustomerData);
                    
                    // âœ… Event gÃ¶nder â†’ app.js filtresini tetikler
                    window.dispatchEvent(
                        new CustomEvent('zohoLeadDataLoaded', { detail: window.zohoCustomerData })
                    );
                    document.dispatchEvent(
                        new CustomEvent('zohoLeadDataLoaded', { detail: window.zohoCustomerData })
                    );
                    
                    // âœ… KonuÅŸmalarÄ± yeniden yÃ¼kle (eÄŸer app.js yÃ¼klendiyse)
                    if (typeof loadConversations === 'function') {
                        console.log('ğŸ”„ KonuÅŸmalar yeniden yÃ¼kleniyor (Zoho SDK lead bilgisi ile)...');
                        loadConversations(false);
                    }
                } catch (e) {
                    console.error('âŒ Zoho SDK lead Ã§ekme hatasÄ±:', e);
                    console.error('   Hata detayÄ±:', e.message);
                    console.error('   Stack:', e.stack);
                    
                    // Fallback: URL'den leadId Ã§ekmeyi dene
                    console.log('âš ï¸ Zoho SDK hatasÄ±, fallback yÃ¶ntem deneniyor...');
                    tryFallbackLeadId();
                }
            });
            
            // âœ… KRÄ°TÄ°K: SDK'yÄ± init et
            ZOHO.embeddedApp.init();
            console.log('âœ…âœ…âœ… Zoho SDK init edildi - PageLoad event\'i dinleniyor...');
        }
        
        // Fallback: URL'den leadId Ã§ekme (Zoho SDK Ã§alÄ±ÅŸmazsa)
        async function tryFallbackLeadId() {
            try {
                // âœ… BASÄ°T: EÄŸer zaten leadId varsa, tekrar Ã§ekme
                if (leadId && leadId !== '$' && !leadId.includes('$') && !leadId.includes('{')) {
                    console.log('âœ…âœ…âœ… leadId zaten var, fallback atlanÄ±yor:', leadId);
                    return;
                }
                
                console.log('ğŸ”„ğŸ”„ğŸ”„ FALLBACK BAÅLIYOR - URL\'den leadId Ã§ekiliyor...');
                const params = new URLSearchParams(window.location.search);
                var foundLeadId = params.get('leadId');
                
                // Placeholder kontrolÃ¼
                if (foundLeadId && (foundLeadId.includes('$') || foundLeadId.includes('{') || foundLeadId.includes('CRM_RECORD_ID'))) {
                    console.log('âš ï¸ Placeholder tespit edildi, parent URL\'den Ã§Ä±karÄ±lÄ±yor...');
                    foundLeadId = null;
                }
                
                if (!foundLeadId) {
                    // Parent URL'den Ã§Ä±kar - Ã‡OKLU YÃ–NTEM
                    var parentUrl = null;
                    
                    // YÃ–NTEM 1: window.parent.location.href
                    try {
                        if (window.parent && window.parent !== window) {
                            parentUrl = window.parent.location.href;
                            console.log('ğŸ” YÃ–NTEM 1 - Parent URL:', parentUrl);
                        }
                    } catch (e) {
                        console.log('âš ï¸ YÃ–NTEM 1 - Cross-origin hatasÄ±:', e.message);
                    }
                    
                    // YÃ–NTEM 2: window.top.location.href
                    if (!parentUrl) {
                        try {
                            if (window.top && window.top !== window) {
                                parentUrl = window.top.location.href;
                                console.log('ğŸ” YÃ–NTEM 2 - Top URL:', parentUrl);
                            }
                        } catch (e) {
                            console.log('âš ï¸ YÃ–NTEM 2 - Cross-origin hatasÄ±:', e.message);
                        }
                    }
                    
                    // YÃ–NTEM 3: document.referrer
                    if (!parentUrl) {
                        parentUrl = document.referrer;
                        console.log('ğŸ” YÃ–NTEM 3 - Referrer:', parentUrl);
                    }
                    
                    // YÃ–NTEM 4: window.name (Zoho bazen buraya bilgi koyar)
                    if (!foundLeadId && window.name && window.name.length > 10) {
                        try {
                            var nameMatch = window.name.match(/(\d{10,})/);
                            if (nameMatch && nameMatch[1]) {
                                foundLeadId = nameMatch[1];
                                console.log('âœ…âœ…âœ… YÃ–NTEM 4 - window.name\'den leadId Ã§Ä±karÄ±ldÄ±:', foundLeadId);
                            }
                        } catch (e) {
                            console.log('âš ï¸ YÃ–NTEM 4 - window.name hatasÄ±:', e.message);
                        }
                    }
                    
                    if (parentUrl && !foundLeadId) {
                        // Pattern 1: /tab/Leads/3519633000086711022
                        var leadIdMatch = parentUrl.match(/\/tab\/Leads\/(\d+)(?:\?|$)/);
                        if (leadIdMatch && leadIdMatch[1]) {
                            foundLeadId = leadIdMatch[1];
                            console.log('âœ…âœ…âœ… Parent URL\'den leadId Ã§Ä±karÄ±ldÄ± (pattern):', foundLeadId);
                        } else {
                            // Pattern 2: Son / dan sonraki sayÄ±
                            var lastSlashIndex = parentUrl.lastIndexOf('/');
                            if (lastSlashIndex !== -1) {
                                var afterLastSlash = parentUrl.substring(lastSlashIndex + 1).split('?')[0];
                                if (/^\d{10,}$/.test(afterLastSlash)) {
                                    foundLeadId = afterLastSlash;
                                    console.log('âœ…âœ…âœ… Parent URL\'den leadId Ã§Ä±karÄ±ldÄ± (son / dan sonraki sayÄ±):', foundLeadId);
                                }
                            }
                        }
                    }
                }
                
                // âœ… BASÄ°T Ã‡Ã–ZÃœM: LeadId yoksa bile backend'e istek gÃ¶nder, o referrer'dan Ã§Ä±karacak
                const API_BASE_URL = `${window.location.origin}/api`;
                
                try {
                    // âœ… KESÄ°N Ã‡ALIÅAN YÃ–NTEM: Backend referrer header'Ä±ndan lead ID'yi Ã§Ä±karacak
                    const res = await fetch(API_BASE_URL + '/zoho/lead-info' + (foundLeadId ? '?id=' + encodeURIComponent(foundLeadId) : ''));
                    const lead = await res.json();
                    
                    // âœ… BASÄ°T: Backend'den gelen lead ID'yi global deÄŸiÅŸkene ata
                    if (lead.id && !foundLeadId) {
                        foundLeadId = lead.id;
                        console.log('âœ…âœ…âœ… Backend\'den leadId alÄ±ndÄ±:', foundLeadId);
                    }
                    
                    if (foundLeadId) {
                        // âœ… BASÄ°T: Global window deÄŸiÅŸkenlerine ata (app.js'den eriÅŸilebilir)
                        window.leadId = foundLeadId;
                        window.leadName = lead.Full_Name || lead.Last_Name || lead.name || 'Bilinmeyen';  // âœ… BASÄ°T: Lead name deÄŸiÅŸkene atandÄ±!
                        window.leadPhone = lead.phone || lead.Phone || '';
                        window.leadEmail = lead.email || lead.Email || '';
                        
                        // âœ… KÄ±sa isimler iÃ§in de gÃ¼ncelle
                        leadId = window.leadId;
                        leadName = window.leadName;
                        leadPhone = window.leadPhone;
                        leadEmail = window.leadEmail;
                        
                        console.log('âœ…âœ…âœ…âœ…âœ… BASÄ°T Ã‡Ã–ZÃœM: DeÄŸiÅŸkenlere atandÄ±!');
                        console.log('   window.leadId:', window.leadId);
                        console.log('   window.leadName (deÄŸiÅŸken):', window.leadName);  // âœ… Lead name deÄŸiÅŸkende!
                        console.log('   window.leadPhone:', window.leadPhone);
                        console.log('   window.leadEmail:', window.leadEmail);
                        
                        // âœ… Eski kod uyumluluÄŸu iÃ§in window.zohoCustomerData'ya da set et
                        window.zohoCustomerData = {
                            id: leadId,
                            name: leadName,
                            Full_Name: lead.Full_Name || lead.Last_Name,
                            Last_Name: lead.Last_Name,
                            phone: leadPhone,
                            email: leadEmail,
                            ...lead
                        };
                        
                        window.dispatchEvent(
                            new CustomEvent('zohoLeadDataLoaded', { detail: window.zohoCustomerData })
                        );
                        document.dispatchEvent(
                            new CustomEvent('zohoLeadDataLoaded', { detail: window.zohoCustomerData })
                        );
                        
                        if (typeof loadConversations === 'function') {
                            console.log('ğŸ”„ FALLBACK: KonuÅŸmalar yeniden yÃ¼kleniyor...');
                            loadConversations(false);
                        }
                    } catch (fetchError) {
                        console.error('âŒ Fallback fetch hatasÄ±:', fetchError);
                        // Hata durumunda bile leadId'yi set et
                        window.zohoCustomerData = {
                            id: leadId,
                            name: 'Lead ' + leadId,
                            Full_Name: 'Lead ' + leadId,
                            Last_Name: 'Lead ' + leadId,
                            phone: '',
                            email: ''
                        };
                        console.log('âš ï¸ Fallback: window.zohoCustomerData set edildi (hata nedeniyle):', window.zohoCustomerData);
                        window.dispatchEvent(
                            new CustomEvent('zohoLeadDataLoaded', { detail: window.zohoCustomerData })
                        );
                        document.dispatchEvent(
                            new CustomEvent('zohoLeadDataLoaded', { detail: window.zohoCustomerData })
                        );
                    }
                } else {
                    console.error('âŒâŒâŒ FALLBACK: LeadId bulunamadÄ±!');
                    console.log('   Widget URL:', window.location.href);
                    console.log('   Parent window:', window.parent && window.parent !== window ? 'Var' : 'Yok');
                }
            } catch (error) {
                console.error('âŒ Fallback hatasÄ±:', error);
            }
        }
        
        // âœ… KRÄ°TÄ°K: Zoho SDK'nÄ±n yÃ¼klendiÄŸini bekle, sonra baÅŸlat
        let sdkCheckCount = 0;
        const MAX_SDK_CHECKS = 30; // 3 saniye (30 * 100ms)
        
        function waitForZohoSDK() {
            sdkCheckCount++;
            if (typeof ZOHO !== 'undefined' && ZOHO.embeddedApp) {
                console.log('âœ…âœ…âœ… ZOHO SDK hazÄ±r, baÅŸlatÄ±lÄ±yor...');
                initZohoLead();
            } else if (sdkCheckCount < MAX_SDK_CHECKS) {
                console.log(`â³ ZOHO SDK bekleniyor... (${sdkCheckCount}/${MAX_SDK_CHECKS})`);
                setTimeout(waitForZohoSDK, 100);
            } else {
                console.error('âŒâŒâŒ ZOHO SDK yÃ¼klenemedi, fallback kullanÄ±lacak!');
                tryFallbackLeadId();
            }
        }
        
        // âœ… KRÄ°TÄ°K: HEMEN fallback'i de baÅŸlat (paralel Ã§alÄ±ÅŸsÄ±n)
        console.log('ğŸš€ğŸš€ğŸš€ HEMEN FALLBACK BAÅLATILIYOR (paralel Ã§alÄ±ÅŸacak)...');
        tryFallbackLeadId();
        
        // âœ… EK KESÄ°N Ã‡Ã–ZÃœM: Parent window'dan mesaj iste
        try {
            if (window.parent && window.parent !== window) {
                // Parent'a lead ID isteÄŸi gÃ¶nder
                window.parent.postMessage({ type: 'GET_LEAD_ID', source: 'sleekflow-widget' }, '*');
                console.log('ğŸ“¤ Parent window\'a lead ID isteÄŸi gÃ¶nderildi');
            }
        } catch (e) {
            console.log('âš ï¸ Parent postMessage hatasÄ±:', e.message);
        }
        
        // Sayfa yÃ¼klendiÄŸinde Zoho SDK'yÄ± baÅŸlat (SDK yÃ¼klenmesini bekle)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // SDK script'i yÃ¼klenmesini bekle
                setTimeout(waitForZohoSDK, 500);
            });
        } else {
            // SDK script'i yÃ¼klenmesini bekle
            setTimeout(waitForZohoSDK, 500);
        }
        
        // âœ… EK GÃœVENLÄ°K: 1, 2, 3 saniye sonra fallback'i tekrar dene
        [1000, 2000, 3000].forEach(delay => {
            setTimeout(() => {
                if (!window.zohoCustomerData || !window.zohoCustomerData.id || 
                    window.zohoCustomerData.id === '$' || 
                    window.zohoCustomerData.id.includes('$') ||
                    window.zohoCustomerData.id.includes('{')) {
                    console.log(`âš ï¸âš ï¸âš ï¸ ${delay/1000} saniye sonra hala zohoCustomerData yok/geÃ§ersiz, fallback tekrar deneniyor...`);
                    tryFallbackLeadId();
                }
            }, delay);
        });
    </script>

    
    <!-- Ana uygulama JavaScript'i -->
    <!-- âœ… ACÄ°L Ã‡Ã–ZÃœM: Buton event listener'Ä± HEMEN KUR (script yÃ¼klenmeden Ã¶nce) -->
    <script>
        // âœ… BUTON EVENT LISTENER'INI HEMEN KUR
        function setupConnectButton() {
            const btn = document.getElementById('connectSleekflow');
            if (btn) {
                console.log('âœ… connectSleekflow butonu bulundu, event listener kuruluyor...');
                btn.onclick = function() {
                    console.log('ğŸ”µğŸ”µğŸ”µ BUTON TIKLANDI!');
                    if (typeof window.connectSleekflow === 'function') {
                        console.log('âœ… window.connectSleekflow Ã§aÄŸrÄ±lÄ±yor...');
                        window.connectSleekflow();
                    } else {
                        console.error('âŒ window.connectSleekflow TANIMLI DEÄÄ°L! Script yÃ¼kleniyor mu?');
                        alert('LÃ¼tfen sayfanÄ±n tamamen yÃ¼klenmesini bekleyin (2-3 saniye) ve tekrar deneyin.');
                    }
                };
            } else {
                console.error('âŒ connectSleekflow butonu bulunamadÄ±!');
            }
        }
        
        // âœ… HEMEN DENE
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupConnectButton);
        } else {
            setupConnectButton();
        }
        
        // âœ… EK GÃœVENLÄ°K: 500ms sonra tekrar dene
        setTimeout(setupConnectButton, 500);
        setTimeout(setupConnectButton, 1000);
        setTimeout(setupConnectButton, 2000);
    </script>
    
     <!-- Frontend Utilities (matchNames, normalizeName vb.) -->
     <script src="utils/frontendUtils.js"></script>
     
     <script src="app.js?v=71"></script>
     <script>
         // âœ… Script yÃ¼klendikten sonra buton event listener'Ä±nÄ± tekrar kur
         window.addEventListener('load', function() {
             setTimeout(function() {
                 setupConnectButton();
                 if (typeof window.connectSleekflow === 'function') {
                     console.log('âœ…âœ…âœ… window.connectSleekflow YÃœKLENDÄ° VE HAZIR!');
                 } else {
                     console.error('âŒâŒâŒ window.connectSleekflow HALA TANIMLI DEÄÄ°L!');
                 }
             }, 1000);
         });
     </script>
    <script>
        // âœ… SIDEBAR KONTROL FONKSÄ°YONU - Sadece baÄŸlantÄ± yoksa aÃ§Ä±k tut
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return false;
            
            sidebar.classList.toggle('open');
            sidebar.classList.toggle('closed');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            return false;
        };

        // Widget iÃ§in arama fonksiyonu (case-insensitive - TÃ¼rkÃ§e karakter desteÄŸi ile)
        function setupWidgetSearch() {
            const searchInput = document.getElementById('searchConversations');
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                // TÃ¼rkÃ§e karakterleri normalize et ve kÃ¼Ã§Ã¼k harfe Ã§evir
                const normalizeText = (text) => {
                    return text
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Diyakritik iÅŸaretleri kaldÄ±r
                        .replace(/Ä±/g, 'i')
                        .replace(/ÄŸ/g, 'g')
                        .replace(/Ã¼/g, 'u')
                        .replace(/ÅŸ/g, 's')
                        .replace(/Ã¶/g, 'o')
                        .replace(/Ã§/g, 'c');
                };
                
                const search = normalizeText(e.target.value.trim());
                const items = document.querySelectorAll('.conversation-item');
                items.forEach(item => {
                    const nameEl = item.querySelector('.conversation-name');
                    const previewEl = item.querySelector('.conversation-preview');
                    
                    if (!nameEl) return;
                    
                    const name = normalizeText(nameEl.textContent.trim());
                    const preview = previewEl ? normalizeText(previewEl.textContent.trim()) : '';
                    
                    // Ä°sim veya mesaj Ã¶nizlemesinde ara (case-insensitive)
                    const matches = search === '' || name.includes(search) || preview.includes(search);
                    item.style.display = matches ? 'flex' : 'none';
                });
            });
        }

        // Sidebar ve arama iÃ§in event listener'lar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ Widget DOM yÃ¼klendi, sidebar event listener\'lar ekleniyor...');
            
            // Sidebar her zaman aÃ§Ä±k baÅŸla
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
            
            // âœ… SIDEBAR'Ä± KORU - SADECE BAÄLANTI YOKSA AÃ‡IK TUT (setInterval kaldÄ±rÄ±ldÄ± - connectSleekflow iÃ§inde kapatÄ±lÄ±yor)
            
            // Buton event listener'larÄ±
            document.getElementById('openSidebar')?.addEventListener('click', window.toggleSidebar);
            document.getElementById('toggleSidebar')?.addEventListener('click', window.toggleSidebar);

            // Arama fonksiyonunu kur
            setupWidgetSearch();
        });
    </script>
</body>
</html>

